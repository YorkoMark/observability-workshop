<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.110.0"><meta name=generator content="Relearn 5.11.2+tip"><meta name=description content="Splunk Observability Workshops"><title>6. O11y - Distributed Tracing for modern applications :: Splunk Observability Cloud Workshops</title><link href=https://splunk.github.io/observability-workshop/v4.57/tko/session-6/index.html rel=canonical type=text/html title="6. O11y - Distributed Tracing for modern applications :: Splunk Observability Cloud Workshops"><link href=https://splunk.github.io/observability-workshop/v4.57/tko/session-6/index.xml rel=alternate type=application/rss+xml title="6. O11y - Distributed Tracing for modern applications :: Splunk Observability Cloud Workshops"><link href=https://splunk.github.io/observability-workshop/v4.57/images/favicon.ico?1676480222 rel=icon type=image/x-icon><link href=https://splunk.github.io/observability-workshop/v4.57/css/fontawesome-all.min.css?1676480224 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://splunk.github.io/observability-workshop/v4.57/css/fontawesome-all.min.css?1676480224 rel=stylesheet></noscript><link href=https://splunk.github.io/observability-workshop/v4.57/css/auto-complete.css?1676480224 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://splunk.github.io/observability-workshop/v4.57/css/auto-complete.css?1676480224 rel=stylesheet></noscript><link href=https://splunk.github.io/observability-workshop/v4.57/css/perfect-scrollbar.min.css?1676480224 rel=stylesheet><link href=https://splunk.github.io/observability-workshop/v4.57/css/nucleus.css?1676480224 rel=stylesheet><link href=https://splunk.github.io/observability-workshop/v4.57/css/fonts.css?1676480224 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://splunk.github.io/observability-workshop/v4.57/css/fonts.css?1676480224 rel=stylesheet></noscript><link href=https://splunk.github.io/observability-workshop/v4.57/css/theme.css?1676480224 rel=stylesheet><link href=https://splunk.github.io/observability-workshop/v4.57/css/theme-splunk-light.css?1676480224 rel=stylesheet id=variant-style><link href=https://splunk.github.io/observability-workshop/v4.57/css/ie.css?1676480224 rel=stylesheet><link href=https://splunk.github.io/observability-workshop/v4.57/css/variant.css?1676480224 rel=stylesheet><link href=https://splunk.github.io/observability-workshop/v4.57/css/print.css?1676480224 rel=stylesheet media=print><link href=https://splunk.github.io/observability-workshop/v4.57/css/format-print.css?1676480224 rel=stylesheet><script src=https://splunk.github.io/observability-workshop/v4.57/js/url.js?1676480224></script>
<script src=https://splunk.github.io/observability-workshop/v4.57/js/variant.js?1676480224></script>
<script>window.index_js_url="https://splunk.github.io/observability-workshop/v4.57/index.search.js";var root_url="https://splunk.github.io/observability-workshop/v4.57/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found="No results found for \u0022{0}\u0022",window.T_N_results_found="{1} results found for \u0022{0}\u0022",baseUriFull="https://splunk.github.io/observability-workshop/v4.57/",window.variants&&variants.init(["splunk-light","splunk-dark","aws"])</script></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=https://splunk.github.io/observability-workshop/v4.57/tko/session-6/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable dir=ltr><div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle class=topbar-link title='Menu (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=https://splunk.github.io/observability-workshop/v4.57/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=https://splunk.github.io/observability-workshop/v4.57/tko/index.html><span itemprop=name>TKO Workshops</span></a><meta itemprop=position content="2">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>6. O11y - Distributed Tracing for modern applications</span><meta itemprop=position content="3"></li></ol></div></div></nav><main id=body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><div id=head-tags></div><article class=default><h1 id=6-o11y---distributed-tracing-for-modern-applications>6. O11y - Distributed Tracing for modern applications</h1><p>Here at Buttercup Instruments, our business is expanding ! We have recently added 3 new locations, two locations in the USA, Colorado and Chicago and one international location in SRI Lanka!</p><p>Our technical staff has already on-boarded the data from these new locations and incorporated them into our inventory application and it is our job to review these improvements and send any issues back to our developers for repairs.</p><p>We now have a total of 6 locations!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of 6. O11y - Distributed Tracing for modern applications</h1><article class=default><h1 id=setup>Setup</h1><h2 id=1-set-environment-variables>1. Set Environment Variables</h2><p>Environment Variables:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>USERNAME</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;Your-UserName&gt;
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>SPLUNK_ACCESS_TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;Your-Token&gt;
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>SPLUNK_REALM</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;Your-Realm&gt;
</span></span></code></pre></div><h2 id=2-implement-auto-instrumentation>2. Implement Auto-Instrumentation</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> shop
</span></span><span style=display:flex><span>vi Dockerfile
</span></span></code></pre></div><p>Add the Otel Java Agent to Java ENTRYPOINT:</p><p>Change this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ENTRYPOINT java  -Dotel.resource.attributes<span style=color:#ce5c00;font-weight:700>=</span>service.name<span style=color:#ce5c00;font-weight:700>=</span>shop,deployment.environment<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>USERNAME</span><span style=color:#4e9a06>}</span>_Apm_Instrumentation_Shop -jar app.jar
</span></span></code></pre></div><p>To this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ENTRYPOINT java -javaagent:splunk-otel-javaagent-all.jar 
</span></span><span style=display:flex><span>-Dotel.resource.attributes<span style=color:#ce5c00;font-weight:700>=</span>service.name<span style=color:#ce5c00;font-weight:700>=</span>shop,deployment.environment<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>USERNAME</span><span style=color:#4e9a06>}</span>_Apm_Instrumentation_Shop
</span></span><span style=display:flex><span>-jar app.jar
</span></span></code></pre></div><p>See examples at:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi ../Dockerfiles_Instrumented
</span></span></code></pre></div><p>Repeat for: <code>instruments / products / stock</code></p><h2 id=3-build-and-deploy-application>3. Build and Deploy Application</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> <span style=color:#4e9a06>&#34;javashop-otel directory&#34;</span>
</span></span><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><footer class=footline></footer></article><article class=default><h1 id=validate-traces-are-being-collected>Validate Traces are being collected</h1><h2 id=1-users-and-workflows>1. Users and Workflows</h2><p>As we go through this workshop we will be switching roles from SRE to Developer. First we will start with first responders or SREs who will identify an issue in Splunk Observability UI.</p><p>Next, we will jump to a Developer Role to see how a Developer will solve a problem using trace data identified by our SRE. Of course, we are not requiring 2 people for this workshop as each participant will play both roles.</p><h2 id=2-view-service-map>2. View Service Map</h2><p>If your instrumentation was successful, the service-map will show latency from the shop service to the products service.</p><p><a href=#image-d1b3ea7c63c4d25dac1fe0f22b18d5c1 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/206541846-7f0e6462-7659-44bc-bc48-3621c2872fc4.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-d1b3ea7c63c4d25dac1fe0f22b18d5c1><img src=https://user-images.githubusercontent.com/32849847/206541846-7f0e6462-7659-44bc-bc48-3621c2872fc4.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" class=lightbox-image loading=lazy></a></p><p>Click on shop service, click Traces (right side), sort by Duration and select the longest duration trace.</p><p><a href=#image-e9435beca973b21ee58832e14c95250b class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204347798-4f232b7f-7a7a-483f-9d61-f0b535e9ecf0.png alt=LongTrace style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-e9435beca973b21ee58832e14c95250b><img src=https://user-images.githubusercontent.com/32849847/204347798-4f232b7f-7a7a-483f-9d61-f0b535e9ecf0.png alt=LongTrace class=lightbox-image loading=lazy></a></p><p>Now we can see the long latency occurred in the products service and if we click on <code>products: /products</code> we can see the offending method was <code>products:ProductResource.getAllProducts</code>.</p><p><a href=#image-db126ef2252cd96f4ecbb923659292c7 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204347855-724545bf-c3df-478a-a27d-e4f85f708e15.png alt=long-trace-detail-GetAllProducts style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-db126ef2252cd96f4ecbb923659292c7><img src=https://user-images.githubusercontent.com/32849847/204347855-724545bf-c3df-478a-a27d-e4f85f708e15.png alt=long-trace-detail-GetAllProducts class=lightbox-image loading=lazy></a></p><p>Our next step here would be to send that trace to a developer by clicking download trace and they will have to debug the method. Before we do that please take note of the Tags available for the developer to leverage to find root cause.</p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Note:</div><div class=box-content><p>Since they do not have full parameter information it can be a long process.</p></div></div><footer class=footline></footer></article><article class=default><h1 id=developer-role>Developer Role</h1><h2 id=1-now-lets-play-the-role-of-the-developer>1. Now let&rsquo;s play the role of the developer</h2><p>As a developer we must debug the function products:ProductResource.getAllProducts to find the problem.</p><p>Now find the needle in Haystack !</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi products/src/main/java/com/shabushabu/javashop/products/resources/ProductResource.java
</span></span></code></pre></div><p>Find getAllProducts <code>/getAllProducts</code></p><p>scroll way&mldr; down!</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ProductResource</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ProductService</span> <span style=color:#000>productService</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Inject</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ProductResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ProductService</span> <span style=color:#000>productService</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>productService</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>productService</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@GET</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Response</span> <span style=color:#000>getAllProducts</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@DefaultValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;California&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#5c35cc;font-weight:700>@QueryParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;location&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// STEP X: All we know right now is somewhere in this function, latency was introduced.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction10</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction13</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction5</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction6</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction7</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction8</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction9</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction10</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction11</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction12</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>//something in HAYSTACK
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//something in HAYSTACK
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//something in HAYSTACK
</span></span></span></code></pre></div><p>Exit vi <code>:q!</code></p><p>OK, enough fun&mldr; let&rsquo;s make this easier for our developer.</p><footer class=footline></footer></article><article class=default><h1 id=custom-attribution>Custom Attribution</h1><p>To take a deeper look at this issue, we will implement Custom Attributes via Opentelemetry Manual Instrumentation</p><p>To speed up manual instrumentation in Java you can leverage <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotations</a>, which automatically create a span around a method without modifying the actual code inside the method.</p><p>This can be very valueable if you are working with an SRE that may have limited accesss to source code changes.</p><p>To add even more information to help our developers find the root cause faster, <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotations</a> can be used to generate span tags with parameter values for the method in question.</p><p>It is important to remember that any developer should be able to debug a method with knowledge of parameter values at the time of an issue ( exception or latency).</p><p>To expedite manual instrumentation implementation for this exercise, we have provided a tool which will annotate the entirety of the &ldquo;shop&rdquo; and &ldquo;products&rdquo; services with OpenTelemetry standard annotations for every method call without having to write any code. This &ldquo;annotator&rdquo; tool will also tag every parameter in every function, which adds a span tag with Parameter=Value.</p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Note:</div><div class=box-content><p>This Full-fidelity Every-method approach is the Monolith Use Case with Splunk APM for Java.</p></div></div><h2 id=1-run-manual-instrumentation-tool>1. Run Manual Instrumentation Tool</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> javashop-otel directory
</span></span><span style=display:flex><span>./AutomateManualInstrumentation.sh
</span></span></code></pre></div><h2 id=2-rebuild-and-deploy-application>2. Rebuild and Deploy Application</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Now that we have rebuilt and deployed our application, traffic is being sent once again.</p><p>Go back to the Splunk Observability UI and let&rsquo;s see if these annotations help us narrow down the root cause more quickly.</p><p>Click back on the trace window</p><p><a href=#image-ee5eacdc4153e5dd3869cccb9c7b6d54 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204348366-38b8c82a-02ca-472b-b1aa-feeb746ec1d7.png alt="Screen Shot 2022-11-28 at 7 29 43 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-ee5eacdc4153e5dd3869cccb9c7b6d54><img src=https://user-images.githubusercontent.com/32849847/204348366-38b8c82a-02ca-472b-b1aa-feeb746ec1d7.png alt="Screen Shot 2022-11-28 at 7 29 43 AM" class=lightbox-image loading=lazy></a></p><p>Give the traces a couple minutes to generate &mldr;</p><h2 id=3-houston-we-have-a-new-problem>3. Houston, we have a new problem</h2><p>Once traces populate, Select &ldquo;Errors Only&rdquo;</p><p><a href=#image-827dc8738b92177dcdb76142d6d36f18 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204348492-84a4ad45-e11c-4e75-a6a9-d6e52e0eb13e.png alt="Screen Shot 2022-11-28 at 7 36 50 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-827dc8738b92177dcdb76142d6d36f18><img src=https://user-images.githubusercontent.com/32849847/204348492-84a4ad45-e11c-4e75-a6a9-d6e52e0eb13e.png alt="Screen Shot 2022-11-28 at 7 36 50 AM" class=lightbox-image loading=lazy></a></p><p>Note: we haven&rsquo;t changed the code at all by adding annotations. Click on a trace with an error present.</p><p><a href=#image-31b09cc5986d3cc19ef947cf327fef4f class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204348687-12241153-b297-4bd7-9ea8-4b410369e82c.png alt="Screen Shot 2022-11-28 at 7 38 33 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-31b09cc5986d3cc19ef947cf327fef4f><img src=https://user-images.githubusercontent.com/32849847/204348687-12241153-b297-4bd7-9ea8-4b410369e82c.png alt="Screen Shot 2022-11-28 at 7 38 33 AM" class=lightbox-image loading=lazy></a></p><p>We can see our Exception is <code>InvalidLocaleException</code>!</p><p>The real problem must be related to the new data associated with SRI LANKA as the Exception says &ldquo;Non English Characters found in Instrument Data.</p><p>This exception had not surfaced in previous traces because the method where it was thrown was NOT covered with Auto Instrumentation.</p><p>Once we completed the Manual Instrumentation via the Annotations we added, this method was instrumented and we can now see we had a buried Exception being thrown.</p><footer class=footline></footer></article><article class=default><h1 id=fix-the-issue>Fix the issue</h1><h2 id=1-lets-play-developer-once-again-and-fix-our-issue>1. Let&rsquo;s play Developer once again and fix our issue</h2><p>We already know exactly what file to look in and what method to look at as it is called out in the trace.</p><p><a href=#image-ccccd9e8039d1b53943f9657b80addc5 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349038-3b43a5ba-18e3-4d58-8985-29ee1f7da40a.png alt="Screen Shot 2022-11-28 at 7 43 58 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-ccccd9e8039d1b53943f9657b80addc5><img src=https://user-images.githubusercontent.com/32849847/204349038-3b43a5ba-18e3-4d58-8985-29ee1f7da40a.png alt="Screen Shot 2022-11-28 at 7 43 58 AM" class=lightbox-image loading=lazy></a></p><p>Edit the file</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi shop/src/main/java/com/shabushabu/javashop/shop/model/Instrument.java
</span></span></code></pre></div><p>Search for the method buildForLocale <code>/buildForLocale</code></p><p>Look at Code, notice the Annotation <code>@WithSpan()</code>? <code>@WithSpan()</code> is an <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotation</a> for Java that automatically generates a span around a the function that follows.</p><p><code>@SpanAttribute()</code> is another <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotation</a> that automatically adds a tag to a span with the corresponding parameter it annotates and its value. Using this technique we can tell developers exactly what the values of every parameter of a function the wrote or must repair at the time the problem occurred.</p><p><a href=#image-00cfaf177ca7735ec2063343a754ecba class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349143-1e35b6e4-4059-4c56-8718-76c14d41727c.png alt="Screen Shot 2022-11-28 at 7 45 13 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-00cfaf177ca7735ec2063343a754ecba><img src=https://user-images.githubusercontent.com/32849847/204349143-1e35b6e4-4059-4c56-8718-76c14d41727c.png alt="Screen Shot 2022-11-28 at 7 45 13 AM" class=lightbox-image loading=lazy></a></p><p>Now let&rsquo;s fix this code. We are going to simply comment this out for now and see if it fixes our latency issue. Type <code>i</code> for insert</p><p>Change this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isEnglish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>title</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InvalidLocaleException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Non English Characters found in Instrument Data&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Characters OK &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>To this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//if (!isEnglish(title)) {
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  throw new InvalidLocaleException(&#34;Non English Characters found in Instrument Data&#34;);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// } else {
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// System.out.println(&#34;Characters OK &#34;);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//}
</span></span></span></code></pre></div><p>To save changes in vi type <code>:wq</code></p><p>Make sure you saved your changes to <code>shop/src/main/java/com/shabushabu/javashop/shop/model/Instrument.java</code></p><h2 id=2-build-and-deploy-application>2. Build and Deploy Application</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Wait a few minutes&mldr;..</p><footer class=footline></footer></article><article class=default><h1 id=root-cause-analysis>Root Cause Analysis</h1><h2 id=1-latency-root-cause>1. Latency Root Cause</h2><p>Open Service Map in Splunk Observability UI</p><p><a href=#image-a00d3c82de26148367b74a9970806d92 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/206542093-f97b37ce-7e58-45bc-a281-5a388d60617e.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-a00d3c82de26148367b74a9970806d92><img src=https://user-images.githubusercontent.com/32849847/206542093-f97b37ce-7e58-45bc-a281-5a388d60617e.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" class=lightbox-image loading=lazy></a></p><p>We can see we still have our original Latency issue, however our exception for Invalid Locale should be gone.</p><p>Let&rsquo;s check to see our InvalidLocale Exception is gone. Click Shop Service, click Traces on the right. We did remove the exception however it seems removing the Exception did not fix the latency&mldr;</p><p>Lets see if the newly added annotations provide us more relevant information for the next responder once we find the cause.</p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:warning><div class=box-label>Note:</div><div class=box-content><p>We added additional information Parameter Values at Time of Latency. In this case the <strong>Location</strong> tag was created due our handy Annotator, that did the <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotations</a></p></div></div><p><a href=#image-4f3cbf02f960c0f3d511dcd48a771bf5 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/213582624-66466a19-00fa-4dda-acd0-f6970d594ba1.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-4f3cbf02f960c0f3d511dcd48a771bf5><img src=https://user-images.githubusercontent.com/32849847/213582624-66466a19-00fa-4dda-acd0-f6970d594ba1.png alt=image class=lightbox-image loading=lazy></a></p><p>We can see that the actual function call that has the latency was not <code>ProductResource.getAllProducts</code> but the function call <code>ProductResource.myCoolFunction234234234</code>!</p><p>With this information a Developer can debug very quickly. Consider the case of debugging code, that you may not have written yourself without Parameter Values at the time of the issue? You would have no choice but to go line &mldr;. by line &mldr;.. by line&mldr;.. which can take a very long time.</p><p>Since we now have the parameter tagged as part of our span metadata the actual root cause is seemingly related to the &ldquo;location&rdquo; Colorado!</p><p>It appears the one custom attribute that was tagged for function <code>ProductResource.myCoolFunction234234234</code> was <code>myInt</code> with a value of <code>999</code>.</p><p>Let&rsquo;s see if we can find the code that is causing this latency.</p><h2 id=2-fix-the-code>2. Fix the code</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi products/src/main/java/com/shabushabu/javashop/products/resources/ProductResource.java
</span></span></code></pre></div><p>search for 999 <code>/999</code></p><p>We found and fixed the Needle In Haystack more quickly! Let&rsquo;s fix our code, enter <code>i</code> for insert.</p><p>Change this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>myCoolFunction234234234</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@SpanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;myInt&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>myInt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Generate a FAST sleep of 0 time !
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Random</span> <span style=color:#000>sleepy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Random</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>999</span><span style=color:#ce5c00;font-weight:700>==</span><span style=color:#000>myInt</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sleepy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5000</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#0000cf;font-weight:700>3000</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>3000</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span></code></pre></div><p>To this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>myCoolFunction234234234</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@SpanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;myInt&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>myInt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Generate a FAST sleep of 0 time !
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Random</span> <span style=color:#000>sleepy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Random</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//    if (999==myInt)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//        Thread.sleep(sleepy.nextInt(5000 - 3000) + 3000);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span></code></pre></div><p>Save changes in vi type <code>:wq</code></p><p>Make sure you saved your changes to: <code>products/src/main/java/com/shabushabu/javashop/products/resources/ProductResource.java</code></p><footer class=footline></footer></article><article class=default><h1 id=build-and-deploy-again>Build and Deploy again</h1><h2 id=1-build-and-deploy-application-again>1. Build and Deploy Application again</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Now that we have rebuilt and deployed our application, traffic is being sent once again.</p><p>We are waiting a few minutes . . .</p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Congratulations</div><div class=box-content><p>If you do not see Red in your service map, you have successfully completed our Inventory application review for Shri Lanka and Colorado locations!!</p></div></div><p>Now let&rsquo;s ensure Chicago was on-boarded correctly. However, since we have been having so many issues related to &ldquo;location&rdquo; and we have added that custom attribute via Opentelemetry Manual Instrumentation, lets go to the Splunk Observability UI and create an APM metric set around that tag.</p><p>NOTE: We can do this without concern for Cardinality as we know this tag only has 6 possible values.</p><p>Index the location Tag.</p><p><a href=#image-879b161f0e689007af427aae64e16d36 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/213540265-5b0567ab-c9f3-412f-bec0-07277c7e8650.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-879b161f0e689007af427aae64e16d36><img src=https://user-images.githubusercontent.com/32849847/213540265-5b0567ab-c9f3-412f-bec0-07277c7e8650.png alt=image class=lightbox-image loading=lazy></a></p><h2 id=2-build-and-deploy-application-to-run-traffic-again>2. Build and Deploy Application to run traffic again</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Open a browser and navigate to <a href=http://localhost:8010 target=_blank>http://localhost:8010</a></p><p><a href=#image-e1d2edc4bbb7ed83aa82a27853367e68 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/213541843-30266285-787f-493b-bc90-ffb4ac6e4c77.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-e1d2edc4bbb7ed83aa82a27853367e68><img src=https://user-images.githubusercontent.com/32849847/213541843-30266285-787f-493b-bc90-ffb4ac6e4c77.png alt=image class=lightbox-image loading=lazy></a></p><p>Select a few locagtions and hit the login button, remember to select the Chicago Location and Login</p><p>Uhh ohh ! We received a 500 error, something is wrong there as well. Return to the Splunk Observability UI and lets look once again at our Service Map</p><p><a href=#image-f3667dd84e5d67f39d238cd3905d3715 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349595-fca270ad-379e-48c5-b2e1-7f222af82c55.png alt="Screen Shot 2022-11-28 at 8 11 47 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-f3667dd84e5d67f39d238cd3905d3715><img src=https://user-images.githubusercontent.com/32849847/204349595-fca270ad-379e-48c5-b2e1-7f222af82c55.png alt="Screen Shot 2022-11-28 at 8 11 47 AM" class=lightbox-image loading=lazy></a></p><p>We see there was an un-handled exception thrown in Instruments service and some latency from our database.</p><p>Select the Instruments Service, click on Traces on the right and select <strong>Errors Only</strong></p><p><a href=#image-0b1116443155b115f27be0900c8b29e3 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349696-dc19d62f-ed82-4533-ad27-138237821b8e.png alt="Screen Shot 2022-11-28 at 8 14 50 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-0b1116443155b115f27be0900c8b29e3><img src=https://user-images.githubusercontent.com/32849847/204349696-dc19d62f-ed82-4533-ad27-138237821b8e.png alt="Screen Shot 2022-11-28 at 8 14 50 AM" class=lightbox-image loading=lazy></a></p><p>We can see the exception was thrown by Hibernate, however it was thrown in our method <code>instruments: InstrumentRepository.findInstruments</code></p><p><a href=#image-dd7ac3f1042bb62f473de158eafc6110 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204351905-03fe632b-b21c-4e8d-8044-dc582fed2253.png alt="Screen Shot 2022-11-28 at 8 14 37 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-dd7ac3f1042bb62f473de158eafc6110><img src=https://user-images.githubusercontent.com/32849847/204351905-03fe632b-b21c-4e8d-8044-dc582fed2253.png alt="Screen Shot 2022-11-28 at 8 14 37 AM" class=lightbox-image loading=lazy></a></p><footer class=footline></footer></article><article class=default><h1 id=the-final-fix>The Final Fix!</h1><h2 id=1-lets-play-developer-again>1. Let&rsquo;s play developer again</h2><p>Edit the file <code>instruments: InstrumentRepository.findInstruments</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi instruments/src/main/java/com/shabushabu/javashop/instruments/repositories/FindInstrumentRepositoryImpl.java
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>findInstruments</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;findInstruments Called (All)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>Object</span> <span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entityManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createNativeQuery</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#4e9a06>&#34;SELECT * FROM instruments_for_sale, instruments_for_sale_chicago&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getResultList</span><span style=color:#ce5c00;font-weight:700>();</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>We can see the developer accidently added the Instruments database with the Chicago Instruments database! Let&rsquo;s change the query and fix this, remove <code>instruments_for_sale</code> from our query.</p><p>Change this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>findInstruments</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;findInstruments Called (All)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#000>Object</span> <span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entityManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createNativeQuery</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#4e9a06>&#34;SELECT * FROM instruments_for_sale, instruments_for_sale_chicago&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getResultList</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>To this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>findInstruments</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;findInstruments Called (All)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//Object obj = entityManager.createNativeQuery( &#34;SELECT * FROM instruments_for_sale, instruments_for_sale_chicago&#34;).getResultList();
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span>    <span style=color:#000>Object</span> <span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entityManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createNativeQuery</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#4e9a06>&#34;SELECT * FROM instruments_for_sale_chicago&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getResultList</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=2-build-and-deploy-application-once-more>2. Build and Deploy Application once more</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> javashop-otel directory
</span></span><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Now let&rsquo;s test the Chicago location once again, open a browser and navigate to <a href=http://localhost:8010 target=_blank>http://localhost:8010</a>. Select the Chicago Location and Login.</p><p>We now see the 500 error is gone! Let&rsquo;s confirm a clean Service Map!</p><p><a href=#image-4664b14da05613d29ee879bf3a8cd690 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204350088-fca43e3c-42ea-4933-8a61-01eb2083fd23.png alt="Screen Shot 2022-11-28 at 8 35 11 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-4664b14da05613d29ee879bf3a8cd690><img src=https://user-images.githubusercontent.com/32849847/204350088-fca43e3c-42ea-4933-8a61-01eb2083fd23.png alt="Screen Shot 2022-11-28 at 8 35 11 AM" class=lightbox-image loading=lazy></a></p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Congratulations</div><div class=box-content><p>If you see a clean service map, free of errors and Latency you have successfully completed the Java Instrumentation Workshop!**</p></div></div><p><strong>Have a lovely day!</strong></p><footer class=footline></footer></article><article class=default><h1 id=observability-lambda-lab>Observability Lambda Lab</h1><p>Welcome to Observability Lambda Lab. This lab will make a tracing superhero out of you! Follow the steps bellow to set up and get started.</p><h2 id=pre-requisites>Pre-Requisites</h2><p>You should already have the lab content available on your ec2 lab host. You will need to update custom settings to your environment. Please follow the steps bellow to achieve that.</p><p>Ensure that your working lab folder is on your home directory:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ls
</span></span></code></pre></div><p>Expected output:
You should see the directory <code>o11y-lambda-lab</code> in the list.</p><p><em>Note:</em> If you don&rsquo;t see the directory, fetch the contents of this repository by running the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone -b master https://github.com/kdroukman/o11y-lambda-lab.git
</span></span></code></pre></div><p>In your Splunk Observability Cloud lab Organisation (Org) obtain your Access Token and Realm Values.</p><h3 id=1-set-environment-variables>1. Set Environment Variables</h3><p>Set the bellow environment variables:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ACCESS_TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;CHANGE_ME&gt; <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span><span style=color:#204a87>export</span> <span style=color:#000>REALM</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;CHANGE_ME&gt; <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span><span style=color:#204a87>export</span> <span style=color:#000>PREFIX</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>hostname<span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><h3 id=2-update-auto-instrumentation-template>2. Update Auto-instrumentation template</h3><p>Update your auto-instrumentation Serverless template.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/o11y-lambda-lab/auto/serverless_unset.yml <span style=color:#000;font-weight:700>|</span> envsubst &gt; ~/o11y-lambda-lab/auto/serverless.yml
</span></span></code></pre></div><p>Examine the output of the updated serverless.yml contents (you may need to scroll up to the relevant section).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/o11y-lambda-lab/auto/serverless.yml
</span></span></code></pre></div><p>Locate the following section and confirm that the parameters have been set:
<a href=#image-160379a586c41a34d967536587755854 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219005735-a494c35a-41c4-4350-930a-b9ce7e1f64ea.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-160379a586c41a34d967536587755854><img src=https://user-images.githubusercontent.com/5187861/219005735-a494c35a-41c4-4350-930a-b9ce7e1f64ea.png alt=image class=lightbox-image loading=lazy></a></p><h3 id=3-update-manual-instrumentation-template>3. Update Manual-instrumentation template</h3><p>Update your manual-instrumentation Serverless template.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/o11y-lambda-lab/manual/serverless_unset.yml <span style=color:#000;font-weight:700>|</span> envsubst &gt; ~/o11y-lambda-lab/manual/serverless.yml
</span></span></code></pre></div><p>Examine the output of the updated serverless.yml contents (you may need to scroll up to the relevant section).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/o11y-lambda-lab/manual/serverless.yml
</span></span></code></pre></div><p>Locate the following section and confirm that the parameters have been set:
<a href=#image-d65c674d27bfb3b7ce9c3e359e84a2e0 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219005735-a494c35a-41c4-4350-930a-b9ce7e1f64ea.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-d65c674d27bfb3b7ce9c3e359e84a2e0><img src=https://user-images.githubusercontent.com/5187861/219005735-a494c35a-41c4-4350-930a-b9ce7e1f64ea.png alt=image class=lightbox-image loading=lazy></a></p><h3 id=4-set-your-aws-credentials>4. Set your AWS Credentials</h3><p>Add your credntials file and populate it with your provided AWS Access Key ID and AWS Secret Access Key values.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir ~/.aws <span style=color:#000;font-weight:700>&amp;</span> vi ~/.aws/credentials
</span></span></code></pre></div><p>In <code>vi</code> editor paste the bellow and change to your Access Key values. (Hint: Hit letter <code>i</code> to set your Vi editor to Insert/Edit mode)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>[default]
</span></span><span style=display:flex><span>aws_access_key_id=&lt;CHANGE ME&gt;
</span></span><span style=display:flex><span>aws_secret_access_key=&lt;CHANGE ME&gt;
</span></span></code></pre></div><p>Save your <code>credentials</code> file:</p><ol><li>Hit <code>Esc</code> button to exit Insert mode in your Vi Editor</li><li>Press column <code>:</code> - this will give you access to command prompt within your Vi Editor</li><li>Key in <code>wq</code> and press <code>Enter</code>. This will write and quit your Vi Editor. i.e. Save.</li></ol><p>Now you are set up and ready for this Lab.</p><h2 id=auto-instrumentation>Auto-Instrumentation</h2><p>Navigate to the <code>auto</code> directory that contains auto-instrumentation code.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/o11y-lambda-lab/auto
</span></span></code></pre></div><p>Inspect the contents of the files in this directory.
Take a look at the <code>serverless.yml</code> template.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat serverless.yml
</span></span></code></pre></div><ol><li>Can you identify which AWS entities are being created by this template?</li><li>Can you identify where OpenTelemetry instrumentation is being set up?</li><li>Can you determine which instrumentation information is being provided by the Environment Variables?</li></ol><p>You should see the Splunk OpenTelemetry Lambda layer being added to each fuction.</p><p><a href=#image-9fdb9e49148ec57da214dba43b15e40e class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219007839-fd96d1bb-c53d-4cfa-9533-c7982262459d.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-9fdb9e49148ec57da214dba43b15e40e><img src=https://user-images.githubusercontent.com/5187861/219007839-fd96d1bb-c53d-4cfa-9533-c7982262459d.png alt=image class=lightbox-image loading=lazy></a></p><p>You can see the relevant layer ARNs (Amazon Resource Name) and latest versions for each AWS region here: <a href=https://github.com/signalfx/lambda-layer-versions/blob/main/splunk-apm/splunk-apm.md target=_blank>https://github.com/signalfx/lambda-layer-versions/blob/main/splunk-apm/splunk-apm.md</a></p><p>You should also see in the Environment variables that are being set.
<a href=#image-391c310b77c3ce077e417aa5f9bc9270 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219012413-fddbea72-3f5a-418f-9f8f-83cf2305d976.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-391c310b77c3ce077e417aa5f9bc9270><img src=https://user-images.githubusercontent.com/5187861/219012413-fddbea72-3f5a-418f-9f8f-83cf2305d976.png alt=image class=lightbox-image loading=lazy></a></p><p>Using the environment variables we are specifying to use the NodeJS function wrapper, since our Lambda is written in NodeJS. We are also providing APM service name and environment name, as well as Access token and Realm details.
You should also see in the Environment variables that are being set. Using the environment variables we are specifying to use the NodeJS function wrapper, since our Lambda is written in NodeJS. We are also providing APM service name and environment name, as well as Access token and Realm details.</p><p>Take a look at the function code.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat handler.js
</span></span></code></pre></div><ol><li>Can you identify the code for producer function?</li><li>Can you identify the code for consumer function?</li></ol><p>Note that there is no mention of Splunk or OpenTelemetry in the code. We are adding the instrumentation using the Lambda layer and Environment Variables only.</p><h3 id=deploy-your-lambdas>Deploy your Lambdas</h3><p>Run the following command to deploy your Lambda Functions:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>serverless deploy
</span></span></code></pre></div><p>This command will follow the instructions in your <code>serverless.yml</code> template to create your Lambda functions and your Kinesis stream. Note it may take a couple of minutes to execute.</p><p>Expected output:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Deploying hostname-lambda-lab to stage dev (us-east-1)
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>endpoint: POST - https://randomstring.execute-api.us-east-1.amazonaws.com/dev/producer
</span></span><span style=display:flex><span>functions:
</span></span><span style=display:flex><span>  producer: hostname-lambda-lab-dev-producer (1.6 kB)
</span></span><span style=display:flex><span>  consumer: hostname-lambda-lab-dev-consumer (1.6 kB)
</span></span></code></pre></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p><code>serverless.yml</code> is in fact a CloudFormation template. CloudFormation is an infrastructure as code service from AWS. You can read more about it here - <a href=https://aws.amazon.com/cloudformation/ target=_blank>https://aws.amazon.com/cloudformation/</a></p></div></div><p>Check the details of your serverless functions:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>serverless info
</span></span></code></pre></div><p>Take note of your endpoint value:</p><p><a href=#image-6bcba81b995f7253c2000e1548882cb5 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219013249-bfa87ba1-f719-4287-8124-f95d87df83f5.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-6bcba81b995f7253c2000e1548882cb5><img src=https://user-images.githubusercontent.com/5187861/219013249-bfa87ba1-f719-4287-8124-f95d87df83f5.png alt=image class=lightbox-image loading=lazy></a></p><h3 id=send-some-traffic>Send some Traffic</h3><p>Use the <code>curl</code> command to send a payload to your producer function. Note that the flat <code>-d</code> is followed by your payload. Try changing the value of <code>name</code> to your name and telling the Lambda function about your <code>superpower</code>.
Replace <code>YOUR_ENDPOINT</code> with the endpoint from your previous step.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -d <span style=color:#4e9a06>&#39;{ &#34;name&#34;: &#34;CHANGE_ME&#34;, &#34;superpower&#34;: &#34;CHANGE_ME&#34; }&#39;</span> YOUR_ENDPOINT
</span></span></code></pre></div><p>For example:
<a href=#image-75eda8e0322b457372bdf85c61379343 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219024684-cd1853cf-8d9d-4fbb-af2f-96ba518622e3.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-75eda8e0322b457372bdf85c61379343><img src=https://user-images.githubusercontent.com/5187861/219024684-cd1853cf-8d9d-4fbb-af2f-96ba518622e3.png alt=image class=lightbox-image loading=lazy></a></p><p>You should see the following output if your message is successful:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>&#34;message&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;Message planced in the Event Stream: hostname-eventSteam&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>If unsuccessful, you will see:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>&#34;message&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Internal server error&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Ask one of the lab facilitators for assistance.</p><p>If you see a success message, generate more load: re-send that messate 5+ times. You should keep seeing a success message after each send.</p><p>Now check the lambda logs output.</p><h4 id=producer-function-logs>Producer function logs</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>serverless logs -f producer
</span></span></code></pre></div><h4 id=consumer-function-logs>Consumer function logs</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>serverless logs -f consumer
</span></span></code></pre></div><p>Examine the logs carefully. Do you see OpenTelemetry being loaded? Look out for lines with <code>splunk-extension-wrapper</code>.</p><h3 id=find-your-lambda-data-in-splunk-apm>Find your Lambda data in Splunk APM</h3><p>Now it&rsquo;s time to check how your Lambda traffic has been captured in Splunk APM.</p><p>Navigate to your Lab Organisation at [https://app.us1.signalfx.com]</p><p>Select APM from the Main Menu and then select your APM Environment. Your APM environment should be in the format <code>$(hostname)-lambda-lab</code> where the hostname value is a four letter name of your lab host. (Check it by looking at your command prompt, or by running <code>echo $(hostname)</code>)</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>It may take a few minutes for you traces to appear in Splunk APM. Try hitting refresh on your browser until you find your environement name in the list of Envrionments</p></div></div><p><a href=#image-0380dad5835d14a78e3e8ecd33a1462b class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/218997315-e3e5f6e1-fd7f-4267-8113-79ca748b9d77.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-0380dad5835d14a78e3e8ecd33a1462b><img src=https://user-images.githubusercontent.com/5187861/218997315-e3e5f6e1-fd7f-4267-8113-79ca748b9d77.png alt=image class=lightbox-image loading=lazy></a></p><p>You should see your lambda function and Kinesis service show up in the map.</p><p>Go to Explore the service map for a better view.</p><p><a href=#image-a68bb4c6dbc2c2ed827b36694215c158 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219001784-a25e7c9f-981d-49b9-b6df-f39d2bff0975.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-a68bb4c6dbc2c2ed827b36694215c158><img src=https://user-images.githubusercontent.com/5187861/219001784-a25e7c9f-981d-49b9-b6df-f39d2bff0975.png alt=image class=lightbox-image loading=lazy></a></p><p>You should be able to see the <code>producer-lambda</code> and the call it is making to <code>Kinesis</code> service.
<a href=#image-17b8d039bbce5529530d1e13cfaedeae class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219001985-fbf431ac-010a-4b1b-a9b0-3bad6825c5b6.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-17b8d039bbce5529530d1e13cfaedeae><img src=https://user-images.githubusercontent.com/5187861/219001985-fbf431ac-010a-4b1b-a9b0-3bad6825c5b6.png alt=image class=lightbox-image loading=lazy></a></p><p>What about your <code>consumer-lambda</code>? Where is it?</p><p>Click into <em>Traces</em> and examine one of the traces generated.
<a href=#image-df27a603fa0f84c22ecd90617cbec42c class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219002535-d11afd2f-9134-4e1b-87fb-f3af47969372.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-df27a603fa0f84c22ecd90617cbec42c><img src=https://user-images.githubusercontent.com/5187861/219002535-d11afd2f-9134-4e1b-87fb-f3af47969372.png alt=image class=lightbox-image loading=lazy></a></p><p>We can see the <code>producer-lambda</code> putting a Record on the Kinesis stream. But we can&rsquo;t see the <code>consumer-function</code> consuming that record.</p><p>This is because the <em>Context</em> is not being propagated - this is not something that is supported automatically Out-of-the-Box for Kinesis service at the time of this lab. Our Distributed Trace stops at <em>Kinesis</em> inferred service and we can&rsquo;t see the propagation any further.</p><p>Not yet&mldr;</p><p>Let&rsquo;s see how we work around this in the next section of this lab.</p><h2 id=manual-instrumentation>Manual Instrumentation</h2><p>Navigate to the <code>manual</code> directory that contains manually instrumentated code.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/o11y-lambda-lab/manual
</span></span></code></pre></div><p>Inspect the contents of the files in this directory.
Take a look at the <code>serverless.yml</code> template.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat serverless.yml
</span></span></code></pre></div><p>Do you see any difference from the same file in your <code>auto</code> directory?
You can try to compare them with a <code>diff</code> command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>diff ~/o11y-lambda-lab/auto/serverless.yml ~/o11y-lambda-lab/manual/serverless.yml 
</span></span></code></pre></div><p>There is no difference! <em>(Well, there shouldn&rsquo;t be. Get a lab assistant to help you if there is)</em></p><p><a href=#image-f50a1672405e2d7fdf816891dfcd884b class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219018152-6b21a172-9447-4e36-9ce5-814438c5d427.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-f50a1672405e2d7fdf816891dfcd884b><img src=https://user-images.githubusercontent.com/5187861/219018152-6b21a172-9447-4e36-9ce5-814438c5d427.png alt=image class=lightbox-image loading=lazy></a></p><p>Take a look at the function code.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat handler.js
</span></span></code></pre></div><p>Compare it with the same file in <code>auto</code> directory using the <code>diff</code> command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>diff ~/o11y-lambda-lab/auto/handler.js ~/o11y-lambda-lab/manual/handler.js 
</span></span></code></pre></div><p>Look at all these differences!</p><p>Notice how we are now importing some OpenTelemetry libraries directly into our function to handle some of the manual instrumenation tasks we require.</p><p>We are using <a href=https://www.npmjs.com/package/@opentelemetry/api target=_blank>https://www.npmjs.com/package/@opentelemetry/api</a> to manipulate the tracing logic in our functions.
We are using <a href=https://www.npmjs.com/package/@opentelemetry/core target=_blank>https://www.npmjs.com/package/@opentelemetry/core</a> to access the <strong>Propagator</strong> objects that we will use to manually propagate our context with.</p><p>The bellow code executes the following steps inside the Producer function:</p><ol><li>Get the current Active Span.</li><li>Create a Propagator.</li><li>Initialize a context carrier object.</li><li>Inject the context of the active span into the carrier object.</li><li>Modify the record we are about to put on our Kinesis stream to include the carrier that will carry the active span&rsquo;s context to the consumer.</li></ol><p><a href=#image-ad24db75f0bcf6440eb73c921eab2e2f class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219020209-33a3b24a-b3a7-4d80-865f-fbf3a8d8754a.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-ad24db75f0bcf6440eb73c921eab2e2f><img src=https://user-images.githubusercontent.com/5187861/219020209-33a3b24a-b3a7-4d80-865f-fbf3a8d8754a.png alt=image class=lightbox-image loading=lazy></a></p><p>The bellow code executes the following steps inside the Consumer function:</p><ol><li>Extract the context that we obtained from the Producer into a carrier object.</li><li>Create a Propagator.</li><li>Extract the context from the carrier object in Customer function&rsquo;s parent span context.</li><li>Start a new span with the parent span context.</li><li>Bonus: Add extra attributes to your span, including custom ones with the values from your message!</li><li>Once completed, end the span.</li></ol><p><a href=#image-6a65e0e4f155f5600545110f9e4302ef class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219020986-0ed2f8b9-8842-47cb-ac30-fdf9851015e6.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-6a65e0e4f155f5600545110f9e4302ef><img src=https://user-images.githubusercontent.com/5187861/219020986-0ed2f8b9-8842-47cb-ac30-fdf9851015e6.png alt=image class=lightbox-image loading=lazy></a></p><p>Now let&rsquo;s see the difference this makes.</p><h3 id=re-deploy-your-lambdas>Re-deploy your Lambdas</h3><p>While remaining in your <code>manual</code> directory, run the following command to deploy your Lambda Functions:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>serverless deploy
</span></span></code></pre></div><p>This command will follow the instructions in your <code>serverless.yml</code> template to update your Lambda functions with new <code>handler.js</code> code.</p><p>Expected output:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Deploying hostname-lambda-lab to stage dev (us-east-1)
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>endpoint: POST - https://randomstring.execute-api.us-east-1.amazonaws.com/dev/producer
</span></span><span style=display:flex><span>functions:
</span></span><span style=display:flex><span>  producer: hostname-lambda-lab-dev-producer (1.6 kB)
</span></span><span style=display:flex><span>  consumer: hostname-lambda-lab-dev-consumer (1.6 kB)
</span></span></code></pre></div><p>Check the details of your serverless functions:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>serverless info
</span></span></code></pre></div><p>Take note of your endpoint value. It should remain the same:</p><p><a href=#image-0953e63b3deb63e892cbf0bd25c0b777 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219013249-bfa87ba1-f719-4287-8124-f95d87df83f5.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-0953e63b3deb63e892cbf0bd25c0b777><img src=https://user-images.githubusercontent.com/5187861/219013249-bfa87ba1-f719-4287-8124-f95d87df83f5.png alt=image class=lightbox-image loading=lazy></a></p><h3 id=send-some-traffic-again>Send some Traffic again</h3><p>Use the <code>curl</code> command to send a payload to your producer function. Note that the flat <code>-d</code> is followed by your payload. Try changing the value of <code>name</code> to your name and telling the Lambda function about your <code>superpower</code>.
Replace <code>YOUR_ENDPOINT</code> with the endpoint from your previous step.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -d <span style=color:#4e9a06>&#39;{ &#34;name&#34;: &#34;CHANGE_ME&#34;, &#34;superpower&#34;: &#34;CHANGE_ME&#34; }&#39;</span> YOUR_ENDPOINT
</span></span></code></pre></div><p>For example:
<a href=#image-deac7a11cb532484e17923c8a89cc8f1 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219024684-cd1853cf-8d9d-4fbb-af2f-96ba518622e3.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-deac7a11cb532484e17923c8a89cc8f1><img src=https://user-images.githubusercontent.com/5187861/219024684-cd1853cf-8d9d-4fbb-af2f-96ba518622e3.png alt=image class=lightbox-image loading=lazy></a></p><p>You should see the following output if your message is successful:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>&#34;message&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;Message planced in the Event Stream: hostname-eventSteam&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>If unsuccessful, you will see:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>&#34;message&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Internal server error&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Ask one of the lab facilitators for assistance.</p><p>If you see a success message, generate more load: re-send that messate 5+ times. You should keep seeing a success message after each send.</p><p>Now check the lambda logs output.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Producer function logs" class="tab-nav-button direction-ltr active" onclick='switchTab("default","Producer function logs")'>
<span>Producer function logs</span></button></div><div class=tab-content><div data-tab-item="Producer function logs" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>serverless logs -f producer
</span></span></code></pre></div></div></div></div><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Consumer function logs" class="tab-nav-button direction-ltr active" onclick='switchTab("default","Consumer function logs")'>
<span>Consumer function logs</span></button></div><div class=tab-content><div data-tab-item="Consumer function logs" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>serverless logs -f consumer
</span></span></code></pre></div></div></div></div><p>Examine the logs carefully. Do you notice the difference?</p><p>Note that we are logging our Record value built inside the Producer function. Copy one of the underlined sub-sections of your trace parent context, and save it for later.</p><p><a href=#image-f9bdb840ade522641442e736b2027efd class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219031025-61ae5852-dabb-4c86-a215-aead651ab9c7.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-f9bdb840ade522641442e736b2027efd><img src=https://user-images.githubusercontent.com/5187861/219031025-61ae5852-dabb-4c86-a215-aead651ab9c7.png alt=image class=lightbox-image loading=lazy></a></p><h3 id=find-your-updated-lambda-data-in-splunk-apm>Find your updated Lambda data in Splunk APM</h3><p>Navigate back to APM in Splunk Observabilty Cloud - <a href=https://app.us1.signalfx.com/#/apm target=_blank>https://app.us1.signalfx.com/#/apm</a></p><p>Navigate to Explore the Service Dependency Map again.</p><p><a href=#image-74ddab6fd83eff9d74f7501e5f021006 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219030534-9dc94124-16e1-4350-b63f-0a4e4c8aa640.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-74ddab6fd83eff9d74f7501e5f021006><img src=https://user-images.githubusercontent.com/5187861/219030534-9dc94124-16e1-4350-b63f-0a4e4c8aa640.png alt=image class=lightbox-image loading=lazy></a></p><p>You should be able to see the <em>consumer-lambda</em> now clearly connected to the <em>producer-lambda</em>.</p><p>Remember the value you copied from your producer logs? You can run <code>serverless logs -f producer</code> command again on your EC2 lab host to fetch one.</p><p>Take that value, and paste it into trace search:</p><p><a href=#image-4b2c5b5769ea22a87824b9242e6c3dd6 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219031728-c926f2e4-78c7-438f-ad38-98f6facbad66.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-4b2c5b5769ea22a87824b9242e6c3dd6><img src=https://user-images.githubusercontent.com/5187861/219031728-c926f2e4-78c7-438f-ad38-98f6facbad66.png alt=image class=lightbox-image loading=lazy></a></p><p>Click on <em>Go</em> and you should be able to find the logged Trace:</p><p><a href=#image-44baa8ecdd026760156d2bac5e4bbc68 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219032326-becba400-c08d-4762-93b5-ba3f2c2322cb.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-44baa8ecdd026760156d2bac5e4bbc68><img src=https://user-images.githubusercontent.com/5187861/219032326-becba400-c08d-4762-93b5-ba3f2c2322cb.png alt=image class=lightbox-image loading=lazy></a></p><p>Note how the <em>Trace ID</em> is something that makes up the trace <em>context</em> that we propagated.</p><p>You can read up on the two common propagation standards:</p><ol><li>W3C: <a href=https://www.w3.org/TR/trace-context/#traceparent-header target=_blank>https://www.w3.org/TR/trace-context/#traceparent-header</a></li><li>B3: <a href=https://github.com/openzipkin/b3-propagation#overall-process target=_blank>https://github.com/openzipkin/b3-propagation#overall-process</a></li></ol><p>Which one are we using? <em>It should be self-explanatory from the Propagator we are creating in the Functions</em></p><p><strong>Bonus Question:</strong> What happens if we mix and match the W3C and B3 headers?</p><p>Expand the <code>consumer-lambda</code> span. Can you find the attributes from your message?</p><p><a href=#image-7976808c759d6ee5b4dd3fde4ce95b5a class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219032913-70dfc212-f5d7-4468-bda8-5041ea3e21e0.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-7976808c759d6ee5b4dd3fde4ce95b5a><img src=https://user-images.githubusercontent.com/5187861/219032913-70dfc212-f5d7-4468-bda8-5041ea3e21e0.png alt=image class=lightbox-image loading=lazy></a></p><h2 id=conclusion>Conclusion</h2><p>Congratuations on finishing the lab. You can now built out a Trace manually by linking two different functions together. This is very powerful, when auto-instrumenation, or third-party systems do not support context propagation out of the box.</p><p>Notice in the lab we used a combination of auto-instrumenation with some extra manual steps to do what we need to, in order to connect the trace. This is a common way to instrument, and workaround any instrumentation challenges you may face.</p><footer class=footline></footer></article></section></div></main></div><script src=https://splunk.github.io/observability-workshop/v4.57/js/clipboard.min.js?1676480224 defer></script>
<script src=https://splunk.github.io/observability-workshop/v4.57/js/perfect-scrollbar.min.js?1676480224 defer></script>
<script src=https://splunk.github.io/observability-workshop/v4.57/js/theme.js?1676480224 defer></script></body></html>