<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.110.0"><meta name=generator content="Relearn 5.11.2+tip"><meta name=description content="Splunk Observability Workshops"><title>6. O11y - Distributed Tracing for modern applications :: Splunk Observability Cloud Workshops</title><link href=https://splunk.github.io/observability-workshop/v4.62/tko/session-6/index.html rel=canonical type=text/html title="6. O11y - Distributed Tracing for modern applications :: Splunk Observability Cloud Workshops"><link href=../../tko/session-6/index.xml rel=alternate type=application/rss+xml title="6. O11y - Distributed Tracing for modern applications :: Splunk Observability Cloud Workshops"><link href=../../images/favicon.ico?1676856706 rel=icon type=image/x-icon><link href=../../css/fontawesome-all.min.css?1676856707 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../css/fontawesome-all.min.css?1676856707 rel=stylesheet></noscript><link href=../../css/nucleus.css?1676856707 rel=stylesheet><link href=../../css/auto-complete.css?1676856707 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../css/auto-complete.css?1676856707 rel=stylesheet></noscript><link href=../../css/perfect-scrollbar.min.css?1676856707 rel=stylesheet><link href=../../css/fonts.css?1676856707 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../css/fonts.css?1676856707 rel=stylesheet></noscript><link href=../../css/theme.css?1676856707 rel=stylesheet><link href=../../css/theme-splunk-light.css?1676856707 rel=stylesheet id=variant-style><link href=../../css/variant.css?1676856707 rel=stylesheet><link href=../../css/print.css?1676856707 rel=stylesheet media=print><link href=../../css/format-print.css?1676856707 rel=stylesheet><link href=../../css/ie.css?1676856707 rel=stylesheet><script src=../../js/url.js?1676856707></script>
<script src=../../js/variant.js?1676856707></script>
<script>window.index_js_url="../../index.search.js";var root_url="../../",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found="No results found for \u0022{0}\u0022",window.T_N_results_found="{1} results found for \u0022{0}\u0022",baseUriFull="https://splunk.github.io/observability-workshop/v4.62/",window.variants&&variants.init(["splunk-light","splunk-dark","aws"])</script></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=../../tko/session-6/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable><div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle class=topbar-link title='Menu (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../tko/index.html><span itemprop=name>TKO Workshops</span></a><meta itemprop=position content="2">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>6. O11y - Distributed Tracing for modern applications</span><meta itemprop=position content="3"></li></ol></div></div></nav><main id=body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><div id=head-tags></div><article class=default><h1 id=6-o11y---distributed-tracing-for-modern-applications>6. O11y - Distributed Tracing for modern applications</h1><span class="btn cstyle transparent"><button type=button>
<i class="fa-fw fas fa-clock"></i>
45 minutes</button></span><p>Here at Buttercup Instruments, our business is expanding ! We have recently added 3 new locations, two locations in the USA, Colorado and Chicago and one international location in SRI Lanka !</p><p>Our technical staff has already on-boarded the data from these new locations and incorporated them into our inventory application and it is our job to review these improvements and send any issues back to our developers for repairs.</p><p>We now have a total of 6 locations !</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of 6. O11y - Distributed Tracing for modern applications</h1><article class=default><h1 id=6-o11y---distributed-tracing-for-modern-applications>6. O11y - Distributed Tracing for modern applications</h1><h2 id=set-environment-variables>Set Environment Variables</h2><p>Environment Variables:</p><p>Using nano edit .env in <code>javashop-otel</code> directory</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nano .env
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>SHOP_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;your_name&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>SPLUNK_ACCESS_TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;your_token&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>SPLUNK_REALM</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;your_realm&gt;</span>
</span></span></code></pre></div><p>Save in nano</p><p>CTRL-O ENTER</p><p>Exit nano</p><p>CTRL-X</p><h2 id=build-and-deploy-application>Build and Deploy Application</h2><p>Let&rsquo;s get started by building and deploying our Application, the Buttercup Instrument Shop. Run the commands below to begin and start reading ahead as your traces are coming up !</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> javashop-otel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><h2 id=users-and-workflows>Users and Workflows</h2><p>As we go through this workshop we will be switching roles from SRE to Developer. First we will start with alert responders or SREs who will identify an issue in Splunk Observability UI. Next, we will jump to a Developer Role to see how a Developer will debug and repair/fix a software problem using trace data provided by our SRE.</p><p>Of course, we are not requiring 2 people for this workshop as each participant will play both roles.</p><h2 id=today-we-will-learn>Today we will learn</h2><p>Today we will learn the type of data ( In the form of a trace ) that an SRE or alert responder would send to a developer to then repair/fix software. We will do this with both Auto-Instrumentation data and Custom attributes, via Manual Instrumentation data.</p><p>While we will be spending time Debugging code, &mldr;. Don&rsquo;t worry, &mldr;there is no programming experience necessary, as our goal here is for everyone in the audience to understand how using Custom Attributes in Splunk APM @ Full Fidelity can accelerate Mean Time to Repair Software problems for our customers.</p><p>Translated, Developers are High Cost resources, with high opportunity cost. Less time on fixing problems = more time for features.</p><h2 id=lets-define-a-few-terms-for-those-new-to-apm--software-development-or-java>Let&rsquo;s define a few terms for those new to APM / Software Development or Java</h2><ol><li>What&rsquo;s a Function in Java ?
A Function in most languages including Java, is a logical chunk of code when executed that solves a repeatable task. This is basically what our customers&rsquo; Dev teams spend their time building and where software issues will most commonly be.</li><li>What&rsquo;s a Method in Java ?
See What&rsquo;s a function -> Function and method are synonymous.</li><li>What&rsquo;s an Exception in Java ?
An Exceptional error condition that indicates abnormal or unhandled condition, that interrupts program execution abnormally.</li></ol><h2 id=view-service-map>View Service Map</h2><p>Please note it may take 3-4 minutes for traces to show up and you will see full map &ldquo;form&rdquo; as traces are coming in, so you may have to refresh the page a few times each time we Build and Deploy.</p><p>It is recommended to use a -5m look back during this lab. Start there, use 15 if you feel you have to.</p><p><a href=#image-9efa45731c50fe7cf3103948ba901641 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/218923108-6c6a7efb-588e-4f7b-b788-768037eae4bb.png alt="Service Map" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-9efa45731c50fe7cf3103948ba901641><img src=https://user-images.githubusercontent.com/32849847/218923108-6c6a7efb-588e-4f7b-b788-768037eae4bb.png alt="Service Map" class=lightbox-image loading=lazy></a></p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> NOTE</div><div class=box-content><p>Typically, to identify root cause and route an issue, an SRE or alert responder would check metrics and logs to determine if it is a software or hardware related issue, and thus route to the correct party. In this exercise we are ONLY handling software issues, so we are skipping the metrics and logs parts of normal triage.</p></div></div><p>If your instrumentation was successful, the service-map will show latency from the shop service to the products service.</p><p><a href=#image-188c4121aa4439b9883b64734dac0040 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/206541846-7f0e6462-7659-44bc-bc48-3621c2872fc4.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-188c4121aa4439b9883b64734dac0040><img src=https://user-images.githubusercontent.com/32849847/206541846-7f0e6462-7659-44bc-bc48-3621c2872fc4.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" class=lightbox-image loading=lazy></a></p><p>Ok let&rsquo;s triage this SOFTWARE ISSUE and skip directly to the traces.</p><ul><li>Click on shop service</li><li>Click Traces ( right side )</li><li>Sort by Duration</li></ul><p>Select the longest duration trace ( or one of the obvious much longer ones )</p><p><a href=#image-13bdf928dd0ae7e0f7b6c6f6bd7bd988 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204347798-4f232b7f-7a7a-483f-9d61-f0b535e9ecf0.png alt=LongTrace style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-13bdf928dd0ae7e0f7b6c6f6bd7bd988><img src=https://user-images.githubusercontent.com/32849847/204347798-4f232b7f-7a7a-483f-9d61-f0b535e9ecf0.png alt=LongTrace class=lightbox-image loading=lazy></a></p><p>Now we can see the long latency occurred in the products service and if we click on products: /products
we can see the offending method was products:ProductResource.getAllProducts</p><p><a href=#image-4c7a0ee266a2a1b4052a5c896c90c603 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204347855-724545bf-c3df-478a-a27d-e4f85f708e15.png alt=long-trace-detail-GetAllProducts style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-4c7a0ee266a2a1b4052a5c896c90c603><img src=https://user-images.githubusercontent.com/32849847/204347855-724545bf-c3df-478a-a27d-e4f85f708e15.png alt=long-trace-detail-GetAllProducts class=lightbox-image loading=lazy></a></p><p>Our next step here would be to send that trace to a developer by clicking download trace and
they will have to debug the function. Since we will be the developer there is no need to download the trace. Just remember that is normal workflow for alert responders to route an issue to the &ldquo;Repairers&rdquo; while providing trace data.</p><p>Before we do that please take note of the Tags available for the developer to leverage to find the root cause. We see standard out of the box Otel tags on the span, environmental information, but no indications of data specific to something inside custom code ( which is where the problem always is. )</p><h2 id=now-lets-play-the-role-of-the-developer>Now let&rsquo;s play the role of the developer</h2><p>As a developer we must debug the function products:ProductResource.getAllProducts to find the problem.</p><h2 id=debugging-101-the-line-by-line-method>Debugging 101, the Line by Line method</h2><p>Without anything to go on other than &ldquo;BAD FUNCTION&rdquo;, a Developer must then look at code visually line by line to find and fix the problem. To make this worse, Functions, call Functions and it can get very messy in bad code scenarios.</p><p>We will do the visual inspection method next.</p><p>Using Nano:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nano products/src/main/java/com/shabushabu/javashop/products/resources/ProductResource.java
</span></span></code></pre></div><p>Search in Nano
CTRL-W</p><p>Enter in: getAllProducts</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#5c35cc;font-weight:700>@GET</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Response</span> <span style=color:#000>getAllProducts</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@DefaultValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;California&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#5c35cc;font-weight:700>@QueryParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;location&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>       
</span></span><span style=display:flex><span>     <span style=color:#8f5902;font-style:italic>// STEP X: All we know right now is somewhere in this function, latency was introduced.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  
</span></span><span style=display:flex><span>     <span style=color:#000>myCoolFunction1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>     <span style=color:#000>myCoolFunction2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>     <span style=color:#000>myCoolFunction10</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>     <span style=color:#000>myCoolFunction13</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>     <span style=color:#000>myCoolFunction5</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>     <span style=color:#000>myCoolFunction6</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span></code></pre></div><p>We can see here in getAllProducts, the first call is to myCoolFunction1(), so as may have guessed our next step is to go look at myCoolFunction1()</p><p>Search in Nano
CTRL-W</p><p>Enter in: myCoolFunction1</p><p>CTRL-W</p><p>Enter in: ENTER</p><p>Keep doing that until you get to the actual function definition, it looks like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>myCoolFunction1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// Generate a FAST sleep of 0 time !
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sleepy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lookupLocation1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sleepy</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>Now, myCoolFunction1 calls lookupLocation1(location)</p><p>Search in Nano
CTRL-W</p><p>Enter in: lookupLocation1</p><p>I think you get the picture by now, you have no choice but to inspect every line of code and every function called and visually inspect them for problems. This can be a VERY long process and kills our customers Mean time to Repair. This happens quite often to our customers with our competition because they can&rsquo;t provide all the traces 100% of the time and most can&rsquo;t scale to add more data, via Custom Attributes on top of that !</p><p>Remember, without Full Fidelity, you have to either reproduce errors / latency in another environment or inspect code line by line.</p><p>So they are stuck where we are, quite often.</p><p>OK, enough fun ..let&rsquo;s make this easier for our developer&mldr; and show off some Splunk APM Scale!</p><p>OK, exit your editor:</p><p>Edit nano CTRL-X ( DO NOT SAVE IF MODIFIED )</p><h2 id=custom-attribution>Custom Attribution</h2><p>To take a deeper look at this issue and make this much easier to debug we will implement Custom Attributes via Opentelemetry Manual Instrumentation.</p><p>To speed up manual instrumentation in Java you can leverage <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotations</a>, which automatically create a span around a method without modifying the actual code inside the method. This can be very valuable if you are working with an SRE that may have limited access to source code changes.</p><p>To add even more information to help our developers find the root cause faster,
<a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotations</a> can be used to generate span tags with parameter values for the method in question. This is incredibly important to mean time to Repair, because as a Developer, if I know the parameter values of a function at the time of latency or error, I can debug this without having to reproduce an issue in another environment if I have Full Fidelity Tracing.</p><p>Splunk Full Fidelity APM allows our customers&rsquo; development teams to debug their code as it runs in production, 100% of the time . With Custom Attribution, you are providing repeatable Mean Time to Repair reduction&mldr; 100% of the time, only with Full Fidelity tracing.</p><p>To expedite manual instrumentation implementation for this exercise, we have provided a tool which will annotate the entirety of the &ldquo;shop&rdquo; and &ldquo;products&rdquo; services with OpenTelemetry standard annotations for every method call without having to write any code. This &ldquo;annotator&rdquo; tool will also tag every parameter in every function, which adds a span tag with Parameter=Value.</p><h2 id=run-manual-instrumentation-tool>Run Manual Instrumentation Tool</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> javashop-otel directory
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./AutomateManualInstrumentation.sh
</span></span></code></pre></div><h2 id=rebuild-and-deploy-application>Rebuild and Deploy Application</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Now that we have rebuilt and deployed our application, traffic is being sent once again.</p><p>Go back to the Splunk Observability UI and let&rsquo;s see if these annotations help us narrow down the root cause more quickly.</p><p>Let&rsquo;s try to find our latency root cause again, this time with every function and every parameter spanned and tagged respectively&mldr;. You will see exactly what this means and how it benefits developers in a moment&mldr;</p><p><a href=#image-4765c78b133ab076c82259f1e8a313ea class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/206541846-7f0e6462-7659-44bc-bc48-3621c2872fc4.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-4765c78b133ab076c82259f1e8a313ea><img src=https://user-images.githubusercontent.com/32849847/206541846-7f0e6462-7659-44bc-bc48-3621c2872fc4.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" class=lightbox-image loading=lazy></a></p><ul><li>Click on shop service</li><li>Click Traces ( right side )</li><li>Sort by Duration</li></ul><p>Select the longest duration trace ( or one of the obvious much longer ones )</p><p><a href=#image-5f8ba033b4c266b0c0688aa1928fe745 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/213582624-66466a19-00fa-4dda-acd0-f6970d594ba1.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-5f8ba033b4c266b0c0688aa1928fe745><img src=https://user-images.githubusercontent.com/32849847/213582624-66466a19-00fa-4dda-acd0-f6970d594ba1.png alt=image class=lightbox-image loading=lazy></a></p><p>We can see that the actual function call that has the latency was not ProductResource.getAllProducts but the function call &ldquo;ProductResource.myCoolFunction234234234&rdquo; !</p><p>Since we now have the parameter tagged as part of our span metadata the actual root cause is seemingly related to the &ldquo;location&rdquo; Colorado ! And it appears the one custom attribute that was tagged for the function &ldquo;ProductResource.myCoolFunction234234234&rdquo; was &ldquo;myInt&rdquo; with a value of 999. With this information a Developer can debug very quickly.</p><p>Consider the case of debugging code which each of you have just experienced. Imagine that you may have not written the code yourself and the code is a mess, which I can tell you from a former developer, everyone else&rsquo;s code sucks&mldr;. So without Parameter Values at the time of the issue .. You would have no choice but to go line &mldr;. by line &mldr;.. by line&mldr;.. which I am sorry I forced you to do earlier&mldr; this can take a very long time.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> NOTE</div><div class=box-content><p>We added additional span information, which we call &ldquo;Custom Attributes&rdquo; here at Splunk, in this case our &ldquo;Custom Attributes&rdquo; are &ldquo;Parameter Values at Time of Latency&rdquo;.</p></div></div><p>In our example the &ldquo;Location&rdquo; tag was created due our handy Annotator, that did the <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotations</a> for us.</p><p>Using nano:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nano products/src/main/java/com/shabushabu/javashop/products/resources/ProductResource.java
</span></span></code></pre></div><p>Search in Nano
CTRL-W</p><p>Enter in: 999</p><p>We can see here, someone wrote some very bad code in the form of a long Sleep !</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>999</span><span style=color:#ce5c00;font-weight:700>==</span><span style=color:#000>myInt</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>sleepy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5000</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#0000cf;font-weight:700>3000</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>3000</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><h2 id=how-did-we-get-here--how-did-the-999-end-up-in-the-trace-as-a-custom-attribute->How did we get here ? How did the 999 end up in the trace as a Custom Attribute ?</h2><p>Take a look at the function signature</p><p>private void myCoolFunction234234234(@SpanAttribute(&ldquo;myInt&rdquo;) int myInt)</p><p>@SpanAttribute(&ldquo;myint&rdquo;) is an Opentelemetry Java Annotation that was added by our Java Otel Annotator tool.</p><p>Let&rsquo;s fix our code.</p><p>Change this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>myCoolFunction234234234</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@SpanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;myInt&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>myInt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Generate a FAST sleep of 0 time !
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Random</span> <span style=color:#000>sleepy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Random</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>999</span><span style=color:#ce5c00;font-weight:700>==</span><span style=color:#000>myInt</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>sleepy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5000</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#0000cf;font-weight:700>3000</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>3000</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span></code></pre></div><p>To this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>myCoolFunction234234234</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@SpanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;myInt&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>myInt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Generate a FAST sleep of 0 time !
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Random</span> <span style=color:#000>sleepy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Random</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// if (999==myInt)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  Thread.sleep(
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  sleepy.nextInt(5000 - 3000)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  + 3000);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span></code></pre></div><p>Using nano</p><p>place comments before every line in myCoolFunction234234234</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// if (999==myInt)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  Thread.sleep(
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  sleepy.nextInt(5000 - 3000)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  + 3000);
</span></span></span></code></pre></div><p>Write out changes in nano</p><p>CTRL-O</p><p>CTRL-X to exit.</p><p>Make sure you saved your changes to: products/src/main/java/com/shabushabu/javashop/products/resources/ProductResource.java</p><h2 id=lets-go-see-if-our-manual-instrumentation-uncovered-any-other-issues-we-did-not-see-before>Let&rsquo;s go see if our manual instrumentation uncovered any other issues we did not see before</h2><p>So you may be asking yourself, &ldquo;How does manual instrumentation alone show us &ldquo;more problems&rdquo; than before latency is latency is it ?</p><p>The answer is, with auto-instrumentation you are in most situations NOT covering functions our customers&rsquo; development teams wrote, which is of course the bulk of what developers do, they write functions&mldr;. and of course this is where the bulk of software problems occur.</p><p>You may have noticed a new exception in our trace that was not present with Auto-Instrumentation during our latency fix use-case. Since we skipped over this, let&rsquo;s walk you through it.</p><p>Return to the service map</p><ul><li>Click on shop service</li><li>Click Traces ( right side )</li><li>Select &ldquo;Errors Only&rdquo;</li></ul><p><a href=#image-2207a20ca9a778cab64b0c8f6c31d6d4 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204348492-84a4ad45-e11c-4e75-a6a9-d6e52e0eb13e.png alt="Screen Shot 2022-11-28 at 7 36 50 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-2207a20ca9a778cab64b0c8f6c31d6d4><img src=https://user-images.githubusercontent.com/32849847/204348492-84a4ad45-e11c-4e75-a6a9-d6e52e0eb13e.png alt="Screen Shot 2022-11-28 at 7 36 50 AM" class=lightbox-image loading=lazy></a></p><p>Note: we haven&rsquo;t changed the code at all by adding annotations.</p><p>Click on a trace with an error present</p><p><a href=#image-1aba96dbd73070fe0643952f4a24254f class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204348687-12241153-b297-4bd7-9ea8-4b410369e82c.png alt="Screen Shot 2022-11-28 at 7 38 33 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-1aba96dbd73070fe0643952f4a24254f><img src=https://user-images.githubusercontent.com/32849847/204348687-12241153-b297-4bd7-9ea8-4b410369e82c.png alt="Screen Shot 2022-11-28 at 7 38 33 AM" class=lightbox-image loading=lazy></a></p><p>We can see our Exception is InvalidLocaleException !</p><p>The real problem must be related to the new data associated with SRI LANKA as the Exception says &ldquo;Non English Characters found in Instrument Data.</p><p>This exception had not surfaced in previous traces based on ONLY Auto-Instrumentation because the method where it was thrown was NOT covered with Auto-Instrumentation.</p><p>Once we completed the Manual Instrumentation via the Otel Annotator, this method was instrumented and we can now see we had a buried Exception being thrown.</p><h2 id=lets-play-developer-once-again-and-fix-our-issue>Let&rsquo;s play Developer once again and fix our issue</h2><p>We already know exactly what file to look in and what method to look at as it is called out in the trace.</p><p><a href=#image-b0efb72f63bd4d261285cecf211c874a class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349038-3b43a5ba-18e3-4d58-8985-29ee1f7da40a.png alt="Screen Shot 2022-11-28 at 7 43 58 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-b0efb72f63bd4d261285cecf211c874a><img src=https://user-images.githubusercontent.com/32849847/204349038-3b43a5ba-18e3-4d58-8985-29ee1f7da40a.png alt="Screen Shot 2022-11-28 at 7 43 58 AM" class=lightbox-image loading=lazy></a></p><p>Edit the file</p><p>Using nano</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nano shop/src/main/java/com/shabushabu/javashop/shop/model/Instrument.java
</span></span></code></pre></div><p>Search in Nano
CTRL-W</p><p>Enter in: buildForLocale</p><p>Look just above the buildForLocale function, notice the Annotation @WithSpan? @WithSpan is an <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotation</a> for Java that automatically generates a span around the function that follows.</p><p><a href=#image-6bb795abf29b9bece3c8d321547cf273 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349143-1e35b6e4-4059-4c56-8718-76c14d41727c.png alt="Screen Shot 2022-11-28 at 7 45 13 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-6bb795abf29b9bece3c8d321547cf273><img src=https://user-images.githubusercontent.com/32849847/204349143-1e35b6e4-4059-4c56-8718-76c14d41727c.png alt="Screen Shot 2022-11-28 at 7 45 13 AM" class=lightbox-image loading=lazy></a></p><p>Now let&rsquo;s fix this code. We are going to simply comment this out for now and see if it fixes our latency issue.</p><p>Using nano</p><p>Place comments in front of the entire if statement as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isEnglish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>title</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InvalidLocaleException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Non English Characters found in Instrument Data&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Characters OK &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>To this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//if (!isEnglish(title)) {
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  throw new InvalidLocaleException(&#34;Non English Characters found in Instrument Data&#34;);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// } else {
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  System.out.println(&#34;Characters OK &#34;);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//}
</span></span></span></code></pre></div><p>Save Changes in nano</p><p>CTRL-O</p><p>Exit nano</p><p>CTRL-X</p><p>Make sure you saved your changes to shop/src/main/java/com/shabushabu/javashop/shop/model/Instrument.java</p><h2 id=rebuild-and-deploy-application-1>Rebuild and Deploy Application</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>We are waiting a few minutes&mldr;</p><p>Return to the service map</p><p>If you do NOT see RED in your service map, you have completed the Latency Repair for the Colorado Location !</p><p>Now let&rsquo;s check for our exception in the traces.</p><ul><li>Click on shop service</li><li>Click Traces ( right side )</li><li>Select &ldquo;Errors Only&rdquo;</li></ul><p>If you do not have red in your service map and you do not see Errors in traces, you have successfully completed our Inventory application review for Sri Lanka and Colorado locations!!</p><h2 id=we-are-nearly-done-one-more-location-to-go-chicago>We are nearly done, one more location to go&mldr; Chicago</h2><p>Last but not least, let&rsquo;s ensure Chicago was on-boarded correctly. However, since we have been having so many issues related to &ldquo;location&rdquo; and we have added that custom attribute via Opentelemetry Manual Instrumentation, let&rsquo;s go to the Splunk Observability UI and look at an APM metric set around that tag that I created for us.</p><p><a href=#image-91ac86dc3ba987e2289bd078537f5c26 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/213540265-5b0567ab-c9f3-412f-bec0-07277c7e8650.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-91ac86dc3ba987e2289bd078537f5c26><img src=https://user-images.githubusercontent.com/32849847/213540265-5b0567ab-c9f3-412f-bec0-07277c7e8650.png alt=image class=lightbox-image loading=lazy></a></p><p>Open a browser and navigate to <a href=http://localhost:8010 target=_blank>http://localhost:8010</a></p><p>Select a few locations and hit the login button, remember to select the Chicago Location and Login</p><p><a href=#image-ebf2d07213826fba55bdfb4ee174dfa5 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/213541843-30266285-787f-493b-bc90-ffb4ac6e4c77.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-ebf2d07213826fba55bdfb4ee174dfa5><img src=https://user-images.githubusercontent.com/32849847/213541843-30266285-787f-493b-bc90-ffb4ac6e4c77.png alt=image class=lightbox-image loading=lazy></a></p><p>Uhh ohh ! We received a 500 error, something is wrong there as well.</p><p><a href=#image-0691e2e742860edaeb1460776de38866 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349595-fca270ad-379e-48c5-b2e1-7f222af82c55.png alt="Screen Shot 2022-11-28 at 8 11 47 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-0691e2e742860edaeb1460776de38866><img src=https://user-images.githubusercontent.com/32849847/204349595-fca270ad-379e-48c5-b2e1-7f222af82c55.png alt="Screen Shot 2022-11-28 at 8 11 47 AM" class=lightbox-image loading=lazy></a></p><p>Return to the Splunk Observability UI and lets look once again at our Service Map, select the Instruments Service and click the breakdowns on the right and select &ldquo;location&rdquo;</p><p><a href=#image-c717f8e53084b2b4116fdc50f64f238d class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/214941419-2eaae297-e246-460b-a913-28c2a28fcd6a.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-c717f8e53084b2b4116fdc50f64f238d><img src=https://user-images.githubusercontent.com/32849847/214941419-2eaae297-e246-460b-a913-28c2a28fcd6a.png alt=image class=lightbox-image loading=lazy></a></p><p>We see there was an un-handled exception thrown in Instruments service and some latency from our database that is related to the Chicago location !</p><ul><li>Click on Traces on the right</li><li>Select &ldquo;Errors Only&rdquo;</li></ul><p><a href=#image-5d8c03b687557cbf832a3d201f085748 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349696-dc19d62f-ed82-4533-ad27-138237821b8e.png alt="Screen Shot 2022-11-28 at 8 14 50 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-5d8c03b687557cbf832a3d201f085748><img src=https://user-images.githubusercontent.com/32849847/204349696-dc19d62f-ed82-4533-ad27-138237821b8e.png alt="Screen Shot 2022-11-28 at 8 14 50 AM" class=lightbox-image loading=lazy></a></p><p>We can see the exception was thrown by Hibernate, however it was thrown in our method &ldquo;instruments: InstrumentRepository.findInstruments&rdquo;</p><p><a href=#image-93bcfd4dd82d690d6118a7e60e1c1dee class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204351905-03fe632b-b21c-4e8d-8044-dc582fed2253.png alt="Screen Shot 2022-11-28 at 8 14 37 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-93bcfd4dd82d690d6118a7e60e1c1dee><img src=https://user-images.githubusercontent.com/32849847/204351905-03fe632b-b21c-4e8d-8044-dc582fed2253.png alt="Screen Shot 2022-11-28 at 8 14 37 AM" class=lightbox-image loading=lazy></a></p><h2 id=lets-play-developer-again>Let&rsquo;s play developer again</h2><p>Edit the file &ldquo;instruments: InstrumentRepository.findInstruments&rdquo;</p><p>Using nano</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nano instruments/src/main/java/com/shabushabu/javashop/instruments/repositories/FindInstrumentRepositoryImpl.java
</span></span></code></pre></div><p><a href=#image-46231b1249b37aff3a75c115454601d3 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349802-06135d9d-d70b-4cf1-aaea-3ba737e5c2b9.png alt="Screen Shot 2022-11-28 at 8 20 24 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-46231b1249b37aff3a75c115454601d3><img src=https://user-images.githubusercontent.com/32849847/204349802-06135d9d-d70b-4cf1-aaea-3ba737e5c2b9.png alt="Screen Shot 2022-11-28 at 8 20 24 AM" class=lightbox-image loading=lazy></a></p><p>We can see the developer accidently added the Instruments database with the Chicago Instruments database !</p><p>Let&rsquo;s change the query and fix this, remove &ldquo;instruments_for_sale&rdquo; from our Query</p><p>Change this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>findInstruments</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;findInstruments Called (All)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#000>Object</span> <span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entityManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createNativeQuery</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#4e9a06>&#34;SELECT * FROM instruments_for_sale, instruments_for_sale_chicago&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getResultList</span><span style=color:#ce5c00;font-weight:700>();</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>To this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// public Object findInstruments() {
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//   LOGGER.info(&#34;findInstruments Called (All)&#34;);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//   Object obj = entityManager.createNativeQuery( &#34;SELECT * FROM instruments_for_sale_chicago&#34;).getResultList(); 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  return obj;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//}
</span></span></span></code></pre></div><p>Save Changes in nano</p><p>CTRL-O</p><p>Exit nano</p><p>CTRL-X</p><h3 id=build-and-deploy-application-1>Build and Deploy Application</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> javashop-otel directory
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Now let&rsquo;s test the Chicago location once again</p><ul><li>Open a browser and navigate to <a href=http://localhost:8010 target=_blank>http://localhost:8010</a></li><li>Select the Chicago Location and Login</li></ul><p>We now see the 500 error is gone! Let&rsquo;s confirm a clean Service Map</p><p><a href=#image-04c84bfb878f18958236815ae0aad590 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204350088-fca43e3c-42ea-4933-8a61-01eb2083fd23.png alt="Screen Shot 2022-11-28 at 8 35 11 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-04c84bfb878f18958236815ae0aad590><img src=https://user-images.githubusercontent.com/32849847/204350088-fca43e3c-42ea-4933-8a61-01eb2083fd23.png alt="Screen Shot 2022-11-28 at 8 35 11 AM" class=lightbox-image loading=lazy></a></p><p>If you see a clean service map, free of errors and Latency you have successfully completed the Java Instrumentation Workshop!</p><p><strong>Have a lovely day.</strong></p><footer class=footline></footer></article><article class=default><h1 id=build-a-distributed-trace-in-lambda>Build a Distributed Trace in Lambda</h1><p>This lab will make a tracing superhero out of you!</p><p>In this lab you will learn how a distributed trace is constructed for a small serverless application that runs on <a href=https://aws.amazon.com/lambda/ target=_blank>AWS Lambda</a>, producing and consuming your message via <a href=https://aws.amazon.com/kinesis/ target=_blank>AWS Kinesis</a>.</p><p><a href=#image-f9a16448ea6434476772932e959285bc class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219358330-50022c0d-7882-47a3-a047-c4edda81de0d.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-f9a16448ea6434476772932e959285bc><img src=https://user-images.githubusercontent.com/5187861/219358330-50022c0d-7882-47a3-a047-c4edda81de0d.png alt=image class=lightbox-image loading=lazy></a></p><h2 id=pre-requisites>Pre-Requisites</h2><p>You should already have the lab content available on your EC2 lab host.</p><p>Ensure that this lab&rsquo;s required folder <code>o11y-lambda-lab</code> is on your home directory:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button>
<button data-tab-item=Output class=tab-nav-button onclick='switchTab("default","Output")'>
<span>Output</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~ <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> ls
</span></span></code></pre></div></div><div data-tab-item=Output class=tab-content-text><p>o11y-lambda-lab</p></div></div></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>If you don&rsquo;t see it, fetch the lab contents by running the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/kdroukman/o11y-lambda-lab.git
</span></span></code></pre></div></div></div><h3 id=1-set-environment-variables>1. Set Environment Variables</h3><p>In your Splunk Observability Cloud Organisation (Org) obtain your Access Token and Realm Values.</p><p>Please reset your environment variables from the earlier lab. Take care that for this lab we may be using different names - make sure to match the Environment Variable names bellow.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Export Environment Variables" class="tab-nav-button active" onclick='switchTab("default","Export Environment Variables")'>
<span>Export Environment Variables</span></button></div><div class=tab-content><div data-tab-item="Export Environment Variables" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ACCESS_TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span>CHANGE_ME <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span><span style=color:#204a87>export</span> <span style=color:#000>REALM</span><span style=color:#ce5c00;font-weight:700>=</span>CHANGE_ME <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span><span style=color:#204a87>export</span> <span style=color:#000>PREFIX</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>hostname<span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div></div></div></div><h3 id=2-update-auto-instrumentation-serverless-template>2. Update Auto-instrumentation serverless template</h3><p>Update your auto-instrumentation Serverless template to include new values from the Enviornment variables.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Substitute Environment Variables" class="tab-nav-button active" onclick='switchTab("default","Substitute Environment Variables")'>
<span>Substitute Environment Variables</span></button></div><div class=tab-content><div data-tab-item="Substitute Environment Variables" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/o11y-lambda-lab/auto/serverless_unset.yml <span style=color:#000;font-weight:700>|</span> envsubst &gt; ~/o11y-lambda-lab/auto/serverless.yml
</span></span></code></pre></div></div></div></div><p>Examine the output of the updated serverless.yml contents (you may need to scroll up to the relevant section).</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Check file contents" class="tab-nav-button active" onclick='switchTab("default","Check file contents")'>
<span>Check file contents</span></button>
<button data-tab-item="Expected Content" class=tab-nav-button onclick='switchTab("default","Expected Content")'>
<span>Expected Content</span></button></div><div class=tab-content><div data-tab-item="Check file contents" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/o11y-lambda-lab/auto/serverless.yml
</span></span></code></pre></div></div><div data-tab-item="Expected Content" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># USER SET VALUES =====================              
</span></span><span style=display:flex><span>custom: 
</span></span><span style=display:flex><span>  accessToken: &lt;updated to your Access Token&gt;
</span></span><span style=display:flex><span>  realm: &lt;updated to your Realm&gt;
</span></span><span style=display:flex><span>  prefix: &lt;updated to your Hostname&gt;
</span></span><span style=display:flex><span>#====================================== 
</span></span></code></pre></div></div></div></div><h3 id=3-update-manual-instrumentation-template>3. Update Manual instrumentation template</h3><p>Update your manual instrumentation Serverless template to include new values from the Enviornment variables.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Substitute Environment Variables" class="tab-nav-button active" onclick='switchTab("default","Substitute Environment Variables")'>
<span>Substitute Environment Variables</span></button></div><div class=tab-content><div data-tab-item="Substitute Environment Variables" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/o11y-lambda-lab/manual/serverless_unset.yml <span style=color:#000;font-weight:700>|</span> envsubst &gt; ~/o11y-lambda-lab/manual/serverless.yml
</span></span></code></pre></div></div></div></div><p>Examine the output of the updated serverless.yml contents (you may need to scroll up to the relevant section).</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Check file contents" class="tab-nav-button active" onclick='switchTab("default","Check file contents")'>
<span>Check file contents</span></button>
<button data-tab-item="Expected Content" class=tab-nav-button onclick='switchTab("default","Expected Content")'>
<span>Expected Content</span></button></div><div class=tab-content><div data-tab-item="Check file contents" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/o11y-lambda-lab/manual/serverless.yml
</span></span></code></pre></div></div><div data-tab-item="Expected Content" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># USER SET VALUES =====================              
</span></span><span style=display:flex><span>custom: 
</span></span><span style=display:flex><span>  accessToken: &lt;updated to your Access Token&gt;
</span></span><span style=display:flex><span>  realm: &lt;updated to your Realm&gt;
</span></span><span style=display:flex><span>  prefix: &lt;updated to your Hostname&gt;
</span></span><span style=display:flex><span>#====================================== 
</span></span></code></pre></div></div></div></div><h3 id=4-set-your-aws-credentials>4. Set your AWS Credentials</h3><p>You will be provided with AWS Access Key ID and AWS Secret Access Key values - substitue these values in place of <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_ACCESS_KEY_SECRET</code> in the bellow command:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Set AWS Credentials" class="tab-nav-button active" onclick='switchTab("default","Set AWS Credentials")'>
<span>Set AWS Credentials</span></button></div><div class=tab-content><div data-tab-item="Set AWS Credentials" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls config credentials --provider aws --key AWS_ACCCESS_KEY_ID --secret AWS_ACCESS_KEY_SECRET
</span></span></code></pre></div></div></div></div><p>This command will create a file <code>~/.aws/credentials</code> with your AWS Credentails populated.</p><p>Note that we are using <code>sls</code> here, which is a <a href=https://www.serverless.com/ target=_blank>Serverless</a> framework for developing and deploying AWS Lambda functions. We will be using this command throughout the lab.</p><p>Now you are set up and ready go!</p><h2 id=auto-instrumentation>Auto-Instrumentation</h2><p>Navigate to the <code>auto</code> directory that contains auto-instrumentation code.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/o11y-lambda-lab/auto
</span></span></code></pre></div></div></div></div><p>Inspect the contents of the files in this directory.
Take a look at the <code>serverless.yml</code> template.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat serverless.yml
</span></span></code></pre></div></div></div></div><ol><li>Can you identify which AWS entities are being created by this template?</li><li>Can you identify where OpenTelemetry instrumentation is being set up?</li><li>Can you determine which instrumentation information is being provided by the Environment Variables?</li></ol><p>You should see the Splunk OpenTelemetry Lambda layer being added to each fuction.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>layers:
</span></span><span style=display:flex><span>      - arn:aws:lambda:us-east-1:254067382080:layer:splunk-apm:70
</span></span></code></pre></div><p>You can see the relevant layer ARNs (Amazon Resource Name) and latest versions for each AWS region here: <a href=https://github.com/signalfx/lambda-layer-versions/blob/main/splunk-apm/splunk-apm.md target=_blank>https://github.com/signalfx/lambda-layer-versions/blob/main/splunk-apm/splunk-apm.md</a></p><p>You should also see a section where the Environment variables that are being set.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span> environment:
</span></span><span style=display:flex><span>      AWS_LAMBDA_EXEC_WRAPPER: /opt/nodejs-otel-handler
</span></span><span style=display:flex><span>      OTEL_RESOURCE_ATTRIBUTES: deployment.environment=${self:custom.prefix}-apm-lambda
</span></span><span style=display:flex><span>      OTEL_SERVICE_NAME: consumer-lambda
</span></span><span style=display:flex><span>      SPLUNK_ACCESS_TOKEN: ${self:custom.accessToken}
</span></span><span style=display:flex><span>      SPLUNK_REALM: ${self:custom.realm}
</span></span></code></pre></div><p>Using the environment variables we are configuring and enriching our auto-instrumentation.</p><p>Here we provide minimum information, such as NodeJS wrapper location in the Splunk APM Layer, environment name, service name, and our Splunk Org credentials. We are sending trace data directly to Splunk Observability Cloud. You could alternatively export traces to an OpenTelemetry Collector set up in <a href=https://opentelemetry.io/docs/collector/deployment/#gateway target=_blank>Gateway</a> mode.</p><p>Take a look at the function code.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat handler.js
</span></span></code></pre></div></div></div></div><ol><li>Can you identify the code for <strong>producer</strong> function?</li><li>Can you identify the code for <strong>consumer</strong> function?</li></ol><p>Notice there is no mention of Splunk or OpenTelemetry in the code. We are adding the instrumentation using the Lambda layer and Environment Variables only.</p><h3 id=deploy-your-lambdas>Deploy your Lambdas</h3><p>Run the following command to deploy your Lambda Functions:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Deploy Command" class="tab-nav-button active" onclick='switchTab("default","Deploy Command")'>
<span>Deploy Command</span></button>
<button data-tab-item="Expected Output" class=tab-nav-button onclick='switchTab("default","Expected Output")'>
<span>Expected Output</span></button></div><div class=tab-content><div data-tab-item="Deploy Command" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls deploy
</span></span></code></pre></div></div><div data-tab-item="Expected Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Deploying hostname-lambda-lab to stage dev (us-east-1)
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>endpoint: POST - https://randomstring.execute-api.us-east-1.amazonaws.com/dev/producer
</span></span><span style=display:flex><span>functions:
</span></span><span style=display:flex><span>  producer: hostname-lambda-lab-dev-producer (1.6 kB)
</span></span><span style=display:flex><span>  consumer: hostname-lambda-lab-dev-consumer (1.6 kB)
</span></span></code></pre></div></div></div></div><p>This command will follow the instructions in your <code>serverless.yml</code> template to create your Lambda functions and your Kinesis stream.
Note it may take a <em>1-2 minutes</em> to execute.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p><code>serverless.yml</code> is in fact a CloudFormation template. CloudFormation is an infrastructure as code service from AWS. You can read more about it here - <a href=https://aws.amazon.com/cloudformation/ target=_blank>https://aws.amazon.com/cloudformation/</a></p></div></div><p>Check the details of your serverless functions:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls info
</span></span></code></pre></div></div></div></div><p>Take note of your endpoint value:</p><p><a href=#image-09e46c82cff2a49c58b33fe499577ace class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219366650-2babbe19-8253-43a0-8521-f47c1dda7200.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-09e46c82cff2a49c58b33fe499577ace><img src=https://user-images.githubusercontent.com/5187861/219366650-2babbe19-8253-43a0-8521-f47c1dda7200.png alt=image class=lightbox-image loading=lazy></a></p><h3 id=send-some-traffic>Send some Traffic</h3><p>Use the <code>curl</code> command to send a payload to your <strong>producer</strong> function.
Note the command option <code>-d</code> is followed by your message payload.</p><p>Try changing the value of <code>name</code> to your name and telling the Lambda function about your <code>superpower</code>.
Replace <code>YOUR_ENDPOINT</code> with the endpoint from your previous step.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -d <span style=color:#4e9a06>&#39;{ &#34;name&#34;: &#34;CHANGE_ME&#34;, &#34;superpower&#34;: &#34;CHANGE_ME&#34; }&#39;</span> YOUR_ENDPOINT
</span></span></code></pre></div></div></div></div><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>curl -d &#39;{ &#34;name&#34;: &#34;Kate&#34;, &#34;superpower&#34;: &#34;Distributed Tracing&#34; }&#39; https://xvq043lj45.execute-api.us-east-1.amazonaws.com/dev/producer
</span></span></code></pre></div><p>You should see the following output if your message is successful:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>&#34;message&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;Message placed in the Event Stream: hostname-eventSteam&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>If unsuccessful, you will see:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>&#34;message&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Internal server error&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>If this occurs, ask one of the lab facilitators for assistance.</p><p>If you see a success message, generate more load: <em>re-send that messate <strong>5+ times</strong></em>.
You should keep seeing a success message after each send.</p><p>Check the lambda logs output.</p><h4 id=producer-function-logs>Producer function logs</h4><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Producer Function Logs" class="tab-nav-button active" onclick='switchTab("default","Producer Function Logs")'>
<span>Producer Function Logs</span></button></div><div class=tab-content><div data-tab-item="Producer Function Logs" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls logs -f producer
</span></span></code></pre></div></div></div></div><h4 id=consumer-function-logs>Consumer function logs</h4><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Consumer Function Logs" class="tab-nav-button active" onclick='switchTab("default","Consumer Function Logs")'>
<span>Consumer Function Logs</span></button></div><div class=tab-content><div data-tab-item="Consumer Function Logs" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls logs -f consumer
</span></span></code></pre></div></div></div></div><p>Examine the logs carefully. Do you see OpenTelemetry being loaded? Look out for lines with <code>splunk-extension-wrapper</code>.</p><h3 id=find-your-lambda-data-in-splunk-apm>Find your Lambda data in Splunk APM</h3><p>Now it&rsquo;s time to check how your Lambda traffic has been captured in Splunk APM.</p><p>Navigate to your <a href=https://app.us1.signalfx.com target=_blank>Splunk Observability Cloud</a></p><p>Select APM from the Main Menu and then select your APM Environment. Your APM environment should be in the format <code>$(hostname)-apm-lambda</code> where the hostname value is a four letter name of your lab host. (Check it by looking at your command prompt, or by running <code>echo $(hostname)</code>)</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>It may take a few minutes for you traces to appear in Splunk APM. Try hitting refresh on your browser until you find your environement name in the list of Envrionments</p></div></div><p><a href=#image-c586b75487d988dd9a4fde32c5b6c505 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219368081-20a1522e-a908-40d8-b635-942bffdbb0bd.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-c586b75487d988dd9a4fde32c5b6c505><img src=https://user-images.githubusercontent.com/5187861/219368081-20a1522e-a908-40d8-b635-942bffdbb0bd.png alt=image class=lightbox-image loading=lazy></a></p><p>Go to Explore the Service Map to see the Dependencies between your Lambda Functions.</p><p><a href=#image-db6d4236e7224ccde5aa5201a091336b class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219001784-a25e7c9f-981d-49b9-b6df-f39d2bff0975.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-db6d4236e7224ccde5aa5201a091336b><img src=https://user-images.githubusercontent.com/5187861/219001784-a25e7c9f-981d-49b9-b6df-f39d2bff0975.png alt=image class=lightbox-image loading=lazy></a></p><p>You should be able to see the <code>producer-lambda</code> and the call it is making to <code>Kinesis</code> service. What about your <code>consumer-lambda</code>?
<a href=#image-522793feea4167e6f882e606b1a737a0 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219368350-5bebb65b-d658-42be-9895-5d39a8d60a2d.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-522793feea4167e6f882e606b1a737a0><img src=https://user-images.githubusercontent.com/5187861/219368350-5bebb65b-d658-42be-9895-5d39a8d60a2d.png alt=image class=lightbox-image loading=lazy></a></p><p>Click into <em>Traces</em> and examine some traces that container <strong>procuder</strong> function calls and traces with <strong>consumer</strong> function calls.
<a href=#image-e9738224e412a27eafed7141620d31c6 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219002535-d11afd2f-9134-4e1b-87fb-f3af47969372.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-e9738224e412a27eafed7141620d31c6><img src=https://user-images.githubusercontent.com/5187861/219002535-d11afd2f-9134-4e1b-87fb-f3af47969372.png alt=image class=lightbox-image loading=lazy></a></p><p>We can see the <code>producer-lambda</code> putting a Record on the Kinesis stream. But the action of <code>consumer-function</code> is disconnected!</p><p>This is because the <strong>Trace Context</strong> is not being propagated.</p><p>This is not something that is supported automatically Out-of-the-Box by Kinesis service at the time of this lab. Our Distributed Trace stops at <em>Kinesis</em> inferred service, and we can&rsquo;t see the propagation any further.</p><p>Not yet&mldr;</p><p>Let&rsquo;s see how we work around this in the next section of this lab.</p><h2 id=manual-instrumentation>Manual Instrumentation</h2><p>Navigate to the <code>manual</code> directory that contains manually instrumentated code.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/o11y-lambda-lab/manual
</span></span></code></pre></div></div></div></div><p>Inspect the contents of the files in this directory.
Take a look at the <code>serverless.yml</code> template.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat serverless.yml
</span></span></code></pre></div></div></div></div><p>Do you see any difference from the same file in your <code>auto</code> directory?</p><p>You can try to compare them with a <code>diff</code> command:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Diff Command" class="tab-nav-button active" onclick='switchTab("default","Diff Command")'>
<span>Diff Command</span></button>
<button data-tab-item="Expected Output" class=tab-nav-button onclick='switchTab("default","Expected Output")'>
<span>Expected Output</span></button></div><div class=tab-content><div data-tab-item="Diff Command" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>diff ~/o11y-lambda-lab/auto/serverless.yml ~/o11y-lambda-lab/manual/serverless.yml 
</span></span></code></pre></div></div><div data-tab-item="Expected Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>19c19
</span></span><span style=display:flex><span>&lt; #======================================    
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>&gt; #======================================   
</span></span></code></pre></div></div></div></div><p>There is no difference! <em>(Well, there shouldn&rsquo;t be. Ask your lab facilitator to assist you if there is)</em></p><p>Now compare <code>handler.js</code> it with the same file in <code>auto</code> directory using the <code>diff</code> command:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Diff Command" class="tab-nav-button active" onclick='switchTab("default","Diff Command")'>
<span>Diff Command</span></button></div><div class=tab-content><div data-tab-item="Diff Command" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>diff ~/o11y-lambda-lab/auto/handler.js ~/o11y-lambda-lab/manual/handler.js 
</span></span></code></pre></div></div></div></div><p>Look at all these differences!</p><p><em>You may wish to view the entire file with <code>cat handler.js</code> command and examine its content.</em></p><p>Notice how we are now importing some OpenTelemetry libraries directly into our function to handle some of the manual instrumenation tasks we require.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>const otelapi  = require(&#39;@opentelemetry/api&#39;);
</span></span><span style=display:flex><span>const otelcore = require(&#39;@opentelemetry/core&#39;);
</span></span></code></pre></div><p>We are using <a href=https://www.npmjs.com/package/@opentelemetry/api target=_blank>https://www.npmjs.com/package/@opentelemetry/api</a> to manipulate the tracing logic in our functions.
We are using <a href=https://www.npmjs.com/package/@opentelemetry/core target=_blank>https://www.npmjs.com/package/@opentelemetry/core</a> to access the <strong>Propagator</strong> objects that we will use to manually propagate our context with.</p><h3 id=inject-trace-context-in-producer-function>Inject Trace Context in Producer Function</h3><p>The bellow code executes the following steps inside the Producer function:</p><ol><li>Get the current Active Span.</li><li>Create a Propagator.</li><li>Initialize a context carrier object.</li><li>Inject the context of the active span into the carrier object.</li><li>Modify the record we are about to put on our Kinesis stream to include the carrier that will carry the active span&rsquo;s context to the consumer.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>const activeSpan = otelapi.trace.getSpan(otelapi.context.active());
</span></span><span style=display:flex><span>const propagator = new otelcore.W3CTraceContextPropagator();
</span></span><span style=display:flex><span>let carrier = {};
</span></span><span style=display:flex><span>propagator.inject(otelapi.trace.setSpanContext(otelapi.ROOT_CONTEXT, activeSpan.spanContext()),
</span></span><span style=display:flex><span>                 carrier,
</span></span><span style=display:flex><span>                otelapi.defaultTextMapSetter
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>const data = &#34;{\&#34;tracecontext\&#34;: &#34; + JSON.stringify(carrier) + &#34;, \&#34;record\&#34;:&#34; + event.body + &#34;}&#34;;
</span></span><span style=display:flex><span>console.log(`Record with Trace Context added: 
</span></span><span style=display:flex><span>             ${data}`);
</span></span></code></pre></div><h4 id=extract-trace-context-in-consumer-function>Extract Trace Context in Consumer Function</h4><p>The bellow code executes the following steps inside the Consumer function:</p><ol><li>Extract the context that we obtained from the Producer into a carrier object.</li><li>Create a Propagator.</li><li>Extract the context from the carrier object in Customer function&rsquo;s parent span context.</li><li>Start a new span with the parent span context.</li><li>Bonus: Add extra attributes to your span, including custom ones with the values from your message!</li><li>Once completed, end the span.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>const carrier = JSON.parse( message ).tracecontext;
</span></span><span style=display:flex><span>const propagator = new otelcore.W3CTraceContextPropagator();
</span></span><span style=display:flex><span>const parentContext = propagator.extract(otelapi.ROOT_CONTEXT, carrier, otelapi.defaultTextMapGetter);
</span></span><span style=display:flex><span>const tracer = otelapi.trace.getTracer(process.env.OTEL_SERVICE_NAME);
</span></span><span style=display:flex><span>const span = tracer.startSpan(&#34;Kinesis.getRecord&#34;, undefined, parentContext);
</span></span><span style=display:flex><span>                         
</span></span><span style=display:flex><span>span.setAttribute(&#34;span.kind&#34;, &#34;server&#34;);
</span></span><span style=display:flex><span>const body = JSON.parse( message ).record;
</span></span><span style=display:flex><span>if (body.name) {
</span></span><span style=display:flex><span>    span.setAttribute(&#34;custom.tag.name&#34;, body.name);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span> if (body.superpower) {
</span></span><span style=display:flex><span>    span.setAttribute(&#34;custom.tag.superpower&#34;, body.superpower);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  --- function does some work
</span></span><span style=display:flex><span> span.end();
</span></span></code></pre></div><p>Now let&rsquo;s see the difference this makes.</p><h3 id=re-deploy-your-lambdas>Re-deploy your Lambdas</h3><p>While remaining in your <code>manual</code> directory, run the following commandd to re-deploy your Lambda Functions:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Deploy Producer Code" class="tab-nav-button active" onclick='switchTab("default","Deploy Producer Code")'>
<span>Deploy Producer Code</span></button>
<button data-tab-item="Expected Output" class=tab-nav-button onclick='switchTab("default","Expected Output")'>
<span>Expected Output</span></button></div><div class=tab-content><div data-tab-item="Deploy Producer Code" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls deploy -f producer
</span></span></code></pre></div></div><div data-tab-item="Expected Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Deploying function producer to stage dev (us-east-1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>✔ Function code deployed (6s)
</span></span><span style=display:flex><span>Configuration did not change. Configuration update skipped. (6s)
</span></span></code></pre></div></div></div></div><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Deploy Consumer Code" class="tab-nav-button active" onclick='switchTab("default","Deploy Consumer Code")'>
<span>Deploy Consumer Code</span></button>
<button data-tab-item="Expected Output" class=tab-nav-button onclick='switchTab("default","Expected Output")'>
<span>Expected Output</span></button></div><div class=tab-content><div data-tab-item="Deploy Consumer Code" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls deploy -f consumer
</span></span></code></pre></div></div><div data-tab-item="Expected Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Deploying function consumer to stage dev (us-east-1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>✔ Function code deployed (6s)
</span></span><span style=display:flex><span>Configuration did not change. Configuration update skipped. (6s)
</span></span></code></pre></div></div></div></div><p>Note that this deployment now only updates the code changes within the function. Our configuration remains the same.</p><p>Check the details of your serverless functions:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls info
</span></span></code></pre></div></div></div></div><p>You endpoint value should remain the same:</p><p><a href=#image-9e5df67d060a91e14149482beefd15dc class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219371979-4e474746-2633-4824-9d7a-1b39d3d2ce3f.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-9e5df67d060a91e14149482beefd15dc><img src=https://user-images.githubusercontent.com/5187861/219371979-4e474746-2633-4824-9d7a-1b39d3d2ce3f.png alt=image class=lightbox-image loading=lazy></a></p><h3 id=send-some-traffic-again>Send some Traffic again</h3><p>Use the <code>curl</code> command to send a payload to your <strong>producer</strong> function.
Note the command option <code>-d</code> is followed by your message payload.</p><p>Try changing the value of <code>name</code> to your name and telling the Lambda function about your <code>superpower</code>.
Replace <code>YOUR_ENDPOINT</code> with the endpoint from your previous step.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -d <span style=color:#4e9a06>&#39;{ &#34;name&#34;: &#34;CHANGE_ME&#34;, &#34;superpower&#34;: &#34;CHANGE_ME&#34; }&#39;</span> YOUR_ENDPOINT
</span></span></code></pre></div></div></div></div><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>curl -d &#39;{ &#34;name&#34;: &#34;Kate&#34;, &#34;superpower&#34;: &#34;Distributed Tracing&#34; }&#39; https://xvq043lj45.execute-api.us-east-1.amazonaws.com/dev/producer
</span></span></code></pre></div><p>You should see the following output if your message is successful:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>&#34;message&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;Message placed in the Event Stream: hostname-eventSteam&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>If unsuccessful, you will see:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>&#34;message&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Internal server error&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>If this occurs, ask one of the lab facilitators for assistance.</p><p>If you see a success message, generate more load: <em>re-send that messate <strong>5+ times</strong></em>. You should keep seeing a success message after each send.</p><p>Check the lambda logs output.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Producer Function Logs" class="tab-nav-button active" onclick='switchTab("default","Producer Function Logs")'>
<span>Producer Function Logs</span></button></div><div class=tab-content><div data-tab-item="Producer Function Logs" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls logs -f producer
</span></span></code></pre></div></div></div></div><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Consumer Function Logs" class="tab-nav-button active" onclick='switchTab("default","Consumer Function Logs")'>
<span>Consumer Function Logs</span></button></div><div class=tab-content><div data-tab-item="Consumer Function Logs" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls logs -f consumer
</span></span></code></pre></div></div></div></div><p>Examine the logs carefully. Do you notice the difference?</p><p>Note that we are logging our Record together with the Trace context that we have added to it. Copy one of the underlined sub-sections of your trace parent context, and save it for later.</p><p><a href=#image-7a7d74590b34fc200aa567cef29326f3 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219372916-ed1afce5-176f-4baf-a9a3-0aae29e3f01b.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-7a7d74590b34fc200aa567cef29326f3><img src=https://user-images.githubusercontent.com/5187861/219372916-ed1afce5-176f-4baf-a9a3-0aae29e3f01b.png alt=image class=lightbox-image loading=lazy></a></p><h3 id=find-your-updated-lambda-data-in-splunk-apm>Find your updated Lambda data in Splunk APM</h3><p>Navigate back to APM in <a href=https://app.us1.signalfx.com/#/apm target=_blank>Splunk Observabilty Cloud</a></p><p>Go back to your Service Dependency map. Notice the difference?</p><p><a href=#image-07b2ec306a341482e6f27fac68628779 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219373312-0d556475-9f27-4729-af38-ac94f0773c5c.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-07b2ec306a341482e6f27fac68628779><img src=https://user-images.githubusercontent.com/5187861/219373312-0d556475-9f27-4729-af38-ac94f0773c5c.png alt=image class=lightbox-image loading=lazy></a></p><p>You should be able to see the <strong>consumer-lambda</strong> now clearly connected to the <strong>producer-lambda</strong>.</p><p>Remember the value you copied from your producer logs? You can run <code>sls logs -f consumer</code> command again on your EC2 lab host to fetch one.</p><p>Take that value, and paste it into trace search:</p><p><a href=#image-bd14cd16c2ef3dbf9a67f88c57a0d212 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219373635-cc5a5841-5afb-49f9-baea-9d4d45aabfb6.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-bd14cd16c2ef3dbf9a67f88c57a0d212><img src=https://user-images.githubusercontent.com/5187861/219373635-cc5a5841-5afb-49f9-baea-9d4d45aabfb6.png alt=image class=lightbox-image loading=lazy></a></p><p>Click on <em>Go</em> and you should be able to find the logged Trace:</p><p><a href=#image-e602b55636e4d374dd6c4ff0e089f092 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219374024-de32aa68-f34a-43eb-8f00-5cc698864b00.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-e602b55636e4d374dd6c4ff0e089f092><img src=https://user-images.githubusercontent.com/5187861/219374024-de32aa68-f34a-43eb-8f00-5cc698864b00.png alt=image class=lightbox-image loading=lazy></a></p><p>Notice that the <strong>Trace ID</strong> is something that makes up the trace <em>context</em> that we propagated.</p><p>You can read up on the two common propagation standards:</p><ol><li>W3C: <a href=https://www.w3.org/TR/trace-context/#traceparent-header target=_blank>https://www.w3.org/TR/trace-context/#traceparent-header</a></li><li>B3: <a href=https://github.com/openzipkin/b3-propagation#overall-process target=_blank>https://github.com/openzipkin/b3-propagation#overall-process</a></li></ol><p>Which one are we using? <em>It should be self-explanatory from the Propagator we are creating in the Functions</em></p><p><strong>Bonus Question:</strong> What happens if we mix and match the W3C and B3 headers?</p><p>Expand the <strong>consumer-lambda</strong> span. Can you find the attributes from your message?</p><p><a href=#image-5dfc2f1c795e42cae55db11893097363 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219374303-d143515b-d1b1-46b4-bd03-0c4653ea08c0.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-5dfc2f1c795e42cae55db11893097363><img src=https://user-images.githubusercontent.com/5187861/219374303-d143515b-d1b1-46b4-bd03-0c4653ea08c0.png alt=image class=lightbox-image loading=lazy></a></p><h2 id=before-you-go>Before you Go</h2><p>Please kindly clean up your lab using the following command:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Remove Functions" class="tab-nav-button active" onclick='switchTab("default","Remove Functions")'>
<span>Remove Functions</span></button></div><div class=tab-content><div data-tab-item="Remove Functions" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls remove
</span></span></code></pre></div></div></div></div><h2 id=conclusion>Conclusion</h2><p>Congratuations on finishing the lab. You have seen how we complement auto-instrumentation with manual steps to force <strong>Producer</strong> function&rsquo;s context to be sent to <strong>Consumer</strong> function via a Record put on a Kinesis stream. This allowed us to build the expected Distributed Trace.</p><p><a href=#image-dced8a46fc5f2cecd1737e4099c4a249 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219375907-5a5e23ce-b9bb-4939-865d-7dbbaa668c53.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-dced8a46fc5f2cecd1737e4099c4a249><img src=https://user-images.githubusercontent.com/5187861/219375907-5a5e23ce-b9bb-4939-865d-7dbbaa668c53.png alt=image class=lightbox-image loading=lazy></a></p><p>You can now built out a Trace manually by linking two different functions together. This is very powerful when your auto-instrumenation, or third-party systems, do not support context propagation out of the box.</p><footer class=footline></footer></article></section></div></main></div><script src=../../js/clipboard.min.js?1676856707 defer></script>
<script src=../../js/perfect-scrollbar.min.js?1676856707 defer></script>
<script src=../../js/theme.js?1676856707 defer></script></body></html>