<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.110.0"><meta name=generator content="Relearn 5.11.2+tip"><meta name=description content="TKO 2023 - Observability Workshops"><title>TKO Workshops :: Splunk Observability Cloud Workshops</title><link href=https://splunk.github.io/observability-workshop/v4.65/tko/index.html rel=canonical type=text/html title="TKO Workshops :: Splunk Observability Cloud Workshops"><link href=../tko/index.xml rel=alternate type=application/rss+xml title="TKO Workshops :: Splunk Observability Cloud Workshops"><link href=../images/favicon.ico?1676905180 rel=icon type=image/x-icon><link href=../css/fontawesome-all.min.css?1676905181 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/fontawesome-all.min.css?1676905181 rel=stylesheet></noscript><link href=../css/nucleus.css?1676905181 rel=stylesheet><link href=../css/auto-complete.css?1676905181 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/auto-complete.css?1676905181 rel=stylesheet></noscript><link href=../css/perfect-scrollbar.min.css?1676905181 rel=stylesheet><link href=../css/fonts.css?1676905181 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/fonts.css?1676905181 rel=stylesheet></noscript><link href=../css/theme.css?1676905181 rel=stylesheet><link href=../css/theme-splunk-light.css?1676905181 rel=stylesheet id=variant-style><link href=../css/variant.css?1676905181 rel=stylesheet><link href=../css/print.css?1676905181 rel=stylesheet media=print><link href=../css/format-print.css?1676905181 rel=stylesheet><link href=../css/ie.css?1676905181 rel=stylesheet><script src=../js/url.js?1676905181></script>
<script src=../js/variant.js?1676905181></script>
<script>window.index_js_url="../index.search.js";var root_url="../",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found="No results found for \u0022{0}\u0022",window.T_N_results_found="{1} results found for \u0022{0}\u0022",baseUriFull="https://splunk.github.io/observability-workshop/v4.65/",window.variants&&variants.init(["splunk-light","splunk-dark","aws"])</script></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=../tko/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable><div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle class=topbar-link title='Menu (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>TKO Workshops</span><meta itemprop=position content="2"></li></ol></div></div></nav><main id=body-inner class="highlightable home" tabindex=-1><div class=flex-block-wrapper><div id=head-tags></div><article class=home><h1 id=tko-workshops>TKO Workshops</h1><div class="children children-h3 children-sort-"><h3><a href=../tko/session-2/index.html>Getting Data In (GDI) & OTEL</a></h3><p>45 minutes During this technical workshop you will learn how to:
efficiently deploy complex environments capture metrics from these environments to Splunk Observability Cloud auto-instrument a python application enabling OS logging to Splunk Enterprise via Universal Forwarder In order to simplify the workshop modules, a pre-configured AWS EC2 instance is provided.
By the end of this technical workshop you will have an approach to demonstrating metrics collection for complex environments and services.</p><h3><a href=../tko/session-5/index.html>5. How Platform Engineers Observe Kubernetes</a></h3><p>45 minutes This workshop will equip you with the basic understanding of monitoring Kubernetes using the Splunk OpenTelemetry Collector. During the workshop you will deploy PHP/Apache and a load generator.
You will learn about OpenTelemetry Receivers, Kubernetes Namespaces, ReplicaSets, Kubernetes Horizontal Pod AutoScaling and how to monitor all this using the Splunk Observability Cloud. The main learnings from the workshop will be a better understanding of the Kubernetes Navigator (and Dashboards) in Splunk Observability Cloud as well as seeing Kubernetes metrics, events and Detectors.</p><h3><a href=../tko/session-6/index.html>6. O11y - Distributed Tracing for modern applications</a></h3><p>45 minutes Here at Buttercup Instruments, our business is expanding ! We have recently added 3 new locations, two locations in the USA, Colorado and Chicago and one international location in SRI Lanka !
Our technical staff has already on-boarded the data from these new locations and incorporated them into our inventory application and it is our job to review these improvements and send any issues back to our developers for repairs.</p></div><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of TKO Workshops</h1><article class=default><h1 id=getting-data-in-gdi--otel>Getting Data In (GDI) & OTEL</h1><span class="btn cstyle transparent"><button type=button>
<i class="fa-fw fas fa-clock"></i>
45 minutes</button></span><p>During this technical workshop you will learn how to:</p><ul><li>efficiently deploy complex environments</li><li>capture metrics from these environments to Splunk Observability Cloud</li><li>auto-instrument a python application</li><li>enabling OS logging to Splunk Enterprise via Universal Forwarder</li></ul><p>In order to simplify the workshop modules, a pre-configured AWS EC2 instance is provided.</p><p>By the end of this technical workshop you will have an approach to demonstrating metrics collection for complex environments and services.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Getting Data In (GDI) & OTEL</h1><article class=default><h1 id=getting-started-with-o11y-gdi---real-time-enrichment-workshop>Getting Started with O11y GDI - Real Time Enrichment Workshop</h1><p>Please note to begin the following lab, you must have completed the prework:</p><ul><li>Obtain a Splunk Observability Cloud access key</li><li>Understand cli commands</li></ul><p>Follow these steps if using O11y Workshop EC2 instances</p><ol><li>Verify yelp data files are present</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ll /var/appdata/yelp*
</span></span></code></pre></div><ol start=2><li>Export the following variables.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ACCESS_TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your-access-token&gt; 
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>REALM</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your-o11y-cloud-realm&gt; 
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>clusterName</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your-k8s-cluster&gt; 
</span></span></code></pre></div><ol start=3><li>Clone the following repo</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> /home/ubuntu 
</span></span><span style=display:flex><span>git clone https://github.com/leungsteve/realtime_enrichment.git 
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> realtime_enrichment/workshop 
</span></span><span style=display:flex><span>python3 -m venv rtapp-workshop 
</span></span><span style=display:flex><span><span style=color:#204a87>source</span> rtapp-workshop/bin/activate
</span></span></code></pre></div><footer class=footline></footer></article><article class=default><h1 id=deploy-complex-environments-and-capture-meterics>Deploy complex environments and capture meterics</h1><p><strong>Objective:</strong> Learn how to efficiently deploy complex infrastructure components such as Kafka and MongoDB to demonstrate metrics collection with Splunk O11y IM integrations</p><p><strong>Duration</strong>: 15 Minutes</p><h2 id=scenario>Scenario</h2><p>A prospect uses Kafka and MongoDB in their environment. Since there are integrations for these services, you’d like to demonstrate this to the prospect. What is a quick and efficient way to set up a live environment with these services and have metrics collected?</p><h3 id=1-where-can-i-find-helm-charts>1. Where can I find helm charts?</h3><ul><li>Google “myservice helm chart”</li><li><code>https://artifacthub.io/</code> (<strong>Note:</strong> Look for charts from trusted organizations, with high star count and frequent updates)</li></ul><h3 id=2-review-apache-kafka-packaged-by-bitnamihttpsgithubcombitnamichartstreemainbitnamikafkainstalling-the-chart>2. Review <a href=https://github.com/bitnami/charts/tree/main/bitnami/kafka/#installing-the-chart target=_blank>Apache Kafka packaged by Bitnami</a></h3><p>We will deploy the helm chart with these options enabled:</p><ul><li><code>replicaCount=3</code></li><li><code>metrics.jmx.enabled=true</code></li><li><code>metrics.kafka.enabled=true</code></li><li><code>deleteTopicEnable=true</code></li></ul><h3 id=3-review-mongodbr-packaged-by-bitnamihttpsgithubcombitnamichartstreemasterbitnamimongodbinstalling-the-chart>3. Review <a href=https://github.com/bitnami/charts/tree/master/bitnami/mongodb/#installing-the-chart target=_blank>MongoDB(R) packaged by Bitnami</a></h3><p>We will deploy the helm chart with these options enabled:</p><ul><li><code>version 12.1.31</code></li><li><code>metrics.enabled=true</code></li><li><code>global.namespaceOverride=default</code></li><li><code>auth.rootUser=root</code></li><li><code>auth.rootPassword=splunk</code></li><li><code>auth.enabled=false</code></li></ul><h3 id=4-install-kafka-and-mongodb-with-helm-charts>4. Install Kafka and MongoDB with helm charts</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add bitnami https://charts.bitnami.com/bitnami
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm install kafka --set <span style=color:#000>replicaCount</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span> --set metrics.jmx.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> --set metrics.kafka.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>  --set <span style=color:#000>deleteTopicEnable</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> bitnami/kafka
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm install mongodb --set metrics.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> bitnami/mongodb --set global.namespaceOverride<span style=color:#ce5c00;font-weight:700>=</span>default --set auth.rootUser<span style=color:#ce5c00;font-weight:700>=</span>root --set auth.rootPassword<span style=color:#ce5c00;font-weight:700>=</span>splunk --set auth.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span> --version 12.1.31
</span></span></code></pre></div><p>Verify the helm chart installation</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="helm list" class="tab-nav-button active" onclick='switchTab("default","helm list")'>
<span>helm list</span></button>
<button data-tab-item="helm list output" class=tab-nav-button onclick='switchTab("default","helm list output")'>
<span>helm list output</span></button></div><div class=tab-content><div data-tab-item="helm list" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm list
</span></span></code></pre></div></div><div data-tab-item="helm list output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>NAME    NAMESPACE   REVISION    UPDATED                                 STATUS      CHART           APP VERSION
</span></span><span style=display:flex><span>kafka   default     1           2022-11-14 11:21:36.328956822 -0800 PST deployed    kafka-19.1.3    3.3.1
</span></span><span style=display:flex><span>mongodb default     1           2022-11-14 11:19:36.507690487 -0800 PST deployed    mongodb-12.1.31 5.0.10
</span></span></code></pre></div></div></div></div><p>Verify the helm chart installation</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="kubectl get pods" class="tab-nav-button active" onclick='switchTab("default","kubectl get pods")'>
<span>kubectl get pods</span></button>
<button data-tab-item="kubectl get pods Output" class=tab-nav-button onclick='switchTab("default","kubectl get pods Output")'>
<span>kubectl get pods Output</span></button></div><div class=tab-content><div data-tab-item="kubectl get pods" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div></div><div data-tab-item="kubectl get pods Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>NAME                              READY   STATUS              RESTARTS   AGE
</span></span><span style=display:flex><span>kafka-exporter-595778d7b4-99ztt   0/1     ContainerCreating   0          17s
</span></span><span style=display:flex><span>mongodb-b7c968dbd-jxvsj           0/2     Pending             0          6s
</span></span><span style=display:flex><span>kafka-1                           0/2     ContainerCreating   0          16s
</span></span><span style=display:flex><span>kafka-2                           0/2     ContainerCreating   0          16s
</span></span><span style=display:flex><span>kafka-zookeeper-0                 0/1     Pending             0          17s
</span></span><span style=display:flex><span>kafka-0                           0/2     Pending             0          17s
</span></span></code></pre></div></div></div></div><p>Use information for each Helm chart and Splunk O11y Data Setup to generate values.yaml for capturing metrics from Kafka and MongoDB.</p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Note</div><div class=box-content><p><code>values.yaml</code> for the different services will be passed to the Splunk Helm Chart at installation time. These will configure the OTEL collector to capture metrics from these services.</p></div></div><ul><li>References:<ul><li><a href=https://github.com/bitnami/charts/tree/master/bitnami/spark/#installing-the-chart target=_blank>Apache Kafka packaged by Bitnami</a></li><li><a href=https://docs.splunk.com/Observability/gdi/kafka/kafka.html target=_blank>Configure application receivers for databases » Apache Kafka</a></li><li><a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/kafkametricsreceiver target=_blank>Kafkametricsreceiver</a></li></ul></li></ul><h4 id=41-example-kafkavaluesyaml>4.1 Example kafka.values.yaml</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>otelAgent</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>receivers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>receiver_creator</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>receivers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>smartagent/kafka</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>rule</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type == &#34;pod&#34; &amp;&amp; name matches &#34;kafka&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#8f5902;font-style:italic>#endpoint: &#39;`endpoint`:5555&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5555</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>collectd/kafka</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>clusterName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sl-kafka</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>otelK8sClusterReceiver</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>k8sEventsEnabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>receivers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kafkametrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>brokers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kafka:9092</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>protocol_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2.0.0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>scrapers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>brokers</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>topics</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>consumers</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>service</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pipelines</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>metrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>receivers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#8f5902;font-style:italic>#- prometheus</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>k8s_cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>kafkametrics</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h4 id=42-example-mongodbvaluesyaml>4.2 Example mongodb.values.yaml</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>otelAgent</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>receivers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>receiver_creator</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>receivers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>smartagent/mongodb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>rule</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type == &#34;pod&#34; &amp;&amp; name matches &#34;mongo&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>collectd/mongodb</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mongodb.default.svc.cluster.local</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>27017</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;admin&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;O11y&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;local&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;config&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>sendCollectionMetrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>sendCollectionTopMetrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h4 id=43-example-zookeepervaluesyaml>4.3 Example zookeeper.values.yaml</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>otelAgent</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>receivers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>receiver_creator</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>receivers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>smartagent/zookeeper</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>rule</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type == &#34;pod&#34; &amp;&amp; name matches &#34;kafka-zookeeper&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>collectd/zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kafka-zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2181</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=5-install-the-splunk-otel-helm-chart>5. Install the Splunk OTEL helm chart</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> /home/ubuntu/realtime_enrichment/otel_yamls/ 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>helm repo add splunk-otel-collector-chart https://signalfx.github.io/splunk-otel-collector-chart
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>helm repo update
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm install --set <span style=color:#000>provider</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39; &#39;</span> --set <span style=color:#000>distro</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39; &#39;</span> --set splunkObservability.accessToken<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$ACCESS_TOKEN</span> --set <span style=color:#000>clusterName</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$clusterName</span> --set splunkObservability.realm<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$REALM</span> --set otelCollector.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;false&#39;</span> --set splunkObservability.logsEnabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;true&#39;</span> --set gateway.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;false&#39;</span> --values kafka.values.yaml --values mongodb.values.yaml --values zookeeper.values.yaml --values alwayson.values.yaml --values k3slogs.yaml --generate-name splunk-otel-collector-chart/splunk-otel-collector
</span></span></code></pre></div><h3 id=6-verify-installation>6. Verify installation</h3><p>Verify that the Kafka, MongoDB and Splunk OTEL Collector helm charts are installed, note that names may differ.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="helm list" class="tab-nav-button active" onclick='switchTab("default","helm list")'>
<span>helm list</span></button>
<button data-tab-item="helm list Output" class=tab-nav-button onclick='switchTab("default","helm list Output")'>
<span>helm list Output</span></button></div><div class=tab-content><div data-tab-item="helm list" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm list
</span></span></code></pre></div></div><div data-tab-item="helm list Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>NAME                                NAMESPACE   REVISION    UPDATED                                 STATUS      CHART                           APP VERSION
</span></span><span style=display:flex><span>kafka                               default     1           2021-12-07 12:48:47.066421971 -0800 PST deployed    kafka-14.4.1                    2.8.1
</span></span><span style=display:flex><span>mongodb                             default     1           2021-12-07 12:49:06.132771625 -0800 PST deployed    mongodb-10.29.2                 4.4.10
</span></span><span style=display:flex><span>splunk-otel-collector-1638910184    default     1           2021-12-07 12:49:45.694013749 -0800 PST deployed    splunk-otel-collector-0.37.1    0.37.1
</span></span></code></pre></div></div></div></div><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="kubectl get pods" class="tab-nav-button active" onclick='switchTab("default","kubectl get pods")'>
<span>kubectl get pods</span></button>
<button data-tab-item="kubectl get pods Output" class=tab-nav-button onclick='switchTab("default","kubectl get pods Output")'>
<span>kubectl get pods Output</span></button></div><div class=tab-content><div data-tab-item="kubectl get pods" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div></div><div data-tab-item="kubectl get pods Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>NAME                                                              READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>kafka-zookeeper-0                                                 1/1     Running   0          18m
</span></span><span style=display:flex><span>kafka-2                                                           2/2     Running   1          18m
</span></span><span style=display:flex><span>mongodb-79cf87987f-gsms8                                          2/2     Running   0          18m
</span></span><span style=display:flex><span>kafka-1                                                           2/2     Running   1          18m
</span></span><span style=display:flex><span>kafka-exporter-7c65fcd646-dvmtv                                   1/1     Running   3          18m
</span></span><span style=display:flex><span>kafka-0                                                           2/2     Running   1          18m
</span></span><span style=display:flex><span>splunk-otel-collector-1638910184-agent-27s5c                      2/2     Running   0          17m
</span></span><span style=display:flex><span>splunk-otel-collector-1638910184-k8s-cluster-receiver-8587qmh9l   1/1     Running   0          17m
</span></span></code></pre></div></div></div></div><h3 id=7-verify-dashboards>7. Verify dashboards</h3><p>Verify that out of the box dashboards for Kafka, MongoDB and Zookeeper are populated in the Infrastructure Monitor landing page. Drill down into each component to view granular details for each service.</p><p>Tip: You can use the filter <code>k8s.cluster.name</code> with your cluster name to find your instance.</p><ul><li>Infrastructure Monitoring Landing page:</li></ul><p><a href=#image-69a25b69ac5d1117064c75a8526f62a5 class=lightbox-link><img src=../tko/session-2/deploy/../images/inframon.jpg alt=IM-landing-page style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-69a25b69ac5d1117064c75a8526f62a5><img src=../tko/session-2/deploy/../images/inframon.jpg alt=IM-landing-page class=lightbox-image loading=lazy></a></p><ul><li>K8 Navigator:</li></ul><p><a href=#image-1a7c778ca1eb0503d539b51f3bafac1a class=lightbox-link><img src=../tko/session-2/deploy/../images/k8navigator.jpg alt=k8-navigator style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-1a7c778ca1eb0503d539b51f3bafac1a><img src=../tko/session-2/deploy/../images/k8navigator.jpg alt=k8-navigator class=lightbox-image loading=lazy></a></p><ul><li>MongoDB Dashboard:</li></ul><p><a href=#image-b97a1ff49fe0296ab575300ba3e7ddbe class=lightbox-link><img src=../tko/session-2/deploy/../images/mongoDB.jpg alt=mongodb-dash style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-b97a1ff49fe0296ab575300ba3e7ddbe><img src=../tko/session-2/deploy/../images/mongoDB.jpg alt=mongodb-dash class=lightbox-image loading=lazy></a></p><ul><li>Kafka Dashboard:</li></ul><p><a href=#image-f781c78dea22da1c4c9d0a91423db0f3 class=lightbox-link><img src=../tko/session-2/deploy/../images/kafka.jpg alt=kafka-dash style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-f781c78dea22da1c4c9d0a91423db0f3><img src=../tko/session-2/deploy/../images/kafka.jpg alt=kafka-dash class=lightbox-image loading=lazy></a></p><footer class=footline></footer></article><article class=default><h1 id=code-to-kubernetes---python>Code to Kubernetes - Python</h1><h2 id=code-to-kubernetes---python>Code to Kubernetes - Python</h2><p><strong>Objective:</strong> Understand activities to instrument a python application and run it on Kubernetes.</p><ul><li>Verify the code</li><li>Containerize the app</li><li>Deploy the container in Kubernetes</li></ul><p><strong>Note:</strong> these steps do not involve Splunk</p><p><strong>Duration:</strong> 15 Minutes</p><h2 id=1-verify-the-code---review-service>1. Verify the code - Review service</h2><p>Navigate to the review directory</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> /home/ubuntu/realtime_enrichment/flask_apps_start/review/
</span></span></code></pre></div><p>Inspect review.py (realtime_enrichment/flask_apps_start/review)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat review.py
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>flask</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>Flask</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>jsonify</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>random</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>subprocess</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>review</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Flask</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__name__</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>num_reviews</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>8635403</span>
</span></span><span style=display:flex><span><span style=color:#000>num_reviews</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>100000</span>
</span></span><span style=display:flex><span><span style=color:#000>reviews_file</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;/var/appdata/yelp_academic_dataset_review.json&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@review.route</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hello_world</span><span style=color:#000;font-weight:700>():</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>jsonify</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Hello, you want to hit /get_review. We have &#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87>str</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>num_reviews</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39; reviews!&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@review.route</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/get_review&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>get_review</span><span style=color:#000;font-weight:700>():</span>
</span></span><span style=display:flex><span>    <span style=color:#000>random_review_int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>str</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>random</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>randint</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>num_reviews</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>    <span style=color:#000>line_num</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>random_review_int</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;q;d&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>command</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;sed&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>line_num</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>reviews_file</span><span style=color:#000;font-weight:700>]</span> <span style=color:#8f5902;font-style:italic># sed &#34;7997242q;d&#34; &lt;file&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>random_review</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>subprocess</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>run</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>command</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>stdout</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>subprocess</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>PIPE</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>True</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>random_review</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>stdout</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>__name__</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;__main__&#34;</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>review</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>run</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>host</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;0.0.0.0&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>5000</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>debug</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>True</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><p>Inspect requirements.txt</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Flask==2.0.2
</span></span></code></pre></div><p>Create a virtual environment and Install the necessary python packages</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> /home/ubuntu/realtime_enrichment/workshop/flask_apps_start/review/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pip freeze <span style=color:#8f5902;font-style:italic>#note output</span>
</span></span><span style=display:flex><span>pip install -r requirements.txt
</span></span><span style=display:flex><span>pip freeze <span style=color:#8f5902;font-style:italic>#note output</span>
</span></span></code></pre></div><p>Start the REVIEW service. <strong>Note:</strong> You can stop the app with control+C</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python3 review.py
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> * Serving Flask app <span style=color:#4e9a06>&#39;review&#39;</span> <span style=color:#ce5c00;font-weight:700>(</span>lazy loading<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span> * Environment: production
</span></span><span style=display:flex><span>         ...snip...
</span></span><span style=display:flex><span> * Running on http://10.160.145.246:5000/ <span style=color:#ce5c00;font-weight:700>(</span>Press CTRL+C to quit<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span> * Restarting with stat
</span></span><span style=display:flex><span>127.0.0.1 - - <span style=color:#ce5c00;font-weight:700>[</span>17/May/2022 22:46:38<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#4e9a06>&#34;GET / HTTP/1.1&#34;</span> <span style=color:#0000cf;font-weight:700>200</span> -
</span></span><span style=display:flex><span>127.0.0.1 - - <span style=color:#ce5c00;font-weight:700>[</span>17/May/2022 22:47:02<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#4e9a06>&#34;GET /get_review HTTP/1.1&#34;</span> <span style=color:#0000cf;font-weight:700>200</span> -
</span></span><span style=display:flex><span>127.0.0.1 - - <span style=color:#ce5c00;font-weight:700>[</span>17/May/2022 22:47:58<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#4e9a06>&#34;GET /get_review HTTP/1.1&#34;</span> <span style=color:#0000cf;font-weight:700>200</span> -
</span></span></code></pre></div><p>Verify that the service is working</p><ul><li>Open a new terminal and ssh into your ec2 instance. Then use the curl command in your terminal.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl http://localhost:5000
</span></span></code></pre></div><ul><li>Or hit the URL <code>http://{Your_EC2_IP_address}:5000</code> and <code>http://{Your_EC2_IP_address}:5000/get_review</code> with a browser</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl localhost:5000
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;message&#34;</span>: <span style=color:#4e9a06>&#34;Hello, you want to hit /get_review. We have 100000 reviews!&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl localhost:5000/get_review
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;review_id&#34;</span>:<span style=color:#4e9a06>&#34;NjbiESXotcEdsyTc4EM3fg&#34;</span>,<span style=color:#4e9a06>&#34;user_id&#34;</span>:<span style=color:#4e9a06>&#34;PR9LAM19rCM_HQiEm5OP5w&#34;</span>,<span style=color:#4e9a06>&#34;business_id&#34;</span>:<span style=color:#4e9a06>&#34;UAtX7xmIfdd1W2Pebf6NWg&#34;</span>,<span style=color:#4e9a06>&#34;stars&#34;</span>:3.0,<span style=color:#4e9a06>&#34;useful&#34;</span>:0,<span style=color:#4e9a06>&#34;funny&#34;</span>:0,<span style=color:#4e9a06>&#34;cool&#34;</span>:0,<span style=color:#4e9a06>&#34;text&#34;</span>:<span style=color:#4e9a06>&#34;-If you&#39;re into cheap beer (pitcher of bud-light for </span><span style=color:#000>$7</span><span style=color:#4e9a06>) decent wings and a good time, this is the place for you. Its generally very packed after work hours and weekends. Don&#39;t expect cocktails. \n\n-You run into a lot of sketchy characters here sometimes but for the most part if you&#39;re chilling with friends its not that bad. \n\n-Friendly bouncer and bartenders.&#34;</span>,<span style=color:#4e9a06>&#34;date&#34;</span>:<span style=color:#4e9a06>&#34;2016-04-12 20:23:24&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><ul><li>What does this application do?</li><li>Do you see the yelp dataset being used?</li><li>Why did the output of pip freeze differ each time you ran it?</li><li>Which port is the REVIEW app listening on? Can other python apps use this same port?</li></ul></div></div>}</p><h2 id=2-create-a-review-container>2. Create a REVIEW container</h2><p>To create a container image, you need to create a Dockerfile, run docker build to build the image referencing the Docker file and push it up to a remote repository so it can be pulled by other sources.</p><ul><li><a href=https://docs.docker.com/get-started/02_our_app/ target=_blank>Create a Dockerfile</a></li><li>Creating a Dockerfile typically requires you to consider the following:<ul><li>Identify an appropriate container image<ul><li>ubuntu vs. python vs. alpine/slim</li><li>ubuntu - overkill, large image size, wasted resources when running in K8</li><li>this is a python app, so pick an image that is optimized for it</li><li><a href=https://lih-verma.medium.com/alpine-makes-python-docker-builds-way-too-50-slower-and-images-double-2-larger-61d1d43cbc79 target=_blank>avoid alpine for python</a></li></ul></li><li>Order matters<ul><li>you&rsquo;re building layers.</li><li>re-use the layers as much as possible</li><li>have items that change often towards the end</li></ul></li><li><a href=https://docs.docker.com/develop/develop-images/dockerfile_best-practices/ target=_blank>Other Best practices for writing Dockerfiles</a></li></ul></li></ul><p>Dockerfile for review</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> python:3.10-slim</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>WORKDIR</span><span style=color:#4e9a06> /app</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> requirements.txt /app<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> pip install -r requirements.txt<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> ./review.py /app<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>EXPOSE</span><span style=color:#4e9a06> 5000</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>CMD</span> <span style=color:#000;font-weight:700>[</span> <span style=color:#4e9a06>&#34;python&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;review.py&#34;</span> <span style=color:#000;font-weight:700>]</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Create a container image (locally)
Run ‘docker build’ to build a local container image referencing the Dockerfile</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="docker build" class="tab-nav-button active" onclick='switchTab("default","docker build")'>
<span>docker build</span></button>
<button data-tab-item="docker build Output" class=tab-nav-button onclick='switchTab("default","docker build Output")'>
<span>docker build Output</span></button></div><div class=tab-content><div data-tab-item="docker build" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -f Dockerfile -t localhost:8000/review:0.01 .
</span></span></code></pre></div></div><div data-tab-item="docker build Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>[+] Building 35.5s (11/11) FINISHED
</span></span><span style=display:flex><span> =&gt; [internal] load build definition from Dockerfile                              0.0s
</span></span><span style=display:flex><span>         ...snip...
</span></span><span style=display:flex><span> =&gt; [3/5] COPY requirements.txt /app                                              0.0s
</span></span><span style=display:flex><span> =&gt; [4/5] RUN pip install -r requirements.txt                                     4.6s
</span></span><span style=display:flex><span> =&gt; [5/5] COPY ./review.py /app                                                   0.0s
</span></span><span style=display:flex><span> =&gt; exporting to image                                                            0.2s
</span></span><span style=display:flex><span> =&gt; =&gt; exporting layers                                                           0.2s
</span></span><span style=display:flex><span> =&gt; =&gt; writing image sha256:61da27081372723363d0425e0ceb34bbad6e483e698c6fe439c5  0.0s
</span></span><span style=display:flex><span> =&gt; =&gt; naming to docker.io/localhost:8000/review:0.1                                   0.0
</span></span></code></pre></div></div></div></div><p>Push the container image into a container repository
Run ‘docker push’ to place a copy of the REVIEW container to a remote location</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="docker push" class="tab-nav-button active" onclick='switchTab("default","docker push")'>
<span>docker push</span></button>
<button data-tab-item="docker push Output" class=tab-nav-button onclick='switchTab("default","docker push Output")'>
<span>docker push Output</span></button></div><div class=tab-content><div data-tab-item="docker push" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker push localhost:8000/review:0.01
</span></span></code></pre></div></div><div data-tab-item="docker push Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>The push refers to repository [docker.io/localhost:8000/review]
</span></span><span style=display:flex><span>02c36dfb4867: Pushed
</span></span><span style=display:flex><span>         ...snip...
</span></span><span style=display:flex><span>fd95118eade9: Pushed
</span></span><span style=display:flex><span>0.1: digest: sha256:3651f740abe5635af95d07acd6bcf814e4d025fcc1d9e4af9dee023a9b286f38 size: 2202
</span></span></code></pre></div></div></div></div><p>Verify that the image is in Docker Hub. The same info can be found in Docker Desktop</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="get catalog" class="tab-nav-button active" onclick='switchTab("default","get catalog")'>
<span>get catalog</span></button>
<button data-tab-item="get catalog Output" class=tab-nav-button onclick='switchTab("default","get catalog Output")'>
<span>get catalog Output</span></button></div><div class=tab-content><div data-tab-item="get catalog" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -s http://localhost:8000/v2/_catalog
</span></span></code></pre></div></div><div data-tab-item="get catalog Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>{&#34;repositories&#34;:[&#34;review&#34;]}
</span></span></code></pre></div></div></div></div><h2 id=3-run-review-in-kubernetes>3. Run REVIEW in Kubernetes</h2><p>Create K8 deployment yaml file for the REVIEW app</p><p>Reference: <a href=https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#creating-a-deployment target=_blank>Creating a Deployment</a></p><p>review.deployment.yaml</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>imagePullSecrets</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>regcred</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>localhost:8000/review:0.01</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>volumeMounts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>mountPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/appdata</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>appdata</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>volumes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>appdata</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>hostPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/appdata</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Notes regarding review.deployment.yaml:</p><ul><li>labels - K8 uses labels and selectors to tag and identify resources<ul><li>In the next step, we&rsquo;ll create a service and associate it to this deployment using the label</li></ul></li><li>replicas = 1<ul><li>K8 allows you to scale your deployments horizontally</li><li>We&rsquo;ll leverage this later to add load and increase our ingestion rate</li></ul></li><li>regcred provides this deployment with the ability to access your dockerhub credentials which is necessary to pull the container image.</li><li>The volume definition and volumemount make the yelp dataset visible to the container</li></ul><p>Create a K8 service yaml file for the review app.</p><p>Reference: <a href=https://kubernetes.io/docs/concepts/services-networking/service/#defining-a-service target=_blank>Creating a service:</a></p><p>review.service.yaml</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NodePort</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>nodePort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>30000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Notes about review.service.yaml:</p><ul><li>the selector associates this service to pods with the label app with the value being review</li><li>the review service exposes the review pods as a network service<ul><li>other pods can now ping &lsquo;review&rsquo; and they will hit a review pod.</li><li>a pod would get a review if it ran <code>curl http://review:5000</code></li></ul></li><li>NodePort service<ul><li>the service is accessible to the K8 host by the nodePort, 30000</li><li>Another machine that has this can get a review if it ran <code>curl http://&lt;k8 host ip>:30000</code></li></ul></li></ul><p>Apply the review deployment and service</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f review.service.yaml -f review.deployment.yaml
</span></span></code></pre></div><p>Verify that the deployment and services are running:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="kubectl get deployments" class="tab-nav-button active" onclick='switchTab("default","kubectl get deployments")'>
<span>kubectl get deployments</span></button>
<button data-tab-item="kubectl get deployments output" class=tab-nav-button onclick='switchTab("default","kubectl get deployments output")'>
<span>kubectl get deployments output</span></button></div><div class=tab-content><div data-tab-item="kubectl get deployments" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get deployments
</span></span></code></pre></div></div><div data-tab-item="kubectl get deployments output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>NAME                                                    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>review                                                  1/1     1            1           19h
</span></span></code></pre></div></div></div></div><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="kubectl get services" class="tab-nav-button active" onclick='switchTab("default","kubectl get services")'>
<span>kubectl get services</span></button>
<button data-tab-item="kubectl get services output" class=tab-nav-button onclick='switchTab("default","kubectl get services output")'>
<span>kubectl get services output</span></button></div><div class=tab-content><div data-tab-item="kubectl get services" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get services
</span></span></code></pre></div></div><div data-tab-item="kubectl get services output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>NAME                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                         AGE
</span></span><span style=display:flex><span>review                     NodePort    10.43.175.21    &lt;none&gt;        5000:30000/TCP                  154d
</span></span></code></pre></div></div></div></div><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="curl localhost" class="tab-nav-button active" onclick='switchTab("default","curl localhost")'>
<span>curl localhost</span></button>
<button data-tab-item="curl localhost Output" class=tab-nav-button onclick='switchTab("default","curl localhost Output")'>
<span>curl localhost Output</span></button></div><div class=tab-content><div data-tab-item="curl localhost" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl localhost:30000
</span></span></code></pre></div></div><div data-tab-item="curl localhost Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;message&#34;: &#34;Hello, you want to hit /get_review. We have 100000 reviews!&#34;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></div></div><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="get review" class="tab-nav-button active" onclick='switchTab("default","get review")'>
<span>get review</span></button>
<button data-tab-item="get review Output" class=tab-nav-button onclick='switchTab("default","get review Output")'>
<span>get review Output</span></button></div><div class=tab-content><div data-tab-item="get review" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl localhost:30000/get_review
</span></span></code></pre></div></div><div data-tab-item="get review Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>{&#34;review_id&#34;:&#34;Vv9rHtfBrFc-1M1DHRKN9Q&#34;,&#34;user_id&#34;:&#34;EaNqIwKkM7p1bkraKotqrg&#34;,&#34;business_id&#34;:&#34;TA1KUSCu8GkWP9w0rmElxw&#34;,&#34;stars&#34;:3.0,&#34;useful&#34;:1,&#34;funny&#34;:0,&#34;cool&#34;:0,&#34;text&#34;:&#34;This is the first time I&#39;ve actually written a review for Flip, but I&#39;ve probably been here about 10 times.  \n\nThis used to be where I would take out of town guests who wanted a good, casual, and relatively inexpensive meal.  \n\nI hadn&#39;t been for a while, so after a long day in midtown, we decided to head to Flip.  \n\nWe had the fried pickles, onion rings, the gyro burger, their special burger, and split a nutella milkshake.  I have tasted all of the items we ordered previously (with the exception of the special) and have been blown away with how good they were.  My guy had the special which was definitely good, so no complaints there.  The onion rings and the fried pickles were greasier than expected.  Though I&#39;ve thought they were delicious in the past, I probably wouldn&#39;t order either again.  The gyro burger was good, but I could have used a little more sauce.  It almost tasted like all of the ingredients didn&#39;t entirely fit together.  Something was definitely off. It was a friday night and they weren&#39;t insanely busy, so I&#39;m not sure I would attribute it to the staff not being on their A game...\n\nDon&#39;t get me wrong.  Flip is still good.  The wait staff is still amazingly good looking.  They still make delicious milk shakes.  It&#39;s just not as amazing as it once was, which really is a little sad.&#34;,&#34;date&#34;:&#34;2010-10-11 18:18:35&#34;}
</span></span></code></pre></div></div></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>What changes are required if you need to make an update to your Dockerfile now?</p></div></div><footer class=footline></footer></article><article class=default><h1 id=instrument-reviews-for-tracing>Instrument REVIEWS for Tracing</h1><h2 id=1-use-data-setup-to-instrument-a-python-application>1. Use Data Setup to instrument a Python application</h2><p>Within the O11y Cloud UI:</p><p>Data Management -> Add Integration -> Monitor Applications -> Python (traces) -> Add Integration</p><p>Provide the following to the Configure Integration Wizard:</p><ul><li><p>Service: review</p></li><li><p>Django: no</p></li><li><p>collector endpoint: <code>http://localhost:4317</code></p></li><li><p>Environment: rtapp-workshop-[YOURNAME]</p></li><li><p>Kubernetes: yes</p></li><li><p>Legacy Agent: no</p></li></ul><p><a href=#image-a4c94a892d82d543c7021f4f9dcfecfe class=lightbox-link><img src=../tko/session-2/instrument/../images/configureintegration.png alt=o11y_cloud_ui style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-a4c94a892d82d543c7021f4f9dcfecfe><img src=../tko/session-2/instrument/../images/configureintegration.png alt=o11y_cloud_ui class=lightbox-image loading=lazy></a></p><p>We are instructed to:</p><ul><li><p>Install the instrumentation packages for your Python environment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>pip install splunk-opentelemetry[all]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>splunk-py-trace-bootstrap
</span></span></code></pre></div></li><li><p>Configure the Downward API to expose environment variables to Kubernetes resources.</p><p>For example, update a Deployment to inject environment variables by adding <code>.spec.template.spec.containers.env</code> like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>your-application</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SPLUNK_OTEL_AGENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>status.hostIP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OTEL_EXPORTER_OTLP_ENDPOINT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;http://$(SPLUNK_OTEL_AGENT):4317&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OTEL_SERVICE_NAME</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;review&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OTEL_RESOURCE_ATTRIBUTES</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;deployment.environment=rtapp-workshop-stevel&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li><li><p>Enable the Splunk OTel Python agent by editing your Python service command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>splunk-py-trace python3 main.py --port=8000
</span></span></code></pre></div></li><li><p>The actions we must perform include:</p><ul><li>Update the Dockerfile to install the splunk-opentelemetry packages</li><li>Update the deployment.yaml for each service to include these environment variables which will be used by the pod and container.</li><li>Update our Dockerfile for REVIEW so that our program is bootstrapped with splunk-py-trace</li></ul></li></ul><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Note</div><div class=box-content><p>We will accomplish this by 1) generating a new requirements.txt file, 2) generating a new container image with an updated Dockerfile for REVIEW and then 3) update the review.deployment.yaml to capture all of these changes.</p></div></div><h2 id=2-update-the-review-container>2. Update the REVIEW container</h2><ul><li><p>Generate a new container image</p></li><li><p>Update the Dockerfile for REVIEW (<code>/workshop/flask_apps_finish/review</code>)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> python:3.10-slim</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>WORKDIR</span><span style=color:#4e9a06> /app</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> requirements.txt /app<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> pip install -r requirements.txt<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> pip install splunk-opentelemetry<span style=color:#ce5c00;font-weight:700>[</span>all<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> splk-py-trace-bootstrap<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> ./review.py /app<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>EXPOSE</span><span style=color:#4e9a06> 5000</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENTRYPOINT</span> <span style=color:#000;font-weight:700>[</span> <span style=color:#4e9a06>&#34;splunk-py-trace&#34;</span> <span style=color:#000;font-weight:700>]</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>CMD</span> <span style=color:#000;font-weight:700>[</span> <span style=color:#4e9a06>&#34;python&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;review.py&#34;</span> <span style=color:#000;font-weight:700>]</span><span style=color:#a40000>
</span></span></span></code></pre></div></li></ul><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Note</div><div class=box-content><p>Note that the only lines, in bold, added to the Dockerfile</p></div></div><ul><li>Generate a new container image with docker build in the ‘finished’ directory</li><li>Notice that I have changed the repository name from <code>localhost:8000/review:0.01</code> to <code>localhost:8000/review-splkotel:0.01</code></li></ul><p>Ensure you are in the correct directory.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  <span style=color:#204a87>pwd</span>
</span></span><span style=display:flex><span>  ./workshop/flask_apps_finish/review
</span></span></code></pre></div><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="docker build" class="tab-nav-button active" onclick='switchTab("default","docker build")'>
<span>docker build</span></button>
<button data-tab-item="docker build Output" class=tab-nav-button onclick='switchTab("default","docker build Output")'>
<span>docker build Output</span></button></div><div class=tab-content><div data-tab-item="docker build" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -f Dockerfile.review -t localhost:8000/review-splkotel:0.01 .
</span></span></code></pre></div></div><div data-tab-item="docker build Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>[+] Building 27.1s (12/12) FINISHED
</span></span><span style=display:flex><span>=&gt; [internal] load build definition from Dockerfile                                                        0.0s
</span></span><span style=display:flex><span>=&gt; =&gt; transferring dockerfile: 364B                                                                        0.0s
</span></span><span style=display:flex><span>=&gt; [internal] load .dockerignore                                                                           0.0s
</span></span><span style=display:flex><span>=&gt; =&gt; transferring context: 2B                                                                             0.0s
</span></span><span style=display:flex><span>=&gt; [internal] load metadata for docker.io/library/python:3.10-slim                                         1.6s
</span></span><span style=display:flex><span>=&gt; [auth] library/python:pull token for registry-1.docker.io                                               0.0s
</span></span><span style=display:flex><span>=&gt; [1/6] FROM docker.io/library/python:3.10-slim@sha256:54956d6c929405ff651516d5ebbc204203a6415c9d2757aad  0.0s
</span></span><span style=display:flex><span>=&gt; [internal] load build context                                                                           0.3s
</span></span><span style=display:flex><span>=&gt; =&gt; transferring context: 1.91kB                                                                         0.3s
</span></span><span style=display:flex><span>=&gt; CACHED [2/6] WORKDIR /app                                                                               0.0s
</span></span><span style=display:flex><span>=&gt; [3/6] COPY requirements.txt /app                                                                        0.0s
</span></span><span style=display:flex><span>=&gt; [4/6] RUN pip install -r requirements.txt                                                              15.3s
</span></span><span style=display:flex><span>=&gt; [5/6] RUN splk-py-trace-bootstrap                                                                       9.0s
</span></span><span style=display:flex><span>=&gt; [6/6] COPY ./review.py /app                                                                             0.0s
</span></span><span style=display:flex><span>=&gt; exporting to image                                                                                      0.6s
</span></span><span style=display:flex><span>=&gt; =&gt; exporting layers                                                                                     0.6s
</span></span><span style=display:flex><span>=&gt; =&gt; writing image sha256:164977dd860a17743b8d68bcc50c691082bd3bfb352d1025dc3a54b15d5f4c4d                0.0s
</span></span><span style=display:flex><span>=&gt; =&gt; naming to docker.io/localhost:8000/review-splkotel:0.01                                              0.0s
</span></span></code></pre></div></div></div></div><ul><li>Push the image to Docker Hub with docker push command</li></ul><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="docker push" class="tab-nav-button active" onclick='switchTab("default","docker push")'>
<span>docker push</span></button>
<button data-tab-item="docker push Output" class=tab-nav-button onclick='switchTab("default","docker push Output")'>
<span>docker push Output</span></button></div><div class=tab-content><div data-tab-item="docker push" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker push localhost:8000/review-splkotel:0.01
</span></span></code></pre></div></div><div data-tab-item="docker push Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>The push refers to repository [docker.io/localhost:8000/review-splkotel]
</span></span><span style=display:flex><span>682f0e550f2c: Pushed
</span></span><span style=display:flex><span>dd7dfa312442: Pushed
</span></span><span style=display:flex><span>917fd8334695: Pushed
</span></span><span style=display:flex><span>e6782d51030d: Pushed
</span></span><span style=display:flex><span>c6b19a64e528: Mounted from localhost:8000/review
</span></span><span style=display:flex><span>8f52e3bfc0ab: Mounted from localhost:8000/review
</span></span><span style=display:flex><span>f90b85785215: Mounted from localhost:8000/review
</span></span><span style=display:flex><span>d5c0beb90ce6: Mounted from localhost:8000/review
</span></span><span style=display:flex><span>3759be374189: Mounted from localhost:8000/review
</span></span><span style=display:flex><span>fd95118eade9: Mounted from localhost:8000/review
</span></span><span style=display:flex><span>0.01: digest: sha256:3b251059724dbb510ea81424fc25ed03554221e09e90ef965438da33af718a45 size: 2412
</span></span></code></pre></div></div></div></div><h2 id=3-update-the-review-deployment-in-kubernetes>3. Update the REVIEW deployment in Kubernetes</h2><ul><li><p>review.deployment.yaml must be updated with the following changes:</p><ul><li>Load the new container image on Docker Hub</li><li>Add environment variables so traces can be emitted to the OTEL collector</li></ul></li><li><p>The deployment must be replaced using the updated review.deployment.yaml</p><ul><li>Update review.deployment.yaml (updates highlighted in bold)</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>imagePullSecrets</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>regcred</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>localhost:8000/review-splkotel:0.01</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>volumeMounts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>mountPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/appdata</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>appdata</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SPLUNK_OTEL_AGENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>status.hostIP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OTEL_SERVICE_NAME</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;review&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SPLUNK_METRICS_ENDPOINT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;http://$(SPLUNK_OTEL_AGENT):9943&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OTEL_EXPORTER_OTLP_ENDPOINT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;http://$(SPLUNK_OTEL_AGENT):4317&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OTEL_RESOURCE_ATTRIBUTES</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;deployment.environment=rtapp-workshop-stevel&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>volumes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>appdata</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>hostPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/appdata</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li><li><p>Apply review.deployment.yaml. Kubernetes will automatically pick up the changes to the deployment and redeploy new pods with these updates</p><ul><li>Notice that the review-* pod has been restarted</li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f review.deployment.yaml
</span></span><span style=display:flex><span>  deployment.apps/review configured
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  kubectl get pods
</span></span><span style=display:flex><span>  NAME                                                              READY   STATUS        RESTARTS   AGE
</span></span><span style=display:flex><span>  kafka-client                                                      0/1     Unknown       0          155d
</span></span><span style=display:flex><span>  curl                                                              0/1     Unknown       0          155d
</span></span><span style=display:flex><span>  kafka-zookeeper-0                                                 1/1     Running       0          26h
</span></span><span style=display:flex><span>  kafka-2                                                           2/2     Running       0          26h
</span></span><span style=display:flex><span>  kafka-exporter-647bddcbfc-h9gp5                                   1/1     Running       2          26h
</span></span><span style=display:flex><span>  mongodb-6f6c78c76-kl4vv                                           2/2     Running       0          26h
</span></span><span style=display:flex><span>  kafka-1                                                           2/2     Running       1          26h
</span></span><span style=display:flex><span>  kafka-0                                                           2/2     Running       1          26h
</span></span><span style=display:flex><span>  splunk-otel-collector-1653114277-agent-n4dfn                      2/2     Running       0          26h
</span></span><span style=display:flex><span>  splunk-otel-collector-1653114277-k8s-cluster-receiver-5f48v296j   1/1     Running       0          26h
</span></span><span style=display:flex><span>  splunk-otel-collector-1653114277-agent-jqxhh                      2/2     Running       0          26h
</span></span><span style=display:flex><span>  review-6686859bd7-4pf5d                                           1/1     Running       0          11s
</span></span><span style=display:flex><span>  review-5dd8cfd77b-52jbd                                           0/1     Terminating   0          2d10h
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  kubectl get pods
</span></span><span style=display:flex><span>  NAME                                                              READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>  kafka-client                                                      0/1     Unknown   0          155d
</span></span><span style=display:flex><span>  curl                                                              0/1     Unknown   0          155d
</span></span><span style=display:flex><span>  kafka-zookeeper-0                                                 1/1     Running   0          26h
</span></span><span style=display:flex><span>  kafka-2                                                           2/2     Running   0          26h
</span></span><span style=display:flex><span>  kafka-exporter-647bddcbfc-h9gp5                                   1/1     Running   2          26h
</span></span><span style=display:flex><span>  mongodb-6f6c78c76-kl4vv                                           2/2     Running   0          26h
</span></span><span style=display:flex><span>  kafka-1                                                           2/2     Running   1          26h
</span></span><span style=display:flex><span>  kafka-0                                                           2/2     Running   1          26h
</span></span><span style=display:flex><span>  splunk-otel-collector-1653114277-agent-n4dfn                      2/2     Running   0          26h
</span></span><span style=display:flex><span>  splunk-otel-collector-1653114277-k8s-cluster-receiver-5f48v296j   1/1     Running   0          26h
</span></span><span style=display:flex><span>  splunk-otel-collector-1653114277-agent-jqxhh                      2/2     Running   0          26h
</span></span><span style=display:flex><span>  review-6686859bd7-4pf5d                                           1/1     Running   0          15s
</span></span></code></pre></div><footer class=footline></footer></article><article class=default><h1 id=monitor-system-logs-with-splunk-universal-forwarder>Monitor System Logs with Splunk Universal Forwarder</h1><p><strong>Objective:</strong> Learn how to monitor Linux system logs with the Universal Forwarder sending logs to Splunk Enterprise</p><p><strong>Duration</strong>: 10 Minutes</p><h2 id=scenario>Scenario</h2><p>You&rsquo;ve been tasked with monitoring the OS logs of the host running your Kubernetes cluster. We are going to utilize a script that will autodeploy the Splunk Universal Forwarder. You will then configure the Universal Forwarder to send logs to the Splunk Enterprise instance assigned to you.</p><h3 id=1-ensure-youre-in-the-correct-directory>1. Ensure You&rsquo;re in the Correct Directory</h3><ul><li>we will need to be in /home/ubuntu/session-2</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> /home/ubuntu/session-2
</span></span></code></pre></div><h3 id=2-review-the-universal-forwarder-install-script>2. Review the Universal Forwarder Install Script</h3><ul><li>Let&rsquo;s take a look at the script that will install the Universal Forwarder and Linux TA automatically for you.<ul><li>This script is primarily used for remote instances.</li><li>Note we are not using a deployment server in this lab, however it is recommended in production we do that.</li><li>What user are we installing Splunk as?</li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/sh  
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic># This EXAMPLE script shows how to deploy the Splunk universal forwarder</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># to many remote hosts via ssh and common Unix commands.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># For &#34;real&#34; use, this script needs ERROR DETECTION AND LOGGING!!</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># --Variables that you must set -----</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Set username using by splunkd to run.</span>
</span></span><span style=display:flex><span>  <span style=color:#000>SPLUNK_RUN_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;ubuntu&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Populate this file with a list of hosts that this script should install to,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># with one host per line. This must be specified in the form that should</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># be used for the ssh login, ie. username@host</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Example file contents:</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># splunkuser@10.20.13.4</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># splunkker@10.20.13.5</span>
</span></span><span style=display:flex><span>  <span style=color:#000>HOSTS_FILE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;myhost.txt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># This should be a WGET command that was *carefully* copied from splunk.com!!</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Sign into splunk.com and go to the download page, then look for the wget</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># link near the top of the page (once you have selected your platform)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># copy and paste your wget command between the &#34;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>WGET_CMD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;wget -O splunkforwarder-9.0.3-dd0128b1f8cd-Linux-x86_64.tgz &#39;https://download.splunk.com/products/universalforwarder/releases/9.0.3/linux/splunkforwarder-9.0.3-dd0128b1f8cd-Linux-x86_64.tgz&#39;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Set the install file name to the name of the file that wget downloads</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># (the second argument to wget)</span>
</span></span><span style=display:flex><span>  <span style=color:#000>INSTALL_FILE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;splunkforwarder-9.0.3-dd0128b1f8cd-Linux-x86_64.tgz&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># After installation, the forwarder will become a deployment client of this</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># host.  Specify the host and management (not web) port of the deployment server</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># that will be managing these forwarder instances.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Example 1.2.3.4:8089</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#  DEPLOY_SERVER=&#34;x.x.x.x:8089&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># After installation, the forwarder can have additional TA&#39;s added to the </span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /app directory please provide the local where TA&#39;s will be. </span>
</span></span><span style=display:flex><span>  <span style=color:#000>TA_INSTALL_DIRECTORY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/home/ubuntu/session-2&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Set the seed app folder name for deploymentclien.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#  DEPLOY_APP_FOLDER_NAME=&#34;seed_all_deploymentclient&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Set the new Splunk admin password</span>
</span></span><span style=display:flex><span>  <span style=color:#000>PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;buttercup&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>REMOTE_SCRIPT_DEPLOY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  cd /opt
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  sudo </span><span style=color:#000>$WGET_CMD</span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  sudo tar xvzf </span><span style=color:#000>$INSTALL_FILE</span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  sudo rm </span><span style=color:#000>$INSTALL_FILE</span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  #sudo useradd </span><span style=color:#000>$SPLUNK_RUN_USER</span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  sudo find </span><span style=color:#000>$TA_INSTALL_DIRECTORY</span><span style=color:#4e9a06> -name &#39;*.tgz&#39; -exec tar xzvf {} --directory /opt/splunkforwarder/etc/apps \;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  sudo chown -R </span><span style=color:#000>$SPLUNK_RUN_USER</span><span style=color:#4e9a06>:</span><span style=color:#000>$SPLUNK_RUN_USER</span><span style=color:#4e9a06> /opt/splunkforwarder
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  echo \&#34;[user_info] 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  USERNAME = admin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  PASSWORD = </span><span style=color:#000>$PASSWORD</span><span style=color:#4e9a06>\&#34; &gt; /opt/splunkforwarder/etc/system/local/user-seed.conf   
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  #sudo cp </span><span style=color:#000>$TA_INSTALL_DIRECTORY</span><span style=color:#4e9a06>/*.tgz /opt/splunkforwader/etc/apps/
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  #sudo find /opt/splunkforwarder/etc/apps/ -name &#39;*.tgz&#39; -exec tar xzvf {} \;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  #sudo -u splunk /opt/splunkforwarder/bin/splunk start --accept-license --answer-yes --auto-ports --no-prompt
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  /opt/splunkforwarder/bin/splunk start --accept-license --answer-yes --auto-ports --no-prompt
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  #sudo /opt/splunkforwarder/bin/splunk enable boot-start -user </span><span style=color:#000>$SPLUNK_RUN_USER</span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  /opt/splunkforwarder/bin/splunk enable boot-start -user </span><span style=color:#000>$SPLUNK_RUN_USER</span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  #sudo cp </span><span style=color:#000>$TA_INSTALL_DIRECTORY</span><span style=color:#4e9a06>/*.tgz /opt/splunkforwarder/etc/apps/
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  exit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06> &#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>DIR</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>$(</span> <span style=color:#204a87>cd</span> <span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>$(</span> dirname <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BASH_SOURCE</span><span style=color:#000;font-weight:700>[0]</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span> &gt;/dev/null <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>pwd</span> <span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#===============================================================================================</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;In 5 seconds, will run the following script on each remote host:&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;====================&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$REMOTE_SCRIPT_DEPLOY</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;====================&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> 
</span></span><span style=display:flex><span>  sleep <span style=color:#0000cf;font-weight:700>5</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Reading host logins from </span><span style=color:#000>$HOSTS_FILE</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Starting.&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>for</span> DST in <span style=color:#4e9a06>`</span>cat <span style=color:#4e9a06>&#34;</span><span style=color:#000>$DIR</span><span style=color:#4e9a06>/</span><span style=color:#000>$HOSTS_FILE</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>`</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> -z <span style=color:#4e9a06>&#34;</span><span style=color:#000>$DST</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>continue</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;---------------------------&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Installing to </span><span style=color:#000>$DST</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Initial UF deployment&#34;</span>
</span></span><span style=display:flex><span>    sudo ssh -t <span style=color:#4e9a06>&#34;</span><span style=color:#000>$DST</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$REMOTE_SCRIPT_DEPLOY</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>done</span>  
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;---------------------------&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Done&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Please use the following app folder name to override deploymentclient.conf options: </span><span style=color:#000>$DEPLOY_APP_FOLDER_NAME</span><span style=color:#4e9a06>&#34;</span>
</span></span></code></pre></div><h3 id=3-run-the-install-script>3. Run the install script</h3><p>We will run the install script now. You will see some Warnings at the end. This is totally normal. The script is built for use on remote machines, however for todays lab you will be using localhost.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./install.sh
</span></span></code></pre></div><p>You will be asked <code>Are you sure you want to continue connecting (yes/no/[fingerprint])?</code>
Answer Yes.</p><p>Enter your ssh password when prompted.</p><h3 id=4-verify-installation-of-the-universal-forwarader>4. Verify installation of the Universal Forwarader</h3><ul><li>We need to verify that the Splunk Universal Forwarder is installed and running.<ul><li>You should see a couple PID&rsquo;s return and a &ldquo;Splunk is currently running.&rdquo; message.</li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/opt/splunkforwarder/bin/splunk status
</span></span></code></pre></div><h4 id=5-configure-the-universal-forwarder-to-send-data-to-splunk-enterprise>5. Configure the Universal Forwarder to Send Data to Splunk Enterprise.</h4><ul><li>We will be able to send the data to our Splunk Enterprise environment easily by entering one line into the cli.<ul><li><a href=https://docs.splunk.com/Documentation/Forwarder/9.0.3/Forwarder/Configuretheuniversalforwarder target=_blank>Universal Forwarder Config Guide</a></li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/opt/splunkforwarder/bin/splunk add forward-server &lt;your_splunk_enterprise_ip&gt;:9997
</span></span></code></pre></div><h4 id=6-verify-the-data-in-your-splunk-enterprise-environment>6. Verify the Data in Your Splunk Enterprise Environment</h4><ul><li><p>We are now going to take a look at the Splunk Enterprise environment to verify logs are coming in.</p><ul><li>Logs will be coming into <code>index=main</code></li></ul></li><li><p>Open your web browser and navigate to: <code>http://&lt;your_splunk_enterprise_ip:8000</code></p><ul><li>You will use the credentials <code>admin:&lt;your_ssh_password></code></li></ul></li><li><p>In the search bar, type in the following:</p></li><li><p><code>index=main host=&lt;your_host_name></code></p></li><li><p>You should see data from your host. Take note of the interesting fields and the different data sources flowing in.</p></li></ul><footer class=footline></footer></article></section><article class=default><h1 id=5-how-platform-engineers-observe-kubernetes>5. How Platform Engineers Observe Kubernetes</h1><span class="btn cstyle transparent"><button type=button>
<i class="fa-fw fas fa-clock"></i>
45 minutes</button></span><p>This workshop will equip you with the basic understanding of monitoring Kubernetes using the Splunk OpenTelemetry Collector. During the workshop you will deploy PHP/Apache and a load generator.</p><p>You will learn about OpenTelemetry Receivers, Kubernetes Namespaces, ReplicaSets, Kubernetes Horizontal Pod AutoScaling and how to monitor all this using the Splunk Observability Cloud. The main learnings from the workshop will be a better understanding of the Kubernetes Navigator (and Dashboards) in Splunk Observability Cloud as well as seeing Kubernetes metrics, events and Detectors.</p><p>In order to part take in this workshop you will need to have:</p><ul><li>Your laptop</li><li>Already have logged into US Splunk Show via <a href=https://app.us1.signalfx.com target=_blank>https://app.us1.signalfx.com</a> using Google SSO</li><li>Terminal access to the workshop instance via SSH</li><li>Hopefully a stable wi-fi connection, but we can&rsquo;t promise that!</li></ul><p>For this workshop Splunk has prepared an Ubuntu Linux instance in AWS/EC2 all pre-configured for you.</p><p>To get access to the instance that you will be using in the workshop, please visit the URL provided by the workshop leader in the workshop Slack channel.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of 5. How Platform Engineers Observe Kubernetes</h1><article class=default><h1 id=deploying-the-opentelemetry-collector-in-kubernetes-using-a-namespace>Deploying the OpenTelemetry Collector in Kubernetes using a NameSpace</h1><h2 id=1-new-kubernetes-navigator-20-ui>1. New Kubernetes Navigator 2.0 UI</h2><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation"></i> Note</div><div class=box-content><p>As the new Kubernetes Navigator is still in Preview, some steps of this workshop might not work as expected. If you encounter any issues, please do the following:</p><ul><li><p>Switch back to the old Kubernetes Navigator by clicking on the big blue
<span class="btn cstyle blue"><button type=button>
Switch to old navigator</button></span> button in the top right corner of the Kubernetes Navigator.</p></li><li><p>Let us know in the <strong>#tko-2023-o11y-session-5 channel</strong> in Slack.</p></li></ul></div></div><p>We will be starting this workshop using the new Kubernetes Navigator so please check that you are already using the new Navigator.</p><p>When you select <strong>Infrastructure</strong> from the main menu on the left, followed by selecting <strong>Kubernetes</strong>, you should see two services panes for Kubernetes, similar like the ones below:</p><p><a href=#image-1f50401da83cb60b7ffbeccd5309dee7 class=lightbox-link><img src=../tko/session-5/deploy-otel/../images/k8s-nav2-two.png alt=k8s-navi-v-2 style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-1f50401da83cb60b7ffbeccd5309dee7><img src=../tko/session-5/deploy-otel/../images/k8s-nav2-two.png alt=k8s-navi-v-2 class=lightbox-image loading=lazy></a></p><p>If you are taken straight to the Kubernetes Navigator v1 Map view after selecting <strong>Kubernetes</strong>, you need to opt-in to the new Navigator yourself for this workshop by clicking on the big blue
<span class="btn cstyle blue"><button type=button>
Switch to new navigator</button>
</span>.</p><p>You should now be in the K8s Node view with chart below the cluster map similar like shown below:</p><p><a href=#image-39607e99f81c17e417aadbc7e5b98811 class=lightbox-link><img src=../tko/session-5/deploy-otel/../images/new-k8s-view.png alt=k8s-navi-v-2 style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-39607e99f81c17e417aadbc7e5b98811><img src=../tko/session-5/deploy-otel/../images/new-k8s-view.png alt=k8s-navi-v-2 class=lightbox-image loading=lazy></a></p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Note</div><div class=box-content><p>If you actually see three services for Kubernetes including one that is named <code>K8s clusters</code>, you need to turn off Precognition in the Superpowers view.
To do this, please change the Url in your browser to match the following: <a href=https://app.[REALM].signalfx.com/#/superpowers target=_blank>https://app.[REALM].signalfx.com/#/superpowers</a></p><p>where [REALM] needs to match the Realm we are using for this workshop then remove the Precognition flag like in the example below. This is one of the first options you can set:</p><p><a href=#image-a7b1daf15fd12b9b53c29e19e44599bc class=lightbox-link><img src=../tko/session-5/deploy-otel/../images/precognition.png alt=Set-Precognition style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-a7b1daf15fd12b9b53c29e19e44599bc><img src=../tko/session-5/deploy-otel/../images/precognition.png alt=Set-Precognition class=lightbox-image loading=lazy></a></p><p>Once its unset, you can refresh your page and reselect Kubernetes from the Infrastructure Navigator menu.</p></div></div><h2 id=2-connect-to-ec2-instance>2. Connect to EC2 instance</h2><p>You will be able to connect to the workshop instance by using SSH from your Mac, Linux or Windows device. Open the link to the sheet provided in the <strong>#tko-2023-o11y-session-5 channel</strong> in Slack. This sheet contains the IP addresses and the password for the workshop instances. Please</p><p>To use SSH, open a terminal on your system and type <code>ssh ubuntu@x.x.x.x</code> (replacing x.x.x.x with the IP address assigned to you). The password for this workshop is also provided in the sheet.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Note</div><div class=box-content><p>Your workshop instance has been pre-configured with the correct <code>ACCESS_TOKEN</code> and <code>REALM</code> for this workshop. There is no need for you to configure these.</p></div></div><h2 id=3-namespaces-in-kubernetes>3. Namespaces in Kubernetes</h2><p>Most of our customers will make use of some kind of private or public cloud service to run Kubernetes. They often choose to have only a few large Kubernetes clusters as it is easier to manage centrally.</p><p>Namespaces are a way to organize these large Kubernetes clusters into virtual sub-clusters. This can be helpful when different teams or projects share a Kubernetes cluster as this will give them the easy ability to just see and work with their own stuff.</p><p>Any number of namespaces are supported within a cluster, each logically separated from others but with the ability to communicate with each other. Components are only <strong>visible</strong> when selecting a namespace or when adding the <code>--all-namespaces</code> flag to <code>kubectl</code> instead of allowing you to view just the components relevant to your project by selecting your namespace.</p><p>Most customers will want to install the Splunk OpenTelemetry Collector in a separate namespace. This workshop will follow that practice.</p><h2 id=4-install-splunk-otel-using-helm>4. Install Splunk OTel using Helm</h2><p>Install the OpenTelemetry Collector using the Splunk Helm chart. First, add the Splunk Helm chart repository and update.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Helm Repo Add" class="tab-nav-button active" onclick='switchTab("default","Helm Repo Add")'>
<span>Helm Repo Add</span></button>
<button data-tab-item="Helm Repo Add Output" class=tab-nav-button onclick='switchTab("default","Helm Repo Add Output")'>
<span>Helm Repo Add Output</span></button></div><div class=tab-content><div data-tab-item="Helm Repo Add" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add splunk-otel-collector-chart https://signalfx.github.io/splunk-otel-collector-chart <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> helm repo update
</span></span></code></pre></div></div><div data-tab-item="Helm Repo Add Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Using ACCESS_TOKEN={REDACTED}
</span></span><span style=display:flex><span>Using REALM=eu0
</span></span><span style=display:flex><span>&#34;splunk-otel-collector-chart&#34; has been added to your repositories
</span></span><span style=display:flex><span>Using ACCESS_TOKEN={REDACTED}
</span></span><span style=display:flex><span>Using REALM=eu0
</span></span><span style=display:flex><span>Hang tight while we grab the latest from your chart repositories...
</span></span><span style=display:flex><span>...Successfully got an update from the &#34;splunk-otel-collector-chart&#34; chart repository
</span></span><span style=display:flex><span>Update Complete. ⎈Happy Helming!⎈
</span></span></code></pre></div></div></div></div><p>Install the OpenTelemetry Collector Helm chart into the <code>splunk</code> namespace with the following commands, do <strong>NOT</strong> edit this:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Helm Install" class="tab-nav-button active" onclick='switchTab("default","Helm Install")'>
<span>Helm Install</span></button></div><div class=tab-content><div data-tab-item="Helm Install" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm install splunk-otel-collector <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;splunkObservability.realm=</span><span style=color:#000>$REALM</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;splunkObservability.accessToken=</span><span style=color:#000>$ACCESS_TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;clusterName=</span><span style=color:#204a87;font-weight:700>$(</span>hostname<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>-k3s-cluster&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;splunkObservability.logsEnabled=true&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;splunkObservability.infrastructureMonitoringEventsEnabled=true&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>splunk-otel-collector-chart/splunk-otel-collector <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--namespace splunk <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--create-namespace <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>-f ~/workshop/k3s/splunk-defaults.yaml
</span></span></code></pre></div></div></div></div><h2 id=5-verify-deployment>5. Verify Deployment</h2><p>You can monitor the progress of the deployment by running <code>kubectl get pods</code> and adding <code>-n splunk</code> to the command to see the pods in the <code>splunk</code> namespace which should typically report that the new pods are up and running after about 30 seconds.</p><p>Ensure the status is reported as <strong>Running</strong> before continuing.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="kubectl get pods" class="tab-nav-button active" onclick='switchTab("default","kubectl get pods")'>
<span>kubectl get pods</span></button>
<button data-tab-item="kubectl get pods Output" class=tab-nav-button onclick='switchTab("default","kubectl get pods Output")'>
<span>kubectl get pods Output</span></button></div><div class=tab-content><div data-tab-item="kubectl get pods" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods -n splunk
</span></span></code></pre></div></div><div data-tab-item="kubectl get pods Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>NAME                                                          READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>splunk-otel-collector-agent-pvstb                             2/2     Running   0          19s
</span></span><span style=display:flex><span>splunk-otel-collector-k8s-cluster-receiver-6c454894f8-mqs8n   1/1     Running   0          19s
</span></span></code></pre></div></div></div></div><p>Use the label set by the <code>helm</code> install to tail logs (You will need to press <code>ctrl + c</code> to exit).</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="kubectl logs" class="tab-nav-button active" onclick='switchTab("default","kubectl logs")'>
<span>kubectl logs</span></button></div><div class=tab-content><div data-tab-item="kubectl logs" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl logs -l <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>=</span>splunk-otel-collector -f --container otel-collector -n splunk
</span></span></code></pre></div></div></div></div><p>Or use the installed <code>k9s</code> terminal UI.</p><p><a href=#image-3807a3b87d4a00e9629ad05b921e7bac class=lightbox-link><img src=../tko/session-5/deploy-otel/../images/k9s.png alt=k9s style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-3807a3b87d4a00e9629ad05b921e7bac><img src=../tko/session-5/deploy-otel/../images/k9s.png alt=k9s class=lightbox-image loading=lazy></a></p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Deleting a failed installation</div><div class=box-content><p>If you make an error installing the Splunk OpenTelemetry Collector you can start over by deleting the installation using:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>helm delete splunk-otel-collector -n splunk
</span></span></code></pre></div></div></div><footer class=footline></footer></article><article class=default><h1 id=tour-of-the-kubernetes-navigator-v2>Tour of the Kubernetes Navigator v2</h1><h2 id=1-cluster-vs-workload-view>1. Cluster vs Workload View</h2><p>The Kubernetes Navigator offers you two separate use cases to view your Kubernetes data.</p><ul><li>The <strong>K8s workloads</strong> is focusing on providing information in regards to workloads a.k.a. <em>your deployments</em>.</li><li>The <strong>K8s nodes</strong> is focusing on providing insight into the performance of clusters, Nodes, Pods & Containers.</li></ul><p>You initially select either view depending on your need (you can switch between the view on the fly if required). The most common one we will use in this workshop is the workload view and we will focus on that specifically.</p><h3 id=11-finding-your-k8s-cluster-name>1.1 Finding your K8s Cluster name</h3><p>Your first task is to identify and find your own cluster. The cluster will be named after your EC2 instance name.</p><p>To confirm your EC2 instance name, look at the prompt of your EC2 instance. For example, if you are assigned the 7th EC2 instance, the prompt will show:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ubuntu@emea-ws-7 ~ $
</span></span></code></pre></div><p>This means your cluster is named: <code>emea-ws-7-k3s-cluster</code>. Please make a note of your cluster name as you will need this later in the workshop for filtering.</p><h2 id=2-workloads--workload-details-pane>2. Workloads & Workload Details Pane</h2><p>Go to the <strong>Infrastructure</strong> menu item in the Observability UI and select <strong>Kubernetes</strong>. Go to the <strong>Infrastructure</strong> page in the Observability UI and select <strong>Kubernetes</strong>, this will offer you a set of Kubernetes services, one of them being the <strong>K8s workloads</strong> pane.</p><p>The pane will show a tiny graph giving you a bird&rsquo;s eye view of the load being handled across those Workloads. Also, if there are any alerts for one of the workloads, you will see a small alert indicator as shown in the image above.</p><p><a href=#image-45424ba6c3d36608df03178ebbafd843 class=lightbox-link><img src=../tko/session-5/check-new-navigator-short/../images/K8s-Workloads.png alt=k8sWorkloads style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-45424ba6c3d36608df03178ebbafd843><img src=../tko/session-5/check-new-navigator-short/../images/K8s-Workloads.png alt=k8sWorkloads class=lightbox-image loading=lazy></a></p><p>Click on the <strong>K8s workloads</strong> pane and you will be taken to the workload view.</p><p>Initially, you will see all the workloads that are reported by your clusters into your Observability Cloud Org. If an alert has fired for any of the workloads, it will be highlighted on the top right <em>as marked with a red stripe</em> in the image below. You can go directly to the alert by clicking it to expand it.</p><p><a href=#image-32b6fc883f4146ae7feb737581a3d1f2 class=lightbox-link><img src=../tko/session-5/check-new-navigator-short/../images/k8s-workload-screen.png alt=Workloads style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-32b6fc883f4146ae7feb737581a3d1f2><img src=../tko/session-5/check-new-navigator-short/../images/k8s-workload-screen.png alt=Workloads class=lightbox-image loading=lazy></a></p><p>Now, let&rsquo;s find your own cluster by filtering on the field <code>k8s.cluster.name</code> in the filter toolbar, <em>as marked with a blue stripe</em>. Note: you can enter a partial name into the search box, such as &rsquo;emea-ws-7*&rsquo;, to quickly find your Cluster. Also it&rsquo;s a very good idea to switch the default time from the default <strong>-3h</strong> back to last 15 minutes (<strong>-15m</strong>).</p><p>You should now just see information for your own cluster.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>How many workloads are running & how many namespaces are in your Cluster?</p></div></div><h3 id=21-using-the-navigator-selection-chart>2.1 Using the Navigator Selection chart</h3><p>The <strong>K8s workloads</strong> table is a common feature used across most of the Navigator&rsquo;s and will offer you a list view of the data you are viewing. In our case, it shows a list of <code>Pods Failed</code> grouped by <code>k8s.namespace.name</code>.</p><p>You will find this pane used in various Navigators in this workshop (ex: Workloads & Apache Servers). The way the selection pane works is similar across the Navigators in that the information shown will match the selection criteria in your filters.</p><p><a href=#image-e4fd8f0761ec8ba2edd223db80339de0 class=lightbox-link><img src=../tko/session-5/check-new-navigator-short/../images/workload-selection.png alt=k8s-workload-list style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-e4fd8f0761ec8ba2edd223db80339de0><img src=../tko/session-5/check-new-navigator-short/../images/workload-selection.png alt=k8s-workload-list class=lightbox-image loading=lazy></a></p><p>Now let&rsquo;s change the list view to a heat map view by selecting either the Heat map icon or List icon in the upper-right corner of the screen <em>(as marked with a purple line)</em>.</p><p>Changing this option will result in the following representation, which is one we will use most of the time in this workshop:</p><p><a href=#image-aadb19e8103fb5ae631500c6f187da30 class=lightbox-link><img src=../tko/session-5/check-new-navigator-short/../images/heatmap.png alt=k8s-Heat-map style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-aadb19e8103fb5ae631500c6f187da30><img src=../tko/session-5/check-new-navigator-short/../images/heatmap.png alt=k8s-Heat-map class=lightbox-image loading=lazy></a></p><p>In this view, you will note that each workload is now a colored rectangle. These rectangles change color according to the <strong>Color by</strong> option you selected, <em>as marked by a green line</em> above. The colors give a visual indication of health and/or usage. You can check the meaning by hovering over the <strong>legend</strong> exclamation icon
<i class="fa-fw fas fa-exclamation-circle"></i>
bottom right of the heatmaps.</p><p>Another valuable option in this screen is <strong>Find Outliers</strong> which provides historical analytics of your clusters based on what is selected in the <strong>Color by</strong> dropdown.</p><p>Now, let&rsquo;s select the <strong>File system usage (bytes)</strong> from the <strong>Color by</strong> drop down box, <em>as marked with a green line</em> then click on the <strong>Find outliers</strong> drop down <em>as marked by a yellow stripe</em> in the above image and make sure you change the Strategy in the dialog to <strong>Deviation from Median</strong> as below:</p><p><a href=#image-776fc9946930d3ebc9945073cd234296 class=lightbox-link><img src=../tko/session-5/check-new-navigator-short/../images/set-find-outliers.png alt=k8s-Heat-map style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-776fc9946930d3ebc9945073cd234296><img src=../tko/session-5/check-new-navigator-short/../images/set-find-outliers.png alt=k8s-Heat-map class=lightbox-image loading=lazy></a></p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>What happened to the Heatmap?</p></div></div><p>The <strong>Find outliers</strong> view is very useful when you need to view a selection of your workloads (or any service depending on the Navigator used) and quickly need to figure out if something has changed.</p><p>It will give you fast insight into items (workloads in our case) that are performing differently (both increased or decreased) which helps to make it easier to spot problems.</p><p>Now switch the <strong>Find Outliers</strong> option back to off.</p><h3 id=22-the-workload-overview-pane>2.2 The Workload Overview pane</h3><p>The workload overview gives you a quick insight of the status of your deployment. You can see at once if the pods of your deployments are Pending, Running, Failed, Succeeded or in an unknown state.</p><p><a href=#image-a53e3d878c92acdf071073d76356f6cd class=lightbox-link><img src=../tko/session-5/check-new-navigator-short/../images/k8s-workload-overview.png alt=k8s-workload-overview style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-a53e3d878c92acdf071073d76356f6cd><img src=../tko/session-5/check-new-navigator-short/../images/k8s-workload-overview.png alt=k8s-workload-overview class=lightbox-image loading=lazy></a></p><ul><li><em>Running:</em> Pods are deployed and in a running state</li><li><em>Pending:</em> Waiting to be deployed</li><li><em>Succeeded:</em> Pod has been deployed and completed its job and is finished</li><li><em>Failed:</em> Containers in the pod have run and returned some kind of error</li><li><em>Unknown:</em> Kubernetes isn&rsquo;t reporting any of the known states. (This may be during start or stopping of pods, for example).</li></ul><p>You can expand the Workload name by hovering your mouse on it, in case the name is longer than the chart allows.</p><p><a href=#image-98e2e1fcf9a7131e96728116dbd43665 class=lightbox-link><img src=../tko/session-5/check-new-navigator-short/../images/k8s-workload-hoover.png alt=k8s-workload-hoover style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-98e2e1fcf9a7131e96728116dbd43665><img src=../tko/session-5/check-new-navigator-short/../images/k8s-workload-hoover.png alt=k8s-workload-hoover class=lightbox-image loading=lazy></a></p><p>To filter to a specific workload, you can click on three dots <code>...</code> next to the workload name in the <strong>k8s.workload.name</strong> column and choose <strong>Filter</strong> from the dropdown box.</p><p><a href=#image-9a3b7417bfb44c80fd59026b7c5caa89 class=lightbox-link><img src=../tko/session-5/check-new-navigator-short/../images/workload-add-filter.png alt=workload-add-filter style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-9a3b7417bfb44c80fd59026b7c5caa89><img src=../tko/session-5/check-new-navigator-short/../images/workload-add-filter.png alt=workload-add-filter class=lightbox-image loading=lazy></a></p><p>This will add the selected workload to your filters. Try this for the <strong>splunk-otel-collector-k8s-cluster-receiver</strong> workload. It should give you a single rectangle in the <code>splunk</code> namespace.</p><p>Confirm that you have the right filter by hovering over the rectangle, and if it is indeed the <strong>splunk-otel-collector-k8s-cluster-receiver</strong> workload, by double-clicking on it. This brings you to a more detailed view of your workload.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>What are the CPU request & CPU limit units for the otel-collector?</p></div></div><p>At this point you can drill into the information of the pods, but that is outside the scope of this workshop, for now reset your view by removing the filter for the <strong>splunk-otel-collector-k8s-cluster-receiver</strong> workload and setting the <strong>Color by</strong> option to <strong>Pods Running</strong>.</p><h2 id=3-pivot-sidebar>3. Pivot Sidebar</h2><p>Later in the workshop, you will deploy an Apache server into your cluster which will create a new icon in the <strong>Pivot Sidebar</strong>.</p><p>As soon as any metric that is used by a Navigator, is flowing into your Observability org, the system will add that service to the Pivot Sidebar.</p><p>The Pivot Sidebar will expand and a link to the discovered service will be added as seen in the image below:</p><p><a href=#image-79c09559a9ce75c3feadf7a862370ee9 class=lightbox-link><img src=../tko/session-5/check-new-navigator-short/../images/pivotbar.png alt=pivotbar style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-79c09559a9ce75c3feadf7a862370ee9><img src=../tko/session-5/check-new-navigator-short/../images/pivotbar.png alt=pivotbar class=lightbox-image loading=lazy></a></p><p>This will allow for easy switching between Navigators. The same applies for your Apache server instance, it will have a Pivot Sidebar allowing you to quickly jump back to the Kubernetes navigator.</p><footer class=footline></footer></article><article class=default><h1 id=deploying-phpapache>Deploying PHP/Apache</h1><h2 id=1--dns-and-services-in-kubernetes>1. DNS and Services in Kubernetes</h2><p>The Domain Name System (DNS) is a mechanism for linking various sorts of information with easy-to-remember names, such as IP addresses. Using a DNS system to translate request names into IP addresses makes it easy for end-users to reach their target domain name effortlessly.</p><p>Most Kubernetes clusters include an internal DNS service configured by default to offer a lightweight approach for service discovery. Even when Pods and Services are created, deleted, or shifted between nodes, built-in service discovery simplifies applications to identify and communicate with services on the Kubernetes clusters.</p><p>In short, the DNS system for Kubernetes will create a DNS entry for each Pod and Service. In general, a Pod has the following DNS resolution:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>pod-name.my-namespace.pod.cluster-domain.example
</span></span></code></pre></div><p>For example, if a Pod in the <code>default</code> namespace has the Pod name <code>my_pod</code>, and the domain name for your cluster is <code>cluster.local</code>, then the Pod has a DNS name:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>my_pod.default.pod.cluster.local
</span></span></code></pre></div><p>Any Pods exposed by a Service have the following DNS resolution available:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>my_pod.service-name.my-namespace.svc.cluster-domain.example
</span></span></code></pre></div><p>More information can be found here : <a href=https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/ target=_blank>DNS for Service and Pods</a></p><h2 id=2-review-otel-receiver-for-phpapache>2. Review OTel receiver for PHP/Apache</h2><p>Inspect the YAML file <code>~/workshop/k3s/otel-apache.yaml</code> and validate the contents using the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/workshop/k3s/otel-apache.yaml
</span></span></code></pre></div><p>This file contains the configuration for the OpenTelemetry agent to monitor the PHP/Apache deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>agent</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>receivers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>receiver_creator</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>receivers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>smartagent/apache</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>rule</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type == &#34;port&#34; &amp;&amp; pod.name matches &#34;apache&#34; &amp;&amp; port == 80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>collectd/apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http://php-apache-svc.apache.svc.cluster.local/server-status?auto</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=3--observation-rules-in-the-opentelemetry-config>3. Observation Rules in the OpenTelemetry config</h2><p>The above file contains an observation rule for Apache using the OTel <code>receiver_creator</code>. This receiver can instantiate other receivers at runtime based on whether observed endpoints match a configured rule.</p><p>The configured rules will be evaluated for each endpoint discovered. If the rule evaluates to true, then the receiver for that rule will be started as configured against the matched endpoint.</p><p>In the file above we tell the OpenTelemetry agent to look for Pods that match the name <code>apache</code> and have port <code>80</code> open. Once found, the agent will configure an Apache receiver to read Apache metrics from the configured URL. Note, the K8s DNS based URL in the above YAML for the service.</p><p>To use the Apache configuration, you can upgrade the existing Splunk OpenTelemetry Collector Helm chart to use the <code>otel-apache.yaml</code> file with the following command:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Helm Upgrade" class="tab-nav-button active" onclick='switchTab("default","Helm Upgrade")'>
<span>Helm Upgrade</span></button></div><div class=tab-content><div data-tab-item="Helm Upgrade" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm upgrade splunk-otel-collector <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;splunkObservability.realm=</span><span style=color:#000>$REALM</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;splunkObservability.accessToken=</span><span style=color:#000>$ACCESS_TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;clusterName=</span><span style=color:#204a87;font-weight:700>$(</span>hostname<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>-k3s-cluster&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;splunkObservability.logsEnabled=true&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;splunkObservability.infrastructureMonitoringEventsEnabled=true&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>splunk-otel-collector-chart/splunk-otel-collector <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--namespace splunk <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>-f ~/workshop/k3s/splunk-defaults.yaml <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>-f ~/workshop/k3s/otel-apache.yaml
</span></span></code></pre></div></div></div></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> NOTE</div><div class=box-content><p>The <strong>REVISION</strong> number of the deployment has changed, which is a helpful way to keep track of your changes.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Release &#34;splunk-otel-collector&#34; has been upgraded. Happy Helming!
</span></span><span style=display:flex><span>NAME: splunk-otel-collector
</span></span><span style=display:flex><span>LAST DEPLOYED: Tue Jan 31 16:57:22 2023
</span></span><span style=display:flex><span>NAMESPACE: splunk
</span></span><span style=display:flex><span>STATUS: deployed
</span></span><span style=display:flex><span>REVISION: 2
</span></span><span style=display:flex><span>TEST SUITE: None
</span></span></code></pre></div></div></div><h2 id=4-kubernetes-configmaps>4. Kubernetes ConfigMaps</h2><p>A ConfigMap is an object in Kubernetes consisting of key-value pairs which can be injected into your application. With a ConfigMap, you can separate configuration from your Pods.</p><p>Using ConfigMap, you can prevent hardcoding configuration data. ConfigMaps are useful for storing and sharing non-sensitive, unencrypted configuration information.</p><p>The OpenTelemetry collector/agent uses ConfigMaps to store the configuration of the agent and the K8s Cluster receiver. You can/will always verify the current configuration of an agent after a change by running the following commands:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get cm -n splunk
</span></span></code></pre></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>How many ConfigMaps are used by the collector?</p></div></div><p>When you have list of ConfigMaps from the namespace, select the one for the <code>otel-agent</code> and view it with the following command:</p><p><strong>Note:</strong> The option <code>-o yaml</code> will print the content of the ConfigMap in a YAML format.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get cm splunk-otel-collector-otel-agent -n splunk -o yaml
</span></span></code></pre></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Is the content of <code>otel-apache.yaml</code> saved in the ConfigMap for the collector agent?</p></div></div><h2 id=5-review-phpapache-deployment-yaml>5. Review PHP/Apache deployment YAML</h2><p>Inspect the YAML file <code>~/workshop/k3s/php-apache.yaml</code> and validate the contents using the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/workshop/k3s/php-apache.yaml
</span></span></code></pre></div><p>This file contains the configuration for the PHP/Apache deployment and will create a new StatefulSet with a single replica of the PHP/Apache image.</p><p>A stateless application is one that does not care which network it is using, and it does not need permanent storage. Examples of stateless apps may include web servers such as Apache, Nginx, or Tomcat.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StatefulSet</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>php-apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>updateStrategy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RollingUpdate</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>run</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>php-apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>serviceName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;php-apache-svc&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>run</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>php-apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>php-apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ghcr.io/splunk/php-apache:latest</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;8&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;9Mi&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;6&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;4Mi&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>php-apache-svc</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>run</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>php-apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>run</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>php-apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=6-deploy-phpapache>6. Deploy PHP/Apache</h2><p>Create an apache namespace then deploy the PHP/Apache application to the cluster.</p><p>Create the <code>apache</code> namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create namespace apache
</span></span></code></pre></div><p>Deploy the PHP/Apache application:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f ~/workshop/k3s/php-apache.yaml -n apache
</span></span></code></pre></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>What metrics for your Apache instance are being reported in the Apache Navigator?</p><p><strong>Tip:</strong> Click on <strong>Infrastructure → Web Server → Apache web servers</strong> to go to the Navigator and look for a server with the same name as your EC2 host.</p></div></div><p>Ensure the deployment has been created:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get statefulset -n apache
</span></span></code></pre></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Using the Observability Kubernetes Navigator, can you find the status of the <code>php-apache</code> <strong>Workload</strong>?</p><p><strong>HINT:</strong> Filter by <code>k8s.cluster.name</code> to isolate your instance!</p></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Where else has the issue with <code>php-apache</code> been logged? What is being reported?</p><p><strong>HINT:</strong> Adjust your <strong>Table settings</strong> by clicking on the cog to use only <code>k8s.cluster.name</code>, <code>object.involvedObject.name</code> & <code>object.message</code>. Make sure you unselect <code>_raw</code>!</p></div></div><footer class=footline></footer></article><article class=default><h1 id=fix-phpapache-issue>Fix PHP/Apache Issue</h1><h2 id=1-kubernetes-resources>1. Kubernetes Resources</h2><p>Especially in Production Kubernetes Clusters, CPU and Memory are considered precious resources. Cluster Operators will normally require you to specify the amount of CPU and Memory your Pod or Service will require in the deployment, so they can have the Cluster automatically manage on which Node(s) your solution will be placed.</p><p>You do this by placing a Resource section in the deployment of you application/Pod</p><p><strong>Example:</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># Maximum amount of CPU &amp; memory for peek use</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;8&#34;</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#8f5902;font-style:italic># Maximum of 8 cores of CPU allowed at for peek use</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;9Mi&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># Maximum allowed 9Mb of memory</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#8f5902;font-style:italic># Request are the expected amount of CPU &amp; memory for normal use</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;6&#34;</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#8f5902;font-style:italic># Requesting 4 cores of a CPU</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;4Mi&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># Requesting 4Mb of memory</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>More information can be found here : <a href=https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/ target=_blank>Resource Management for Pods and Containers</a></p><p>If your application or Pod will go over the limits set in your deployment, Kubernetes will kill and restart your Pod to protect the other applications on the Cluster.</p><p>Another scenario that you will run into is when there is not enough Memory or CPU on a Node. In that case, the Cluster will try to reschedule your Pod(s) on a different Node with more space.</p><p>If that fails, or if there is not enough space when you deploy your application, the Cluster will put your workload/deployment in schedule mode until there is enough room on any of the available Nodes to deploy the Pods according their limits.</p><h2 id=2-fix-phpapache-deployment>2. Fix PHP/Apache Deployment</h2><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Before we start, let&rsquo;s check the current status of the PHP/Apache deployment. Under <strong>Alerts & Detectors</strong> which <strong>[TKO]</strong> detector has fired? Where else can you find this information?</p></div></div><p>To fix the PHP/Apache StatefulSet, edit <code>~/workshop/k3s/php-apache.yaml</code> using the following commands to reduce the CPU resources:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vim ~/workshop/k3s/php-apache.yaml
</span></span></code></pre></div><p>Find the resources section and reduce the CPU limits to <strong>1</strong> and the CPU requests to <strong>0.5</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;9Mi&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;0.5&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;4Mi&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Save the changes youhave made. (Hint: Use <code>Esc</code> followed by <code>:wq!</code> to save your changes).</p><p>Now, we must delete the existing StatefulSet and re-create it. StatefulSets are immutable, so we must delete the existing one and re-create it with the new changes.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl delete statefulset php-apache -n apache
</span></span></code></pre></div><p>Now, deploy your changes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f ~/workshop/k3s/php-apache.yaml -n apache
</span></span></code></pre></div><h2 id=3-validate-the-changes>3. Validate the changes</h2><p>You can validate the changes have been applied by running the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl describe statefulset php-apache -n apache
</span></span></code></pre></div><p>Validate the Pod is now running in Splunk Observability Cloud.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Is the <strong>Apache Web Servers</strong> dashboard showing any data now?</p><p><strong>Tip:</strong> Don&rsquo;t forget to use filters and time frames to narrow down your data.</p></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Another <strong>[TKO]</strong> Detector has fired, which one is it this time?</p></div></div><h2 id=4-fix-memory-issue>4. Fix memory issue</h2><p>If you navigate back to the Apache dashboard, you will notice that metrics are no longer coming in. We have another resource issue and this time we are Out of Memory. Let&rsquo;s edit the stateful set and increase the memory to what is shown in the image below:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl edit statefulset php-apache -n apache
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>16Mi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>500m</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>12Mi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Save the changes you have made.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-exclamation"></i> Hint</div><div class=box-content><p><code>kubectl edit</code> will open the contents in the <code>vi</code> editor, use <code>Esc</code> followed by <code>:wq!</code> to save your changes.</p></div></div><p>Because StatefulSets are immutable, we must delete the existing Pod and let the StatefulSet re-create it with the new changes.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl delete pod php-apache-0 -n apache
</span></span></code></pre></div><p>Validate the changes have been applied by running the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl describe statefulset php-apache -n apache
</span></span></code></pre></div><footer class=footline></footer></article><article class=default><h1 id=deploy-load-generator>Deploy Load Generator</h1><p>Now let&rsquo;s see how the autoscaler reacts to increased load. To do this, you&rsquo;ll start a different Pod to act as a client. The container within the client Pod runs in an infinite loop, sending queries to the <code>php-apache</code> service.</p><h2 id=1-review-loadgen-yaml>1. Review loadgen YAML</h2><p>Inspect the YAML file <code>~/workshop/k3s/loadgen.yaml</code> and validate the contents using the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/workshop/k3s/loadgen.yaml
</span></span></code></pre></div><p>This file contains the configuration for the load generator and will create a new StatefulSet with a single replica of the load generator image.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StatefulSet</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>loadgen</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>loadgen</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>serviceName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;loadgen&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>loadgen</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>loadgen</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>loadgen</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>infinite-calls</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>busybox</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>command</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>/bin/sh</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- -<span style=color:#000>c</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#4e9a06>&#34;while true; do wget -q -O- http://php-apache-svc.apache.svc.cluster.local; done&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=2-create-a-new-namespace>2. Create a new namespace</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>kubectl create namespace loadgen
</span></span></code></pre></div><h2 id=3-deploy-the-loadgen-yaml>3. Deploy the loadgen YAML</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>kubectl apply -f ~/workshop/k3s/loadgen.yaml --namespace loadgen
</span></span></code></pre></div><p>Once you have deployed the load generator, you can see the Pod running in the <code>loadgen</code> namespace. Use previous similar commands to check the status of the Pod from the command line.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>What metrics in the Apache Dashboard have now significantly increased?</p></div></div><h2 id=4-scale-the-load-generator>4. Scale the load generator</h2><p>A ReplicaSet is a process that runs multiple instances of a Pod and keeps the specified number of Pods constant. Its purpose is to maintain the specified number of Pod instances running in a cluster at any given time to prevent users from losing access to their application when a Pod fails or is inaccessible.</p><p>ReplicaSet helps bring up a new instance of a Pod when the existing one fails, scale it up when the running instances are not up to the specified number, and scale down or delete Pods if another instance with the same label is created. A ReplicaSet ensures that a specified number of Pod replicas are running continuously and helps with load-balancing in case of an increase in resource usage.</p><p>Let&rsquo;s scale our ReplicaSet to 4 replicas using the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>kubectl scale statefulset/loadgen --replicas 4 -n loadgen
</span></span></code></pre></div><p>Validate the replicas are running from both the command line and Splunk Observability Cloud:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>kubectl get statefulset loadgen -n loadgen
</span></span></code></pre></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>What impact did this have? Where in O11y can you see the increased replica number?</p></div></div><p>Let the load generator run for around 2-3 minutes and keep observing the metrics in the Kubernetes Navigator and the Apache Navigator.</p><footer class=footline></footer></article><article class=default><h1 id=setup-horizontal-pod-autoscaling-hpa>Setup Horizontal Pod Autoscaling (HPA)</h1><p>In Kubernetes, a HorizontalPodAutoscaler automatically updates a workload resource (such as a Deployment or StatefulSet), with the aim of automatically scaling the workload to match demand.</p><p>Horizontal scaling means that the response to increased load is to deploy more Pods. This is different from vertical scaling, which for Kubernetes would mean assigning more resources (for example: memory or CPU) to the Pods that are already running for the workload.</p><p>If the load decreases, and the number of Pods is above the configured minimum, the HorizontalPodAutoscaler instructs the workload resource (the Deployment, StatefulSet, or other similar resource) to scale back down.</p><h2 id=1-setup-hpa>1. Setup HPA</h2><p>Inspect the <code>~/workshop/k3s/hpa.yaml</code> file and validate the contents using the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/workshop/k3s/hpa.yaml
</span></span></code></pre></div><p>This file contains the configuration for the Horizontal Pod Autoscaler and will create a new HPA for the <code>php-apache</code> deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>autoscaling/v2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HorizontalPodAutoscaler</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>php-apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>maxReplicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>metrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Resource</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cpu</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>target</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>averageUtilization</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Utilization</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Resource</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>target</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>averageUtilization</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>75</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Utilization</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>minReplicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>scaleTargetRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StatefulSet</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>php-apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Once deployed, <code>php-apache</code> will autoscale when either the average CPU usage goes above 50% and average memory usage for the deployment goes above 75%, with a minimum of 1 pod and a maximum of 4 pods.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>kubectl apply -f ~/workshop/k3s/hpa.yaml
</span></span></code></pre></div><h2 id=2-validate-hpa>2. Validate HPA</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>kubectl get hpa -n apache
</span></span></code></pre></div><p>Go to the <strong>Workloads</strong> or <strong>Node Detail</strong> tab in Kubernetes and check the HPA deployment.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>How many additional <code>php-apache-x</code> pods have been created?</p></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Which metrics in the Apache Dashboards have significantly increased again?</p></div></div><h2 id=3-increase-the-hpa-replica-count>3. Increase the HPA replica count</h2><p>Increase the <code>maxReplicas</code> to 8</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl edit hpa php-apache -n apache
</span></span></code></pre></div><p>Save the changes youhave made. (Hint: Use <code>Esc</code> followed by <code>:wq!</code> to save your changes).</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>How many pods are now in a running state? How many are pending? Why are they pending?</p></div></div><p><strong>Congratulations!</strong> You have successfully completed the workshop.</p><footer class=footline></footer></article></section><article class=default><h1 id=6-o11y---distributed-tracing-for-modern-applications>6. O11y - Distributed Tracing for modern applications</h1><span class="btn cstyle transparent"><button type=button>
<i class="fa-fw fas fa-clock"></i>
45 minutes</button></span><p>Here at Buttercup Instruments, our business is expanding ! We have recently added 3 new locations, two locations in the USA, Colorado and Chicago and one international location in SRI Lanka !</p><p>Our technical staff has already on-boarded the data from these new locations and incorporated them into our inventory application and it is our job to review these improvements and send any issues back to our developers for repairs.</p><p>We now have a total of 6 locations !</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of 6. O11y - Distributed Tracing for modern applications</h1><article class=default><h1 id=6-o11y---distributed-tracing-for-modern-applications>6. O11y - Distributed Tracing for modern applications</h1><h2 id=set-environment-variables>Set Environment Variables</h2><p>Environment Variables:</p><p>Using nano edit .env in <code>javashop-otel</code> directory</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nano .env
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>SHOP_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;your_name&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>SPLUNK_ACCESS_TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;your_token&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>SPLUNK_REALM</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;your_realm&gt;</span>
</span></span></code></pre></div><p>Save in nano</p><p>CTRL-O ENTER</p><p>Exit nano</p><p>CTRL-X</p><h2 id=build-and-deploy-application>Build and Deploy Application</h2><p>Let&rsquo;s get started by building and deploying our Application, the Buttercup Instrument Shop. Run the commands below to begin and start reading ahead as your traces are coming up !</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> javashop-otel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><h2 id=users-and-workflows>Users and Workflows</h2><p>As we go through this workshop we will be switching roles from SRE to Developer. First we will start with alert responders or SREs who will identify an issue in Splunk Observability UI. Next, we will jump to a Developer Role to see how a Developer will debug and repair/fix a software problem using trace data provided by our SRE.</p><p>Of course, we are not requiring 2 people for this workshop as each participant will play both roles.</p><h2 id=today-we-will-learn>Today we will learn</h2><p>Today we will learn the type of data ( In the form of a trace ) that an SRE or alert responder would send to a developer to then repair/fix software. We will do this with both Auto-Instrumentation data and Custom attributes, via Manual Instrumentation data.</p><p>While we will be spending time Debugging code, &mldr;. Don&rsquo;t worry, &mldr;there is no programming experience necessary, as our goal here is for everyone in the audience to understand how using Custom Attributes in Splunk APM @ Full Fidelity can accelerate Mean Time to Repair Software problems for our customers.</p><p>Translated, Developers are High Cost resources, with high opportunity cost. Less time on fixing problems = more time for features.</p><h2 id=lets-define-a-few-terms-for-those-new-to-apm--software-development-or-java>Let&rsquo;s define a few terms for those new to APM / Software Development or Java</h2><ol><li>What&rsquo;s a Function in Java ?
A Function in most languages including Java, is a logical chunk of code when executed that solves a repeatable task. This is basically what our customers&rsquo; Dev teams spend their time building and where software issues will most commonly be.</li><li>What&rsquo;s a Method in Java ?
See What&rsquo;s a function -> Function and method are synonymous.</li><li>What&rsquo;s an Exception in Java ?
An Exceptional error condition that indicates abnormal or unhandled condition, that interrupts program execution abnormally.</li></ol><h2 id=view-service-map>View Service Map</h2><p>Please note it may take 3-4 minutes for traces to show up and you will see full map &ldquo;form&rdquo; as traces are coming in, so you may have to refresh the page a few times each time we Build and Deploy.</p><p>It is recommended to use a -5m look back during this lab. Start there, use 15 if you feel you have to.</p><p><a href=#image-8b42adb587cac5a6f7e562301dd9f77b class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/218923108-6c6a7efb-588e-4f7b-b788-768037eae4bb.png alt="Service Map" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-8b42adb587cac5a6f7e562301dd9f77b><img src=https://user-images.githubusercontent.com/32849847/218923108-6c6a7efb-588e-4f7b-b788-768037eae4bb.png alt="Service Map" class=lightbox-image loading=lazy></a></p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> NOTE</div><div class=box-content><p>Typically, to identify root cause and route an issue, an SRE or alert responder would check metrics and logs to determine if it is a software or hardware related issue, and thus route to the correct party. In this exercise we are ONLY handling software issues, so we are skipping the metrics and logs parts of normal triage.</p></div></div><p>If your instrumentation was successful, the service-map will show latency from the shop service to the products service.</p><p><a href=#image-56d5f43dafeff15ef61769fc2afca4a5 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/206541846-7f0e6462-7659-44bc-bc48-3621c2872fc4.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-56d5f43dafeff15ef61769fc2afca4a5><img src=https://user-images.githubusercontent.com/32849847/206541846-7f0e6462-7659-44bc-bc48-3621c2872fc4.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" class=lightbox-image loading=lazy></a></p><p>Ok let&rsquo;s triage this SOFTWARE ISSUE and skip directly to the traces.</p><ul><li>Click on shop service</li><li>Click Traces ( right side )</li><li>Sort by Duration</li></ul><p>Select the longest duration trace ( or one of the obvious much longer ones )</p><p><a href=#image-9e9508b5d6f347eb08b47880813ec7aa class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204347798-4f232b7f-7a7a-483f-9d61-f0b535e9ecf0.png alt=LongTrace style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-9e9508b5d6f347eb08b47880813ec7aa><img src=https://user-images.githubusercontent.com/32849847/204347798-4f232b7f-7a7a-483f-9d61-f0b535e9ecf0.png alt=LongTrace class=lightbox-image loading=lazy></a></p><p>Now we can see the long latency occurred in the products service and if we click on products: /products
we can see the offending method was products:ProductResource.getAllProducts</p><p><a href=#image-fa06c12cf528b2e841faf4dd18c2f271 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204347855-724545bf-c3df-478a-a27d-e4f85f708e15.png alt=long-trace-detail-GetAllProducts style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-fa06c12cf528b2e841faf4dd18c2f271><img src=https://user-images.githubusercontent.com/32849847/204347855-724545bf-c3df-478a-a27d-e4f85f708e15.png alt=long-trace-detail-GetAllProducts class=lightbox-image loading=lazy></a></p><p>Our next step here would be to send that trace to a developer by clicking download trace and
they will have to debug the function. Since we will be the developer there is no need to download the trace. Just remember that is normal workflow for alert responders to route an issue to the &ldquo;Repairers&rdquo; while providing trace data.</p><p>Before we do that please take note of the Tags available for the developer to leverage to find the root cause. We see standard out of the box Otel tags on the span, environmental information, but no indications of data specific to something inside custom code ( which is where the problem always is. )</p><h2 id=now-lets-play-the-role-of-the-developer>Now let&rsquo;s play the role of the developer</h2><p>As a developer we must debug the function products:ProductResource.getAllProducts to find the problem.</p><h2 id=debugging-101-the-line-by-line-method>Debugging 101, the Line by Line method</h2><p>Without anything to go on other than &ldquo;BAD FUNCTION&rdquo;, a Developer must then look at code visually line by line to find and fix the problem. To make this worse, Functions, call Functions and it can get very messy in bad code scenarios.</p><p>We will do the visual inspection method next.</p><p>Using Nano:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nano products/src/main/java/com/shabushabu/javashop/products/resources/ProductResource.java
</span></span></code></pre></div><p>Search in Nano
CTRL-W</p><p>Enter in: getAllProducts</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#5c35cc;font-weight:700>@GET</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Response</span> <span style=color:#000>getAllProducts</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@DefaultValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;California&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#5c35cc;font-weight:700>@QueryParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;location&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>       
</span></span><span style=display:flex><span>     <span style=color:#8f5902;font-style:italic>// STEP X: All we know right now is somewhere in this function, latency was introduced.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  
</span></span><span style=display:flex><span>     <span style=color:#000>myCoolFunction1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>     <span style=color:#000>myCoolFunction2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>     <span style=color:#000>myCoolFunction10</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>     <span style=color:#000>myCoolFunction13</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>     <span style=color:#000>myCoolFunction5</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>     <span style=color:#000>myCoolFunction6</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span></code></pre></div><p>We can see here in getAllProducts, the first call is to myCoolFunction1(), so as may have guessed our next step is to go look at myCoolFunction1()</p><p>Search in Nano
CTRL-W</p><p>Enter in: myCoolFunction1</p><p>CTRL-W</p><p>Enter in: ENTER</p><p>Keep doing that until you get to the actual function definition, it looks like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>myCoolFunction1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// Generate a FAST sleep of 0 time !
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sleepy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lookupLocation1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sleepy</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>Now, myCoolFunction1 calls lookupLocation1(location)</p><p>Search in Nano
CTRL-W</p><p>Enter in: lookupLocation1</p><p>I think you get the picture by now, you have no choice but to inspect every line of code and every function called and visually inspect them for problems. This can be a VERY long process and kills our customers Mean time to Repair. This happens quite often to our customers with our competition because they can&rsquo;t provide all the traces 100% of the time and most can&rsquo;t scale to add more data, via Custom Attributes on top of that !</p><p>Remember, without Full Fidelity, you have to either reproduce errors / latency in another environment or inspect code line by line.</p><p>So they are stuck where we are, quite often.</p><p>OK, enough fun ..let&rsquo;s make this easier for our developer&mldr; and show off some Splunk APM Scale!</p><p>OK, exit your editor:</p><p>Edit nano CTRL-X ( DO NOT SAVE IF MODIFIED )</p><h2 id=custom-attribution>Custom Attribution</h2><p>To take a deeper look at this issue and make this much easier to debug we will implement Custom Attributes via Opentelemetry Manual Instrumentation.</p><p>To speed up manual instrumentation in Java you can leverage <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotations</a>, which automatically create a span around a method without modifying the actual code inside the method. This can be very valuable if you are working with an SRE that may have limited access to source code changes.</p><p>To add even more information to help our developers find the root cause faster,
<a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotations</a> can be used to generate span tags with parameter values for the method in question. This is incredibly important to mean time to Repair, because as a Developer, if I know the parameter values of a function at the time of latency or error, I can debug this without having to reproduce an issue in another environment if I have Full Fidelity Tracing.</p><p>Splunk Full Fidelity APM allows our customers&rsquo; development teams to debug their code as it runs in production, 100% of the time . With Custom Attribution, you are providing repeatable Mean Time to Repair reduction&mldr; 100% of the time, only with Full Fidelity tracing.</p><p>To expedite manual instrumentation implementation for this exercise, we have provided a tool which will annotate the entirety of the &ldquo;shop&rdquo; and &ldquo;products&rdquo; services with OpenTelemetry standard annotations for every method call without having to write any code. This &ldquo;annotator&rdquo; tool will also tag every parameter in every function, which adds a span tag with Parameter=Value.</p><h2 id=run-manual-instrumentation-tool>Run Manual Instrumentation Tool</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> javashop-otel directory
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./AutomateManualInstrumentation.sh
</span></span></code></pre></div><h2 id=rebuild-and-deploy-application>Rebuild and Deploy Application</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Now that we have rebuilt and deployed our application, traffic is being sent once again.</p><p>Go back to the Splunk Observability UI and let&rsquo;s see if these annotations help us narrow down the root cause more quickly.</p><p>Let&rsquo;s try to find our latency root cause again, this time with every function and every parameter spanned and tagged respectively&mldr;. You will see exactly what this means and how it benefits developers in a moment&mldr;</p><p><a href=#image-486b005b3becbc743f48a4e45bf256a3 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/206541846-7f0e6462-7659-44bc-bc48-3621c2872fc4.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-486b005b3becbc743f48a4e45bf256a3><img src=https://user-images.githubusercontent.com/32849847/206541846-7f0e6462-7659-44bc-bc48-3621c2872fc4.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" class=lightbox-image loading=lazy></a></p><ul><li>Click on shop service</li><li>Click Traces ( right side )</li><li>Sort by Duration</li></ul><p>Select the longest duration trace ( or one of the obvious much longer ones )</p><p><a href=#image-c51b74ac4a90d2b6cc8aaf65ff7f9af5 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/213582624-66466a19-00fa-4dda-acd0-f6970d594ba1.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-c51b74ac4a90d2b6cc8aaf65ff7f9af5><img src=https://user-images.githubusercontent.com/32849847/213582624-66466a19-00fa-4dda-acd0-f6970d594ba1.png alt=image class=lightbox-image loading=lazy></a></p><p>We can see that the actual function call that has the latency was not ProductResource.getAllProducts but the function call &ldquo;ProductResource.myCoolFunction234234234&rdquo; !</p><p>Since we now have the parameter tagged as part of our span metadata the actual root cause is seemingly related to the &ldquo;location&rdquo; Colorado ! And it appears the one custom attribute that was tagged for the function &ldquo;ProductResource.myCoolFunction234234234&rdquo; was &ldquo;myInt&rdquo; with a value of 999. With this information a Developer can debug very quickly.</p><p>Consider the case of debugging code which each of you have just experienced. Imagine that you may have not written the code yourself and the code is a mess, which I can tell you from a former developer, everyone else&rsquo;s code sucks&mldr;. So without Parameter Values at the time of the issue .. You would have no choice but to go line &mldr;. by line &mldr;.. by line&mldr;.. which I am sorry I forced you to do earlier&mldr; this can take a very long time.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> NOTE</div><div class=box-content><p>We added additional span information, which we call &ldquo;Custom Attributes&rdquo; here at Splunk, in this case our &ldquo;Custom Attributes&rdquo; are &ldquo;Parameter Values at Time of Latency&rdquo;.</p></div></div><p>In our example the &ldquo;Location&rdquo; tag was created due our handy Annotator, that did the <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotations</a> for us.</p><p>Using nano:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nano products/src/main/java/com/shabushabu/javashop/products/resources/ProductResource.java
</span></span></code></pre></div><p>Search in Nano
CTRL-W</p><p>Enter in: 999</p><p>We can see here, someone wrote some very bad code in the form of a long Sleep !</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>999</span><span style=color:#ce5c00;font-weight:700>==</span><span style=color:#000>myInt</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>sleepy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5000</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#0000cf;font-weight:700>3000</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>3000</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><h2 id=how-did-we-get-here--how-did-the-999-end-up-in-the-trace-as-a-custom-attribute->How did we get here ? How did the 999 end up in the trace as a Custom Attribute ?</h2><p>Take a look at the function signature</p><p>private void myCoolFunction234234234(@SpanAttribute(&ldquo;myInt&rdquo;) int myInt)</p><p>@SpanAttribute(&ldquo;myint&rdquo;) is an Opentelemetry Java Annotation that was added by our Java Otel Annotator tool.</p><p>Let&rsquo;s fix our code.</p><p>Change this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>myCoolFunction234234234</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@SpanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;myInt&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>myInt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Generate a FAST sleep of 0 time !
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Random</span> <span style=color:#000>sleepy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Random</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>999</span><span style=color:#ce5c00;font-weight:700>==</span><span style=color:#000>myInt</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>sleepy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5000</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#0000cf;font-weight:700>3000</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>3000</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span></code></pre></div><p>To this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>myCoolFunction234234234</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@SpanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;myInt&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>myInt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Generate a FAST sleep of 0 time !
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Random</span> <span style=color:#000>sleepy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Random</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// if (999==myInt)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  Thread.sleep(
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  sleepy.nextInt(5000 - 3000)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  + 3000);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span></code></pre></div><p>Using nano</p><p>place comments before every line in myCoolFunction234234234</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// if (999==myInt)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  Thread.sleep(
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  sleepy.nextInt(5000 - 3000)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  + 3000);
</span></span></span></code></pre></div><p>Write out changes in nano</p><p>CTRL-O</p><p>CTRL-X to exit.</p><p>Make sure you saved your changes to: products/src/main/java/com/shabushabu/javashop/products/resources/ProductResource.java</p><h2 id=lets-go-see-if-our-manual-instrumentation-uncovered-any-other-issues-we-did-not-see-before>Let&rsquo;s go see if our manual instrumentation uncovered any other issues we did not see before</h2><p>So you may be asking yourself, &ldquo;How does manual instrumentation alone show us &ldquo;more problems&rdquo; than before latency is latency is it ?</p><p>The answer is, with auto-instrumentation you are in most situations NOT covering functions our customers&rsquo; development teams wrote, which is of course the bulk of what developers do, they write functions&mldr;. and of course this is where the bulk of software problems occur.</p><p>You may have noticed a new exception in our trace that was not present with Auto-Instrumentation during our latency fix use-case. Since we skipped over this, let&rsquo;s walk you through it.</p><p>Return to the service map</p><ul><li>Click on shop service</li><li>Click Traces ( right side )</li><li>Select &ldquo;Errors Only&rdquo;</li></ul><p><a href=#image-7c0d589b7aa2b4bd85f6c7f90e86205d class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204348492-84a4ad45-e11c-4e75-a6a9-d6e52e0eb13e.png alt="Screen Shot 2022-11-28 at 7 36 50 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-7c0d589b7aa2b4bd85f6c7f90e86205d><img src=https://user-images.githubusercontent.com/32849847/204348492-84a4ad45-e11c-4e75-a6a9-d6e52e0eb13e.png alt="Screen Shot 2022-11-28 at 7 36 50 AM" class=lightbox-image loading=lazy></a></p><p>Note: we haven&rsquo;t changed the code at all by adding annotations.</p><p>Click on a trace with an error present</p><p><a href=#image-fd29c4089b03eb8c8a397a27a648cce0 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204348687-12241153-b297-4bd7-9ea8-4b410369e82c.png alt="Screen Shot 2022-11-28 at 7 38 33 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-fd29c4089b03eb8c8a397a27a648cce0><img src=https://user-images.githubusercontent.com/32849847/204348687-12241153-b297-4bd7-9ea8-4b410369e82c.png alt="Screen Shot 2022-11-28 at 7 38 33 AM" class=lightbox-image loading=lazy></a></p><p>We can see our Exception is InvalidLocaleException !</p><p>The real problem must be related to the new data associated with SRI LANKA as the Exception says &ldquo;Non English Characters found in Instrument Data.</p><p>This exception had not surfaced in previous traces based on ONLY Auto-Instrumentation because the method where it was thrown was NOT covered with Auto-Instrumentation.</p><p>Once we completed the Manual Instrumentation via the Otel Annotator, this method was instrumented and we can now see we had a buried Exception being thrown.</p><h2 id=lets-play-developer-once-again-and-fix-our-issue>Let&rsquo;s play Developer once again and fix our issue</h2><p>We already know exactly what file to look in and what method to look at as it is called out in the trace.</p><p><a href=#image-b415b0a4e36016bf6cfb5db05611fefd class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349038-3b43a5ba-18e3-4d58-8985-29ee1f7da40a.png alt="Screen Shot 2022-11-28 at 7 43 58 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-b415b0a4e36016bf6cfb5db05611fefd><img src=https://user-images.githubusercontent.com/32849847/204349038-3b43a5ba-18e3-4d58-8985-29ee1f7da40a.png alt="Screen Shot 2022-11-28 at 7 43 58 AM" class=lightbox-image loading=lazy></a></p><p>Edit the file</p><p>Using nano</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nano shop/src/main/java/com/shabushabu/javashop/shop/model/Instrument.java
</span></span></code></pre></div><p>Search in Nano
CTRL-W</p><p>Enter in: buildForLocale</p><p>Look just above the buildForLocale function, notice the Annotation @WithSpan? @WithSpan is an <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotation</a> for Java that automatically generates a span around the function that follows.</p><p><a href=#image-83fa94840e97793c77da85e85993d1db class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349143-1e35b6e4-4059-4c56-8718-76c14d41727c.png alt="Screen Shot 2022-11-28 at 7 45 13 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-83fa94840e97793c77da85e85993d1db><img src=https://user-images.githubusercontent.com/32849847/204349143-1e35b6e4-4059-4c56-8718-76c14d41727c.png alt="Screen Shot 2022-11-28 at 7 45 13 AM" class=lightbox-image loading=lazy></a></p><p>Now let&rsquo;s fix this code. We are going to simply comment this out for now and see if it fixes our latency issue.</p><p>Using nano</p><p>Place comments in front of the entire if statement as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isEnglish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>title</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InvalidLocaleException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Non English Characters found in Instrument Data&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Characters OK &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>To this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//if (!isEnglish(title)) {
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  throw new InvalidLocaleException(&#34;Non English Characters found in Instrument Data&#34;);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// } else {
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  System.out.println(&#34;Characters OK &#34;);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//}
</span></span></span></code></pre></div><p>Save Changes in nano</p><p>CTRL-O</p><p>Exit nano</p><p>CTRL-X</p><p>Make sure you saved your changes to shop/src/main/java/com/shabushabu/javashop/shop/model/Instrument.java</p><h2 id=rebuild-and-deploy-application-1>Rebuild and Deploy Application</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>We are waiting a few minutes&mldr;</p><p>Return to the service map</p><p>If you do NOT see RED in your service map, you have completed the Latency Repair for the Colorado Location !</p><p>Now let&rsquo;s check for our exception in the traces.</p><ul><li>Click on shop service</li><li>Click Traces ( right side )</li><li>Select &ldquo;Errors Only&rdquo;</li></ul><p>If you do not have red in your service map and you do not see Errors in traces, you have successfully completed our Inventory application review for Sri Lanka and Colorado locations!!</p><h2 id=we-are-nearly-done-one-more-location-to-go-chicago>We are nearly done, one more location to go&mldr; Chicago</h2><p>Last but not least, let&rsquo;s ensure Chicago was on-boarded correctly. However, since we have been having so many issues related to &ldquo;location&rdquo; and we have added that custom attribute via Opentelemetry Manual Instrumentation, let&rsquo;s go to the Splunk Observability UI and look at an APM metric set around that tag that I created for us.</p><p><a href=#image-9976fb9516ccb11c546039c899d34eec class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/213540265-5b0567ab-c9f3-412f-bec0-07277c7e8650.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-9976fb9516ccb11c546039c899d34eec><img src=https://user-images.githubusercontent.com/32849847/213540265-5b0567ab-c9f3-412f-bec0-07277c7e8650.png alt=image class=lightbox-image loading=lazy></a></p><p>Open a browser and navigate to <a href=http://localhost:8010 target=_blank>http://localhost:8010</a></p><p>Select a few locations and hit the login button, remember to select the Chicago Location and Login</p><p><a href=#image-82a710372826c9b826f8921a865fd8ce class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/213541843-30266285-787f-493b-bc90-ffb4ac6e4c77.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-82a710372826c9b826f8921a865fd8ce><img src=https://user-images.githubusercontent.com/32849847/213541843-30266285-787f-493b-bc90-ffb4ac6e4c77.png alt=image class=lightbox-image loading=lazy></a></p><p>Uhh ohh ! We received a 500 error, something is wrong there as well.</p><p><a href=#image-a278332c167984c777803dd520b97147 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349595-fca270ad-379e-48c5-b2e1-7f222af82c55.png alt="Screen Shot 2022-11-28 at 8 11 47 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-a278332c167984c777803dd520b97147><img src=https://user-images.githubusercontent.com/32849847/204349595-fca270ad-379e-48c5-b2e1-7f222af82c55.png alt="Screen Shot 2022-11-28 at 8 11 47 AM" class=lightbox-image loading=lazy></a></p><p>Return to the Splunk Observability UI and lets look once again at our Service Map, select the Instruments Service and click the breakdowns on the right and select &ldquo;location&rdquo;</p><p><a href=#image-1288bbfc6e408d4928f4519c0d2d2c6b class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/214941419-2eaae297-e246-460b-a913-28c2a28fcd6a.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-1288bbfc6e408d4928f4519c0d2d2c6b><img src=https://user-images.githubusercontent.com/32849847/214941419-2eaae297-e246-460b-a913-28c2a28fcd6a.png alt=image class=lightbox-image loading=lazy></a></p><p>We see there was an un-handled exception thrown in Instruments service and some latency from our database that is related to the Chicago location !</p><ul><li>Click on Traces on the right</li><li>Select &ldquo;Errors Only&rdquo;</li></ul><p><a href=#image-40f63d28c9bd4e7d455336765c70a879 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349696-dc19d62f-ed82-4533-ad27-138237821b8e.png alt="Screen Shot 2022-11-28 at 8 14 50 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-40f63d28c9bd4e7d455336765c70a879><img src=https://user-images.githubusercontent.com/32849847/204349696-dc19d62f-ed82-4533-ad27-138237821b8e.png alt="Screen Shot 2022-11-28 at 8 14 50 AM" class=lightbox-image loading=lazy></a></p><p>We can see the exception was thrown by Hibernate, however it was thrown in our method &ldquo;instruments: InstrumentRepository.findInstruments&rdquo;</p><p><a href=#image-be6651c37555beba800e56ead6550af7 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204351905-03fe632b-b21c-4e8d-8044-dc582fed2253.png alt="Screen Shot 2022-11-28 at 8 14 37 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-be6651c37555beba800e56ead6550af7><img src=https://user-images.githubusercontent.com/32849847/204351905-03fe632b-b21c-4e8d-8044-dc582fed2253.png alt="Screen Shot 2022-11-28 at 8 14 37 AM" class=lightbox-image loading=lazy></a></p><h2 id=lets-play-developer-again>Let&rsquo;s play developer again</h2><p>Edit the file &ldquo;instruments: InstrumentRepository.findInstruments&rdquo;</p><p>Using nano</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nano instruments/src/main/java/com/shabushabu/javashop/instruments/repositories/FindInstrumentRepositoryImpl.java
</span></span></code></pre></div><p><a href=#image-cf13741a0c4f4fda2df862b3e1cc9afd class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349802-06135d9d-d70b-4cf1-aaea-3ba737e5c2b9.png alt="Screen Shot 2022-11-28 at 8 20 24 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-cf13741a0c4f4fda2df862b3e1cc9afd><img src=https://user-images.githubusercontent.com/32849847/204349802-06135d9d-d70b-4cf1-aaea-3ba737e5c2b9.png alt="Screen Shot 2022-11-28 at 8 20 24 AM" class=lightbox-image loading=lazy></a></p><p>We can see the developer accidently added the Instruments database with the Chicago Instruments database !</p><p>Let&rsquo;s change the query and fix this, remove &ldquo;instruments_for_sale&rdquo; from our Query</p><p>Change this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>findInstruments</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;findInstruments Called (All)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#000>Object</span> <span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entityManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createNativeQuery</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#4e9a06>&#34;SELECT * FROM instruments_for_sale, instruments_for_sale_chicago&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getResultList</span><span style=color:#ce5c00;font-weight:700>();</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>To this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// public Object findInstruments() {
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//   LOGGER.info(&#34;findInstruments Called (All)&#34;);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//   Object obj = entityManager.createNativeQuery( &#34;SELECT * FROM instruments_for_sale_chicago&#34;).getResultList(); 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  return obj;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//}
</span></span></span></code></pre></div><p>Save Changes in nano</p><p>CTRL-O</p><p>Exit nano</p><p>CTRL-X</p><h3 id=build-and-deploy-application-1>Build and Deploy Application</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> javashop-otel directory
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Now let&rsquo;s test the Chicago location once again</p><ul><li>Open a browser and navigate to <a href=http://localhost:8010 target=_blank>http://localhost:8010</a></li><li>Select the Chicago Location and Login</li></ul><p>We now see the 500 error is gone! Let&rsquo;s confirm a clean Service Map</p><p><a href=#image-17b0032b1182b2a83d07021e835eff69 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204350088-fca43e3c-42ea-4933-8a61-01eb2083fd23.png alt="Screen Shot 2022-11-28 at 8 35 11 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-17b0032b1182b2a83d07021e835eff69><img src=https://user-images.githubusercontent.com/32849847/204350088-fca43e3c-42ea-4933-8a61-01eb2083fd23.png alt="Screen Shot 2022-11-28 at 8 35 11 AM" class=lightbox-image loading=lazy></a></p><p>If you see a clean service map, free of errors and Latency you have successfully completed the Java Instrumentation Workshop!</p><p><strong>Have a lovely day.</strong></p><footer class=footline></footer></article><article class=default><h1 id=build-a-distributed-trace-in-lambda>Build a Distributed Trace in Lambda</h1><p>This lab will make a tracing superhero out of you!</p><p>In this lab you will learn how a distributed trace is constructed for a small serverless application that runs on <a href=https://aws.amazon.com/lambda/ target=_blank>AWS Lambda</a>, producing and consuming your message via <a href=https://aws.amazon.com/kinesis/ target=_blank>AWS Kinesis</a>.</p><p><a href=#image-be66d4a824dc3202181ec16ad18d2dcf class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219358330-50022c0d-7882-47a3-a047-c4edda81de0d.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-be66d4a824dc3202181ec16ad18d2dcf><img src=https://user-images.githubusercontent.com/5187861/219358330-50022c0d-7882-47a3-a047-c4edda81de0d.png alt=image class=lightbox-image loading=lazy></a></p><h2 id=pre-requisites>Pre-Requisites</h2><p>You should already have the lab content available on your EC2 lab host.</p><p>Ensure that this lab&rsquo;s required folder <code>o11y-lambda-lab</code> is on your home directory:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button>
<button data-tab-item=Output class=tab-nav-button onclick='switchTab("default","Output")'>
<span>Output</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~ <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> ls
</span></span></code></pre></div></div><div data-tab-item=Output class=tab-content-text><p>o11y-lambda-lab</p></div></div></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>If you don&rsquo;t see it, fetch the lab contents by running the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/kdroukman/o11y-lambda-lab.git
</span></span></code></pre></div></div></div><h3 id=1-set-environment-variables>1. Set Environment Variables</h3><p>In your Splunk Observability Cloud Organisation (Org) obtain your Access Token and Realm Values.</p><p>Please reset your environment variables from the earlier lab. Take care that for this lab we may be using different names - make sure to match the Environment Variable names bellow.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Export Environment Variables" class="tab-nav-button active" onclick='switchTab("default","Export Environment Variables")'>
<span>Export Environment Variables</span></button></div><div class=tab-content><div data-tab-item="Export Environment Variables" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ACCESS_TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span>CHANGE_ME <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span><span style=color:#204a87>export</span> <span style=color:#000>REALM</span><span style=color:#ce5c00;font-weight:700>=</span>CHANGE_ME <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span><span style=color:#204a87>export</span> <span style=color:#000>PREFIX</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>hostname<span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div></div></div></div><h3 id=2-update-auto-instrumentation-serverless-template>2. Update Auto-instrumentation serverless template</h3><p>Update your auto-instrumentation Serverless template to include new values from the Enviornment variables.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Substitute Environment Variables" class="tab-nav-button active" onclick='switchTab("default","Substitute Environment Variables")'>
<span>Substitute Environment Variables</span></button></div><div class=tab-content><div data-tab-item="Substitute Environment Variables" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/o11y-lambda-lab/auto/serverless_unset.yml <span style=color:#000;font-weight:700>|</span> envsubst &gt; ~/o11y-lambda-lab/auto/serverless.yml
</span></span></code></pre></div></div></div></div><p>Examine the output of the updated serverless.yml contents (you may need to scroll up to the relevant section).</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Check file contents" class="tab-nav-button active" onclick='switchTab("default","Check file contents")'>
<span>Check file contents</span></button>
<button data-tab-item="Expected Content" class=tab-nav-button onclick='switchTab("default","Expected Content")'>
<span>Expected Content</span></button></div><div class=tab-content><div data-tab-item="Check file contents" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/o11y-lambda-lab/auto/serverless.yml
</span></span></code></pre></div></div><div data-tab-item="Expected Content" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># USER SET VALUES =====================              
</span></span><span style=display:flex><span>custom: 
</span></span><span style=display:flex><span>  accessToken: &lt;updated to your Access Token&gt;
</span></span><span style=display:flex><span>  realm: &lt;updated to your Realm&gt;
</span></span><span style=display:flex><span>  prefix: &lt;updated to your Hostname&gt;
</span></span><span style=display:flex><span>#====================================== 
</span></span></code></pre></div></div></div></div><h3 id=3-update-manual-instrumentation-template>3. Update Manual instrumentation template</h3><p>Update your manual instrumentation Serverless template to include new values from the Enviornment variables.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Substitute Environment Variables" class="tab-nav-button active" onclick='switchTab("default","Substitute Environment Variables")'>
<span>Substitute Environment Variables</span></button></div><div class=tab-content><div data-tab-item="Substitute Environment Variables" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/o11y-lambda-lab/manual/serverless_unset.yml <span style=color:#000;font-weight:700>|</span> envsubst &gt; ~/o11y-lambda-lab/manual/serverless.yml
</span></span></code></pre></div></div></div></div><p>Examine the output of the updated serverless.yml contents (you may need to scroll up to the relevant section).</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Check file contents" class="tab-nav-button active" onclick='switchTab("default","Check file contents")'>
<span>Check file contents</span></button>
<button data-tab-item="Expected Content" class=tab-nav-button onclick='switchTab("default","Expected Content")'>
<span>Expected Content</span></button></div><div class=tab-content><div data-tab-item="Check file contents" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/o11y-lambda-lab/manual/serverless.yml
</span></span></code></pre></div></div><div data-tab-item="Expected Content" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># USER SET VALUES =====================              
</span></span><span style=display:flex><span>custom: 
</span></span><span style=display:flex><span>  accessToken: &lt;updated to your Access Token&gt;
</span></span><span style=display:flex><span>  realm: &lt;updated to your Realm&gt;
</span></span><span style=display:flex><span>  prefix: &lt;updated to your Hostname&gt;
</span></span><span style=display:flex><span>#====================================== 
</span></span></code></pre></div></div></div></div><h3 id=4-set-your-aws-credentials>4. Set your AWS Credentials</h3><p>You will be provided with AWS Access Key ID and AWS Secret Access Key values - substitue these values in place of <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_ACCESS_KEY_SECRET</code> in the bellow command:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Set AWS Credentials" class="tab-nav-button active" onclick='switchTab("default","Set AWS Credentials")'>
<span>Set AWS Credentials</span></button></div><div class=tab-content><div data-tab-item="Set AWS Credentials" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls config credentials --provider aws --key AWS_ACCCESS_KEY_ID --secret AWS_ACCESS_KEY_SECRET
</span></span></code></pre></div></div></div></div><p>This command will create a file <code>~/.aws/credentials</code> with your AWS Credentails populated.</p><p>Note that we are using <code>sls</code> here, which is a <a href=https://www.serverless.com/ target=_blank>Serverless</a> framework for developing and deploying AWS Lambda functions. We will be using this command throughout the lab.</p><p>Now you are set up and ready go!</p><h2 id=auto-instrumentation>Auto-Instrumentation</h2><p>Navigate to the <code>auto</code> directory that contains auto-instrumentation code.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/o11y-lambda-lab/auto
</span></span></code></pre></div></div></div></div><p>Inspect the contents of the files in this directory.
Take a look at the <code>serverless.yml</code> template.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat serverless.yml
</span></span></code></pre></div></div></div></div><ol><li>Can you identify which AWS entities are being created by this template?</li><li>Can you identify where OpenTelemetry instrumentation is being set up?</li><li>Can you determine which instrumentation information is being provided by the Environment Variables?</li></ol><p>You should see the Splunk OpenTelemetry Lambda layer being added to each fuction.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>layers:
</span></span><span style=display:flex><span>      - arn:aws:lambda:us-east-1:254067382080:layer:splunk-apm:70
</span></span></code></pre></div><p>You can see the relevant layer ARNs (Amazon Resource Name) and latest versions for each AWS region here: <a href=https://github.com/signalfx/lambda-layer-versions/blob/main/splunk-apm/splunk-apm.md target=_blank>https://github.com/signalfx/lambda-layer-versions/blob/main/splunk-apm/splunk-apm.md</a></p><p>You should also see a section where the Environment variables that are being set.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span> environment:
</span></span><span style=display:flex><span>      AWS_LAMBDA_EXEC_WRAPPER: /opt/nodejs-otel-handler
</span></span><span style=display:flex><span>      OTEL_RESOURCE_ATTRIBUTES: deployment.environment=${self:custom.prefix}-apm-lambda
</span></span><span style=display:flex><span>      OTEL_SERVICE_NAME: consumer-lambda
</span></span><span style=display:flex><span>      SPLUNK_ACCESS_TOKEN: ${self:custom.accessToken}
</span></span><span style=display:flex><span>      SPLUNK_REALM: ${self:custom.realm}
</span></span></code></pre></div><p>Using the environment variables we are configuring and enriching our auto-instrumentation.</p><p>Here we provide minimum information, such as NodeJS wrapper location in the Splunk APM Layer, environment name, service name, and our Splunk Org credentials. We are sending trace data directly to Splunk Observability Cloud. You could alternatively export traces to an OpenTelemetry Collector set up in <a href=https://opentelemetry.io/docs/collector/deployment/#gateway target=_blank>Gateway</a> mode.</p><p>Take a look at the function code.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat handler.js
</span></span></code></pre></div></div></div></div><ol><li>Can you identify the code for <strong>producer</strong> function?</li><li>Can you identify the code for <strong>consumer</strong> function?</li></ol><p>Notice there is no mention of Splunk or OpenTelemetry in the code. We are adding the instrumentation using the Lambda layer and Environment Variables only.</p><h3 id=deploy-your-lambdas>Deploy your Lambdas</h3><p>Run the following command to deploy your Lambda Functions:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Deploy Command" class="tab-nav-button active" onclick='switchTab("default","Deploy Command")'>
<span>Deploy Command</span></button>
<button data-tab-item="Expected Output" class=tab-nav-button onclick='switchTab("default","Expected Output")'>
<span>Expected Output</span></button></div><div class=tab-content><div data-tab-item="Deploy Command" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls deploy
</span></span></code></pre></div></div><div data-tab-item="Expected Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Deploying hostname-lambda-lab to stage dev (us-east-1)
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>endpoint: POST - https://randomstring.execute-api.us-east-1.amazonaws.com/dev/producer
</span></span><span style=display:flex><span>functions:
</span></span><span style=display:flex><span>  producer: hostname-lambda-lab-dev-producer (1.6 kB)
</span></span><span style=display:flex><span>  consumer: hostname-lambda-lab-dev-consumer (1.6 kB)
</span></span></code></pre></div></div></div></div><p>This command will follow the instructions in your <code>serverless.yml</code> template to create your Lambda functions and your Kinesis stream.
Note it may take a <em>1-2 minutes</em> to execute.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p><code>serverless.yml</code> is in fact a CloudFormation template. CloudFormation is an infrastructure as code service from AWS. You can read more about it here - <a href=https://aws.amazon.com/cloudformation/ target=_blank>https://aws.amazon.com/cloudformation/</a></p></div></div><p>Check the details of your serverless functions:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls info
</span></span></code></pre></div></div></div></div><p>Take note of your endpoint value:</p><p><a href=#image-c4c0cf0dd6dc4d5f9458775dc3413da5 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219366650-2babbe19-8253-43a0-8521-f47c1dda7200.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-c4c0cf0dd6dc4d5f9458775dc3413da5><img src=https://user-images.githubusercontent.com/5187861/219366650-2babbe19-8253-43a0-8521-f47c1dda7200.png alt=image class=lightbox-image loading=lazy></a></p><h3 id=send-some-traffic>Send some Traffic</h3><p>Use the <code>curl</code> command to send a payload to your <strong>producer</strong> function.
Note the command option <code>-d</code> is followed by your message payload.</p><p>Try changing the value of <code>name</code> to your name and telling the Lambda function about your <code>superpower</code>.
Replace <code>YOUR_ENDPOINT</code> with the endpoint from your previous step.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -d <span style=color:#4e9a06>&#39;{ &#34;name&#34;: &#34;CHANGE_ME&#34;, &#34;superpower&#34;: &#34;CHANGE_ME&#34; }&#39;</span> YOUR_ENDPOINT
</span></span></code></pre></div></div></div></div><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>curl -d &#39;{ &#34;name&#34;: &#34;Kate&#34;, &#34;superpower&#34;: &#34;Distributed Tracing&#34; }&#39; https://xvq043lj45.execute-api.us-east-1.amazonaws.com/dev/producer
</span></span></code></pre></div><p>You should see the following output if your message is successful:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>&#34;message&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;Message placed in the Event Stream: hostname-eventSteam&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>If unsuccessful, you will see:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>&#34;message&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Internal server error&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>If this occurs, ask one of the lab facilitators for assistance.</p><p>If you see a success message, generate more load: <em>re-send that messate <strong>5+ times</strong></em>.
You should keep seeing a success message after each send.</p><p>Check the lambda logs output.</p><h4 id=producer-function-logs>Producer function logs</h4><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Producer Function Logs" class="tab-nav-button active" onclick='switchTab("default","Producer Function Logs")'>
<span>Producer Function Logs</span></button></div><div class=tab-content><div data-tab-item="Producer Function Logs" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls logs -f producer
</span></span></code></pre></div></div></div></div><h4 id=consumer-function-logs>Consumer function logs</h4><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Consumer Function Logs" class="tab-nav-button active" onclick='switchTab("default","Consumer Function Logs")'>
<span>Consumer Function Logs</span></button></div><div class=tab-content><div data-tab-item="Consumer Function Logs" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls logs -f consumer
</span></span></code></pre></div></div></div></div><p>Examine the logs carefully. Do you see OpenTelemetry being loaded? Look out for lines with <code>splunk-extension-wrapper</code>.</p><h3 id=find-your-lambda-data-in-splunk-apm>Find your Lambda data in Splunk APM</h3><p>Now it&rsquo;s time to check how your Lambda traffic has been captured in Splunk APM.</p><p>Navigate to your <a href=https://app.us1.signalfx.com target=_blank>Splunk Observability Cloud</a></p><p>Select APM from the Main Menu and then select your APM Environment. Your APM environment should be in the format <code>$(hostname)-apm-lambda</code> where the hostname value is a four letter name of your lab host. (Check it by looking at your command prompt, or by running <code>echo $(hostname)</code>)</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>It may take a few minutes for you traces to appear in Splunk APM. Try hitting refresh on your browser until you find your environement name in the list of Envrionments</p></div></div><p><a href=#image-2bc49b019ca43a9bcc4ee908ec2aed0e class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219368081-20a1522e-a908-40d8-b635-942bffdbb0bd.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-2bc49b019ca43a9bcc4ee908ec2aed0e><img src=https://user-images.githubusercontent.com/5187861/219368081-20a1522e-a908-40d8-b635-942bffdbb0bd.png alt=image class=lightbox-image loading=lazy></a></p><p>Go to Explore the Service Map to see the Dependencies between your Lambda Functions.</p><p><a href=#image-14e7330042899ce626eaf78a04c6cd93 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219001784-a25e7c9f-981d-49b9-b6df-f39d2bff0975.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-14e7330042899ce626eaf78a04c6cd93><img src=https://user-images.githubusercontent.com/5187861/219001784-a25e7c9f-981d-49b9-b6df-f39d2bff0975.png alt=image class=lightbox-image loading=lazy></a></p><p>You should be able to see the <code>producer-lambda</code> and the call it is making to <code>Kinesis</code> service. What about your <code>consumer-lambda</code>?
<a href=#image-f43c0aad4a307208b4873c67010dbbd0 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219368350-5bebb65b-d658-42be-9895-5d39a8d60a2d.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-f43c0aad4a307208b4873c67010dbbd0><img src=https://user-images.githubusercontent.com/5187861/219368350-5bebb65b-d658-42be-9895-5d39a8d60a2d.png alt=image class=lightbox-image loading=lazy></a></p><p>Click into <em>Traces</em> and examine some traces that container <strong>procuder</strong> function calls and traces with <strong>consumer</strong> function calls.
<a href=#image-39f771121182fdf4092ce05960d34b34 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219002535-d11afd2f-9134-4e1b-87fb-f3af47969372.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-39f771121182fdf4092ce05960d34b34><img src=https://user-images.githubusercontent.com/5187861/219002535-d11afd2f-9134-4e1b-87fb-f3af47969372.png alt=image class=lightbox-image loading=lazy></a></p><p>We can see the <code>producer-lambda</code> putting a Record on the Kinesis stream. But the action of <code>consumer-function</code> is disconnected!</p><p>This is because the <strong>Trace Context</strong> is not being propagated.</p><p>This is not something that is supported automatically Out-of-the-Box by Kinesis service at the time of this lab. Our Distributed Trace stops at <em>Kinesis</em> inferred service, and we can&rsquo;t see the propagation any further.</p><p>Not yet&mldr;</p><p>Let&rsquo;s see how we work around this in the next section of this lab.</p><h2 id=manual-instrumentation>Manual Instrumentation</h2><p>Navigate to the <code>manual</code> directory that contains manually instrumentated code.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/o11y-lambda-lab/manual
</span></span></code></pre></div></div></div></div><p>Inspect the contents of the files in this directory.
Take a look at the <code>serverless.yml</code> template.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat serverless.yml
</span></span></code></pre></div></div></div></div><p>Do you see any difference from the same file in your <code>auto</code> directory?</p><p>You can try to compare them with a <code>diff</code> command:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Diff Command" class="tab-nav-button active" onclick='switchTab("default","Diff Command")'>
<span>Diff Command</span></button>
<button data-tab-item="Expected Output" class=tab-nav-button onclick='switchTab("default","Expected Output")'>
<span>Expected Output</span></button></div><div class=tab-content><div data-tab-item="Diff Command" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>diff ~/o11y-lambda-lab/auto/serverless.yml ~/o11y-lambda-lab/manual/serverless.yml 
</span></span></code></pre></div></div><div data-tab-item="Expected Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>19c19
</span></span><span style=display:flex><span>&lt; #======================================    
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>&gt; #======================================   
</span></span></code></pre></div></div></div></div><p>There is no difference! <em>(Well, there shouldn&rsquo;t be. Ask your lab facilitator to assist you if there is)</em></p><p>Now compare <code>handler.js</code> it with the same file in <code>auto</code> directory using the <code>diff</code> command:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Diff Command" class="tab-nav-button active" onclick='switchTab("default","Diff Command")'>
<span>Diff Command</span></button></div><div class=tab-content><div data-tab-item="Diff Command" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>diff ~/o11y-lambda-lab/auto/handler.js ~/o11y-lambda-lab/manual/handler.js 
</span></span></code></pre></div></div></div></div><p>Look at all these differences!</p><p><em>You may wish to view the entire file with <code>cat handler.js</code> command and examine its content.</em></p><p>Notice how we are now importing some OpenTelemetry libraries directly into our function to handle some of the manual instrumenation tasks we require.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>const otelapi  = require(&#39;@opentelemetry/api&#39;);
</span></span><span style=display:flex><span>const otelcore = require(&#39;@opentelemetry/core&#39;);
</span></span></code></pre></div><p>We are using <a href=https://www.npmjs.com/package/@opentelemetry/api target=_blank>https://www.npmjs.com/package/@opentelemetry/api</a> to manipulate the tracing logic in our functions.
We are using <a href=https://www.npmjs.com/package/@opentelemetry/core target=_blank>https://www.npmjs.com/package/@opentelemetry/core</a> to access the <strong>Propagator</strong> objects that we will use to manually propagate our context with.</p><h3 id=inject-trace-context-in-producer-function>Inject Trace Context in Producer Function</h3><p>The bellow code executes the following steps inside the Producer function:</p><ol><li>Get the current Active Span.</li><li>Create a Propagator.</li><li>Initialize a context carrier object.</li><li>Inject the context of the active span into the carrier object.</li><li>Modify the record we are about to put on our Kinesis stream to include the carrier that will carry the active span&rsquo;s context to the consumer.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>const activeSpan = otelapi.trace.getSpan(otelapi.context.active());
</span></span><span style=display:flex><span>const propagator = new otelcore.W3CTraceContextPropagator();
</span></span><span style=display:flex><span>let carrier = {};
</span></span><span style=display:flex><span>propagator.inject(otelapi.trace.setSpanContext(otelapi.ROOT_CONTEXT, activeSpan.spanContext()),
</span></span><span style=display:flex><span>                 carrier,
</span></span><span style=display:flex><span>                otelapi.defaultTextMapSetter
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>const data = &#34;{\&#34;tracecontext\&#34;: &#34; + JSON.stringify(carrier) + &#34;, \&#34;record\&#34;:&#34; + event.body + &#34;}&#34;;
</span></span><span style=display:flex><span>console.log(`Record with Trace Context added: 
</span></span><span style=display:flex><span>             ${data}`);
</span></span></code></pre></div><h4 id=extract-trace-context-in-consumer-function>Extract Trace Context in Consumer Function</h4><p>The bellow code executes the following steps inside the Consumer function:</p><ol><li>Extract the context that we obtained from the Producer into a carrier object.</li><li>Create a Propagator.</li><li>Extract the context from the carrier object in Customer function&rsquo;s parent span context.</li><li>Start a new span with the parent span context.</li><li>Bonus: Add extra attributes to your span, including custom ones with the values from your message!</li><li>Once completed, end the span.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>const carrier = JSON.parse( message ).tracecontext;
</span></span><span style=display:flex><span>const propagator = new otelcore.W3CTraceContextPropagator();
</span></span><span style=display:flex><span>const parentContext = propagator.extract(otelapi.ROOT_CONTEXT, carrier, otelapi.defaultTextMapGetter);
</span></span><span style=display:flex><span>const tracer = otelapi.trace.getTracer(process.env.OTEL_SERVICE_NAME);
</span></span><span style=display:flex><span>const span = tracer.startSpan(&#34;Kinesis.getRecord&#34;, undefined, parentContext);
</span></span><span style=display:flex><span>                         
</span></span><span style=display:flex><span>span.setAttribute(&#34;span.kind&#34;, &#34;server&#34;);
</span></span><span style=display:flex><span>const body = JSON.parse( message ).record;
</span></span><span style=display:flex><span>if (body.name) {
</span></span><span style=display:flex><span>    span.setAttribute(&#34;custom.tag.name&#34;, body.name);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span> if (body.superpower) {
</span></span><span style=display:flex><span>    span.setAttribute(&#34;custom.tag.superpower&#34;, body.superpower);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  --- function does some work
</span></span><span style=display:flex><span> span.end();
</span></span></code></pre></div><p>Now let&rsquo;s see the difference this makes.</p><h3 id=re-deploy-your-lambdas>Re-deploy your Lambdas</h3><p>While remaining in your <code>manual</code> directory, run the following commandd to re-deploy your Lambda Functions:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Deploy Producer Code" class="tab-nav-button active" onclick='switchTab("default","Deploy Producer Code")'>
<span>Deploy Producer Code</span></button>
<button data-tab-item="Expected Output" class=tab-nav-button onclick='switchTab("default","Expected Output")'>
<span>Expected Output</span></button></div><div class=tab-content><div data-tab-item="Deploy Producer Code" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls deploy -f producer
</span></span></code></pre></div></div><div data-tab-item="Expected Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Deploying function producer to stage dev (us-east-1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>✔ Function code deployed (6s)
</span></span><span style=display:flex><span>Configuration did not change. Configuration update skipped. (6s)
</span></span></code></pre></div></div></div></div><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Deploy Consumer Code" class="tab-nav-button active" onclick='switchTab("default","Deploy Consumer Code")'>
<span>Deploy Consumer Code</span></button>
<button data-tab-item="Expected Output" class=tab-nav-button onclick='switchTab("default","Expected Output")'>
<span>Expected Output</span></button></div><div class=tab-content><div data-tab-item="Deploy Consumer Code" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls deploy -f consumer
</span></span></code></pre></div></div><div data-tab-item="Expected Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Deploying function consumer to stage dev (us-east-1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>✔ Function code deployed (6s)
</span></span><span style=display:flex><span>Configuration did not change. Configuration update skipped. (6s)
</span></span></code></pre></div></div></div></div><p>Note that this deployment now only updates the code changes within the function. Our configuration remains the same.</p><p>Check the details of your serverless functions:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls info
</span></span></code></pre></div></div></div></div><p>You endpoint value should remain the same:</p><p><a href=#image-d70797049ae0ba0402b163d4c70cb1ba class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219371979-4e474746-2633-4824-9d7a-1b39d3d2ce3f.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-d70797049ae0ba0402b163d4c70cb1ba><img src=https://user-images.githubusercontent.com/5187861/219371979-4e474746-2633-4824-9d7a-1b39d3d2ce3f.png alt=image class=lightbox-image loading=lazy></a></p><h3 id=send-some-traffic-again>Send some Traffic again</h3><p>Use the <code>curl</code> command to send a payload to your <strong>producer</strong> function.
Note the command option <code>-d</code> is followed by your message payload.</p><p>Try changing the value of <code>name</code> to your name and telling the Lambda function about your <code>superpower</code>.
Replace <code>YOUR_ENDPOINT</code> with the endpoint from your previous step.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item=Command class="tab-nav-button active" onclick='switchTab("default","Command")'>
<span>Command</span></button></div><div class=tab-content><div data-tab-item=Command class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -d <span style=color:#4e9a06>&#39;{ &#34;name&#34;: &#34;CHANGE_ME&#34;, &#34;superpower&#34;: &#34;CHANGE_ME&#34; }&#39;</span> YOUR_ENDPOINT
</span></span></code></pre></div></div></div></div><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>curl -d &#39;{ &#34;name&#34;: &#34;Kate&#34;, &#34;superpower&#34;: &#34;Distributed Tracing&#34; }&#39; https://xvq043lj45.execute-api.us-east-1.amazonaws.com/dev/producer
</span></span></code></pre></div><p>You should see the following output if your message is successful:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>&#34;message&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;Message placed in the Event Stream: hostname-eventSteam&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>If unsuccessful, you will see:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>&#34;message&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Internal server error&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>If this occurs, ask one of the lab facilitators for assistance.</p><p>If you see a success message, generate more load: <em>re-send that messate <strong>5+ times</strong></em>. You should keep seeing a success message after each send.</p><p>Check the lambda logs output.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Producer Function Logs" class="tab-nav-button active" onclick='switchTab("default","Producer Function Logs")'>
<span>Producer Function Logs</span></button></div><div class=tab-content><div data-tab-item="Producer Function Logs" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls logs -f producer
</span></span></code></pre></div></div></div></div><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Consumer Function Logs" class="tab-nav-button active" onclick='switchTab("default","Consumer Function Logs")'>
<span>Consumer Function Logs</span></button></div><div class=tab-content><div data-tab-item="Consumer Function Logs" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls logs -f consumer
</span></span></code></pre></div></div></div></div><p>Examine the logs carefully. Do you notice the difference?</p><p>Note that we are logging our Record together with the Trace context that we have added to it. Copy one of the underlined sub-sections of your trace parent context, and save it for later.</p><p><a href=#image-dd14fdb5c1eebe0b74dc49f3ba865a06 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219372916-ed1afce5-176f-4baf-a9a3-0aae29e3f01b.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-dd14fdb5c1eebe0b74dc49f3ba865a06><img src=https://user-images.githubusercontent.com/5187861/219372916-ed1afce5-176f-4baf-a9a3-0aae29e3f01b.png alt=image class=lightbox-image loading=lazy></a></p><h3 id=find-your-updated-lambda-data-in-splunk-apm>Find your updated Lambda data in Splunk APM</h3><p>Navigate back to APM in <a href=https://app.us1.signalfx.com/#/apm target=_blank>Splunk Observabilty Cloud</a></p><p>Go back to your Service Dependency map. Notice the difference?</p><p><a href=#image-ed83e37141a0531f5bd31c5f01512b40 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219373312-0d556475-9f27-4729-af38-ac94f0773c5c.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-ed83e37141a0531f5bd31c5f01512b40><img src=https://user-images.githubusercontent.com/5187861/219373312-0d556475-9f27-4729-af38-ac94f0773c5c.png alt=image class=lightbox-image loading=lazy></a></p><p>You should be able to see the <strong>consumer-lambda</strong> now clearly connected to the <strong>producer-lambda</strong>.</p><p>Remember the value you copied from your producer logs? You can run <code>sls logs -f consumer</code> command again on your EC2 lab host to fetch one.</p><p>Take that value, and paste it into trace search:</p><p><a href=#image-befd0da2b5140caf5ffbcd9060fe8933 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219373635-cc5a5841-5afb-49f9-baea-9d4d45aabfb6.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-befd0da2b5140caf5ffbcd9060fe8933><img src=https://user-images.githubusercontent.com/5187861/219373635-cc5a5841-5afb-49f9-baea-9d4d45aabfb6.png alt=image class=lightbox-image loading=lazy></a></p><p>Click on <em>Go</em> and you should be able to find the logged Trace:</p><p><a href=#image-b94d40a25040e1603a6d2edea1289714 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219374024-de32aa68-f34a-43eb-8f00-5cc698864b00.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-b94d40a25040e1603a6d2edea1289714><img src=https://user-images.githubusercontent.com/5187861/219374024-de32aa68-f34a-43eb-8f00-5cc698864b00.png alt=image class=lightbox-image loading=lazy></a></p><p>Notice that the <strong>Trace ID</strong> is something that makes up the trace <em>context</em> that we propagated.</p><p>You can read up on the two common propagation standards:</p><ol><li>W3C: <a href=https://www.w3.org/TR/trace-context/#traceparent-header target=_blank>https://www.w3.org/TR/trace-context/#traceparent-header</a></li><li>B3: <a href=https://github.com/openzipkin/b3-propagation#overall-process target=_blank>https://github.com/openzipkin/b3-propagation#overall-process</a></li></ol><p>Which one are we using? <em>It should be self-explanatory from the Propagator we are creating in the Functions</em></p><p><strong>Bonus Question:</strong> What happens if we mix and match the W3C and B3 headers?</p><p>Expand the <strong>consumer-lambda</strong> span. Can you find the attributes from your message?</p><p><a href=#image-8c0bbf64f6ce115337cb2636ac75e8e0 class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219374303-d143515b-d1b1-46b4-bd03-0c4653ea08c0.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-8c0bbf64f6ce115337cb2636ac75e8e0><img src=https://user-images.githubusercontent.com/5187861/219374303-d143515b-d1b1-46b4-bd03-0c4653ea08c0.png alt=image class=lightbox-image loading=lazy></a></p><h2 id=before-you-go>Before you Go</h2><p>Please kindly clean up your lab using the following command:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Remove Functions" class="tab-nav-button active" onclick='switchTab("default","Remove Functions")'>
<span>Remove Functions</span></button></div><div class=tab-content><div data-tab-item="Remove Functions" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sls remove
</span></span></code></pre></div></div></div></div><h2 id=conclusion>Conclusion</h2><p>Congratuations on finishing the lab. You have seen how we complement auto-instrumentation with manual steps to force <strong>Producer</strong> function&rsquo;s context to be sent to <strong>Consumer</strong> function via a Record put on a Kinesis stream. This allowed us to build the expected Distributed Trace.</p><p><a href=#image-80492f2ad20da66da73dd70b85a5cbea class=lightbox-link><img src=https://user-images.githubusercontent.com/5187861/219375907-5a5e23ce-b9bb-4939-865d-7dbbaa668c53.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-80492f2ad20da66da73dd70b85a5cbea><img src=https://user-images.githubusercontent.com/5187861/219375907-5a5e23ce-b9bb-4939-865d-7dbbaa668c53.png alt=image class=lightbox-image loading=lazy></a></p><p>You can now built out a Trace manually by linking two different functions together. This is very powerful when your auto-instrumenation, or third-party systems, do not support context propagation out of the box.</p><footer class=footline></footer></article></section></section></div></main></div><script src=../js/clipboard.min.js?1676905181 defer></script>
<script src=../js/perfect-scrollbar.min.js?1676905181 defer></script>
<script src=../js/theme.js?1676905181 defer></script></body></html>