<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.110.0"><meta name=generator content="Relearn 5.11.2+tip"><meta name=description content="Splunk Observability Workshops"><title>6. O11y - Distributed Tracing for modern applications :: Splunk Observability Cloud Workshops</title><link href=https://splunk.github.io/observability-workshop/v4.55/tko/session-6/index.html rel=canonical type=text/html title="6. O11y - Distributed Tracing for modern applications :: Splunk Observability Cloud Workshops"><link href=/observability-workshop/v4.55/tko/session-6/index.xml rel=alternate type=application/rss+xml title="6. O11y - Distributed Tracing for modern applications :: Splunk Observability Cloud Workshops"><link rel=icon href=/images/favicon.ico><link href=/observability-workshop/v4.55/css/fontawesome-all.min.css?1676472823 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v4.55/css/fontawesome-all.min.css?1676472823 rel=stylesheet></noscript><link href=/observability-workshop/v4.55/css/auto-complete.css?1676472823 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v4.55/css/auto-complete.css?1676472823 rel=stylesheet></noscript><link href=/observability-workshop/v4.55/css/perfect-scrollbar.min.css?1676472823 rel=stylesheet><link href=/observability-workshop/v4.55/css/nucleus.css?1676472823 rel=stylesheet><link href=/observability-workshop/v4.55/css/fonts.css?1676472823 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v4.55/css/fonts.css?1676472823 rel=stylesheet></noscript><link href=/observability-workshop/v4.55/css/theme.css?1676472823 rel=stylesheet><link href=/observability-workshop/v4.55/css/theme-splunk-light.css?1676472823 rel=stylesheet id=variant-style><link href=/observability-workshop/v4.55/css/ie.css?1676472823 rel=stylesheet><link href=/observability-workshop/v4.55/css/variant.css?1676472823 rel=stylesheet><link href=/observability-workshop/v4.55/css/print.css?1676472823 rel=stylesheet media=print><link href=/observability-workshop/v4.55/css/format-print.css?1676472823 rel=stylesheet><script src=/observability-workshop/v4.55/js/url.js?1676472823></script>
<script src=/observability-workshop/v4.55/js/variant.js?1676472823></script>
<script>window.index_js_url="/observability-workshop/v4.55/index.search.js";var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found="No results found for \u0022{0}\u0022",window.T_N_results_found="{1} results found for \u0022{0}\u0022",baseUriFull="https://splunk.github.io/observability-workshop/v4.55/",window.variants&&variants.init(["splunk-light","splunk-dark","aws"])</script></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/observability-workshop/v4.55/tko/session-6/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable dir=ltr><div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle class=topbar-link title='Menu (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v4.55/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v4.55/tko/index.html><span itemprop=name>TKO Workshops</span></a><meta itemprop=position content="2">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>6. O11y - Distributed Tracing for modern applications</span><meta itemprop=position content="3"></li></ol></div></div></nav><main id=body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><div id=head-tags></div><article class=default><h1 id=6-o11y---distributed-tracing-for-modern-applications>6. O11y - Distributed Tracing for modern applications</h1><p>Here at Buttercup Instruments, our business is expanding ! We have recently added 3 new locations, two locations in the USA, Colorado and Chicago and one international location in SRI Lanka!</p><p>Our technical staff has already on-boarded the data from these new locations and incorporated them into our inventory application and it is our job to review these improvements and send any issues back to our developers for repairs.</p><p>We now have a total of 6 locations!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of 6. O11y - Distributed Tracing for modern applications</h1><article class=default><h1 id=setup>Setup</h1><h2 id=1-set-environment-variables>1. Set Environment Variables</h2><p>Environment Variables:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>USERNAME</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;Your-UserName&gt;
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>SPLUNK_ACCESS_TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;Your-Token&gt;
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>SPLUNK_REALM</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;Your-Realm&gt;
</span></span></code></pre></div><h2 id=2-implement-auto-instrumentation>2. Implement Auto-Instrumentation</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> shop
</span></span><span style=display:flex><span>vi Dockerfile
</span></span></code></pre></div><p>Add the Otel Java Agent to Java ENTRYPOINT:</p><p>Change this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ENTRYPOINT java  -Dotel.resource.attributes<span style=color:#ce5c00;font-weight:700>=</span>service.name<span style=color:#ce5c00;font-weight:700>=</span>shop,deployment.environment<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>USERNAME</span><span style=color:#4e9a06>}</span>_Apm_Instrumentation_Shop -jar app.jar
</span></span></code></pre></div><p>To this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ENTRYPOINT java -javaagent:splunk-otel-javaagent-all.jar 
</span></span><span style=display:flex><span>-Dotel.resource.attributes<span style=color:#ce5c00;font-weight:700>=</span>service.name<span style=color:#ce5c00;font-weight:700>=</span>shop,deployment.environment<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>USERNAME</span><span style=color:#4e9a06>}</span>_Apm_Instrumentation_Shop
</span></span><span style=display:flex><span>-jar app.jar
</span></span></code></pre></div><p>See examples at:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi ../Dockerfiles_Instrumented
</span></span></code></pre></div><p>Repeat for: <code>instruments / products / stock</code></p><h2 id=3-build-and-deploy-application>3. Build and Deploy Application</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> <span style=color:#4e9a06>&#34;javashop-otel directory&#34;</span>
</span></span><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><footer class=footline></footer></article><article class=default><h1 id=validate-traces-are-being-collected>Validate Traces are being collected</h1><h2 id=1-users-and-workflows>1. Users and Workflows</h2><p>As we go through this workshop we will be switching roles from SRE to Developer. First we will start with first responders or SREs who will identify an issue in Splunk Observability UI.</p><p>Next, we will jump to a Developer Role to see how a Developer will solve a problem using trace data identified by our SRE. Of course, we are not requiring 2 people for this workshop as each participant will play both roles.</p><h2 id=2-view-service-map>2. View Service Map</h2><p>If your instrumentation was successful, the service-map will show latency from the shop service to the products service.</p><p><a href=#image-e67d1dda0611b23eeb85fe4e94da6c7b class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/206541846-7f0e6462-7659-44bc-bc48-3621c2872fc4.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-e67d1dda0611b23eeb85fe4e94da6c7b><img src=https://user-images.githubusercontent.com/32849847/206541846-7f0e6462-7659-44bc-bc48-3621c2872fc4.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" class=lightbox-image loading=lazy></a></p><p>Click on shop service, click Traces (right side), sort by Duration and select the longest duration trace.</p><p><a href=#image-894f90a650dff8296e5ebbc325cfd73c class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204347798-4f232b7f-7a7a-483f-9d61-f0b535e9ecf0.png alt=LongTrace style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-894f90a650dff8296e5ebbc325cfd73c><img src=https://user-images.githubusercontent.com/32849847/204347798-4f232b7f-7a7a-483f-9d61-f0b535e9ecf0.png alt=LongTrace class=lightbox-image loading=lazy></a></p><p>Now we can see the long latency occurred in the products service and if we click on <code>products: /products</code> we can see the offending method was <code>products:ProductResource.getAllProducts</code>.</p><p><a href=#image-7bb64d632c58e552f4180dcabeba5259 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204347855-724545bf-c3df-478a-a27d-e4f85f708e15.png alt=long-trace-detail-GetAllProducts style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-7bb64d632c58e552f4180dcabeba5259><img src=https://user-images.githubusercontent.com/32849847/204347855-724545bf-c3df-478a-a27d-e4f85f708e15.png alt=long-trace-detail-GetAllProducts class=lightbox-image loading=lazy></a></p><p>Our next step here would be to send that trace to a developer by clicking download trace and they will have to debug the method. Before we do that please take note of the Tags available for the developer to leverage to find root cause.</p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Note:</div><div class=box-content><p>Since they do not have full parameter information it can be a long process.</p></div></div><footer class=footline></footer></article><article class=default><h1 id=developer-role>Developer Role</h1><h2 id=1-now-lets-play-the-role-of-the-developer>1. Now let&rsquo;s play the role of the developer</h2><p>As a developer we must debug the function products:ProductResource.getAllProducts to find the problem.</p><p>Now find the needle in Haystack !</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi products/src/main/java/com/shabushabu/javashop/products/resources/ProductResource.java
</span></span></code></pre></div><p>Find getAllProducts <code>/getAllProducts</code></p><p>scroll way&mldr; down!</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ProductResource</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ProductService</span> <span style=color:#000>productService</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Inject</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ProductResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ProductService</span> <span style=color:#000>productService</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>productService</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>productService</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@GET</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Response</span> <span style=color:#000>getAllProducts</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@DefaultValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;California&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#5c35cc;font-weight:700>@QueryParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;location&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// STEP X: All we know right now is somewhere in this function, latency was introduced.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction10</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction13</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction5</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction6</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction7</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction8</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction9</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction10</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction11</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction12</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>//something in HAYSTACK
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//something in HAYSTACK
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//something in HAYSTACK
</span></span></span></code></pre></div><p>Exit vi <code>:q!</code></p><p>OK, enough fun&mldr; let&rsquo;s make this easier for our developer.</p><footer class=footline></footer></article><article class=default><h1 id=custom-attribution>Custom Attribution</h1><p>To take a deeper look at this issue, we will implement Custom Attributes via Opentelemetry Manual Instrumentation</p><p>To speed up manual instrumentation in Java you can leverage <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotations</a>, which automatically create a span around a method without modifying the actual code inside the method.</p><p>This can be very valueable if you are working with an SRE that may have limited accesss to source code changes.</p><p>To add even more information to help our developers find the root cause faster, <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotations</a> can be used to generate span tags with parameter values for the method in question.</p><p>It is important to remember that any developer should be able to debug a method with knowledge of parameter values at the time of an issue ( exception or latency).</p><p>To expedite manual instrumentation implementation for this exercise, we have provided a tool which will annotate the entirety of the &ldquo;shop&rdquo; and &ldquo;products&rdquo; services with OpenTelemetry standard annotations for every method call without having to write any code. This &ldquo;annotator&rdquo; tool will also tag every parameter in every function, which adds a span tag with Parameter=Value.</p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Note:</div><div class=box-content><p>This Full-fidelity Every-method approach is the Monolith Use Case with Splunk APM for Java.</p></div></div><h2 id=1-run-manual-instrumentation-tool>1. Run Manual Instrumentation Tool</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> javashop-otel directory
</span></span><span style=display:flex><span>./AutomateManualInstrumentation.sh
</span></span></code></pre></div><h2 id=2-rebuild-and-deploy-application>2. Rebuild and Deploy Application</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Now that we have rebuilt and deployed our application, traffic is being sent once again.</p><p>Go back to the Splunk Observability UI and let&rsquo;s see if these annotations help us narrow down the root cause more quickly.</p><p>Click back on the trace window</p><p><a href=#image-302b244f2ce95dcf57f83cc373359c8a class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204348366-38b8c82a-02ca-472b-b1aa-feeb746ec1d7.png alt="Screen Shot 2022-11-28 at 7 29 43 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-302b244f2ce95dcf57f83cc373359c8a><img src=https://user-images.githubusercontent.com/32849847/204348366-38b8c82a-02ca-472b-b1aa-feeb746ec1d7.png alt="Screen Shot 2022-11-28 at 7 29 43 AM" class=lightbox-image loading=lazy></a></p><p>Give the traces a couple minutes to generate &mldr;</p><h2 id=3-houston-we-have-a-new-problem>3. Houston, we have a new problem</h2><p>Once traces populate, Select &ldquo;Errors Only&rdquo;</p><p><a href=#image-1e41a07119bbc89be1a1c4322d3246e8 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204348492-84a4ad45-e11c-4e75-a6a9-d6e52e0eb13e.png alt="Screen Shot 2022-11-28 at 7 36 50 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-1e41a07119bbc89be1a1c4322d3246e8><img src=https://user-images.githubusercontent.com/32849847/204348492-84a4ad45-e11c-4e75-a6a9-d6e52e0eb13e.png alt="Screen Shot 2022-11-28 at 7 36 50 AM" class=lightbox-image loading=lazy></a></p><p>Note: we haven&rsquo;t changed the code at all by adding annotations. Click on a trace with an error present.</p><p><a href=#image-4fc3be4054e77c268f77fd3fb73b4829 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204348687-12241153-b297-4bd7-9ea8-4b410369e82c.png alt="Screen Shot 2022-11-28 at 7 38 33 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-4fc3be4054e77c268f77fd3fb73b4829><img src=https://user-images.githubusercontent.com/32849847/204348687-12241153-b297-4bd7-9ea8-4b410369e82c.png alt="Screen Shot 2022-11-28 at 7 38 33 AM" class=lightbox-image loading=lazy></a></p><p>We can see our Exception is <code>InvalidLocaleException</code>!</p><p>The real problem must be related to the new data associated with SRI LANKA as the Exception says &ldquo;Non English Characters found in Instrument Data.</p><p>This exception had not surfaced in previous traces because the method where it was thrown was NOT covered with Auto Instrumentation.</p><p>Once we completed the Manual Instrumentation via the Annotations we added, this method was instrumented and we can now see we had a buried Exception being thrown.</p><footer class=footline></footer></article><article class=default><h1 id=fix-the-issue>Fix the issue</h1><h2 id=1-lets-play-developer-once-again-and-fix-our-issue>1. Let&rsquo;s play Developer once again and fix our issue</h2><p>We already know exactly what file to look in and what method to look at as it is called out in the trace.</p><p><a href=#image-1813c407c6cd644baa0139e596a5e94b class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349038-3b43a5ba-18e3-4d58-8985-29ee1f7da40a.png alt="Screen Shot 2022-11-28 at 7 43 58 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-1813c407c6cd644baa0139e596a5e94b><img src=https://user-images.githubusercontent.com/32849847/204349038-3b43a5ba-18e3-4d58-8985-29ee1f7da40a.png alt="Screen Shot 2022-11-28 at 7 43 58 AM" class=lightbox-image loading=lazy></a></p><p>Edit the file</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi shop/src/main/java/com/shabushabu/javashop/shop/model/Instrument.java
</span></span></code></pre></div><p>Search for the method buildForLocale <code>/buildForLocale</code></p><p>Look at Code, notice the Annotation <code>@WithSpan()</code>? <code>@WithSpan()</code> is an <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotation</a> for Java that automatically generates a span around a the function that follows.</p><p><code>@SpanAttribute()</code> is another <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotation</a> that automatically adds a tag to a span with the corresponding parameter it annotates and its value. Using this technique we can tell developers exactly what the values of every parameter of a function the wrote or must repair at the time the problem occurred.</p><p><a href=#image-e4b4b43db535098e314e487e5d52a9ad class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349143-1e35b6e4-4059-4c56-8718-76c14d41727c.png alt="Screen Shot 2022-11-28 at 7 45 13 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-e4b4b43db535098e314e487e5d52a9ad><img src=https://user-images.githubusercontent.com/32849847/204349143-1e35b6e4-4059-4c56-8718-76c14d41727c.png alt="Screen Shot 2022-11-28 at 7 45 13 AM" class=lightbox-image loading=lazy></a></p><p>Now let&rsquo;s fix this code. We are going to simply comment this out for now and see if it fixes our latency issue. Type <code>i</code> for insert</p><p>Change this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isEnglish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>title</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InvalidLocaleException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Non English Characters found in Instrument Data&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Characters OK &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>To this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//if (!isEnglish(title)) {
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  throw new InvalidLocaleException(&#34;Non English Characters found in Instrument Data&#34;);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// } else {
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// System.out.println(&#34;Characters OK &#34;);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//}
</span></span></span></code></pre></div><p>To save changes in vi type <code>:wq</code></p><p>Make sure you saved your changes to <code>shop/src/main/java/com/shabushabu/javashop/shop/model/Instrument.java</code></p><h2 id=2-build-and-deploy-application>2. Build and Deploy Application</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Wait a few minutes&mldr;..</p><footer class=footline></footer></article><article class=default><h1 id=root-cause-analysis>Root Cause Analysis</h1><h2 id=1-latency-root-cause>1. Latency Root Cause</h2><p>Open Service Map in Splunk Observability UI</p><p><a href=#image-a01d5c9c34d75baa02bc4fd6645919bd class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/206542093-f97b37ce-7e58-45bc-a281-5a388d60617e.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-a01d5c9c34d75baa02bc4fd6645919bd><img src=https://user-images.githubusercontent.com/32849847/206542093-f97b37ce-7e58-45bc-a281-5a388d60617e.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" class=lightbox-image loading=lazy></a></p><p>We can see we still have our original Latency issue, however our exception for Invalid Locale should be gone.</p><p>Let&rsquo;s check to see our InvalidLocale Exception is gone. Click Shop Service, click Traces on the right. We did remove the exception however it seems removing the Exception did not fix the latency&mldr;</p><p>Lets see if the newly added annotations provide us more relevant information for the next responder once we find the cause.</p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:warning><div class=box-label>Note:</div><div class=box-content><p>We added additional information Parameter Values at Time of Latency. In this case the <strong>Location</strong> tag was created due our handy Annotator, that did the <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotations</a></p></div></div><p><a href=#image-e213dc946da65932c38b58bd815ee7a3 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/213582624-66466a19-00fa-4dda-acd0-f6970d594ba1.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-e213dc946da65932c38b58bd815ee7a3><img src=https://user-images.githubusercontent.com/32849847/213582624-66466a19-00fa-4dda-acd0-f6970d594ba1.png alt=image class=lightbox-image loading=lazy></a></p><p>We can see that the actual function call that has the latency was not <code>ProductResource.getAllProducts</code> but the function call <code>ProductResource.myCoolFunction234234234</code>!</p><p>With this information a Developer can debug very quickly. Consider the case of debugging code, that you may not have written yourself without Parameter Values at the time of the issue? You would have no choice but to go line &mldr;. by line &mldr;.. by line&mldr;.. which can take a very long time.</p><p>Since we now have the parameter tagged as part of our span metadata the actual root cause is seemingly related to the &ldquo;location&rdquo; Colorado!</p><p>It appears the one custom attribute that was tagged for function <code>ProductResource.myCoolFunction234234234</code> was <code>myInt</code> with a value of <code>999</code>.</p><p>Let&rsquo;s see if we can find the code that is causing this latency.</p><h2 id=2-fix-the-code>2. Fix the code</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi products/src/main/java/com/shabushabu/javashop/products/resources/ProductResource.java
</span></span></code></pre></div><p>search for 999 <code>/999</code></p><p>We found and fixed the Needle In Haystack more quickly! Let&rsquo;s fix our code, enter <code>i</code> for insert.</p><p>Change this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>myCoolFunction234234234</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@SpanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;myInt&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>myInt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Generate a FAST sleep of 0 time !
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Random</span> <span style=color:#000>sleepy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Random</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>999</span><span style=color:#ce5c00;font-weight:700>==</span><span style=color:#000>myInt</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sleepy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5000</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#0000cf;font-weight:700>3000</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>3000</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span></code></pre></div><p>To this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>myCoolFunction234234234</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@SpanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;myInt&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>myInt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Generate a FAST sleep of 0 time !
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Random</span> <span style=color:#000>sleepy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Random</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//    if (999==myInt)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//        Thread.sleep(sleepy.nextInt(5000 - 3000) + 3000);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span></code></pre></div><p>Save changes in vi type <code>:wq</code></p><p>Make sure you saved your changes to: <code>products/src/main/java/com/shabushabu/javashop/products/resources/ProductResource.java</code></p><footer class=footline></footer></article><article class=default><h1 id=build-and-deploy-again>Build and Deploy again</h1><h2 id=1-build-and-deploy-application-again>1. Build and Deploy Application again</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Now that we have rebuilt and deployed our application, traffic is being sent once again.</p><p>We are waiting a few minutes . . .</p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Congratulations</div><div class=box-content><p>If you do not see Red in your service map, you have successfully completed our Inventory application review for Shri Lanka and Colorado locations!!</p></div></div><p>Now let&rsquo;s ensure Chicago was on-boarded correctly. However, since we have been having so many issues related to &ldquo;location&rdquo; and we have added that custom attribute via Opentelemetry Manual Instrumentation, lets go to the Splunk Observability UI and create an APM metric set around that tag.</p><p>NOTE: We can do this without concern for Cardinality as we know this tag only has 6 possible values.</p><p>Index the location Tag.</p><p><a href=#image-a6dc949e5f1e27fb0320423c15c4cd22 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/213540265-5b0567ab-c9f3-412f-bec0-07277c7e8650.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-a6dc949e5f1e27fb0320423c15c4cd22><img src=https://user-images.githubusercontent.com/32849847/213540265-5b0567ab-c9f3-412f-bec0-07277c7e8650.png alt=image class=lightbox-image loading=lazy></a></p><h2 id=2-build-and-deploy-application-to-run-traffic-again>2. Build and Deploy Application to run traffic again</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Open a browser and navigate to <a href=http://localhost:8010 target=_blank>http://localhost:8010</a></p><p><a href=#image-afcd7901fc850617d741c1fecbb9cdfd class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/213541843-30266285-787f-493b-bc90-ffb4ac6e4c77.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-afcd7901fc850617d741c1fecbb9cdfd><img src=https://user-images.githubusercontent.com/32849847/213541843-30266285-787f-493b-bc90-ffb4ac6e4c77.png alt=image class=lightbox-image loading=lazy></a></p><p>Select a few locagtions and hit the login button, remember to select the Chicago Location and Login</p><p>Uhh ohh ! We received a 500 error, something is wrong there as well. Return to the Splunk Observability UI and lets look once again at our Service Map</p><p><a href=#image-0930b1d4c5a33cac007d74fc81ed5d9b class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349595-fca270ad-379e-48c5-b2e1-7f222af82c55.png alt="Screen Shot 2022-11-28 at 8 11 47 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-0930b1d4c5a33cac007d74fc81ed5d9b><img src=https://user-images.githubusercontent.com/32849847/204349595-fca270ad-379e-48c5-b2e1-7f222af82c55.png alt="Screen Shot 2022-11-28 at 8 11 47 AM" class=lightbox-image loading=lazy></a></p><p>We see there was an un-handled exception thrown in Instruments service and some latency from our database.</p><p>Select the Instruments Service, click on Traces on the right and select <strong>Errors Only</strong></p><p><a href=#image-c2244dae29c7551be725e8490d9c9644 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349696-dc19d62f-ed82-4533-ad27-138237821b8e.png alt="Screen Shot 2022-11-28 at 8 14 50 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-c2244dae29c7551be725e8490d9c9644><img src=https://user-images.githubusercontent.com/32849847/204349696-dc19d62f-ed82-4533-ad27-138237821b8e.png alt="Screen Shot 2022-11-28 at 8 14 50 AM" class=lightbox-image loading=lazy></a></p><p>We can see the exception was thrown by Hibernate, however it was thrown in our method <code>instruments: InstrumentRepository.findInstruments</code></p><p><a href=#image-69f9502bd958812fe774b3b47013fe90 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204351905-03fe632b-b21c-4e8d-8044-dc582fed2253.png alt="Screen Shot 2022-11-28 at 8 14 37 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-69f9502bd958812fe774b3b47013fe90><img src=https://user-images.githubusercontent.com/32849847/204351905-03fe632b-b21c-4e8d-8044-dc582fed2253.png alt="Screen Shot 2022-11-28 at 8 14 37 AM" class=lightbox-image loading=lazy></a></p><footer class=footline></footer></article><article class=default><h1 id=the-final-fix>The Final Fix!</h1><h2 id=1-lets-play-developer-again>1. Let&rsquo;s play developer again</h2><p>Edit the file <code>instruments: InstrumentRepository.findInstruments</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi instruments/src/main/java/com/shabushabu/javashop/instruments/repositories/FindInstrumentRepositoryImpl.java
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>findInstruments</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;findInstruments Called (All)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>Object</span> <span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entityManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createNativeQuery</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#4e9a06>&#34;SELECT * FROM instruments_for_sale, instruments_for_sale_chicago&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getResultList</span><span style=color:#ce5c00;font-weight:700>();</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>We can see the developer accidently added the Instruments database with the Chicago Instruments database! Let&rsquo;s change the query and fix this, remove <code>instruments_for_sale</code> from our query.</p><p>Change this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>findInstruments</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;findInstruments Called (All)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#000>Object</span> <span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entityManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createNativeQuery</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#4e9a06>&#34;SELECT * FROM instruments_for_sale, instruments_for_sale_chicago&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getResultList</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>To this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>findInstruments</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;findInstruments Called (All)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//Object obj = entityManager.createNativeQuery( &#34;SELECT * FROM instruments_for_sale, instruments_for_sale_chicago&#34;).getResultList();
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span>    <span style=color:#000>Object</span> <span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entityManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createNativeQuery</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#4e9a06>&#34;SELECT * FROM instruments_for_sale_chicago&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getResultList</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=2-build-and-deploy-application-once-more>2. Build and Deploy Application once more</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> javashop-otel directory
</span></span><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Now let&rsquo;s test the Chicago location once again, open a browser and navigate to <a href=http://localhost:8010 target=_blank>http://localhost:8010</a>. Select the Chicago Location and Login.</p><p>We now see the 500 error is gone! Let&rsquo;s confirm a clean Service Map!</p><p><a href=#image-f294b75a0cef50a9a6686d8e3187bdad class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204350088-fca43e3c-42ea-4933-8a61-01eb2083fd23.png alt="Screen Shot 2022-11-28 at 8 35 11 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-f294b75a0cef50a9a6686d8e3187bdad><img src=https://user-images.githubusercontent.com/32849847/204350088-fca43e3c-42ea-4933-8a61-01eb2083fd23.png alt="Screen Shot 2022-11-28 at 8 35 11 AM" class=lightbox-image loading=lazy></a></p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Congratulations</div><div class=box-content><p>If you see a clean service map, free of errors and Latency you have successfully completed the Java Instrumentation Workshop!**</p></div></div><p><strong>Have a lovely day!</strong></p><footer class=footline></footer></article></section></div></main></div><script src=/observability-workshop/v4.55/js/clipboard.min.js?1676472824 defer></script>
<script src=/observability-workshop/v4.55/js/perfect-scrollbar.min.js?1676472824 defer></script>
<script src=/observability-workshop/v4.55/js/theme.js?1676472824 defer></script></body></html>