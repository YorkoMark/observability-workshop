<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.110.0"><meta name=generator content="Relearn 5.11.2+tip"><meta name=description content="TKO 2023 - Observability Workshops"><title>TKO Workshops :: Splunk Observability Cloud Workshops</title><link href=https://splunk.github.io/observability-workshop/v4.55/tko/index.html rel=canonical type=text/html title="TKO Workshops :: Splunk Observability Cloud Workshops"><link href=/observability-workshop/v4.55/tko/index.xml rel=alternate type=application/rss+xml title="TKO Workshops :: Splunk Observability Cloud Workshops"><link rel=icon href=/images/favicon.ico><link href=/observability-workshop/v4.55/css/fontawesome-all.min.css?1676472823 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v4.55/css/fontawesome-all.min.css?1676472823 rel=stylesheet></noscript><link href=/observability-workshop/v4.55/css/auto-complete.css?1676472823 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v4.55/css/auto-complete.css?1676472823 rel=stylesheet></noscript><link href=/observability-workshop/v4.55/css/perfect-scrollbar.min.css?1676472823 rel=stylesheet><link href=/observability-workshop/v4.55/css/nucleus.css?1676472823 rel=stylesheet><link href=/observability-workshop/v4.55/css/fonts.css?1676472823 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v4.55/css/fonts.css?1676472823 rel=stylesheet></noscript><link href=/observability-workshop/v4.55/css/theme.css?1676472823 rel=stylesheet><link href=/observability-workshop/v4.55/css/theme-splunk-light.css?1676472823 rel=stylesheet id=variant-style><link href=/observability-workshop/v4.55/css/ie.css?1676472823 rel=stylesheet><link href=/observability-workshop/v4.55/css/variant.css?1676472823 rel=stylesheet><link href=/observability-workshop/v4.55/css/print.css?1676472823 rel=stylesheet media=print><link href=/observability-workshop/v4.55/css/format-print.css?1676472823 rel=stylesheet><script src=/observability-workshop/v4.55/js/url.js?1676472823></script>
<script src=/observability-workshop/v4.55/js/variant.js?1676472823></script>
<script>window.index_js_url="/observability-workshop/v4.55/index.search.js";var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found="No results found for \u0022{0}\u0022",window.T_N_results_found="{1} results found for \u0022{0}\u0022",baseUriFull="https://splunk.github.io/observability-workshop/v4.55/",window.variants&&variants.init(["splunk-light","splunk-dark","aws"])</script></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/observability-workshop/v4.55/tko/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable dir=ltr><div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle class=topbar-link title='Menu (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v4.55/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>TKO Workshops</span><meta itemprop=position content="2"></li></ol></div></div></nav><main id=body-inner class="highlightable home" tabindex=-1><div class=flex-block-wrapper><div id=head-tags></div><article class=home><h1 id=tko-workshops>TKO Workshops</h1><div class="children children-h3 children-sort-"><h3><a href=/observability-workshop/v4.55/tko/session-2/index.html>Getting Data In (GDI) & OTEL</a></h3><p>Introduction During this technical workshop you will learn how to:
efficiently deploy complex environments capture metrics from these environments to Splunk Observability Cloud auto-instrument a python application enabling OS logging to Splunk Enterprise via Universal Forwarder In order to simplify the workshop modules, a pre-configured AWS EC2 instance is provided.
By the end of this technical workshop you will have an approach to demonstrating metrics collection for complex environments and services and be able to describe, at a high-level, what is required to instrument an application for distributed tracing.</p><h3><a href=/observability-workshop/v4.55/tko/session-3/index.html>3. ITOps Monitoring Monitoring Monitoring</a></h3><p></p><h3><a href=/observability-workshop/v4.55/tko/session-4/index.html>4. ITOps - Understanding Event Analytics in Realistic Business Services</a></h3><p></p><h3><a href=/observability-workshop/v4.55/tko/session-5/index.html>5. How Platform Engineers Observe Kubernetes</a></h3><p>45 minutes This workshop will equip you with the basic understanding of monitoring Kubernetes using the Splunk OpenTelemetry Collector. During the workshop you will deploy PHP/Apache and a load generator.
You will learn about OpenTelemetry Receivers, Kubernetes Namespaces, ReplicaSets, Kubernetes Horizontal Pod AutoScaling and how to monitor all this using the Splunk Observability Cloud. The main learnings from the workshop will be a better understanding of the Kubernetes Navigator (and Dashboards) in Splunk Observability Cloud as well as seeing Kubernetes metrics, events and Auto-Detectors.</p><h3><a href=/observability-workshop/v4.55/tko/session-6/index.html>6. O11y - Distributed Tracing for modern applications</a></h3><p>Here at Buttercup Instruments, our business is expanding ! We have recently added 3 new locations, two locations in the USA, Colorado and Chicago and one international location in SRI Lanka!
Our technical staff has already on-boarded the data from these new locations and incorporated them into our inventory application and it is our job to review these improvements and send any issues back to our developers for repairs.
We now have a total of 6 locations!</p></div><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of TKO Workshops</h1><article class=chapter><div class=article-subheading>Chapter 2</div><h1 id=getting-data-in-gdi--otel>Getting Data In (GDI) & OTEL</h1><h2 id=introduction>Introduction</h2><p>During this technical workshop you will learn how to:</p><ul><li>efficiently deploy complex environments</li><li>capture metrics from these environments to Splunk Observability Cloud</li><li>auto-instrument a python application</li><li>enabling OS logging to Splunk Enterprise via Universal Forwarder</li></ul><p>In order to simplify the workshop modules, a pre-configured AWS EC2 instance is provided.</p><p>By the end of this technical workshop you will have an approach to demonstrating metrics collection for complex environments and services and be able to describe, at a high-level, what is required to instrument an application for distributed tracing.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Getting Data In (GDI) & OTEL</h1><article class=default><h1 id=getting-started-with-o11y-gdi---real-time-enrichment-workshop>Getting Started with O11y GDI - Real Time Enrichment Workshop</h1><p>Please note to begin the following lab, you must have completed the prework:</p><ul><li>Obtain a Splunk Observability Cloud access key</li><li>Understand cli commands</li></ul><p>Follow these steps if using O11y Workshop EC2 instances</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># note: verify yelp data files are present</span>
</span></span><span style=display:flex><span>ll /var/appdata/yelp*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>SPLUNK_ACCESS_TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your-access-token&gt;
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>SPLUNK_REALM</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your-o11y-cloud-realm&gt;
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ACCESS_TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your-access-token&gt;
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>REALM</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your-o11y-cloud-realm&gt;
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>clusterName</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your-k8s-cluster&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> /home/ubuntu
</span></span><span style=display:flex><span>git clone https://github.com/leungsteve/realtime_enrichment.git
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> realtime_enrichment/workshop
</span></span><span style=display:flex><span>python3 -m venv rtapp-workshop
</span></span><span style=display:flex><span><span style=color:#204a87>source</span> rtapp-workshop/bin/activate
</span></span></code></pre></div><footer class=footline></footer></article><article class=default><h1 id=deploy-complex-environments-and-capture-meterics>Deploy complex environments and capture meterics</h1><p><strong>Objective:</strong> Learn how to efficiently deploy complex infrastructure components such as Kafka and MongoDB to demonstrate metrics collection with Splunk O11y IM integrations</p><p><strong>Duration</strong>: 15 Minutes</p><h2 id=scenario>Scenario</h2><p>A prospect uses Kafka and MongoDB in their environment. Since there are integrations for these services, you’d like to demonstrate this to the prospect. What is a quick and efficient way to set up a live environment with these services and have metrics collected?</p><h3 id=1-where-can-i-find-helm-charts>1. Where can I find helm charts?</h3><ul><li>Google “myservice helm chart”</li><li><code>https://artifacthub.io/</code> (<strong>Note:</strong> Look for charts from trusted organizations, with high star count and frequent updates)</li></ul><h3 id=2-review-apache-kafka-packaged-by-bitnamihttpsgithubcombitnamichartstreemainbitnamikafkainstalling-the-chart>2. Review <a href=https://github.com/bitnami/charts/tree/main/bitnami/kafka/#installing-the-chart target=_blank>Apache Kafka packaged by Bitnami</a></h3><p>We will deploy the helm chart with these options enabled:</p><ul><li><code>replicaCount=3</code></li><li><code>metrics.jmx.enabled=true</code></li><li><code>metrics.kafka.enabled=true</code></li><li><code>deleteTopicEnable=true</code></li></ul><h3 id=3-review-mongodbr-packaged-by-bitnamihttpsgithubcombitnamichartstreemasterbitnamimongodbinstalling-the-chart>3. Review <a href=https://github.com/bitnami/charts/tree/master/bitnami/mongodb/#installing-the-chart target=_blank>MongoDB(R) packaged by Bitnami</a></h3><p>We will deploy the helm chart with these options enabled:</p><ul><li><code>version 12.1.31</code></li><li><code>metrics.enabled=true</code></li><li><code>global.namespaceOverride=default</code></li><li><code>auth.rootUser=root</code></li><li><code>auth.rootPassword=splunk</code></li><li><code>auth.enabled=false</code></li></ul><h3 id=4-install-kafka-and-mongodb-with-helm-charts>4. Install Kafka and MongoDB with helm charts</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add bitnami https://charts.bitnami.com/bitnami
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm install kafka --set <span style=color:#000>replicaCount</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span> --set metrics.jmx.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> --set metrics.kafka.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>  --set <span style=color:#000>deleteTopicEnable</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> bitnami/kafka
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm install mongodb --set metrics.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> bitnami/mongodb --set global.namespaceOverride<span style=color:#ce5c00;font-weight:700>=</span>default --set auth.rootUser<span style=color:#ce5c00;font-weight:700>=</span>root --set auth.rootPassword<span style=color:#ce5c00;font-weight:700>=</span>splunk --set auth.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span> --version 12.1.31
</span></span></code></pre></div><p>###verify the helm chart installation
helm list
NAME NAMESPACE REVISION UPDATED STATUS CHART APP VERSION
kafka default 1 2022-11-14 11:21:36.328956822 -0800 PST deployed kafka-19.1.3 3.3.1
mongodb default 1 2022-11-14 11:19:36.507690487 -0800 PST deployed mongodb-12.1.31 5.0.10</p><p>###verify the helm chart installation</p><p>kubectl get pods
NAME READY STATUS RESTARTS AGE
kafka-exporter-595778d7b4-99ztt 0/1 ContainerCreating 0 17s
mongodb-b7c968dbd-jxvsj 0/2 Pending 0 6s
kafka-1 0/2 ContainerCreating 0 16s
kafka-2 0/2 ContainerCreating 0 16s
kafka-zookeeper-0 0/1 Pending 0 17s
kafka-0 0/2 Pending 0 17s</p><pre tabindex=0><code>
Use information for each Helm chart and Splunk O11y Data Setup to generate values.yaml for capturing metrics from Kafka and MongoDB.


<div class="box notices cstyle default" style=--VARIABLE-BOX-color:info>
  <div class=box-label>Note</div>
  <div class=box-content>
<p><code>values.yaml</code> for the different services will be passed to the Splunk Helm Chart at installation time. These will configure the OTEL collector to capture metrics from these services.</p>
  </div>
</div>

- References:
  - [Apache Kafka packaged by Bitnami](https://github.com/bitnami/charts/tree/master/bitnami/spark/#installing-the-chart)
  - [Configure application receivers for databases » Apache Kafka](https://docs.splunk.com/Observability/gdi/kafka/kafka.html)
  - [Kafkametricsreceiver](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/kafkametricsreceiver)

#### 4.1 Example kafka.values.yaml

``` yaml
otelAgent:
config:
    receivers:
    receiver_creator:
        receivers:
        smartagent/kafka:
            rule: type == &#34;pod&#34; &amp;&amp; name matches &#34;kafka&#34;
            config:
                    #endpoint: &#39;`endpoint`:5555&#39;
            port: 5555
            type: collectd/kafka
            clusterName: sl-kafka
otelK8sClusterReceiver:
k8sEventsEnabled: true
config:
    receivers:
    kafkametrics:
        brokers: kafka:9092
        protocol_version: 2.0.0
        scrapers:
        - brokers
        - topics
        - consumers
    service:
    pipelines:
        metrics:
        receivers:
                #- prometheus
        - k8s_cluster
        - kafkametrics
</code></pre><h4 id=42-example-mongodbvaluesyaml>4.2 Example mongodb.values.yaml</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>otelAgent</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>receivers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>receiver_creator</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>receivers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>smartagent/mongodb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>rule</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type == &#34;pod&#34; &amp;&amp; name matches &#34;mongo&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>collectd/mongodb</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mongodb.default.svc.cluster.local</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>27017</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;admin&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;O11y&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;local&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;config&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>sendCollectionMetrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>sendCollectionTopMetrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h4 id=43-example-zookeepervaluesyaml>4.3 Example zookeeper.values.yaml</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>otelAgent</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>receivers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>receiver_creator</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>receivers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>smartagent/zookeeper</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>rule</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type == &#34;pod&#34; &amp;&amp; name matches &#34;kafka-zookeeper&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>collectd/zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kafka-zookeeper</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2181</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=5-install-the-splunk-otel-helm-chart>5. Install the Splunk OTEL helm chart</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ../otel_yamls
</span></span><span style=display:flex><span>repo add splunk-otel-collector-chart https://signalfx.github.io/splunk-otel-collector-chart
</span></span><span style=display:flex><span>helm repo update
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>helm install --set <span style=color:#000>provider</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39; &#39;</span> --set <span style=color:#000>distro</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39; &#39;</span> --set splunkObservability.accessToken<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$SPLUNK_ACCESS_TOKEN</span> --set <span style=color:#000>clusterName</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$clusterName</span> --set splunkObservability.realm<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$SPLUNK_REALM</span> --set otelCollector.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;false&#39;</span> --set splunkObservability.logsEnabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;true&#39;</span> --set gateway.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;false&#39;</span> --values kafka.values.yaml --values mongodb.values.yaml --values zookeeper.values.yaml --values alwayson.values.yaml --values k3slogs.yaml --generate-name splunk-otel-collector-chart/splunk-otel-collector
</span></span></code></pre></div><h3 id=6-verify-installation>6. Verify installation</h3><p>Verify that the Kafka, MongoDB and Splunk OTEL Collector helm charts are installed, note that names may differ.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>$helm list
</span></span><span style=display:flex><span>NAME                                NAMESPACE   REVISION    UPDATED                                 STATUS      CHART                           APP VERSION
</span></span><span style=display:flex><span>kafka                               default     1           2021-12-07 12:48:47.066421971 -0800 PST deployed    kafka-14.4.1                    2.8.1
</span></span><span style=display:flex><span>mongodb                             default     1           2021-12-07 12:49:06.132771625 -0800 PST deployed    mongodb-10.29.2                 4.4.10
</span></span><span style=display:flex><span>splunk-otel-collector-1638910184    default     1           2021-12-07 12:49:45.694013749 -0800 PST deployed    splunk-otel-collector-0.37.1    0.37.1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get pods
</span></span><span style=display:flex><span>NAME                                                              READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>kafka-zookeeper-0                                                 1/1     Running   0          18m
</span></span><span style=display:flex><span>kafka-2                                                           2/2     Running   1          18m
</span></span><span style=display:flex><span>mongodb-79cf87987f-gsms8                                          2/2     Running   0          18m
</span></span><span style=display:flex><span>kafka-1                                                           2/2     Running   1          18m
</span></span><span style=display:flex><span>kafka-exporter-7c65fcd646-dvmtv                                   1/1     Running   3          18m
</span></span><span style=display:flex><span>kafka-0                                                           2/2     Running   1          18m
</span></span><span style=display:flex><span>splunk-otel-collector-1638910184-agent-27s5c                      2/2     Running   0          17m
</span></span><span style=display:flex><span>splunk-otel-collector-1638910184-k8s-cluster-receiver-8587qmh9l   1/1     Running   0          17m
</span></span></code></pre></div><h3 id=7-verify-dashboards>7. Verify dashboards</h3><p>Verify that out of the box dashboards for Kafka, MongoDB and Zookeeper are populated in the Infrastructure Monitor landing page. Drill down into each component to view granular details for each service.</p><ul><li>Infrastructure Monitoring Landing page:</li></ul><p><a href=#image-e96f5e23f717d6bb8ff561477b2b9250 class=lightbox-link><img src=/observability-workshop/v4.55/tko/session-2/docs/deploy/../images/inframon.jpg alt=IM-landing-page style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-e96f5e23f717d6bb8ff561477b2b9250><img src=/observability-workshop/v4.55/tko/session-2/docs/deploy/../images/inframon.jpg alt=IM-landing-page class=lightbox-image loading=lazy></a></p><ul><li>K8 Navigator:</li></ul><p><a href=#image-778c957ab9e20ed650081fa3039c11b7 class=lightbox-link><img src=/observability-workshop/v4.55/tko/session-2/docs/deploy/../images/k8navigator.jpg alt=k8-navigator style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-778c957ab9e20ed650081fa3039c11b7><img src=/observability-workshop/v4.55/tko/session-2/docs/deploy/../images/k8navigator.jpg alt=k8-navigator class=lightbox-image loading=lazy></a></p><ul><li>MongoDB Dashboard:</li></ul><p><a href=#image-676685b401c1992f3471d610e81e22b9 class=lightbox-link><img src=/observability-workshop/v4.55/tko/session-2/docs/deploy/../images/mongoDB.jpg alt=mongodb-dash style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-676685b401c1992f3471d610e81e22b9><img src=/observability-workshop/v4.55/tko/session-2/docs/deploy/../images/mongoDB.jpg alt=mongodb-dash class=lightbox-image loading=lazy></a></p><ul><li>Kafka Dashboard:</li></ul><p><a href=#image-bb661a0853024aa1cf4eb3db9c002064 class=lightbox-link><img src=/observability-workshop/v4.55/tko/session-2/docs/deploy/../images/kafka.jpg alt=kafka-dash style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-bb661a0853024aa1cf4eb3db9c002064><img src=/observability-workshop/v4.55/tko/session-2/docs/deploy/../images/kafka.jpg alt=kafka-dash class=lightbox-image loading=lazy></a></p><footer class=footline></footer></article><article class=default><h1 id=code-to-kubernetes---python>Code to Kubernetes - Python</h1><h2 id=code-to-kubernetes---python>Code to Kubernetes - Python</h2><p><strong>Objective:</strong> Understand activities to instrument a python application and run it on Kubernetes.</p><ul><li>Verify the code</li><li>Containerize the app</li><li>Deploy the container in Kubernetes</li></ul><p><strong>Note:</strong> these steps do not involve Splunk</p><p><strong>Duration:</strong> 15 Minutes</p><h2 id=1-verify-the-code---review-service>1. Verify the code - Review service</h2><p>Inspect review.py (workshop/flask_apps_start/review)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>flask</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>Flask</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>jsonify</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>random</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>subprocess</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>review</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Flask</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__name__</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>num_reviews</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>8635403</span>
</span></span><span style=display:flex><span><span style=color:#000>num_reviews</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>100000</span>
</span></span><span style=display:flex><span><span style=color:#000>reviews_file</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;/var/appdata/yelp_academic_dataset_review.json&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@review.route</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hello_world</span><span style=color:#000;font-weight:700>():</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>jsonify</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Hello, you want to hit /get_review. We have &#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87>str</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>num_reviews</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39; reviews!&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@review.route</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;/get_review&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>get_review</span><span style=color:#000;font-weight:700>():</span>
</span></span><span style=display:flex><span>    <span style=color:#000>random_review_int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>str</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>random</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>randint</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>num_reviews</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>    <span style=color:#000>line_num</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>random_review_int</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;q;d&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>command</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;sed&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>line_num</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>reviews_file</span><span style=color:#000;font-weight:700>]</span> <span style=color:#8f5902;font-style:italic># sed &#34;7997242q;d&#34; &lt;file&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>random_review</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>subprocess</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>run</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>command</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>stdout</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>subprocess</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>PIPE</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>True</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>random_review</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>stdout</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>__name__</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;__main__&#34;</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>review</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>run</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>host</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;0.0.0.0&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>5000</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>debug</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>True</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><p>Inspect requirements.txt</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Flask==2.0.2
</span></span></code></pre></div><p>Create a virtual environment and Install the necessary python packages</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> workshop/flask_apps_start/review
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>python3 -m venv rtapp-workshop
</span></span><span style=display:flex><span><span style=color:#204a87>source</span> rtapp-workshop/bin/activate
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pip freeze <span style=color:#8f5902;font-style:italic>#note output</span>
</span></span><span style=display:flex><span>pip install -r requirements.txt
</span></span><span style=display:flex><span>pip freeze <span style=color:#8f5902;font-style:italic>#note output</span>
</span></span></code></pre></div><p>Start the REVIEW service. <strong>Note:</strong> You can stop the app with control+C</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python3 review.py
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> * Serving Flask app <span style=color:#4e9a06>&#39;review&#39;</span> <span style=color:#ce5c00;font-weight:700>(</span>lazy loading<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span> * Environment: production
</span></span><span style=display:flex><span>         ...snip...
</span></span><span style=display:flex><span> * Running on http://10.160.145.246:5000/ <span style=color:#ce5c00;font-weight:700>(</span>Press CTRL+C to quit<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span> * Restarting with stat
</span></span><span style=display:flex><span>127.0.0.1 - - <span style=color:#ce5c00;font-weight:700>[</span>17/May/2022 22:46:38<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#4e9a06>&#34;GET / HTTP/1.1&#34;</span> <span style=color:#0000cf;font-weight:700>200</span> -
</span></span><span style=display:flex><span>127.0.0.1 - - <span style=color:#ce5c00;font-weight:700>[</span>17/May/2022 22:47:02<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#4e9a06>&#34;GET /get_review HTTP/1.1&#34;</span> <span style=color:#0000cf;font-weight:700>200</span> -
</span></span><span style=display:flex><span>127.0.0.1 - - <span style=color:#ce5c00;font-weight:700>[</span>17/May/2022 22:47:58<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#4e9a06>&#34;GET /get_review HTTP/1.1&#34;</span> <span style=color:#0000cf;font-weight:700>200</span> -
</span></span></code></pre></div><p>Verify that the service is working</p><ul><li>Use curl in your terminal</li><li>Or hit the URL <code>http://{Your_EC2_IP_address}:5000</code> and <code>http://{Your_EC2_IP_address}:5000/get_review</code> with a browser</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl localhost:5000
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;message&#34;</span>: <span style=color:#4e9a06>&#34;Hello, you want to hit /get_review. We have 100000 reviews!&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl localhost:5000/get_review
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;review_id&#34;</span>:<span style=color:#4e9a06>&#34;NjbiESXotcEdsyTc4EM3fg&#34;</span>,<span style=color:#4e9a06>&#34;user_id&#34;</span>:<span style=color:#4e9a06>&#34;PR9LAM19rCM_HQiEm5OP5w&#34;</span>,<span style=color:#4e9a06>&#34;business_id&#34;</span>:<span style=color:#4e9a06>&#34;UAtX7xmIfdd1W2Pebf6NWg&#34;</span>,<span style=color:#4e9a06>&#34;stars&#34;</span>:3.0,<span style=color:#4e9a06>&#34;useful&#34;</span>:0,<span style=color:#4e9a06>&#34;funny&#34;</span>:0,<span style=color:#4e9a06>&#34;cool&#34;</span>:0,<span style=color:#4e9a06>&#34;text&#34;</span>:<span style=color:#4e9a06>&#34;-If you&#39;re into cheap beer (pitcher of bud-light for </span><span style=color:#000>$7</span><span style=color:#4e9a06>) decent wings and a good time, this is the place for you. Its generally very packed after work hours and weekends. Don&#39;t expect cocktails. \n\n-You run into a lot of sketchy characters here sometimes but for the most part if you&#39;re chilling with friends its not that bad. \n\n-Friendly bouncer and bartenders.&#34;</span>,<span style=color:#4e9a06>&#34;date&#34;</span>:<span style=color:#4e9a06>&#34;2016-04-12 20:23:24&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><ul><li>What does this application do?</li><li>Do you see the yelp dataset being used?</li><li>Why did the output of pip freeze differ each time you ran it?</li><li>Which port is the REVIEW app listening on? Can other python apps use this same port?</li></ul></div></div>}</p><h2 id=2-create-a-review-container>2. Create a REVIEW container</h2><p>To create a container image, you need to create a Dockerfile, run docker build to build the image referencing the Docker file and push it up to a remote repository so it can be pulled by other sources.</p><ul><li><a href=https://docs.docker.com/get-started/02_our_app/ target=_blank>Create a Dockerfile</a></li><li>Creating a Dockerfile typically requires you to consider the following:<ul><li>Identify an appropriate container image<ul><li>ubuntu vs. python vs. alpine/slim</li><li>ubuntu - overkill, large image size, wasted resources when running in K8</li><li>this is a python app, so pick an image that is optimized for it</li><li><a href=https://lih-verma.medium.com/alpine-makes-python-docker-builds-way-too-50-slower-and-images-double-2-larger-61d1d43cbc79 target=_blank>avoid alpine for python</a></li></ul></li><li>Order matters<ul><li>you&rsquo;re building layers.</li><li>re-use the layers as much as possible</li><li>have items that change often towards the end</li></ul></li><li><a href=https://docs.docker.com/develop/develop-images/dockerfile_best-practices/ target=_blank>Other Best practices for writing Dockerfiles</a></li></ul></li></ul><p>Dockerfile for review</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> python:3.10-slim</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>WORKDIR</span><span style=color:#4e9a06> /app</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> requirements.txt /app<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> pip install -r requirements.txt<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> ./review.py /app<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>EXPOSE</span><span style=color:#4e9a06> 5000</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>CMD</span> <span style=color:#000;font-weight:700>[</span> <span style=color:#4e9a06>&#34;python&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;review.py&#34;</span> <span style=color:#000;font-weight:700>]</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Create a container image (locally)
Run ‘docker build’ to build a local container image referencing the Dockerfile</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>(</span>venv<span style=color:#ce5c00;font-weight:700>)</span>% docker build -f Dockerfile -t localhost:8000/review:0.01 .
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>+<span style=color:#ce5c00;font-weight:700>]</span> Building 35.5s <span style=color:#ce5c00;font-weight:700>(</span>11/11<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>FINISHED</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#ce5c00;font-weight:700>[</span>internal<span style=color:#ce5c00;font-weight:700>]</span> load build definition from Dockerfile                              0.0s
</span></span><span style=display:flex><span>         ...snip...
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#ce5c00;font-weight:700>[</span>3/5<span style=color:#ce5c00;font-weight:700>]</span> COPY requirements.txt /app                                              0.0s
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#ce5c00;font-weight:700>[</span>4/5<span style=color:#ce5c00;font-weight:700>]</span> RUN pip install -r requirements.txt                                     4.6s
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#ce5c00;font-weight:700>[</span>5/5<span style=color:#ce5c00;font-weight:700>]</span> COPY ./review.py /app                                                   0.0s
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; exporting to image                                                            0.2s
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#ce5c00;font-weight:700>=</span>&gt; exporting layers                                                           0.2s
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#ce5c00;font-weight:700>=</span>&gt; writing image sha256:61da27081372723363d0425e0ceb34bbad6e483e698c6fe439c5  0.0s
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#ce5c00;font-weight:700>=</span>&gt; naming to docker.io/localhost:8000/review:0.1                                   0.0
</span></span></code></pre></div><p>Push the container image into a container repository
Run ‘docker push’ to place a copy of the REVIEW container to a remote location</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker push localhost:8000/review:0.01
</span></span><span style=display:flex><span>The push refers to repository <span style=color:#ce5c00;font-weight:700>[</span>docker.io/localhost:8000/review<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>02c36dfb4867: Pushed
</span></span><span style=display:flex><span>         ...snip...
</span></span><span style=display:flex><span>fd95118eade9: Pushed
</span></span><span style=display:flex><span>0.1: digest: sha256:3651f740abe5635af95d07acd6bcf814e4d025fcc1d9e4af9dee023a9b286f38 size: <span style=color:#0000cf;font-weight:700>2202</span>
</span></span></code></pre></div><p>Verify that the image is in Docker Hub. The same info can be found in Docker Desktop</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -s http://localhost:8000/v2/_catalog
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;repositories&#34;</span>:<span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;review&#34;</span><span style=color:#ce5c00;font-weight:700>]}</span>
</span></span></code></pre></div><h2 id=3-run-review-in-kubernetes>3. Run REVIEW in Kubernetes</h2><p>Create K8 deployment yaml file for the REVIEW app</p><p>Reference: <a href=https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#creating-a-deployment target=_blank>Creating a Deployment</a></p><p>review.deployment.yaml</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>imagePullSecrets</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>regcred</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>localhost:8000/review:0.01</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>volumeMounts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>mountPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/appdata</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>appdata</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>volumes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>appdata</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>hostPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/appdata</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Notes regarding review.deployment.yaml:</p><ul><li>labels - K8 uses labels and selectors to tag and identify resources<ul><li>In the next step, we&rsquo;ll create a service and associate it to this deployment using the label</li></ul></li><li>replicas = 1<ul><li>K8 allows you to scale your deployments horizontally</li><li>We&rsquo;ll leverage this later to add load and increase our ingestion rate</li></ul></li><li>regcred provides this deployment with the ability to access your dockerhub credentials which is necessary to pull the container image.</li><li>The volume definition and volumemount make the yelp dataset visible to the container</li></ul><p>Create a K8 service yaml file for the review app.</p><p>Reference: <a href=https://kubernetes.io/docs/concepts/services-networking/service/#defining-a-service target=_blank>Creating a service:</a></p><p>review.service.yaml</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NodePort</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>nodePort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>30000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Notes about review.service.yaml:</p><ul><li>the selector associates this service to pods with the label app with the value being review</li><li>the review service exposes the review pods as a network service<ul><li>other pods can now ping &lsquo;review&rsquo; and they will hit a review pod.</li><li>a pod would get a review if it ran <code>curl http://review:5000</code></li></ul></li><li>NodePort service<ul><li>the service is accessible to the K8 host by the nodePort, 30000</li><li>Another machine that has this can get a review if it ran <code>curl http://&lt;k8 host ip>:30000</code></li></ul></li></ul><p>Apply the review deployment and service</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f review.service.yaml -f review.deployment.yaml
</span></span></code></pre></div><p>Verify that the deployment and services are running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>ubuntu@ip-10-0-1-54:/tmp$ kubectl get deployments
</span></span><span style=display:flex><span>NAME                                                    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>review                                                  1/1     1            1           19h
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ubuntu@ip-10-0-1-54:/tmp$ kubectl get services
</span></span><span style=display:flex><span>NAME                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                         AGE
</span></span><span style=display:flex><span>review                     NodePort    10.43.175.21    &lt;none&gt;        5000:30000/TCP                  154d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ubuntu@ip-10-0-1-54:/tmp$ curl localhost:30000
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;message&#34;: &#34;Hello, you want to hit /get_review. We have 100000 reviews!&#34;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>ubuntu@ip-10-0-1-54:/tmp$ curl localhost:30000/get_review
</span></span><span style=display:flex><span>{&#34;review_id&#34;:&#34;Vv9rHtfBrFc-1M1DHRKN9Q&#34;,&#34;user_id&#34;:&#34;EaNqIwKkM7p1bkraKotqrg&#34;,&#34;business_id&#34;:&#34;TA1KUSCu8GkWP9w0rmElxw&#34;,&#34;stars&#34;:3.0,&#34;useful&#34;:1,&#34;funny&#34;:0,&#34;cool&#34;:0,&#34;text&#34;:&#34;This is the first time I&#39;ve actually written a review for Flip, but I&#39;ve probably been here about 10 times.  \n\nThis used to be where I would take out of town guests who wanted a good, casual, and relatively inexpensive meal.  \n\nI hadn&#39;t been for a while, so after a long day in midtown, we decided to head to Flip.  \n\nWe had the fried pickles, onion rings, the gyro burger, their special burger, and split a nutella milkshake.  I have tasted all of the items we ordered previously (with the exception of the special) and have been blown away with how good they were.  My guy had the special which was definitely good, so no complaints there.  The onion rings and the fried pickles were greasier than expected.  Though I&#39;ve thought they were delicious in the past, I probably wouldn&#39;t order either again.  The gyro burger was good, but I could have used a little more sauce.  It almost tasted like all of the ingredients didn&#39;t entirely fit together.  Something was definitely off. It was a friday night and they weren&#39;t insanely busy, so I&#39;m not sure I would attribute it to the staff not being on their A game...\n\nDon&#39;t get me wrong.  Flip is still good.  The wait staff is still amazingly good looking.  They still make delicious milk shakes.  It&#39;s just not as amazing as it once was, which really is a little sad.&#34;,&#34;date&#34;:&#34;2010-10-11 18:18:35&#34;}
</span></span></code></pre></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>What changes are required if you need to make an update to your Dockerfile now?</p></div></div><footer class=footline></footer></article><article class=default><h1 id=instrument-reviews-for-tracing>Instrument REVIEWS for Tracing</h1><h2 id=1-use-data-setup-to-instrument-a-python-application>1. Use Data Setup to instrument a Python application</h2><p>Within the O11y Cloud UI:</p><p>Data Setup -> Monitor Applications -> Python (traces) -> Add Integration</p><p>Provide the following to the Configure Integration Wizard:</p><ul><li><p>Service: review</p></li><li><p>Django: no</p></li><li><p>collector endpoint: <code>http://localhost:4317</code></p></li><li><p>Environment: rtapp-workshop-[YOURNAME]</p></li><li><p>Kubernetes: yes</p></li><li><p>Legacy Agent: no</p></li></ul><p><a href=#image-38165b714cb5447265b9ad4a74b3313a class=lightbox-link><img src=/observability-workshop/v4.55/tko/session-2/docs/instrument/../images/configureintegration.png alt=o11y_cloud_ui style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-38165b714cb5447265b9ad4a74b3313a><img src=/observability-workshop/v4.55/tko/session-2/docs/instrument/../images/configureintegration.png alt=o11y_cloud_ui class=lightbox-image loading=lazy></a></p><p>We are instructed to:</p><ul><li><p>Install the instrumentation packages for your Python environment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>pip install splunk-opentelemetry[all]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>splunk-py-trace-bootstrap
</span></span></code></pre></div></li><li><p>Configure the Downward API to expose environment variables to Kubernetes resources.</p><p>For example, update a Deployment to inject environment variables by adding <code>.spec.template.spec.containers.env</code> like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>your-application</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SPLUNK_OTEL_AGENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>status.hostIP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OTEL_EXPORTER_OTLP_ENDPOINT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;http://$(SPLUNK_OTEL_AGENT):4317&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OTEL_SERVICE_NAME</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;review&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OTEL_RESOURCE_ATTRIBUTES</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;deployment.environment=rtapp-workshop-stevel&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li><li><p>Enable the Splunk OTel Python agent by editing your Python service command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>splunk-py-trace python3 main.py --port=8000
</span></span></code></pre></div></li><li><p>The actions we must perform include:</p><ul><li>Update the Dockerfile to install the splunk-opentelemetry packages</li><li>Update the deployment.yaml for each service to include these environment variables which will be used by the pod and container.</li><li>Update our Dockerfile for REVIEW so that our program is bootstrapped with splunk-py-trace</li></ul></li></ul><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Note</div><div class=box-content><p>We will accomplish this by 1) generating a new requirements.txt file, 2) generating a new container image with an updated Dockerfile for REVIEW and then 3) update the review.deployment.yaml to capture all of these changes.</p></div></div><h2 id=2-update-the-review-container>2. Update the REVIEW container</h2><ul><li><p>Generate a new container image</p></li><li><p>Update the Dockerfile for REVIEW (<code>/workshop/flask_apps_finish/review</code>)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> python:3.10-slim</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>WORKDIR</span><span style=color:#4e9a06> /app</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> requirements.txt /app<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> pip install -r requirements.txt<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> pip install splunk-opentelemetry<span style=color:#ce5c00;font-weight:700>[</span>all<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> splk-py-trace-bootstrap<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> ./review.py /app<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>EXPOSE</span><span style=color:#4e9a06> 5000</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENTRYPOINT</span> <span style=color:#000;font-weight:700>[</span> <span style=color:#4e9a06>&#34;splunk-py-trace&#34;</span> <span style=color:#000;font-weight:700>]</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>CMD</span> <span style=color:#000;font-weight:700>[</span> <span style=color:#4e9a06>&#34;python&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;review.py&#34;</span> <span style=color:#000;font-weight:700>]</span><span style=color:#a40000>
</span></span></span></code></pre></div></li></ul><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Note</div><div class=box-content><p>Note that the only lines, in bold, added to the Dockerfile</p></div></div><ul><li><p>Generate a new container image with docker build in the ‘finished’ directory</p></li><li><p>Notice that I have changed the repository name from <code>localhost:8000/review:0.01</code> to <code>localhost:8000/review-splkotel:0.01</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>pwd
</span></span><span style=display:flex><span>./workshop/flask_apps_finish/review
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker build -f Dockerfile.review -t localhost:8000/review-splkotel:0.01 .
</span></span><span style=display:flex><span>[+] Building 27.1s (12/12) FINISHED
</span></span><span style=display:flex><span>=&gt; [internal] load build definition from Dockerfile                                                        0.0s
</span></span><span style=display:flex><span>=&gt; =&gt; transferring dockerfile: 364B                                                                        0.0s
</span></span><span style=display:flex><span>=&gt; [internal] load .dockerignore                                                                           0.0s
</span></span><span style=display:flex><span>=&gt; =&gt; transferring context: 2B                                                                             0.0s
</span></span><span style=display:flex><span>=&gt; [internal] load metadata for docker.io/library/python:3.10-slim                                         1.6s
</span></span><span style=display:flex><span>=&gt; [auth] library/python:pull token for registry-1.docker.io                                               0.0s
</span></span><span style=display:flex><span>=&gt; [1/6] FROM docker.io/library/python:3.10-slim@sha256:54956d6c929405ff651516d5ebbc204203a6415c9d2757aad  0.0s
</span></span><span style=display:flex><span>=&gt; [internal] load build context                                                                           0.3s
</span></span><span style=display:flex><span>=&gt; =&gt; transferring context: 1.91kB                                                                         0.3s
</span></span><span style=display:flex><span>=&gt; CACHED [2/6] WORKDIR /app                                                                               0.0s
</span></span><span style=display:flex><span>=&gt; [3/6] COPY requirements.txt /app                                                                        0.0s
</span></span><span style=display:flex><span>=&gt; [4/6] RUN pip install -r requirements.txt                                                              15.3s
</span></span><span style=display:flex><span>=&gt; [5/6] RUN splk-py-trace-bootstrap                                                                       9.0s
</span></span><span style=display:flex><span>=&gt; [6/6] COPY ./review.py /app                                                                             0.0s
</span></span><span style=display:flex><span>=&gt; exporting to image                                                                                      0.6s
</span></span><span style=display:flex><span>=&gt; =&gt; exporting layers                                                                                     0.6s
</span></span><span style=display:flex><span>=&gt; =&gt; writing image sha256:164977dd860a17743b8d68bcc50c691082bd3bfb352d1025dc3a54b15d5f4c4d                0.0s
</span></span><span style=display:flex><span>=&gt; =&gt; naming to docker.io/localhost:8000/review-splkotel:0.01                                              0.0s
</span></span></code></pre></div></li><li><p>Push the image to Docker Hub with docker push command</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>docker push localhost:8000/review-splkotel:0.01
</span></span><span style=display:flex><span>The push refers to repository [docker.io/localhost:8000/review-splkotel]
</span></span><span style=display:flex><span>682f0e550f2c: Pushed
</span></span><span style=display:flex><span>dd7dfa312442: Pushed
</span></span><span style=display:flex><span>917fd8334695: Pushed
</span></span><span style=display:flex><span>e6782d51030d: Pushed
</span></span><span style=display:flex><span>c6b19a64e528: Mounted from localhost:8000/review
</span></span><span style=display:flex><span>8f52e3bfc0ab: Mounted from localhost:8000/review
</span></span><span style=display:flex><span>f90b85785215: Mounted from localhost:8000/review
</span></span><span style=display:flex><span>d5c0beb90ce6: Mounted from localhost:8000/review
</span></span><span style=display:flex><span>3759be374189: Mounted from localhost:8000/review
</span></span><span style=display:flex><span>fd95118eade9: Mounted from localhost:8000/review
</span></span><span style=display:flex><span>0.01: digest: sha256:3b251059724dbb510ea81424fc25ed03554221e09e90ef965438da33af718a45 size: 2412
</span></span></code></pre></div></li></ul><h2 id=3-update-the-review-deployment-in-kubernetes>3. Update the REVIEW deployment in Kubernetes</h2><ul><li><p>review.deployment.yaml must be updated with the following changes:</p><ul><li>Load the new container image on Docker Hub</li><li>Add environment variables so traces can be emitted to the OTEL collector</li></ul></li><li><p>The deployment must be replaced using the updated review.deployment.yaml</p><ul><li>Update review.deployment.yaml (updates highlighted in bold)</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>imagePullSecrets</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>regcred</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>localhost:8000/review-splkotel:0.01</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>volumeMounts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>mountPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/appdata</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>appdata</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SPLUNK_OTEL_AGENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>status.hostIP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OTEL_SERVICE_NAME</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;review&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SPLUNK_METRICS_ENDPOINT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;http://$(SPLUNK_OTEL_AGENT):9943&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OTEL_EXPORTER_OTLP_ENDPOINT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;http://$(SPLUNK_OTEL_AGENT):4317&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OTEL_RESOURCE_ATTRIBUTES</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;deployment.environment=rtapp-workshop-stevel&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>volumes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>appdata</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>hostPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/appdata</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></li><li><p>Apply review.deployment.yaml. Kubernetes will automatically pick up the changes to the deployment and redeploy new pods with these updates</p><ul><li>Notice that the review-* pod has been restarted</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>kubectl apply -f review.deployment.yaml
</span></span><span style=display:flex><span>deployment.apps/review configured
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get pods
</span></span><span style=display:flex><span>NAME                                                              READY   STATUS        RESTARTS   AGE
</span></span><span style=display:flex><span>kafka-client                                                      0/1     Unknown       0          155d
</span></span><span style=display:flex><span>curl                                                              0/1     Unknown       0          155d
</span></span><span style=display:flex><span>kafka-zookeeper-0                                                 1/1     Running       0          26h
</span></span><span style=display:flex><span>kafka-2                                                           2/2     Running       0          26h
</span></span><span style=display:flex><span>kafka-exporter-647bddcbfc-h9gp5                                   1/1     Running       2          26h
</span></span><span style=display:flex><span>mongodb-6f6c78c76-kl4vv                                           2/2     Running       0          26h
</span></span><span style=display:flex><span>kafka-1                                                           2/2     Running       1          26h
</span></span><span style=display:flex><span>kafka-0                                                           2/2     Running       1          26h
</span></span><span style=display:flex><span>splunk-otel-collector-1653114277-agent-n4dfn                      2/2     Running       0          26h
</span></span><span style=display:flex><span>splunk-otel-collector-1653114277-k8s-cluster-receiver-5f48v296j   1/1     Running       0          26h
</span></span><span style=display:flex><span>splunk-otel-collector-1653114277-agent-jqxhh                      2/2     Running       0          26h
</span></span><span style=display:flex><span>review-6686859bd7-4pf5d                                           1/1     Running       0          11s
</span></span><span style=display:flex><span>review-5dd8cfd77b-52jbd                                           0/1     Terminating   0          2d10h
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get pods
</span></span><span style=display:flex><span>NAME                                                              READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>kafka-client                                                      0/1     Unknown   0          155d
</span></span><span style=display:flex><span>curl                                                              0/1     Unknown   0          155d
</span></span><span style=display:flex><span>kafka-zookeeper-0                                                 1/1     Running   0          26h
</span></span><span style=display:flex><span>kafka-2                                                           2/2     Running   0          26h
</span></span><span style=display:flex><span>kafka-exporter-647bddcbfc-h9gp5                                   1/1     Running   2          26h
</span></span><span style=display:flex><span>mongodb-6f6c78c76-kl4vv                                           2/2     Running   0          26h
</span></span><span style=display:flex><span>kafka-1                                                           2/2     Running   1          26h
</span></span><span style=display:flex><span>kafka-0                                                           2/2     Running   1          26h
</span></span><span style=display:flex><span>splunk-otel-collector-1653114277-agent-n4dfn                      2/2     Running   0          26h
</span></span><span style=display:flex><span>splunk-otel-collector-1653114277-k8s-cluster-receiver-5f48v296j   1/1     Running   0          26h
</span></span><span style=display:flex><span>splunk-otel-collector-1653114277-agent-jqxhh                      2/2     Running   0          26h
</span></span><span style=display:flex><span>review-6686859bd7-4pf5d                                           1/1     Running   0          15s
</span></span></code></pre></div></li></ul><footer class=footline></footer></article><article class=default><h1 id=monitor-system-logs-with-splunk-universal-forwarder>Monitor System Logs with Splunk Universal Forwarder</h1><p><strong>Objective:</strong> Learn how to monitor Linux system logs with the Universal Forwarder sending logs to Splunk Enterprise</p><p><strong>Duration</strong>: 10 Minutes</p><h2 id=scenario>Scenario</h2><p>You&rsquo;ve been tasked with monitoring the OS logs of the host running your Kubernetes cluster. We are going to utilize a script that will autodeploy the Splunk Universal Forwarder. You will then configure the Universal Forwarder to send logs to the Splunk Enterprise instance assigned to you.</p><h3 id=1-ensure-youre-in-the-correct-directory>1. Ensure You&rsquo;re in the Correct Directory</h3><ul><li>we will need to be in /home/ubuntu/session-2</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> /home/ubuntu/session-2
</span></span></code></pre></div><h3 id=2-review-the-universal-forwarder-install-script>2. Review the Universal Forwarder Install Script</h3><ul><li>Let&rsquo;s take a look at the script that will install the Universal Forwarder and Linux TA automatically for you.<ul><li>This script is primarily used for remote instances.</li><li>Note we are not using a deployment server in this lab, however it is recommended in production we do that.</li><li>What user are we installing Splunk as?</li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/sh  
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic># This EXAMPLE script shows how to deploy the Splunk universal forwarder</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># to many remote hosts via ssh and common Unix commands.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># For &#34;real&#34; use, this script needs ERROR DETECTION AND LOGGING!!</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># --Variables that you must set -----</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Set username using by splunkd to run.</span>
</span></span><span style=display:flex><span>  <span style=color:#000>SPLUNK_RUN_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;ubuntu&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Populate this file with a list of hosts that this script should install to,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># with one host per line. This must be specified in the form that should</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># be used for the ssh login, ie. username@host</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Example file contents:</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># splunkuser@10.20.13.4</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># splunkker@10.20.13.5</span>
</span></span><span style=display:flex><span>  <span style=color:#000>HOSTS_FILE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;myhost.txt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># This should be a WGET command that was *carefully* copied from splunk.com!!</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Sign into splunk.com and go to the download page, then look for the wget</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># link near the top of the page (once you have selected your platform)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># copy and paste your wget command between the &#34;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>WGET_CMD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;wget -O splunkforwarder-9.0.3-dd0128b1f8cd-Linux-x86_64.tgz &#39;https://download.splunk.com/products/universalforwarder/releases/9.0.3/linux/splunkforwarder-9.0.3-dd0128b1f8cd-Linux-x86_64.tgz&#39;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Set the install file name to the name of the file that wget downloads</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># (the second argument to wget)</span>
</span></span><span style=display:flex><span>  <span style=color:#000>INSTALL_FILE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;splunkforwarder-9.0.3-dd0128b1f8cd-Linux-x86_64.tgz&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># After installation, the forwarder will become a deployment client of this</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># host.  Specify the host and management (not web) port of the deployment server</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># that will be managing these forwarder instances.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Example 1.2.3.4:8089</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#  DEPLOY_SERVER=&#34;x.x.x.x:8089&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># After installation, the forwarder can have additional TA&#39;s added to the </span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /app directory please provide the local where TA&#39;s will be. </span>
</span></span><span style=display:flex><span>  <span style=color:#000>TA_INSTALL_DIRECTORY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/home/ubuntu/session-2&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Set the seed app folder name for deploymentclien.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#  DEPLOY_APP_FOLDER_NAME=&#34;seed_all_deploymentclient&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Set the new Splunk admin password</span>
</span></span><span style=display:flex><span>  <span style=color:#000>PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;buttercup&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>REMOTE_SCRIPT_DEPLOY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  cd /opt
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  sudo </span><span style=color:#000>$WGET_CMD</span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  sudo tar xvzf </span><span style=color:#000>$INSTALL_FILE</span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  sudo rm </span><span style=color:#000>$INSTALL_FILE</span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  #sudo useradd </span><span style=color:#000>$SPLUNK_RUN_USER</span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  sudo find </span><span style=color:#000>$TA_INSTALL_DIRECTORY</span><span style=color:#4e9a06> -name &#39;*.tgz&#39; -exec tar xzvf {} --directory /opt/splunkforwarder/etc/apps \;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  sudo chown -R </span><span style=color:#000>$SPLUNK_RUN_USER</span><span style=color:#4e9a06>:</span><span style=color:#000>$SPLUNK_RUN_USER</span><span style=color:#4e9a06> /opt/splunkforwarder
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  echo \&#34;[user_info] 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  USERNAME = admin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  PASSWORD = </span><span style=color:#000>$PASSWORD</span><span style=color:#4e9a06>\&#34; &gt; /opt/splunkforwarder/etc/system/local/user-seed.conf   
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  #sudo cp </span><span style=color:#000>$TA_INSTALL_DIRECTORY</span><span style=color:#4e9a06>/*.tgz /opt/splunkforwader/etc/apps/
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  #sudo find /opt/splunkforwarder/etc/apps/ -name &#39;*.tgz&#39; -exec tar xzvf {} \;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  #sudo -u splunk /opt/splunkforwarder/bin/splunk start --accept-license --answer-yes --auto-ports --no-prompt
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  /opt/splunkforwarder/bin/splunk start --accept-license --answer-yes --auto-ports --no-prompt
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  #sudo /opt/splunkforwarder/bin/splunk enable boot-start -user </span><span style=color:#000>$SPLUNK_RUN_USER</span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  /opt/splunkforwarder/bin/splunk enable boot-start -user </span><span style=color:#000>$SPLUNK_RUN_USER</span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  #sudo cp </span><span style=color:#000>$TA_INSTALL_DIRECTORY</span><span style=color:#4e9a06>/*.tgz /opt/splunkforwarder/etc/apps/
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  exit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06> &#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>DIR</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>$(</span> <span style=color:#204a87>cd</span> <span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>$(</span> dirname <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BASH_SOURCE</span><span style=color:#000;font-weight:700>[0]</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span> &gt;/dev/null <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>pwd</span> <span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#===============================================================================================</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;In 5 seconds, will run the following script on each remote host:&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;====================&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$REMOTE_SCRIPT_DEPLOY</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;====================&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> 
</span></span><span style=display:flex><span>  sleep <span style=color:#0000cf;font-weight:700>5</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Reading host logins from </span><span style=color:#000>$HOSTS_FILE</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Starting.&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>for</span> DST in <span style=color:#4e9a06>`</span>cat <span style=color:#4e9a06>&#34;</span><span style=color:#000>$DIR</span><span style=color:#4e9a06>/</span><span style=color:#000>$HOSTS_FILE</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>`</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> -z <span style=color:#4e9a06>&#34;</span><span style=color:#000>$DST</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>continue</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;---------------------------&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Installing to </span><span style=color:#000>$DST</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Initial UF deployment&#34;</span>
</span></span><span style=display:flex><span>    sudo ssh -t <span style=color:#4e9a06>&#34;</span><span style=color:#000>$DST</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$REMOTE_SCRIPT_DEPLOY</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>done</span>  
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;---------------------------&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Done&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Please use the following app folder name to override deploymentclient.conf options: </span><span style=color:#000>$DEPLOY_APP_FOLDER_NAME</span><span style=color:#4e9a06>&#34;</span>
</span></span></code></pre></div><h3 id=3-run-the-install-script>3. Run the install script</h3><p>We will run the install script now. You will see some Warnings at the end. This is totally normal.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./install.sh
</span></span></code></pre></div><h3 id=4-verify-installation-of-the-universal-forwarader>4. Verify installation of the Universal Forwarader</h3><ul><li>We need to verify that the Splunk Universal Forwarder is installed and running.<ul><li>You should see a couple PID&rsquo;s return and a &ldquo;Splunk is currently running.&rdquo; message.</li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/opt/splunkforwarder/bin/splunk status
</span></span></code></pre></div><h4 id=5-configure-the-universal-forwarder-to-send-data-to-splunk-enterprise>5. Configure the Universal Forwarder to Send Data to Splunk Enterprise.</h4><ul><li>We will be able to send the data to our Splunk Enterprise environment easily by entering one line into the cli.<ul><li><a href=https://docs.splunk.com/Documentation/Forwarder/9.0.3/Forwarder/Configuretheuniversalforwarder target=_blank>Universal Forwarder Config Guide</a></li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/opt/splunkforwarder/bin/splunk add forward-server &lt;your_splunk_enterprise_ip&gt;:9997
</span></span></code></pre></div><h4 id=6-verify-the-data-in-your-splunk-enterprise-environment>6. Verify the Data in Your Splunk Enterprise Environment</h4><ul><li><p>We are now going to take a look at the Splunk Enterprise environment to verify logs are coming in.</p><ul><li>Logs will be coming into <code>index=main</code></li></ul></li><li><p>Open your web browser and navigate to: <code>http://&lt;your_splunk_enterprise_ip:8000</code></p><ul><li>You will use the credentials <code>admin:&lt;your_ssh_password></code></li></ul></li><li><p>In the search bar, type in the following:</p></li><li><p><code>index=main host=&lt;your_host_name></code></p></li><li><p>You should see data from your host. Take note of the interesting fields and the different data sources flowing in.</p></li></ul><footer class=footline></footer></article></section><article class=default><h1 id=3-itops-monitoring-monitoring-monitoring>3. ITOps Monitoring Monitoring Monitoring</h1><footer class=footline></footer></article><article class=default><h1 id=4-itops---understanding-event-analytics-in-realistic-business-services>4. ITOps - Understanding Event Analytics in Realistic Business Services</h1><footer class=footline></footer></article><article class=default><h1 id=5-how-platform-engineers-observe-kubernetes>5. How Platform Engineers Observe Kubernetes</h1><span class="btn cstyle transparent"><button type=button>
<i class="fa-fw fas fa-clock"></i>
45 minutes</button></span><p>This workshop will equip you with the basic understanding of monitoring Kubernetes using the Splunk OpenTelemetry Collector. During the workshop you will deploy PHP/Apache and a load generator.</p><p>You will learn about OpenTelemetry Receivers, Kubernetes Namespaces, ReplicaSets, Kubernetes Horizontal Pod AutoScaling and how to monitor all this using the Splunk Observability Cloud. The main learnings from the workshop will be a better understanding of the Kubernetes Navigator (and Dashboards) in Splunk Observability Cloud as well as seeing Kubernetes metrics, events and Auto-Detectors.</p><p>In order to part take in this workshop you will need to have:</p><ul><li>Access to a Splunk Observability Cloud account in US Splunk Show</li><li>Your laptop</li><li>Hopefully a stable wi-fi connection :)</li></ul><p>In preparation for the workshop, Splunk has prepared an Ubuntu Linux instance in AWS/EC2.</p><p>To get access to the instance that you will be using in the workshop, please visit the URL provided by the workshop leader in Google Sheets.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of 5. How Platform Engineers Observe Kubernetes</h1><article class=default><h1 id=deploying-the-opentelemetry-collector-in-kubernetes-using-a-namespace>Deploying the OpenTelemetry Collector in Kubernetes using a NameSpace</h1><h2 id=1-new-kubernetes-navigator-20-ui>1. New Kubernetes Navigator 2.0 UI</h2><p>As we are in the process of switching to the new generation of the Kubernetes Navigator, please check if you are already on the new Kubernetes navigator.</p><p>When you select <strong>Infrastructure</strong> from the main menu on the left, followed by selecting <strong>Kubernetes</strong>, you should see two services panes for Kubernetes, similar like the ones below:</p><p><a href=#image-085b9d1a6beeafeabd629deec67a98d5 class=lightbox-link><img src=/observability-workshop/v4.55/tko/session-5/docs/deploy-otel/../images/k8s-nav2-two.png alt=k8s-navi-v-2 style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-085b9d1a6beeafeabd629deec67a98d5><img src=/observability-workshop/v4.55/tko/session-5/docs/deploy-otel/../images/k8s-nav2-two.png alt=k8s-navi-v-2 class=lightbox-image loading=lazy></a></p><p>If you are taken straight to the Kubernetes Navigator v1 Map view after selecting <strong>Kubernetes</strong>, you need to opt-in to the new Navigator yourself for this workshop by clicking on the big blue
<span class="btn cstyle blue"><button type=button>
Switch to new navigator</button>
</span>.</p><p>You should now be in the K8s Node view with chart below the cluster map similar like shown below:</p><p><a href=#image-ccd8b020da37c2ef55c70b392a781db6 class=lightbox-link><img src=/observability-workshop/v4.55/tko/session-5/docs/deploy-otel/../images/new-k8s-view.png alt=k8s-navi-v-2 style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-ccd8b020da37c2ef55c70b392a781db6><img src=/observability-workshop/v4.55/tko/session-5/docs/deploy-otel/../images/new-k8s-view.png alt=k8s-navi-v-2 class=lightbox-image loading=lazy></a></p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Note</div><div class=box-content><p>If you actually see three services for Kubernetes including one that is named <code>K8s clusters</code>, you need to turn off Precognition in the Superpowers view.
To do this, please change the Url in your browser to match the following: <a href=https://app.[REALM].signalfx.com/#/superpowers target=_blank>https://app.[REALM].signalfx.com/#/superpowers</a></p><p>where [REALM] needs to match the Realm we are using for this workshop then remove the Precognition flag like in the example below. This is one of the first options you can set:</p><p><a href=#image-09cd448087c68930d924b9a2eddf76b4 class=lightbox-link><img src=/observability-workshop/v4.55/tko/session-5/docs/deploy-otel/../images/precognition.png alt=Set-Precognition style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-09cd448087c68930d924b9a2eddf76b4><img src=/observability-workshop/v4.55/tko/session-5/docs/deploy-otel/../images/precognition.png alt=Set-Precognition class=lightbox-image loading=lazy></a></p><p>Once its unset, you can refresh your page and reselect Kubernetes from the Infrastructure Navigator menu.</p></div></div><h2 id=2-connect-to-ec2-instance>2. Connect to EC2 instance</h2><p>You will be able to connect to the workshop instance by using SSH from your Mac, Linux or Windows device.</p><p>To use SSH, open a terminal on your system and type <code>ssh ubuntu@x.x.x.x</code> (replacing x.x.x.x with the IP address assigned to you).</p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Note</div><div class=box-content><p>Your workshop instance has been pre-configured with the correct <code>ACCESS_TOKEN</code> and <code>REALM</code> for this workshop. There is no need for you to configure these.</p></div></div><h2 id=3-namespaces-in-kubernetes>3. Namespaces in Kubernetes</h2><p>Most of our customers will make use of some kind of private or public cloud service to run Kubernetes. They often choose to have only a few large Kubernetes clusters as it is easier to manage centrally.</p><p>Namespaces are a way to organize these large Kubernetes clusters into virtual sub-clusters. This can be helpful when different teams or projects share a Kubernetes cluster as this will give them the easy ability to just see and work with their own stuff.</p><p>Any number of namespaces are supported within a cluster, each logically separated from others but with the ability to communicate with each other. Components are only &ldquo;visible&rdquo; when selecting a namespace or when adding the <code>--all-namespaces</code> flag to <code>kubectl</code> instead of allowing you to view just the components relevant to your project by selecting your namespace.</p><p>Most customers will want to install the Splunk OpenTelemetry Collector in a separate namespace. This workshop will follow that practice.</p><h2 id=4-install-splunk-otel-using-helm>4. Install Splunk OTel using Helm</h2><p>Install the OpenTelemetry Collector using the Splunk Helm chart. First, add the Splunk Helm chart repository and update.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Helm Repo Add" class="tab-nav-button direction-ltr active" onclick='switchTab("default","Helm Repo Add")'>
<span>Helm Repo Add</span></button>
<button data-tab-item="Helm Repo Add Output" class="tab-nav-button direction-ltr" onclick='switchTab("default","Helm Repo Add Output")'>
<span>Helm Repo Add Output</span></button></div><div class=tab-content><div data-tab-item="Helm Repo Add" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add splunk-otel-collector-chart https://signalfx.github.io/splunk-otel-collector-chart <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> helm repo update
</span></span></code></pre></div></div><div data-tab-item="Helm Repo Add Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Using ACCESS_TOKEN={REDACTED}
</span></span><span style=display:flex><span>Using REALM=eu0
</span></span><span style=display:flex><span>&#34;splunk-otel-collector-chart&#34; has been added to your repositories
</span></span><span style=display:flex><span>Using ACCESS_TOKEN={REDACTED}
</span></span><span style=display:flex><span>Using REALM=eu0
</span></span><span style=display:flex><span>Hang tight while we grab the latest from your chart repositories...
</span></span><span style=display:flex><span>...Successfully got an update from the &#34;splunk-otel-collector-chart&#34; chart repository
</span></span><span style=display:flex><span>Update Complete. ⎈Happy Helming!⎈
</span></span></code></pre></div></div></div></div><p>Install the OpenTelemetry Collector Helm chart into the <code>splunk</code> namespace with the following commands, do <strong>NOT</strong> edit this:</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Helm Install" class="tab-nav-button direction-ltr active" onclick='switchTab("default","Helm Install")'>
<span>Helm Install</span></button></div><div class=tab-content><div data-tab-item="Helm Install" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm install splunk-otel-collector <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;splunkObservability.realm=</span><span style=color:#000>$REALM</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;splunkObservability.accessToken=</span><span style=color:#000>$ACCESS_TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;clusterName=</span><span style=color:#204a87;font-weight:700>$(</span>hostname<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>-k3s-cluster&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;splunkObservability.logsEnabled=true&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;splunkObservability.infrastructureMonitoringEventsEnabled=true&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>splunk-otel-collector-chart/splunk-otel-collector <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--namespace splunk <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--create-namespace <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>-f ~/workshop/k3s/splunk-defaults.yaml
</span></span></code></pre></div></div></div></div><h2 id=5-verify-deployment>5. Verify Deployment</h2><p>You can monitor the progress of the deployment by running <code>kubectl get pods</code> and adding <code>-n splunk</code> to the command to see the pods in the <code>splunk</code> namespace which should typically report that the new pods are up and running after about 30 seconds.</p><p>Ensure the status is reported as <strong>Running</strong> before continuing.</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="kubectl get pods" class="tab-nav-button direction-ltr active" onclick='switchTab("default","kubectl get pods")'>
<span>kubectl get pods</span></button>
<button data-tab-item="kubectl get pods Output" class="tab-nav-button direction-ltr" onclick='switchTab("default","kubectl get pods Output")'>
<span>kubectl get pods Output</span></button></div><div class=tab-content><div data-tab-item="kubectl get pods" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods -n splunk
</span></span></code></pre></div></div><div data-tab-item="kubectl get pods Output" class=tab-content-text><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>NAME                                                          READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>splunk-otel-collector-agent-pvstb                             2/2     Running   0          19s
</span></span><span style=display:flex><span>splunk-otel-collector-k8s-cluster-receiver-6c454894f8-mqs8n   1/1     Running   0          19s
</span></span></code></pre></div></div></div></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Note</div><div class=box-content><p>If you are using the Kubernetes Integration setup from the Data Management page from the O11y UI , you find that the guide will use
<code>--generate-name splunk-otel-collector-chart/splunk-otel-collector</code> instead of just <code>splunk-otel-collector-chart/splunk-otel-collector</code> as we do in the above example.</p><p>This will generate an unique name/label for the collector install and Pods by adding a unique number at the end of the object name, allowing you to install multiple collectors in your Kubernetes environment with different configurations.</p><p>Just make sure you use the correct label that is generated by the Helm chart if you wish to use the <code>helm</code> and <code>kubectl</code> commands from this workshop on an install done with the <code>--generate-name</code> option.</p></div></div><p>Use the label set by the <code>helm</code> install to tail logs (You will need to press <code>ctrl + c</code> to exit).</p><div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="kubectl logs" class="tab-nav-button direction-ltr active" onclick='switchTab("default","kubectl logs")'>
<span>kubectl logs</span></button></div><div class=tab-content><div data-tab-item="kubectl logs" class="tab-content-text active"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl logs -l <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>=</span>splunk-otel-collector -f --container otel-collector -n splunk
</span></span></code></pre></div></div></div></div><p>Or use the installed <code>k9s</code> terminal UI.</p><p><a href=#image-d05b214a3e86c802610fe863e2e0b365 class=lightbox-link><img src=/observability-workshop/v4.55/tko/session-5/docs/deploy-otel/../images/k9s.png alt=k9s style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-d05b214a3e86c802610fe863e2e0b365><img src=/observability-workshop/v4.55/tko/session-5/docs/deploy-otel/../images/k9s.png alt=k9s class=lightbox-image loading=lazy></a></p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Deleting a failed installation</div><div class=box-content><p>If you make an error installing the Splunk OpenTelemetry Collector you can start over by deleting the installation using:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>helm delete splunk-otel-collector -n splunk
</span></span></code></pre></div></div></div><footer class=footline></footer></article><article class=default><h1 id=tour-of-the-kubernetes-navigator-v2>Tour of the Kubernetes Navigator v2</h1><h2 id=1-cluster-vs-workload-view>1. Cluster vs Workload View</h2><p>The Kubernetes Navigator offers you two separate use cases to view your Kubernetes data.</p><ul><li>The <code>K8s workloads</code> is focusing on providing information in regards to workloads a.k.a. <em>your deployments</em>.</li><li>The <code>K8s nodes</code> is focusing on providing insight into the performance of clusters, Nodes, Pods & Containers.</li></ul><p>You initially select either view depending on your need. (You can switch between the view on the fly if required) The most common one we will use in this workshop is the workload view and we will focus on that specifically.</p><h3 id=11-finding-your-k8s-cluster-name>1.1 Finding your K8s cluster name</h3><p>Your first task is to identify and find your own cluster. The cluster will be named after your EC2 instance name: <code>ws-5-X-k3s-cluster</code> where <code>X</code> is the number of the EC2 instance assigned to you.</p><p>To find your node name, look at the prompt of your EC2 instance. For example, if you are assigned the 7th EC2 instance, the prompt will show: <code>ubuntu@ws-5-7 ~ $</code></p><p>This means your cluster is named: <code>ws-5-7-k3s-cluster</code>. Please make a note of your cluster name as you will need this later in the workshop for filtering.</p><h2 id=2-workloads--workload-details-pane>2. Workloads & Workload Details Pane</h2><p>Go to the <strong>Infrastructure</strong> menu item in the Observability UI and select <strong>Kubernetes</strong>. Go to the <strong>Infrastructure</strong> page in the Observability UI and select <strong>Kubernetes</strong>, this will offer you a set of Kubernetes services, one of them being the <code>K8s workloads</code> pane</p><p>The pane will show a tiny graph giving you a bird&rsquo;s eye view of the load being handled across those Workloads. Also, if there are any alerts for one of the workloads, you will see a small alert indicator as shown in the image above.</p><p><a href=#image-b7f4d1aa8b80b7605af7ccd32b8b0176 class=lightbox-link><img src=/observability-workshop/v4.55/tko/session-5/docs/check-new-navigator-short/../images/K8s-Workloads.png alt=k8sWorkloads style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-b7f4d1aa8b80b7605af7ccd32b8b0176><img src=/observability-workshop/v4.55/tko/session-5/docs/check-new-navigator-short/../images/K8s-Workloads.png alt=k8sWorkloads class=lightbox-image loading=lazy></a></p><p>Click on the <code>K8s workloads</code> pane and you will be taken to the workload view.</p><p>Initially, you will see all the workloads that are reported by your clusters into your Observability Cloud Org. If an alert has fired for any of the workloads,it will be highlighted on the top right, <em>as marked with a red stripe in the image below</em>. You can go directly to the alert by clicking it to expand it.</p><p><a href=#image-4da16a4943c42a131c2288eb1e92e0da class=lightbox-link><img src=/observability-workshop/v4.55/tko/session-5/docs/check-new-navigator-short/../images/k8s-workload-screen.png alt=Workloads style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-4da16a4943c42a131c2288eb1e92e0da><img src=/observability-workshop/v4.55/tko/session-5/docs/check-new-navigator-short/../images/k8s-workload-screen.png alt=Workloads class=lightbox-image loading=lazy></a></p><p>Now, let&rsquo;s find your own cluster by filtering on the field <code>k8s.cluster.name</code> in the filter toolbar, <em>as marked with a blue stripe</em>. Note: you can enter a partial name into the search box, such as &lsquo;ws-5-7*&rsquo;, to quickly find your Cluster. Also it&rsquo;s a very good idea to switch the default time from the default 3 hours back to 15 minutes.</p><p>You should now just see information for your own cluster.</p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:success><div class=box-label>Workshop Question</div><div class=box-content><p>How many workloads are running & how many namespaces are in your Cluster?</p></div></div><h3 id=21-using-the-navigator-selection-chart>2.1 Using the Navigator Selection chart</h3><p>The <code>k8s workloads</code> Table is a common feature used across most of the Navigator&rsquo;s and will offer you a list view of the data you are viewing. In our case, it shows a list of <code>Pods Failed</code> grouped by <code>k8s.namespace.name</code>. You will find this pane used in various navigators in this workshop (ex: Workloads & Apache Servers). The way the selection pane works is similar across the navigators in that the information shown will match the selection criteria in your filters.</p><p><a href=#image-24da194164564727d200c8a6f8eea33c class=lightbox-link><img src=/observability-workshop/v4.55/tko/session-5/docs/check-new-navigator-short/../images/workload-selection.png alt=k8s-workload-list style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-24da194164564727d200c8a6f8eea33c><img src=/observability-workshop/v4.55/tko/session-5/docs/check-new-navigator-short/../images/workload-selection.png alt=k8s-workload-list class=lightbox-image loading=lazy></a></p><p>Now let&rsquo;s change the list view to a heat map view by selecting either the Heat map icon or List icon in the upper-right corner of the screen: <a href=/observability-workshop/v4.55/tko/session-5/docs/check-new-navigator-short/../images/heatmaptoggle.png>heat-map-toggle</a> <em>(as marked with a purple line)</em></p><p>Changing this option will result in the following representation, which is one we will use most of the time in this workshop:</p><p><a href=#image-0e327d9329b4c9a6c435a1b627f3e4a4 class=lightbox-link><img src=/observability-workshop/v4.55/tko/session-5/docs/check-new-navigator-short/../images/heatmap.png alt=k8s-Heat-map style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-0e327d9329b4c9a6c435a1b627f3e4a4><img src=/observability-workshop/v4.55/tko/session-5/docs/check-new-navigator-short/../images/heatmap.png alt=k8s-Heat-map class=lightbox-image loading=lazy></a></p><p>In this view, you will note that each workload is now a colored rectangle. These rectangles change color according to the <code>color by</code> option you selected, <em>as marked by a green line</em>. The colors give a visual indication of health and/or usage. (You can check the meaning by clicking on <code>legend !</code>)</p><p>Another valuable option in this screen is <code>Find Outliers</code> which provides historical analytics of your clusters based on what is selected in the <code>Color by</code> box.</p><p>Now, let&rsquo;s select the <code>File system usage (bytes)</code> from the <strong>Color by</strong> drop down box, <em>as marked with a green line</em> then click on the <code>Find outliers</code> drop down <em>as marked by a yellow stripe in the above image</em> and make sure you change the Strategy in the dialog to <code>Deviation from Median</code> as below:</p><p><a href=#image-7a976b0eb611b22edc288cebed36759b class=lightbox-link><img src=/observability-workshop/v4.55/tko/session-5/docs/check-new-navigator-short/../images/set-find-outliers.png alt=k8s-Heat-map style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-7a976b0eb611b22edc288cebed36759b><img src=/observability-workshop/v4.55/tko/session-5/docs/check-new-navigator-short/../images/set-find-outliers.png alt=k8s-Heat-map class=lightbox-image loading=lazy></a></p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:success><div class=box-label>Workshop Question</div><div class=box-content><p>What happened to the Heatmap?</p></div></div><p>The <code>Find outliers</code> view is very useful when you need to view a selection of your workloads (or any service depending on the navigator used) and quickly need to figure out if something has changed. It will give you fast insight into items (workloads in our case) that are performing differently (both increased or decreased) which helps to make it easier to spot problems.</p><p>Now switch the <code>Find Outliers</code> option back to off.</p><h3 id=22-the-workload-overview-pane>2.2 The Workload Overview pane</h3><p>The workload overview gives you a quick insight of the status of your deployment. You can see at once if the pods of your deployments are Pending, Running, Failed, Succeeded or in an unknown state.</p><p><a href=#image-5d9cb34e965dedaaa98acd3589c473cc class=lightbox-link><img src=/observability-workshop/v4.55/tko/session-5/docs/check-new-navigator-short/../images/k8s-workload-overview.png alt=k8s-workload-overview style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-5d9cb34e965dedaaa98acd3589c473cc><img src=/observability-workshop/v4.55/tko/session-5/docs/check-new-navigator-short/../images/k8s-workload-overview.png alt=k8s-workload-overview class=lightbox-image loading=lazy></a></p><ul><li><em>Running</em> Means your pods are deployed and in a running state</li><li><em>Pending</em> means waiting to be deployed</li><li><em>Succeeded</em> means the pod has been deployed and completed its job and is finished</li><li><em>Failed</em> means the containers in the pod have run and returned some kind of error</li><li><em>Unknown</em> means Kubernetes isn&rsquo;t reporting any of the known states. (This may be during start or stopping pods, for example).</li></ul><p>You can expand the Workload name by hovering your mouse on it, in case the name is longer than the chart allows.</p><p><a href=#image-da43884e60a30bc20eb7557ca6137744 class=lightbox-link><img src=/observability-workshop/v4.55/tko/session-5/docs/check-new-navigator-short/../images/k8s-workload-hoover.png alt=k8s-workload-hoover style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-da43884e60a30bc20eb7557ca6137744><img src=/observability-workshop/v4.55/tko/session-5/docs/check-new-navigator-short/../images/k8s-workload-hoover.png alt=k8s-workload-hoover class=lightbox-image loading=lazy></a></p><p>To filter to a specific Workload, you can click on three dots <code>...</code> next to the workload name in the <em>k8s.workload.name</em> column and choose <code>filter</code> from the drop down box.</p><p><a href=#image-df87f3631418a9c1128bd34a4bc626fa class=lightbox-link><img src=/observability-workshop/v4.55/tko/session-5/docs/check-new-navigator-short/../images/workload-add-filter.png alt=workload-add-filter style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-df87f3631418a9c1128bd34a4bc626fa><img src=/observability-workshop/v4.55/tko/session-5/docs/check-new-navigator-short/../images/workload-add-filter.png alt=workload-add-filter class=lightbox-image loading=lazy></a></p><p>This will add the selected workload to your filters. Try this for the <em>splunk-otel-collector-k8s-cluster-receiver</em> workload. It should give you a single rectangle in the `splunk&rsquo; namespace.
Confirm that you have the right filter by hovering over the rectangle, and if it is indeed the <em>splunk-otel-collector-k8s-cluster-receiver</em> workload, double click on it.</p><p>This brings you to a more detailed view of your workload.</p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:success><div class=box-label>Workshop Question</div><div class=box-content><p>What are the CPU request & CPU limit units for the otel-collector?</p></div></div><p>At this point you can drill into the information of the pods, but that is outside the scope of this workshop,
for now reset your view by removing the filter for the <em>splunk-otel-collector-k8s-cluster-receiver</em> workload. and setting the <code>color by</code> option to <em>Pods Pending</em>.</p><h2 id=3-pivot-sidebar>3. Pivot Sidebar</h2><p>Later in the workshop, you will deploy an Apache server into your cluster which will cause a <code>pivot bar</code> to appear.
As soon as any metric that is used by a Navigator, is flowing into your Observability org, the system will add that service to the pivot bar.</p><p>The pivot bar will expand and a link to the discovered service will be added as seen in the image below:</p><p><a href=#image-01ba1428d0ba544c500493039a0febcf class=lightbox-link><img src=/observability-workshop/v4.55/tko/session-5/docs/check-new-navigator-short/../images/pivotbar.png alt=pivotbar style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-01ba1428d0ba544c500493039a0febcf><img src=/observability-workshop/v4.55/tko/session-5/docs/check-new-navigator-short/../images/pivotbar.png alt=pivotbar class=lightbox-image loading=lazy></a></p><p>This will allow for easy switching between navigators. The same applies for your Apache server instance &ndash; it will have a pivot bar allowing you to quickly jump back to the Kubernetes navigator.</p><footer class=footline></footer></article><article class=default><h1 id=deploying-phpapache>Deploying PHP/Apache</h1><h2 id=1--dns-and-services-in-kubernetes>1. DNS and Services in Kubernetes</h2><p>The Domain Name System (DNS) is a mechanism for linking various sorts of information with easy-to-remember names, such as IP addresses. Using a DNS system to translate request names into IP addresses makes it easy for end-users to reach their target domain name effortlessly.</p><p>Most Kubernetes clusters include an internal DNS service configured by default to offer a lightweight approach for service discovery. Even when Pods and Services are created, deleted, or shifted between nodes, built-in service discovery simplifies applications to identify and communicate with services on the Kubernetes clusters.</p><p>In short, the DNS system for Kubernetes will create a DNS entry for each Pod and Service. In general, a Pod has the following DNS resolution:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>pod-name.my-namespace.pod.cluster-domain.example
</span></span></code></pre></div><p>For example, if a Pod in the <code>default</code> namespace has the Pod name <code>my_pod</code>, and the domain name for your cluster is <code>cluster.local</code>, then the Pod has a DNS name:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>my_pod.default.pod.cluster.local
</span></span></code></pre></div><p>Any Pods exposed by a Service have the following DNS resolution available:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>my_pod.service-name.my-namespace.svc.cluster-domain.example
</span></span></code></pre></div><p>More information can be found here : <a href=https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/ target=_blank>DNS for Service and Pods</a></p><h2 id=2-review-otel-receiver-for-phpapache>2. Review OTel receiver for PHP/Apache</h2><p>Inspect the YAML file <code>~/workshop/k3s/otel-apache.yaml</code> and validate the contents using the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/workshop/k3s/otel-apache.yaml
</span></span></code></pre></div><p>This file contains the configuration for the OpenTelemetry agent to monitor the PHP/Apache deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>agent</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>receivers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>receiver_creator</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>receivers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>smartagent/apache</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>rule</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type == &#34;port&#34; &amp;&amp; pod.name matches &#34;apache&#34; &amp;&amp; port == 80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>collectd/apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http://php-apache-svc.apache.svc.cluster.local/server-status?auto</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=3--observation-rules-in-the-opentelemetry-config>3. Observation Rules in the OpenTelemetry config</h2><p>The above file contains an observation rule for Apache using the OTel <code>receiver_creator</code>. This receiver can instantiate other receivers at runtime based on whether observed endpoints match a configured rule.</p><p>The configured rules will be evaluated for each endpoint discovered. If the rule evaluates to true, then the receiver for that rule will be started as configured against the matched endpoint.</p><p>In the file above we tell the OpenTelemetry agent to look for Pods that match the name <code>apache</code> and have port <code>80</code> open. Once found, the agent will configure an Apache receiver to read Apache metrics from the configured URL. Note, the K8s DNS based URL in the above YAML for the service.</p><p>To use the Apache configuration, you can upgrade the existing Splunk OpenTelemetry Collector Helm chart to use the <code>otel-apache.yaml</code> file with the following command:</p><p>&#171;&#171;&#171;&lt; HEAD<div class=tab-panel data-tab-group=default><div class=tab-nav><button data-tab-item="Helm Upgrade" class="tab-nav-button direction-ltr active" onclick='switchTab("default","Helm Upgrade")'>
<span>Helm Upgrade</span></button></div><div class=tab-content><div data-tab-item="Helm Upgrade" class="tab-content-text active"><p>=======</p><blockquote><blockquote><blockquote><blockquote><blockquote><blockquote><blockquote><p>main</p></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm upgrade splunk-otel-collector <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;splunkObservability.realm=</span><span style=color:#000>$REALM</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;splunkObservability.accessToken=</span><span style=color:#000>$ACCESS_TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;clusterName=</span><span style=color:#204a87;font-weight:700>$(</span>hostname<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>-k3s-cluster&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;splunkObservability.logsEnabled=true&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;splunkObservability.infrastructureMonitoringEventsEnabled=true&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>splunk-otel-collector-chart/splunk-otel-collector <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--namespace splunk <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>-f ~/workshop/k3s/splunk-defaults.yaml <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>-f ~/workshop/k3s/otel-apache.yaml
</span></span></code></pre></div></div></div></div></p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> NOTE</div><div class=box-content><p>The <strong>REVISION</strong> number of the deployment has changed, which is a helpful way to keep track of your changes.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Release &#34;splunk-otel-collector&#34; has been upgraded. Happy Helming!
</span></span><span style=display:flex><span>NAME: splunk-otel-collector
</span></span><span style=display:flex><span>LAST DEPLOYED: Tue Jan 31 16:57:22 2023
</span></span><span style=display:flex><span>NAMESPACE: splunk
</span></span><span style=display:flex><span>STATUS: deployed
</span></span><span style=display:flex><span>REVISION: 2
</span></span><span style=display:flex><span>TEST SUITE: None
</span></span></code></pre></div></div></div><h2 id=4-kubernetes-configmaps>4. Kubernetes ConfigMaps</h2><p>A ConfigMap is an object in Kubernetes consisting of key-value pairs which can be injected into your application. With a ConfigMap, you can separate configuration from your Pods.</p><p>Using ConfigMap, you can prevent hardcoding configuration data. ConfigMaps are useful for storing and sharing non-sensitive, unencrypted configuration information.</p><p>The OpenTelemetry collector/agent uses ConfigMaps to store the configuration of the agent and the K8s Cluster receiver. You can/will always verify the current configuration of an agent after a change by running the following commands:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get cm -n splunk
</span></span></code></pre></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>How many ConfigMaps are used by the collector?</p></div></div><p>When you have list of ConfigMaps from the namespace, select the one for the <code>otel-agent</code> and view it with the following command:</p><p><strong>Note:</strong> The option <code>-o yaml</code> will print the content of the ConfigMap in a YAML format.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get cm splunk-otel-collector-otel-agent -n splunk -o yaml
</span></span></code></pre></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Is the content of <code>otel-apache.yaml</code> saved in the ConfigMap for the collector agent?</p></div></div><h2 id=5-review-phpapache-deployment-yaml>5. Review PHP/Apache deployment YAML</h2><p>Inspect the YAML file <code>~/workshop/k3s/php-apache.yaml</code> and validate the contents using the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/workshop/k3s/php-apache.yaml
</span></span></code></pre></div><p>This file contains the configuration for the PHP/Apache deployment and will create a new StatefulSet with a single replica of the PHP/Apache image.</p><p>A stateless application is one that does not care which network it is using, and it does not need permanent storage. Examples of stateless apps may include web servers such as Apache, Nginx, or Tomcat.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StatefulSet</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>php-apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>updateStrategy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RollingUpdate</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>run</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>php-apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>serviceName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;php-apache-svc&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>run</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>php-apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>php-apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ghcr.io/splunk/php-apache:latest</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;8&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;9Mi&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;6&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;4Mi&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>php-apache-svc</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>run</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>php-apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>run</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>php-apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=6-deploy-phpapache>6. Deploy PHP/Apache</h2><p>Create an apache namespace then deploy the PHP/Apache application to the cluster.</p><p>Create the <code>apache</code> namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create namespace apache
</span></span></code></pre></div><p>Deploy the PHP/Apache application:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f ~/workshop/k3s/php-apache.yaml -n apache
</span></span></code></pre></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>What metrics for your Apache instance are being reported in the Apache Navigator?</p><p><strong>Tip:</strong> Click on <strong>Infrastructure → Web Server → Apache web servers</strong> to go to the Navigator and look for a server with the same name as your EC2 host.</p></div></div><p>Ensure the deployment has been created:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get statefulset -n apache
</span></span></code></pre></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Using the Observability Kubernetes Navigator, can you find the status of the <code>php-apache</code> <strong>Workload</strong>?</p><p><strong>HINT:</strong> Filter by <code>k8s.cluster.name</code> to isolate your instance!</p></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Where else has the issue with <code>php-apache</code> been logged? What is being reported?</p><p><strong>HINT:</strong> Adjust your Table settings to use only <code>k8s.cluster.name</code>, <code>object.involvedObject.name</code> & <code>object.message</code>. Make sure you unselect <code>_raw</code>!</p></div></div><footer class=footline></footer></article><article class=default><h1 id=fix-phpapache-issue>Fix PHP/Apache Issue</h1><h2 id=1-kubernetes-resources>1. Kubernetes Resources</h2><p>Especially in Production Kubernetes Clusters, CPU and Memory are considered precious resources. Cluster Operators will normally require you to specify the amount of CPU and Memory your Pod or Service will require in the deployment, so they can have the Cluster automatically manage on which Node(s) your solution will be placed.</p><p>You do this by placing a Resource section in the deployment of you application/Pod</p><p><strong>Example:</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># Maximum amount of CPU &amp; memory for peek use</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;8&#34;</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#8f5902;font-style:italic># Maximum of 8 cores of CPU allowed at for peek use</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;9Mi&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># Maximum allowed 9Mb of memory</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#8f5902;font-style:italic># Request are the expected amount of CPU &amp; memory for normal use</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;6&#34;</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#8f5902;font-style:italic># Requesting 4 cores of a CPU</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;4Mi&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># Requesting 4Mb of memory</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>More information can be found here : <a href=https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/ target=_blank>Resource Management for Pods and Containers</a></p><p>If your application or Pod will go over the limits set in your deployment, Kubernetes will kill and restart your Pod to protect the other applications on the Cluster.</p><p>Another scenario that you will run into is when there is not enough Memory or CPU on a Node. In that case, the Cluster will try to reschedule your Pod(s) on a different Node with more space.</p><p>If that fails, or if there is not enough space when you deploy your application, the Cluster will put your workload/deployment in schedule mode until there is enough room on any of the available Nodes to deploy the Pods according their limits.</p><h2 id=2-fix-phpapache-deployment>2. Fix PHP/Apache Deployment</h2><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Before we start, let&rsquo;s check the current status of the PHP/Apache deployment. Under <strong>Alerts & Detectors</strong> which detector has fired? Where else can you find this information?</p></div></div><p>To fix the PHP/Apache StatefulSet, edit <code>~/workshop/k3s/php-apache.yaml</code> using the following commands to reduce the CPU resources:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vim ~/workshop/k3s/php-apache.yaml
</span></span></code></pre></div><p>Find the resources section and reduce the CPU limits to <strong>1</strong> and the CPU requests to <strong>0.5</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;9Mi&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;0.5&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;4Mi&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Save the changes youhave made. (Hint: Use <code>Esc</code> followed by <code>:wq!</code> to save your changes).</p><p>Now, we must delete the existing StatefulSet and re-create it. StatefulSets are immutable, so we must delete the existing one and re-create it with the new changes.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl delete statefulset php-apache -n apache
</span></span></code></pre></div><p>Now, deploy your changes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f ~/workshop/k3s/php-apache.yaml -n apache
</span></span></code></pre></div><h2 id=3-validate-the-changes>3. Validate the changes</h2><p>You can validate the changes have been applied by running the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl describe statefulset php-apache -n apache
</span></span></code></pre></div><p>Validate the Pod is now running in Splunk Observability Cloud.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Is the <strong>Apache Web Servers</strong> dashboard showing any data now?</p><p><strong>Tip:</strong> Don&rsquo;t forget to use filters and time frames to narrow down your data.</p></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Another Auto-Detect Detector has fired, which one is it this time?</p></div></div><h2 id=4-fix-memory-issue>4. Fix memory issue</h2><p>Let&rsquo;s edit the stateful set and increase the memory to what is shown in the image below:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl edit statefulset php-apache -n apache
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;16Mi&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;0.5&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;12Mi&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Save the changes youhave made. (Hint: Use <code>Esc</code> followed by <code>:wq!</code> to save your changes).</p><p>Because the StatefulSet is immutable, we must delete the existing Pod and let the StatefulSet re-create it with the new changes.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl delete pod php-apache-0 -n apache
</span></span></code></pre></div><p>Validate the changes have been applied by running the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl describe statefulset php-apache -n apache
</span></span></code></pre></div><footer class=footline></footer></article><article class=default><h1 id=deploy-load-generator>Deploy Load Generator</h1><p>Now let&rsquo;s see how the autoscaler reacts to increased load. To do this, you&rsquo;ll start a different Pod to act as a client. The container within the client Pod runs in an infinite loop, sending queries to the php-apache Service.</p><h2 id=1-review-loadgen-yaml>1. Review loadgen YAML</h2><p>Inspect the YAML file <code>~/workshop/k3s/loadgen.yaml</code> and validate the contents using the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/workshop/k3s/loadgen.yaml
</span></span></code></pre></div><p>This file contains the configuration for the load generator and will create a new StatefulSet with a single replica of the load generator image.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StatefulSet</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>loadgen</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>loadgen</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>serviceName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;loadgen&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>loadgen</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>loadgen</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>loadgen</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>infinite-calls</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>busybox</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>command</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>/bin/sh</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- -<span style=color:#000>c</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#4e9a06>&#34;while true; do wget -q -O- http://php-apache-svc.apache.svc.cluster.local; done&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=2-create-a-new-namespace>2. Create a new namespace</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>kubectl create namespace loadgen
</span></span></code></pre></div><h2 id=3-deploy-the-loadgen-yaml>3. Deploy the loadgen YAML</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>kubectl apply -f ~/workshop/k3s/loadgen.yaml --namespace loadgen
</span></span></code></pre></div><p>Once you have deployed the load generator, you can see the Pod running in the <code>loadgen</code> namespace. Use previous similar commands to check the status of the Pod from the command line.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>What metrics in the Apache Dashboard have now significantly increased?</p></div></div><h2 id=4-scale-the-load-generator>4. Scale the load generator</h2><p>A ReplicaSet is a process that runs multiple instances of a Pod and keeps the specified number of Pods constant. Its purpose is to maintain the specified number of Pod instances running in a cluster at any given time to prevent users from losing access to their application when a Pod fails or is inaccessible.</p><p>ReplicaSet helps bring up a new instance of a Pod when the existing one fails, scale it up when the running instances are not up to the specified number, and scale down or delete Pods if another instance with the same label is created. A ReplicaSet ensures that a specified number of Pod replicas are running continuously and helps with load-balancing in case of an increase in resource usage.</p><p>Let&rsquo;s scale our ReplicaSet to 4 replicas using the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>kubectl scale statefulset/loadgen --replicas 4 -n loadgen
</span></span></code></pre></div><p>Validate the replicas are running from both the command line and Splunk Observability Cloud:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>kubectl get statefulset loadgen -n loadgen
</span></span></code></pre></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>What impact did this have? Where in O11y can you see the increased replica number? Can you identify the point when you scaled?</p></div></div><p>Let the load generator run for around 2-3 minutes and keep observing the metrics in the Kubernetes Navigator and the Apache dashboard.</p><footer class=footline></footer></article><article class=default><h1 id=setup-horizontal-pod-autoscaling-hpa>Setup Horizontal Pod Autoscaling (HPA)</h1><p>In Kubernetes, a HorizontalPodAutoscaler automatically updates a workload resource (such as a Deployment or StatefulSet), with the aim of automatically scaling the workload to match demand.</p><p>Horizontal scaling means that the response to increased load is to deploy more Pods. This is different from vertical scaling, which for Kubernetes would mean assigning more resources (for example: memory or CPU) to the Pods that are already running for the workload.</p><p>If the load decreases, and the number of Pods is above the configured minimum, the HorizontalPodAutoscaler instructs the workload resource (the Deployment, StatefulSet, or other similar resource) to scale back down.</p><h2 id=1-setup-hpa>1. Setup HPA</h2><p>Inspect the <code>~/workshop/k3s/hpa.yaml</code> file and validate the contents using the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/workshop/k3s/hpa.yaml
</span></span></code></pre></div><p>This file contains the configuration for the Horizontal Pod Autoscaler and will create a new HPA for the <code>php-apache</code> deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>autoscaling/v2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HorizontalPodAutoscaler</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>php-apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>maxReplicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>metrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Resource</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cpu</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>target</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>averageUtilization</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Utilization</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Resource</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>memory</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>target</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>averageUtilization</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>75</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Utilization</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>minReplicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>scaleTargetRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StatefulSet</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>php-apache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Once deployed, <code>php-apache</code> will autoscale when either the average CPU usage and average memory usage for the deployment goes above 75%, with a minimum of 1 pod and a maximum of 4 pods.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>kubectl apply -f ~/workshop/k3s/hpa.yaml
</span></span></code></pre></div><h2 id=2-validate-hpa>2. Validate HPA</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>kubectl get hpa -n apache
</span></span></code></pre></div><p>Go to the <strong>Workloads</strong> or <strong>Node Detail</strong> tab in Kubernetes and check the HPA deployment.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>How many additional <code>php-apache-x</code> pods have been created?</p></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Which metrics in the Apache Dashboards have significantly increased again?</p></div></div><h2 id=3-increase-the-hpa-replica-count>3. Increase the HPA replica count</h2><p>Increase the <code>maxReplicas</code> to 8</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl edit hpa php-apache -n apache
</span></span></code></pre></div><p>Save the changes youhave made. (Hint: Use <code>Esc</code> followed by <code>:wq!</code> to save your changes).</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>How many pods are now in a running state? How many are pending? Why are they pending?</p></div></div><footer class=footline></footer></article></section><article class=default><h1 id=6-o11y---distributed-tracing-for-modern-applications>6. O11y - Distributed Tracing for modern applications</h1><p>Here at Buttercup Instruments, our business is expanding ! We have recently added 3 new locations, two locations in the USA, Colorado and Chicago and one international location in SRI Lanka!</p><p>Our technical staff has already on-boarded the data from these new locations and incorporated them into our inventory application and it is our job to review these improvements and send any issues back to our developers for repairs.</p><p>We now have a total of 6 locations!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of 6. O11y - Distributed Tracing for modern applications</h1><article class=default><h1 id=setup>Setup</h1><h2 id=1-set-environment-variables>1. Set Environment Variables</h2><p>Environment Variables:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>USERNAME</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;Your-UserName&gt;
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>SPLUNK_ACCESS_TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;Your-Token&gt;
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>SPLUNK_REALM</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;Your-Realm&gt;
</span></span></code></pre></div><h2 id=2-implement-auto-instrumentation>2. Implement Auto-Instrumentation</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> shop
</span></span><span style=display:flex><span>vi Dockerfile
</span></span></code></pre></div><p>Add the Otel Java Agent to Java ENTRYPOINT:</p><p>Change this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ENTRYPOINT java  -Dotel.resource.attributes<span style=color:#ce5c00;font-weight:700>=</span>service.name<span style=color:#ce5c00;font-weight:700>=</span>shop,deployment.environment<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>USERNAME</span><span style=color:#4e9a06>}</span>_Apm_Instrumentation_Shop -jar app.jar
</span></span></code></pre></div><p>To this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ENTRYPOINT java -javaagent:splunk-otel-javaagent-all.jar 
</span></span><span style=display:flex><span>-Dotel.resource.attributes<span style=color:#ce5c00;font-weight:700>=</span>service.name<span style=color:#ce5c00;font-weight:700>=</span>shop,deployment.environment<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>USERNAME</span><span style=color:#4e9a06>}</span>_Apm_Instrumentation_Shop
</span></span><span style=display:flex><span>-jar app.jar
</span></span></code></pre></div><p>See examples at:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi ../Dockerfiles_Instrumented
</span></span></code></pre></div><p>Repeat for: <code>instruments / products / stock</code></p><h2 id=3-build-and-deploy-application>3. Build and Deploy Application</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> <span style=color:#4e9a06>&#34;javashop-otel directory&#34;</span>
</span></span><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><footer class=footline></footer></article><article class=default><h1 id=validate-traces-are-being-collected>Validate Traces are being collected</h1><h2 id=1-users-and-workflows>1. Users and Workflows</h2><p>As we go through this workshop we will be switching roles from SRE to Developer. First we will start with first responders or SREs who will identify an issue in Splunk Observability UI.</p><p>Next, we will jump to a Developer Role to see how a Developer will solve a problem using trace data identified by our SRE. Of course, we are not requiring 2 people for this workshop as each participant will play both roles.</p><h2 id=2-view-service-map>2. View Service Map</h2><p>If your instrumentation was successful, the service-map will show latency from the shop service to the products service.</p><p><a href=#image-e67d1dda0611b23eeb85fe4e94da6c7b class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/206541846-7f0e6462-7659-44bc-bc48-3621c2872fc4.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-e67d1dda0611b23eeb85fe4e94da6c7b><img src=https://user-images.githubusercontent.com/32849847/206541846-7f0e6462-7659-44bc-bc48-3621c2872fc4.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" class=lightbox-image loading=lazy></a></p><p>Click on shop service, click Traces (right side), sort by Duration and select the longest duration trace.</p><p><a href=#image-894f90a650dff8296e5ebbc325cfd73c class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204347798-4f232b7f-7a7a-483f-9d61-f0b535e9ecf0.png alt=LongTrace style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-894f90a650dff8296e5ebbc325cfd73c><img src=https://user-images.githubusercontent.com/32849847/204347798-4f232b7f-7a7a-483f-9d61-f0b535e9ecf0.png alt=LongTrace class=lightbox-image loading=lazy></a></p><p>Now we can see the long latency occurred in the products service and if we click on <code>products: /products</code> we can see the offending method was <code>products:ProductResource.getAllProducts</code>.</p><p><a href=#image-7bb64d632c58e552f4180dcabeba5259 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204347855-724545bf-c3df-478a-a27d-e4f85f708e15.png alt=long-trace-detail-GetAllProducts style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-7bb64d632c58e552f4180dcabeba5259><img src=https://user-images.githubusercontent.com/32849847/204347855-724545bf-c3df-478a-a27d-e4f85f708e15.png alt=long-trace-detail-GetAllProducts class=lightbox-image loading=lazy></a></p><p>Our next step here would be to send that trace to a developer by clicking download trace and they will have to debug the method. Before we do that please take note of the Tags available for the developer to leverage to find root cause.</p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Note:</div><div class=box-content><p>Since they do not have full parameter information it can be a long process.</p></div></div><footer class=footline></footer></article><article class=default><h1 id=developer-role>Developer Role</h1><h2 id=1-now-lets-play-the-role-of-the-developer>1. Now let&rsquo;s play the role of the developer</h2><p>As a developer we must debug the function products:ProductResource.getAllProducts to find the problem.</p><p>Now find the needle in Haystack !</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi products/src/main/java/com/shabushabu/javashop/products/resources/ProductResource.java
</span></span></code></pre></div><p>Find getAllProducts <code>/getAllProducts</code></p><p>scroll way&mldr; down!</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ProductResource</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ProductService</span> <span style=color:#000>productService</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Inject</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ProductResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ProductService</span> <span style=color:#000>productService</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>productService</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>productService</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@GET</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Response</span> <span style=color:#000>getAllProducts</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@DefaultValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;California&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#5c35cc;font-weight:700>@QueryParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;location&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// STEP X: All we know right now is somewhere in this function, latency was introduced.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction10</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction13</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction5</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction6</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction7</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction8</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction9</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction10</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction11</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>myCoolFunction12</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>//something in HAYSTACK
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//something in HAYSTACK
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//something in HAYSTACK
</span></span></span></code></pre></div><p>Exit vi <code>:q!</code></p><p>OK, enough fun&mldr; let&rsquo;s make this easier for our developer.</p><footer class=footline></footer></article><article class=default><h1 id=custom-attribution>Custom Attribution</h1><p>To take a deeper look at this issue, we will implement Custom Attributes via Opentelemetry Manual Instrumentation</p><p>To speed up manual instrumentation in Java you can leverage <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotations</a>, which automatically create a span around a method without modifying the actual code inside the method.</p><p>This can be very valueable if you are working with an SRE that may have limited accesss to source code changes.</p><p>To add even more information to help our developers find the root cause faster, <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotations</a> can be used to generate span tags with parameter values for the method in question.</p><p>It is important to remember that any developer should be able to debug a method with knowledge of parameter values at the time of an issue ( exception or latency).</p><p>To expedite manual instrumentation implementation for this exercise, we have provided a tool which will annotate the entirety of the &ldquo;shop&rdquo; and &ldquo;products&rdquo; services with OpenTelemetry standard annotations for every method call without having to write any code. This &ldquo;annotator&rdquo; tool will also tag every parameter in every function, which adds a span tag with Parameter=Value.</p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Note:</div><div class=box-content><p>This Full-fidelity Every-method approach is the Monolith Use Case with Splunk APM for Java.</p></div></div><h2 id=1-run-manual-instrumentation-tool>1. Run Manual Instrumentation Tool</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> javashop-otel directory
</span></span><span style=display:flex><span>./AutomateManualInstrumentation.sh
</span></span></code></pre></div><h2 id=2-rebuild-and-deploy-application>2. Rebuild and Deploy Application</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Now that we have rebuilt and deployed our application, traffic is being sent once again.</p><p>Go back to the Splunk Observability UI and let&rsquo;s see if these annotations help us narrow down the root cause more quickly.</p><p>Click back on the trace window</p><p><a href=#image-302b244f2ce95dcf57f83cc373359c8a class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204348366-38b8c82a-02ca-472b-b1aa-feeb746ec1d7.png alt="Screen Shot 2022-11-28 at 7 29 43 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-302b244f2ce95dcf57f83cc373359c8a><img src=https://user-images.githubusercontent.com/32849847/204348366-38b8c82a-02ca-472b-b1aa-feeb746ec1d7.png alt="Screen Shot 2022-11-28 at 7 29 43 AM" class=lightbox-image loading=lazy></a></p><p>Give the traces a couple minutes to generate &mldr;</p><h2 id=3-houston-we-have-a-new-problem>3. Houston, we have a new problem</h2><p>Once traces populate, Select &ldquo;Errors Only&rdquo;</p><p><a href=#image-1e41a07119bbc89be1a1c4322d3246e8 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204348492-84a4ad45-e11c-4e75-a6a9-d6e52e0eb13e.png alt="Screen Shot 2022-11-28 at 7 36 50 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-1e41a07119bbc89be1a1c4322d3246e8><img src=https://user-images.githubusercontent.com/32849847/204348492-84a4ad45-e11c-4e75-a6a9-d6e52e0eb13e.png alt="Screen Shot 2022-11-28 at 7 36 50 AM" class=lightbox-image loading=lazy></a></p><p>Note: we haven&rsquo;t changed the code at all by adding annotations. Click on a trace with an error present.</p><p><a href=#image-4fc3be4054e77c268f77fd3fb73b4829 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204348687-12241153-b297-4bd7-9ea8-4b410369e82c.png alt="Screen Shot 2022-11-28 at 7 38 33 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-4fc3be4054e77c268f77fd3fb73b4829><img src=https://user-images.githubusercontent.com/32849847/204348687-12241153-b297-4bd7-9ea8-4b410369e82c.png alt="Screen Shot 2022-11-28 at 7 38 33 AM" class=lightbox-image loading=lazy></a></p><p>We can see our Exception is <code>InvalidLocaleException</code>!</p><p>The real problem must be related to the new data associated with SRI LANKA as the Exception says &ldquo;Non English Characters found in Instrument Data.</p><p>This exception had not surfaced in previous traces because the method where it was thrown was NOT covered with Auto Instrumentation.</p><p>Once we completed the Manual Instrumentation via the Annotations we added, this method was instrumented and we can now see we had a buried Exception being thrown.</p><footer class=footline></footer></article><article class=default><h1 id=fix-the-issue>Fix the issue</h1><h2 id=1-lets-play-developer-once-again-and-fix-our-issue>1. Let&rsquo;s play Developer once again and fix our issue</h2><p>We already know exactly what file to look in and what method to look at as it is called out in the trace.</p><p><a href=#image-1813c407c6cd644baa0139e596a5e94b class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349038-3b43a5ba-18e3-4d58-8985-29ee1f7da40a.png alt="Screen Shot 2022-11-28 at 7 43 58 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-1813c407c6cd644baa0139e596a5e94b><img src=https://user-images.githubusercontent.com/32849847/204349038-3b43a5ba-18e3-4d58-8985-29ee1f7da40a.png alt="Screen Shot 2022-11-28 at 7 43 58 AM" class=lightbox-image loading=lazy></a></p><p>Edit the file</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi shop/src/main/java/com/shabushabu/javashop/shop/model/Instrument.java
</span></span></code></pre></div><p>Search for the method buildForLocale <code>/buildForLocale</code></p><p>Look at Code, notice the Annotation <code>@WithSpan()</code>? <code>@WithSpan()</code> is an <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotation</a> for Java that automatically generates a span around a the function that follows.</p><p><code>@SpanAttribute()</code> is another <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotation</a> that automatically adds a tag to a span with the corresponding parameter it annotates and its value. Using this technique we can tell developers exactly what the values of every parameter of a function the wrote or must repair at the time the problem occurred.</p><p><a href=#image-e4b4b43db535098e314e487e5d52a9ad class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349143-1e35b6e4-4059-4c56-8718-76c14d41727c.png alt="Screen Shot 2022-11-28 at 7 45 13 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-e4b4b43db535098e314e487e5d52a9ad><img src=https://user-images.githubusercontent.com/32849847/204349143-1e35b6e4-4059-4c56-8718-76c14d41727c.png alt="Screen Shot 2022-11-28 at 7 45 13 AM" class=lightbox-image loading=lazy></a></p><p>Now let&rsquo;s fix this code. We are going to simply comment this out for now and see if it fixes our latency issue. Type <code>i</code> for insert</p><p>Change this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isEnglish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>title</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InvalidLocaleException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Non English Characters found in Instrument Data&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Characters OK &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>To this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//if (!isEnglish(title)) {
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//  throw new InvalidLocaleException(&#34;Non English Characters found in Instrument Data&#34;);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// } else {
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// System.out.println(&#34;Characters OK &#34;);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//}
</span></span></span></code></pre></div><p>To save changes in vi type <code>:wq</code></p><p>Make sure you saved your changes to <code>shop/src/main/java/com/shabushabu/javashop/shop/model/Instrument.java</code></p><h2 id=2-build-and-deploy-application>2. Build and Deploy Application</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Wait a few minutes&mldr;..</p><footer class=footline></footer></article><article class=default><h1 id=root-cause-analysis>Root Cause Analysis</h1><h2 id=1-latency-root-cause>1. Latency Root Cause</h2><p>Open Service Map in Splunk Observability UI</p><p><a href=#image-a01d5c9c34d75baa02bc4fd6645919bd class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/206542093-f97b37ce-7e58-45bc-a281-5a388d60617e.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-a01d5c9c34d75baa02bc4fd6645919bd><img src=https://user-images.githubusercontent.com/32849847/206542093-f97b37ce-7e58-45bc-a281-5a388d60617e.png alt="Screen Shot 2022-12-08 at 11 48 58 AM" class=lightbox-image loading=lazy></a></p><p>We can see we still have our original Latency issue, however our exception for Invalid Locale should be gone.</p><p>Let&rsquo;s check to see our InvalidLocale Exception is gone. Click Shop Service, click Traces on the right. We did remove the exception however it seems removing the Exception did not fix the latency&mldr;</p><p>Lets see if the newly added annotations provide us more relevant information for the next responder once we find the cause.</p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:warning><div class=box-label>Note:</div><div class=box-content><p>We added additional information Parameter Values at Time of Latency. In this case the <strong>Location</strong> tag was created due our handy Annotator, that did the <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ target=_blank>OpenTelemetry Annotations</a></p></div></div><p><a href=#image-e213dc946da65932c38b58bd815ee7a3 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/213582624-66466a19-00fa-4dda-acd0-f6970d594ba1.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-e213dc946da65932c38b58bd815ee7a3><img src=https://user-images.githubusercontent.com/32849847/213582624-66466a19-00fa-4dda-acd0-f6970d594ba1.png alt=image class=lightbox-image loading=lazy></a></p><p>We can see that the actual function call that has the latency was not <code>ProductResource.getAllProducts</code> but the function call <code>ProductResource.myCoolFunction234234234</code>!</p><p>With this information a Developer can debug very quickly. Consider the case of debugging code, that you may not have written yourself without Parameter Values at the time of the issue? You would have no choice but to go line &mldr;. by line &mldr;.. by line&mldr;.. which can take a very long time.</p><p>Since we now have the parameter tagged as part of our span metadata the actual root cause is seemingly related to the &ldquo;location&rdquo; Colorado!</p><p>It appears the one custom attribute that was tagged for function <code>ProductResource.myCoolFunction234234234</code> was <code>myInt</code> with a value of <code>999</code>.</p><p>Let&rsquo;s see if we can find the code that is causing this latency.</p><h2 id=2-fix-the-code>2. Fix the code</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi products/src/main/java/com/shabushabu/javashop/products/resources/ProductResource.java
</span></span></code></pre></div><p>search for 999 <code>/999</code></p><p>We found and fixed the Needle In Haystack more quickly! Let&rsquo;s fix our code, enter <code>i</code> for insert.</p><p>Change this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>myCoolFunction234234234</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@SpanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;myInt&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>myInt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Generate a FAST sleep of 0 time !
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Random</span> <span style=color:#000>sleepy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Random</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>999</span><span style=color:#ce5c00;font-weight:700>==</span><span style=color:#000>myInt</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sleepy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5000</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#0000cf;font-weight:700>3000</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>3000</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span></code></pre></div><p>To this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>myCoolFunction234234234</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@SpanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;myInt&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>myInt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Generate a FAST sleep of 0 time !
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Random</span> <span style=color:#000>sleepy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Random</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//    if (999==myInt)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//        Thread.sleep(sleepy.nextInt(5000 - 3000) + 3000);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span></code></pre></div><p>Save changes in vi type <code>:wq</code></p><p>Make sure you saved your changes to: <code>products/src/main/java/com/shabushabu/javashop/products/resources/ProductResource.java</code></p><footer class=footline></footer></article><article class=default><h1 id=build-and-deploy-again>Build and Deploy again</h1><h2 id=1-build-and-deploy-application-again>1. Build and Deploy Application again</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Now that we have rebuilt and deployed our application, traffic is being sent once again.</p><p>We are waiting a few minutes . . .</p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Congratulations</div><div class=box-content><p>If you do not see Red in your service map, you have successfully completed our Inventory application review for Shri Lanka and Colorado locations!!</p></div></div><p>Now let&rsquo;s ensure Chicago was on-boarded correctly. However, since we have been having so many issues related to &ldquo;location&rdquo; and we have added that custom attribute via Opentelemetry Manual Instrumentation, lets go to the Splunk Observability UI and create an APM metric set around that tag.</p><p>NOTE: We can do this without concern for Cardinality as we know this tag only has 6 possible values.</p><p>Index the location Tag.</p><p><a href=#image-a6dc949e5f1e27fb0320423c15c4cd22 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/213540265-5b0567ab-c9f3-412f-bec0-07277c7e8650.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-a6dc949e5f1e27fb0320423c15c4cd22><img src=https://user-images.githubusercontent.com/32849847/213540265-5b0567ab-c9f3-412f-bec0-07277c7e8650.png alt=image class=lightbox-image loading=lazy></a></p><h2 id=2-build-and-deploy-application-to-run-traffic-again>2. Build and Deploy Application to run traffic again</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Open a browser and navigate to <a href=http://localhost:8010 target=_blank>http://localhost:8010</a></p><p><a href=#image-afcd7901fc850617d741c1fecbb9cdfd class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/213541843-30266285-787f-493b-bc90-ffb4ac6e4c77.png alt=image style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-afcd7901fc850617d741c1fecbb9cdfd><img src=https://user-images.githubusercontent.com/32849847/213541843-30266285-787f-493b-bc90-ffb4ac6e4c77.png alt=image class=lightbox-image loading=lazy></a></p><p>Select a few locagtions and hit the login button, remember to select the Chicago Location and Login</p><p>Uhh ohh ! We received a 500 error, something is wrong there as well. Return to the Splunk Observability UI and lets look once again at our Service Map</p><p><a href=#image-0930b1d4c5a33cac007d74fc81ed5d9b class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349595-fca270ad-379e-48c5-b2e1-7f222af82c55.png alt="Screen Shot 2022-11-28 at 8 11 47 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-0930b1d4c5a33cac007d74fc81ed5d9b><img src=https://user-images.githubusercontent.com/32849847/204349595-fca270ad-379e-48c5-b2e1-7f222af82c55.png alt="Screen Shot 2022-11-28 at 8 11 47 AM" class=lightbox-image loading=lazy></a></p><p>We see there was an un-handled exception thrown in Instruments service and some latency from our database.</p><p>Select the Instruments Service, click on Traces on the right and select <strong>Errors Only</strong></p><p><a href=#image-c2244dae29c7551be725e8490d9c9644 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204349696-dc19d62f-ed82-4533-ad27-138237821b8e.png alt="Screen Shot 2022-11-28 at 8 14 50 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-c2244dae29c7551be725e8490d9c9644><img src=https://user-images.githubusercontent.com/32849847/204349696-dc19d62f-ed82-4533-ad27-138237821b8e.png alt="Screen Shot 2022-11-28 at 8 14 50 AM" class=lightbox-image loading=lazy></a></p><p>We can see the exception was thrown by Hibernate, however it was thrown in our method <code>instruments: InstrumentRepository.findInstruments</code></p><p><a href=#image-69f9502bd958812fe774b3b47013fe90 class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204351905-03fe632b-b21c-4e8d-8044-dc582fed2253.png alt="Screen Shot 2022-11-28 at 8 14 37 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-69f9502bd958812fe774b3b47013fe90><img src=https://user-images.githubusercontent.com/32849847/204351905-03fe632b-b21c-4e8d-8044-dc582fed2253.png alt="Screen Shot 2022-11-28 at 8 14 37 AM" class=lightbox-image loading=lazy></a></p><footer class=footline></footer></article><article class=default><h1 id=the-final-fix>The Final Fix!</h1><h2 id=1-lets-play-developer-again>1. Let&rsquo;s play developer again</h2><p>Edit the file <code>instruments: InstrumentRepository.findInstruments</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi instruments/src/main/java/com/shabushabu/javashop/instruments/repositories/FindInstrumentRepositoryImpl.java
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>findInstruments</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;findInstruments Called (All)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>Object</span> <span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entityManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createNativeQuery</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#4e9a06>&#34;SELECT * FROM instruments_for_sale, instruments_for_sale_chicago&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getResultList</span><span style=color:#ce5c00;font-weight:700>();</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>We can see the developer accidently added the Instruments database with the Chicago Instruments database! Let&rsquo;s change the query and fix this, remove <code>instruments_for_sale</code> from our query.</p><p>Change this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>findInstruments</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;findInstruments Called (All)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#000>Object</span> <span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entityManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createNativeQuery</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#4e9a06>&#34;SELECT * FROM instruments_for_sale, instruments_for_sale_chicago&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getResultList</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>To this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>findInstruments</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;findInstruments Called (All)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//Object obj = entityManager.createNativeQuery( &#34;SELECT * FROM instruments_for_sale, instruments_for_sale_chicago&#34;).getResultList();
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span>    <span style=color:#000>Object</span> <span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entityManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createNativeQuery</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#4e9a06>&#34;SELECT * FROM instruments_for_sale_chicago&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getResultList</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=2-build-and-deploy-application-once-more>2. Build and Deploy Application once more</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> javashop-otel directory
</span></span><span style=display:flex><span>./BuildAndDeploy.sh
</span></span></code></pre></div><p>Now let&rsquo;s test the Chicago location once again, open a browser and navigate to <a href=http://localhost:8010 target=_blank>http://localhost:8010</a>. Select the Chicago Location and Login.</p><p>We now see the 500 error is gone! Let&rsquo;s confirm a clean Service Map!</p><p><a href=#image-f294b75a0cef50a9a6686d8e3187bdad class=lightbox-link><img src=https://user-images.githubusercontent.com/32849847/204350088-fca43e3c-42ea-4933-8a61-01eb2083fd23.png alt="Screen Shot 2022-11-28 at 8 35 11 AM" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-f294b75a0cef50a9a6686d8e3187bdad><img src=https://user-images.githubusercontent.com/32849847/204350088-fca43e3c-42ea-4933-8a61-01eb2083fd23.png alt="Screen Shot 2022-11-28 at 8 35 11 AM" class=lightbox-image loading=lazy></a></p><div class="box notices cstyle default" style=--VARIABLE-BOX-color:info><div class=box-label>Congratulations</div><div class=box-content><p>If you see a clean service map, free of errors and Latency you have successfully completed the Java Instrumentation Workshop!**</p></div></div><p><strong>Have a lovely day!</strong></p><footer class=footline></footer></article></section></section></div></main></div><script src=/observability-workshop/v4.55/js/clipboard.min.js?1676472824 defer></script>
<script src=/observability-workshop/v4.55/js/perfect-scrollbar.min.js?1676472824 defer></script>
<script src=/observability-workshop/v4.55/js/theme.js?1676472824 defer></script></body></html>